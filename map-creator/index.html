<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–¹å—è‹±é›„åœ°å›¾ç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .main-container {
            display: flex;
            flex: 1;
            gap: 15px;
            padding: 15px;
            height: calc(100vh - 100px);
        }

        .toolbar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            width: 280px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .canvas-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        #mapCanvas {
            border: 3px solid #ff6b6b;
            border-radius: 15px;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            display: block;
            cursor: crosshair;
            flex: 1;
        }

        .tool-section {
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-left: 5px solid #ff6b6b;
        }

        .tool-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .tool-item {
            aspect-ratio: 1;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .tool-item:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .tool-item.active {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
        }

        .platform {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: white;
        }

        .obstacle {
            background: linear-gradient(135deg, #696969, #808080);
            color: white;
        }

        .trampoline {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
        }

        .conveyor {
            background: linear-gradient(135deg, #ffa500, #ff8c00);
            color: white;
        }

        .spike {
            background: linear-gradient(135deg, #ff0000, #dc143c);
            color: white;
        }

        .checkpoint {
            background: linear-gradient(135deg, #00ff00, #32cd32);
            color: white;
        }

        .finish {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }

        .decorative {
            background: linear-gradient(135deg, #9370db, #ba55d3);
            color: white;
        }

        .powerup {
            background: linear-gradient(135deg, #00bfff, #1e90ff);
            color: white;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .play-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .clear-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .save-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .load-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 16px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .info-panel {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }

        .file-input {
            display: none;
        }

        .instructions {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            border-left: 5px solid #ffc107;
        }

        .instructions h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
            color: #856404;
        }

        .emoji {
            font-size: 20px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ® æ–¹å—è‹±é›„åœ°å›¾ç¼–è¾‘å™¨</h1>
        <p>åˆ›é€ å±äºä½ çš„æ–¹å—è‹±é›„å†’é™©ä¸–ç•Œï¼</p>
    </div>

    <div class="main-container">
        <div class="toolbar">
            <div class="instructions">
                <h4>ğŸ® ä½¿ç”¨è¯´æ˜</h4>
                <ul>
                    <li>é€‰æ‹©å·¥å…·åç‚¹å‡»ç”»å¸ƒæ”¾ç½®</li>
                    <li>å³é”®åˆ é™¤å…ƒç´ </li>
                    <li>å¯ä»¥ä¿å­˜å’ŒåŠ è½½åœ°å›¾</li>
                    <li>ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"æµ‹è¯•åœ°å›¾</li>
                    <li>æ–¹å—è‹±é›„å¯ä»¥è·³è·ƒå’Œç§»åŠ¨</li>
                </ul>
            </div>

            <div class="tool-section">
                <h3>ğŸ§± åœ°å½¢</h3>
                <div class="tool-grid">
                    <button class="tool-item platform" data-type="grass">
                        <div class="emoji">ğŸŒ±</div>
                        <div>è‰åœ°</div>
                    </button>
                    <button class="tool-item platform" data-type="stone">
                        <div class="emoji">ğŸª¨</div>
                        <div>çŸ³åœ°</div>
                    </button>
                    <button class="tool-item platform" data-type="sand">
                        <div class="emoji">ğŸ–ï¸</div>
                        <div>æ²™åœ°</div>
                    </button>
                </div>
            </div>

            <div class="tool-section">
                <h3>ğŸš§ éšœç¢ç‰©</h3>
                <div class="tool-grid">
                    <button class="tool-item obstacle" data-type="brick">
                        <div class="emoji">ğŸ§±</div>
                        <div>ç –å—</div>
                    </button>
                    <button class="tool-item spike" data-type="cactus">
                        <div class="emoji">ğŸŒµ</div>
                        <div>ä»™äººæŒ</div>
                    </button>
                    <button class="tool-item obstacle" data-type="lava">
                        <div class="emoji">ğŸŒ‹</div>
                        <div>å²©æµ†</div>
                    </button>
                </div>
            </div>

            <div class="tool-section">
                <h3>âš¡ æœºå…³</h3>
                <div class="tool-grid">
                    <button class="tool-item trampoline" data-type="spring">
                        <div class="emoji">ğŸ”µ</div>
                        <div>å¼¹ç°§</div>
                    </button>
                    <button class="tool-item conveyor" data-type="conveyor">
                        <div class="emoji">âš™ï¸</div>
                        <div>ä¼ é€å¸¦</div>
                    </button>
                    <button class="tool-item obstacle" data-type="switch">
                        <div class="emoji">ğŸ”˜</div>
                        <div>å¼€å…³</div>
                    </button>
                </div>
            </div>

            <div class="tool-section">
                <h3>ğŸ¯ ç›®æ ‡ç‚¹</h3>
                <div class="tool-grid">
                    <button class="tool-item checkpoint" data-type="flag">
                        <div class="emoji">ğŸš©</div>
                        <div>æ——å¸œ</div>
                    </button>
                    <button class="tool-item finish" data-type="treasure">
                        <div class="emoji">ğŸ’</div>
                        <div>å®è—</div>
                    </button>
                    <button class="tool-item checkpoint" data-type="spawn">
                        <div class="emoji">â­</div>
                        <div>å‡ºç”Ÿç‚¹</div>
                    </button>
                </div>
            </div>

            <div class="tool-section">
                <h3>ğŸ’ é“å…·</h3>
                <div class="tool-grid">
                    <button class="tool-item powerup" data-type="coin">
                        <div class="emoji">ğŸª™</div>
                        <div>é‡‘å¸</div>
                    </button>
                    <button class="tool-item powerup" data-type="gem">
                        <div class="emoji">ğŸ’</div>
                        <div>å®çŸ³</div>
                    </button>
                    <button class="tool-item powerup" data-type="key">
                        <div class="emoji">ğŸ—ï¸</div>
                        <div>é’¥åŒ™</div>
                    </button>
                </div>
            </div>

            <div class="tool-section">
                <h3>ğŸ¨ è£…é¥°</h3>
                <div class="tool-grid">
                    <button class="tool-item decorative" data-type="mushroom">
                        <div class="emoji">ğŸ„</div>
                        <div>è˜‘è‡</div>
                    </button>
                    <button class="tool-item decorative" data-type="crystal">
                        <div class="emoji">ğŸ”®</div>
                        <div>æ°´æ™¶</div>
                    </button>
                    <button class="tool-item decorative" data-type="star">
                        <div class="emoji">âœ¨</div>
                        <div>æ˜Ÿæ˜Ÿ</div>
                    </button>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn play-btn" id="playBtn">å¼€å§‹æ¸¸æˆ</button>
                <button class="control-btn clear-btn" id="clearBtn">æ¸…ç©ºåœ°å›¾</button>
                <button class="control-btn save-btn" id="saveBtn">ä¿å­˜åœ°å›¾</button>
                <button class="control-btn load-btn" id="loadBtn">åŠ è½½åœ°å›¾</button>
                <input type="file" class="file-input" id="fileInput" accept=".json">
            </div>

            <div class="info-panel">
                <h4>ğŸ“Š åœ°å›¾ä¿¡æ¯</h4>
                <p>åœ°å½¢æ•°é‡: <span id="terrainCount">0</span></p>
                <p>éšœç¢ç‰©æ•°é‡: <span id="obstacleCount">0</span></p>
                <p>é“å…·æ•°é‡: <span id="powerupCount">0</span></p>
                <p>è£…é¥°æ•°é‡: <span id="decorCount">0</span></p>
            </div>
        </div>

        <div class="canvas-container">
            <div class="controls">
                <button class="control-btn" id="gridToggle">ç½‘æ ¼å¼€å…³</button>
                <button class="control-btn" id="zoomIn">æ”¾å¤§</button>
                <button class="control-btn" id="zoomOut">ç¼©å°</button>
            </div>
            <div style="position: relative; flex: 1;">
                <canvas id="mapCanvas" width="800" height="600"></canvas>
            </div>
            <div class="status-bar">
                <span id="statusText">é€‰æ‹©å·¥å…·å¼€å§‹åˆ›ä½œ</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('statusText');
        const terrainCount = document.getElementById('terrainCount');
        const obstacleCount = document.getElementById('obstacleCount');
        const powerupCount = document.getElementById('powerupCount');
        const decorCount = document.getElementById('decorCount');

        let currentTool = null;
        let mapObjects = [];
        let isPlaying = false;
        let showGrid = true;
        let zoom = 1;

        class MapObject {
            constructor(x, y, type, width = 40, height = 40) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = width;
                this.height = height;
                this.id = Math.random().toString(36).substr(2, 9);
                this.rotation = 0;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                ctx.scale(zoom, zoom);
                ctx.rotate(this.rotation);

                switch (this.type) {
                    case 'grass':
                        this.drawGrass();
                        break;
                    case 'stone':
                        this.drawStone();
                        break;
                    case 'sand':
                        this.drawSand();
                        break;
                    case 'brick':
                        this.drawBrick();
                        break;
                    case 'cactus':
                        this.drawCactus();
                        break;
                    case 'lava':
                        this.drawLava();
                        break;
                    case 'spring':
                        this.drawSpring();
                        break;
                    case 'conveyor':
                        this.drawConveyor();
                        break;
                    case 'switch':
                        this.drawSwitch();
                        break;
                    case 'flag':
                        this.drawFlag();
                        break;
                    case 'treasure':
                        this.drawTreasure();
                        break;
                    case 'spawn':
                        this.drawSpawn();
                        break;
                    case 'coin':
                        this.drawCoin();
                        break;
                    case 'gem':
                        this.drawGem();
                        break;
                    case 'key':
                        this.drawKey();
                        break;
                    case 'mushroom':
                        this.drawMushroom();
                        break;
                    case 'crystal':
                        this.drawCrystal();
                        break;
                    case 'star':
                        this.drawStar();
                        break;
                    case 'hero':
                        this.drawHero();
                        break;
                }
                ctx.restore();
            }

            drawGrass() {
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#66BB6A';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#2E7D32';
                for (let i = -15; i < 15; i += 8) {
                    for (let j = -15; j < 15; j += 8) {
                        ctx.fillRect(i, j, 2, 2);
                    }
                }
            }

            drawStone() {
                ctx.fillStyle = '#757575';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#9E9E9E';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#424242';
                for (let i = -15; i < 15; i += 6) {
                    for (let j = -15; j < 15; j += 6) {
                        if (Math.random() > 0.5) {
                            ctx.fillRect(i, j, 3, 3);
                        }
                    }
                }
            }

            drawSand() {
                ctx.fillStyle = '#FFE082';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#FFD54F';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FF8F00';
                for (let i = -15; i < 15; i += 4) {
                    for (let j = -15; j < 15; j += 4) {
                        if (Math.random() > 0.7) {
                            ctx.fillRect(i, j, 2, 2);
                        }
                    }
                }
            }

            drawBrick() {
                ctx.fillStyle = '#8D6E63';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#A1887F';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#5D4037';
                for (let i = -16; i < 16; i += 8) {
                    for (let j = -16; j < 16; j += 8) {
                        ctx.fillRect(i, j, 6, 2);
                        ctx.fillRect(i + 1, j + 4, 6, 2);
                    }
                }
            }

            drawCactus() {
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(-8, -20, 16, 40);
                ctx.fillStyle = '#2E7D32';
                ctx.fillRect(-6, -18, 12, 36);
                ctx.fillStyle = '#1B5E20';
                for (let i = -4; i < 4; i += 2) {
                    ctx.fillRect(i, -15, 1, 3);
                    ctx.fillRect(i, -5, 1, 3);
                    ctx.fillRect(i, 5, 1, 3);
                }
            }

            drawLava() {
                ctx.fillStyle = '#FF5722';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#FF9800';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#D84315';
                for (let i = -15; i < 15; i += 3) {
                    for (let j = -15; j < 15; j += 3) {
                        if (Math.random() > 0.6) {
                            ctx.fillRect(i, j, 2, 2);
                        }
                    }
                }
            }

            drawSpring() {
                ctx.fillStyle = '#2196F3';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#1976D2';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ”µ', 0, 5);
            }

            drawConveyor() {
                ctx.fillStyle = '#FFA500';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#FF8C00';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(-15, -10, 30, 20);
                ctx.fillStyle = '#FF6347';
                for (let i = -12; i < 12; i += 6) {
                    ctx.fillRect(i, -5, 3, 10);
                }
            }

            drawSwitch() {
                ctx.fillStyle = '#9C27B0';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#BA68C8';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ”˜', 0, 5);
            }

            drawFlag() {
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#66BB6A';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸš©', 0, 5);
            }

            drawTreasure() {
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#FFED4E';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FF6347';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ’', 0, 5);
            }

            drawSpawn() {
                ctx.fillStyle = '#00BFFF';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#1E90FF';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('â­', 0, 5);
            }

            drawCoin() {
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#FFED4E';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FF8F00';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸª™', 0, 5);
            }

            drawGem() {
                ctx.fillStyle = '#E91E63';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#F06292';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ’', 0, 5);
            }

            drawKey() {
                ctx.fillStyle = '#FF9800';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#FFB74D';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ—ï¸', 0, 5);
            }

            drawMushroom() {
                ctx.fillStyle = '#8BC34A';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#AED581';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ„', 0, 5);
            }

            drawCrystal() {
                ctx.fillStyle = '#9C27B0';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#BA68C8';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ”®', 0, 5);
            }

            drawStar() {
                ctx.fillStyle = '#FFC107';
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = '#FFD54F';
                ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('âœ¨', 0, 5);
            }

            drawHero() {
                // æ–¹å—è‹±é›„ - å®Œå…¨åŸåˆ›è®¾è®¡
                ctx.fillStyle = '#4A90E2';
                ctx.fillRect(-12, -15, 24, 24);
                ctx.fillStyle = '#2E5BBA';
                ctx.fillRect(-10, -13, 20, 20);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(-6, -8, 4, 4);
                ctx.fillRect(2, -8, 4, 4);
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(-4, 2, 8, 2);
                ctx.fillStyle = '#7ED321';
                ctx.fillRect(-10, 5, 20, 20);
                ctx.fillStyle = '#5BA317';
                ctx.fillRect(-8, 7, 16, 16);
                ctx.fillStyle = '#F5A623';
                ctx.fillRect(-15, 8, 8, 12);
                ctx.fillRect(7, 8, 8, 12);
                ctx.fillStyle = '#D0021B';
                ctx.fillRect(-8, 20, 6, 8);
                ctx.fillRect(2, 20, 6, 8);
                ctx.fillStyle = '#000000';
                ctx.fillRect(-10, 25, 8, 4);
                ctx.fillRect(2, 25, 8, 4);
            }

            isPointInside(x, y) {
                return x >= this.x && x <= this.x + this.width &&
                    y >= this.y && y <= this.y + this.height;
            }
        }

        function initEditor() {
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('contextmenu', handleCanvasRightClick);

            document.querySelectorAll('.tool-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tool-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTool = btn.dataset.type;
                    statusText.textContent = `å·²é€‰æ‹©: ${btn.textContent}`;
                });
            });

            document.getElementById('playBtn').addEventListener('click', togglePlay);
            document.getElementById('clearBtn').addEventListener('click', clearMap);
            document.getElementById('saveBtn').addEventListener('click', saveMap);
            document.getElementById('loadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', loadMap);
            document.getElementById('gridToggle').addEventListener('click', toggleGrid);
            document.getElementById('zoomIn').addEventListener('click', () => zoomIn());
            document.getElementById('zoomOut').addEventListener('click', () => zoomOut());

            updateCounts();
            draw();
        }

        function handleCanvasClick(e) {
            if (isPlaying) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (currentTool) {
                const width = 40;
                const height = 40;
                mapObjects.push(new MapObject(x - width / 2, y - height / 2, currentTool, width, height));
                updateCounts();
                draw();
            }
        }

        function handleCanvasRightClick(e) {
            e.preventDefault();
            if (isPlaying) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            for (let i = mapObjects.length - 1; i >= 0; i--) {
                if (mapObjects[i].isPointInside(x, y)) {
                    mapObjects.splice(i, 1);
                    updateCounts();
                    draw();
                    break;
                }
            }
        }

        function updateCounts() {
            const terrains = mapObjects.filter(obj => ['grass', 'stone', 'sand'].includes(obj.type)).length;
            const obstacles = mapObjects.filter(obj => ['brick', 'cactus', 'lava'].includes(obj.type)).length;
            const powerups = mapObjects.filter(obj => ['coin', 'gem', 'key'].includes(obj.type)).length;
            const decors = mapObjects.filter(obj => ['mushroom', 'crystal', 'star'].includes(obj.type)).length;

            terrainCount.textContent = terrains;
            obstacleCount.textContent = obstacles;
            powerupCount.textContent = powerups;
            decorCount.textContent = decors;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#98FB98');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (showGrid) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                for (let x = 0; x < canvas.width; x += 40) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = 0; y < canvas.height; y += 40) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }

            mapObjects.forEach(obj => obj.draw());
        }

        function togglePlay() {
            if (isPlaying) {
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'å¼€å§‹æ¸¸æˆ';
                statusText.textContent = 'ç¼–è¾‘æ¨¡å¼';
                draw();
            } else {
                isPlaying = true;
                document.getElementById('playBtn').textContent = 'åœæ­¢æ¸¸æˆ';
                statusText.textContent = 'æ¸¸æˆæ¨¡å¼ - æ–¹å—è‹±é›„å¼€å§‹å†’é™©ï¼';
                startGame();
            }
        }

        function startGame() {
            const hero = new MapObject(50, 50, 'hero', 30, 30);
            mapObjects.unshift(hero);
            draw();
            playGameMusic();
        }

        function playGameMusic() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            function createTone(frequency, duration, type = 'square') {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }

            createTone(523, 0.2);
            setTimeout(() => createTone(659, 0.2), 100);
            setTimeout(() => createTone(784, 0.4), 200);
        }

        function clearMap() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºåœ°å›¾å—ï¼Ÿ')) {
                mapObjects = [];
                updateCounts();
                draw();
                statusText.textContent = 'åœ°å›¾å·²æ¸…ç©º';
            }
        }

        function saveMap() {
            const mapData = {
                objects: mapObjects.map(obj => ({
                    x: obj.x,
                    y: obj.y,
                    type: obj.type,
                    width: obj.width,
                    height: obj.height,
                    rotation: obj.rotation
                }))
            };

            const blob = new Blob([JSON.stringify(mapData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'æ–¹å—è‹±é›„åœ°å›¾.json';
            a.click();
            URL.revokeObjectURL(url);

            statusText.textContent = 'åœ°å›¾å·²ä¿å­˜';
        }

        function loadMap(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const mapData = JSON.parse(e.target.result);
                    mapObjects = mapData.objects.map(obj => {
                        const newObj = new MapObject(obj.x, obj.y, obj.type, obj.width, obj.height);
                        newObj.rotation = obj.rotation || 0;
                        return newObj;
                    });
                    updateCounts();
                    draw();
                    statusText.textContent = 'åœ°å›¾å·²åŠ è½½';
                } catch (error) {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
                }
            };
            reader.readAsText(file);
        }

        function toggleGrid() {
            showGrid = !showGrid;
            draw();
            statusText.textContent = showGrid ? 'ç½‘æ ¼å·²å¼€å¯' : 'ç½‘æ ¼å·²å…³é—­';
        }

        function zoomIn() {
            zoom = Math.min(zoom * 1.2, 3);
            draw();
        }

        function zoomOut() {
            zoom = Math.max(zoom / 1.2, 0.5);
            draw();
        }

        initEditor();
    </script>
</body>

</html>