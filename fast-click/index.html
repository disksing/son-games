<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ååº”é€Ÿåº¦æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .game-container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 700px;
            width: 90%;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .instruction {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-start:active {
            transform: translateY(0);
        }

        .btn-timer {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-timer:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-timer:active {
            transform: translateY(0);
        }

        .btn-restart {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            margin-top: 20px;
        }

        .btn-restart:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        .waiting-text {
            font-size: 2em;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .click-text {
            font-size: 2.5em;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: pulse 0.8s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .result {
            margin: 30px 0;
        }

        .result-time {
            font-size: 4em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .result-message {
            font-size: 1.5em;
            color: #666;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        .color-waiting {
            background-color: #e74c3c;
        }

        .color-ready {
            background-color: #2ecc71;
        }

        .color-default {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .too-early {
            color: #e74c3c;
            font-size: 1.8em;
            font-weight: bold;
        }

        .timer-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 40px 0;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            word-break: break-all;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn-control {
            padding: 15px 40px;
            font-size: 1.2em;
            min-width: 120px;
        }

        .btn-back {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-math {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .btn-math:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-math:active {
            transform: translateY(0);
        }

        .btn-game {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .btn-game:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-game:active {
            transform: translateY(0);
        }

        .math-question {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin: 40px 0;
            line-height: 1.5;
            padding: 0 20px;
        }

        .math-input {
            font-size: 2em;
            padding: 15px 25px;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
            width: 80%;
            max-width: 300px;
            margin: 20px auto;
            display: block;
            font-family: 'Courier New', monospace;
        }

        .math-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }

        .math-score {
            font-size: 1.5em;
            color: #666;
            margin: 20px 0;
        }

        .math-feedback {
            font-size: 2em;
            font-weight: bold;
            margin: 20px 0;
        }

        .correct {
            color: #2ecc71;
        }

        .incorrect {
            color: #e74c3c;
        }
    </style>
</head>

<body class="color-default">
    <div class="game-container" id="gameContainer">
        <h1>âš¡ ååº”é€Ÿåº¦æµ‹è¯•</h1>
        <div id="startScreen">
            <p class="instruction" style="margin-bottom: 15px;">
                <strong>â±ï¸ è®¡æ—¶å™¨æ¨¡å¼</strong>
            </p>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 35px;">
                <button class="btn btn-timer" onclick="showTimer(event, 'second')">ç§’</button>
                <button class="btn btn-timer" onclick="showTimer(event, 'millisecond')">æ¯«ç§’</button>
                <button class="btn btn-timer" onclick="showTimer(event, 'microsecond')">å¾®ç§’</button>
                <button class="btn btn-timer" onclick="showTimer(event, 'nanosecond')">çº³ç§’</button>
                <button class="btn btn-timer" onclick="showTimer(event, 'picosecond')">çš®ç§’</button>
            </div>
            <div style="border-top: 2px solid #e0e0e0; margin: 30px 0; padding-top: 30px;">
                <p class="instruction" style="margin-bottom: 15px;">
                    <strong>ğŸ® æ¸¸æˆæ¨¡å¼</strong>
                </p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px;">
                    <button class="btn btn-start" onclick="startGame(event)">ååº”é€Ÿåº¦æµ‹è¯•</button>
                    <button class="btn btn-math" onclick="showMath(event)">æ¦‚ç‡é¢˜æŒ‘æˆ˜</button>
                    <button class="btn btn-game" onclick="showRestaurantGame(event)">ğŸ³ é¤å…å¤§å¨</button>
                    <button class="btn btn-game" onclick="showToastGame(event)">ğŸ çƒ¤é¢åŒ…å·¥åŠ</button>
                    <button class="btn btn-game" onclick="showClawGame(event)">ğŸª æŠ“å¨ƒå¨ƒæœº</button>
                    <button class="btn btn-game" onclick="showNoodleGame(event)">ğŸœ ç…®æ³¡é¢</button>
                    <button class="btn btn-game" onclick="showFishGame(event)">ğŸ£ é’“é±¼</button>
                    <button class="btn btn-game" onclick="showFruitGame(event)">ğŸ‰ åˆ‡æ°´æœ</button>
                    <button class="btn btn-game" onclick="showRPSGame(event)">âœŠ çŒœæ‹³</button>
                    <button class="btn btn-game" onclick="showPianoGame(event)">ğŸ¹ éŸ³ç¬¦è®°å¿†</button>
                    <button class="btn btn-game" onclick="showCatchGame(event)">ğŸ¯ æ¥ä¸œè¥¿</button>
                    <button class="btn btn-game" onclick="showBartenderGame(event)">ğŸ¹ è°ƒé…’å¸ˆ</button>
                    <button class="btn btn-game" onclick="showCafeGame(event)">â˜• å’–å•¡åº—</button>
                    <button class="btn btn-game" onclick="showFarmGame(event)">ğŸŒ¾ å†œåœº</button>
                    <button class="btn btn-game" onclick="showConvenienceGame(event)">ğŸª ä¾¿åˆ©åº—</button>
                    <button class="btn btn-game" onclick="showCakeGame(event)">ğŸ‚ è›‹ç³•åº—</button>
                    <button class="btn btn-game" onclick="showMiningGame(event)">â›ï¸ æŒ–çŸ¿</button>
                    <button class="btn btn-game" onclick="showPetGame(event)">ğŸ¶ å® ç‰©åº—</button>
                    <button class="btn btn-game" onclick="showArtGame(event)">ğŸ¨ ç¾æœ¯é¦†</button>
                    <button class="btn btn-game" onclick="showHospitalGame(event)">ğŸ¥ åŒ»é™¢</button>
                    <button class="btn btn-game" onclick="showCircusGame(event)">ğŸª é©¬æˆå›¢</button>
                </div>
            </div>
        </div>

        <div id="waitingScreen" class="hidden">
            <p class="waiting-text">ç­‰å¾…ç»¿è‰²...</p>
        </div>

        <div id="clickScreen" class="hidden">
            <p class="click-text">å¿«ç‚¹å‡»ï¼</p>
        </div>

        <div id="resultScreen" class="hidden">
            <div class="result">
                <p class="result-message" id="resultMessage">ä½ çš„ååº”æ—¶é—´ï¼š</p>
                <div class="result-time" id="resultTime">0 æ¯«ç§’</div>
                <p class="instruction" id="resultRating"></p>
            </div>
            <button class="btn btn-restart" onclick="restartGame(event)">å†ç©ä¸€æ¬¡</button>
        </div>

        <div id="tooEarlyScreen" class="hidden">
            <p class="too-early">âš ï¸ å¤ªæ—©äº†ï¼</p>
            <p class="instruction">è¯·ç­‰å¾…å±å¹•å˜æˆç»¿è‰²ï¼</p>
            <button class="btn btn-restart" onclick="restartGame(event)">é‡è¯•</button>
        </div>

        <div id="timerScreen" class="hidden">
            <h2 style="color: #333; margin-bottom: 20px;" id="timerTitle">â±ï¸ è®¡æ—¶å™¨</h2>
            <div class="timer-display" id="timerDisplay">0</div>
            <p class="instruction" style="margin-bottom: 20px;" id="timerUnit">å•ä½</p>
            <div class="timer-controls">
                <button class="btn btn-start btn-control" onclick="startTimer(event)" id="startTimerBtn">å¼€å§‹</button>
                <button class="btn btn-restart btn-control" onclick="pauseTimer(event)" id="pauseTimerBtn">æš‚åœ</button>
                <button class="btn btn-restart btn-control" onclick="resetTimer(event)">é‡ç½®</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            </div>
        </div>

        <div id="mathScreen" class="hidden">
            <h2 style="color: #333; margin-bottom: 20px;">ğŸ² æ¦‚ç‡é¢˜æŒ‘æˆ˜</h2>
            <p class="math-score" id="mathScore">å¾—åˆ†ï¼š0 / å·²ç­”ï¼š0</p>
            <div class="math-question" id="mathQuestion">æ¦‚ç‡é¢˜</div>
            <input type="number" class="math-input" id="mathInput" placeholder="è¾“å…¥ç­”æ¡ˆ" autocomplete="off">
            <div class="math-feedback" id="mathFeedback"></div>
            <div class="timer-controls" style="margin-top: 30px;">
                <button class="btn btn-start btn-control" onclick="submitAnswer(event)">æäº¤ç­”æ¡ˆ</button>
                <button class="btn btn-restart btn-control" onclick="skipQuestion(event)">è·³è¿‡</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            </div>
        </div>

        <div id="toastScreen" class="hidden">
            <h2 style="color: #333; margin-bottom: 20px;">ğŸ çƒ¤é¢åŒ…æ¨¡æ‹Ÿå™¨</h2>
            <div id="toastBread"
                style="width: 200px; height: 200px; margin: 30px auto; border: 3px solid #8B4513; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 3em; transition: background-color 0.1s;">
            </div>
            <p class="instruction" id="toastMessage">ç‚¹å‡»å¼€å§‹çƒ¤é¢åŒ…</p>
            <p class="math-score" id="toastScore">å®Œç¾åº¦ï¼š-</p>
            <div class="timer-controls" style="margin-top: 30px;">
                <button class="btn btn-start btn-control" onclick="startToast(event)" id="toastStartBtn">å¼€å§‹çƒ¤</button>
                <button class="btn btn-restart btn-control" onclick="stopToast(event)" id="toastStopBtn"
                    disabled>åœæ­¢ï¼</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            </div>
        </div>

        <div id="simpleGame" class="hidden">
            <h2 style="color: #333; margin-bottom: 20px;" id="simpleGameTitle">ğŸ® æ¸¸æˆ</h2>
            <div style="font-size: 3em; margin: 40px 0;" id="simpleGameContent">æ¸¸æˆå†…å®¹</div>
            <p class="math-score" id="simpleGameScore">å¾—åˆ†ï¼š0</p>
            <div class="timer-controls" style="margin-top: 30px;" id="simpleGameControls"></div>
        </div>

        <div id="restaurantGame" class="hidden">
            <h2 style="color: #333; margin-bottom: 10px;">ğŸ³ é¤å…å¤§å¨</h2>

            <!-- é¡¾å®¢è®¢å• -->
            <div style="background: #fff3cd; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                <div style="font-weight: bold; margin-bottom: 6px; font-size: 0.9em;">ğŸ‘¥ é¡¾å®¢è®¢å•ï¼š</div>
                <div id="ordersList" style="display: grid; gap: 6px; max-height: 120px; overflow-y: auto;"></div>
            </div>

            <!-- èœè°± -->
            <div style="background: #e8f5e9; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                <div style="font-weight: bold; margin-bottom: 6px; font-size: 0.9em;">ğŸ“– èœè°±ï¼ˆç‚¹å‡»æŸ¥çœ‹é…æ–¹ï¼‰ï¼š</div>
                <div id="recipeButtons" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;"></div>
                <div id="recipeDetail"
                    style="margin-top: 8px; padding: 8px; background: white; border-radius: 5px; min-height: 35px; font-size: 0.85em;">
                </div>
            </div>

            <!-- çƒ¹é¥ªå·¥å…·åŒº -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                <!-- çƒ¤ç®± -->
                <div style="background: #ffe4e1; padding: 8px; border-radius: 10px;">
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 0.85em;">ğŸ”¥ çƒ¤ç®± (<span
                            id="ovenCount">0/4</span>)</div>
                    <div id="ovenArea"
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; min-height: 70px;"></div>
                </div>

                <!-- å¹³åº•é”… -->
                <div style="background: #fff8dc; padding: 8px; border-radius: 10px;">
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 0.85em;">ğŸ³ å¹³åº•é”… (<span
                            id="panCount">0/4</span>)</div>
                    <div id="panArea"
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; min-height: 70px;"></div>
                </div>

                <!-- ç…®é”… -->
                <div style="background: #e0f7fa; padding: 8px; border-radius: 10px;">
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 0.85em;">ğŸ² ç…®é”… (<span
                            id="potCount">0/4</span>)</div>
                    <div id="potArea"
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; min-height: 70px;"></div>
                </div>
            </div>

            <!-- åˆ¶ä½œå°ï¼ˆç›˜å­ï¼‰ -->
            <div style="background: #d1ecf1; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                <div style="font-weight: bold; margin-bottom: 6px; font-size: 0.9em;">ğŸ½ï¸ åˆ¶ä½œå° (ç›˜å­: <span
                        id="plateCount">0/4</span>)</div>
                <div id="platesArea"
                    style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; min-height: 100px;"></div>
            </div>

            <!-- åŸæ–™åŒº -->
            <div style="background: #f0f8ff; padding: 10px; border-radius: 10px; margin-bottom: 8px;">
                <div style="font-weight: bold; margin-bottom: 6px; font-size: 0.9em;">ğŸ§º åŸæ–™åŒºï¼ˆç‚¹å‡»æ”¾å…¥å¯¹åº”å·¥å…·ï¼‰ï¼š</div>
                <div id="ingredientsArea" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px;"></div>
            </div>

            <p class="math-score" id="restaurantScore">ğŸ’° 0å…ƒ | â­ 5.0 | å®Œæˆ: 0</p>
            <div class="timer-controls">
                <button class="btn btn-timer btn-control" onclick="createNewPlate(event)">æ–°å»ºç›˜å­</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            </div>
        </div>

        <!-- é€šç”¨æ¸¸æˆç•Œé¢ -->
        <div id="universalGame" class="hidden">
            <h2 style="color: #333; margin-bottom: 15px;" id="universalGameTitle">æ¸¸æˆ</h2>
            <div id="universalGameContent"
                style="min-height: 300px; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 15px;">
                <div style="text-align: center; padding: 50px; color: #999;">æ¸¸æˆåŠ è½½ä¸­...</div>
            </div>
            <p class="math-score" id="universalGameScore">å¾—åˆ†ï¼š0</p>
            <div class="timer-controls" id="universalGameControls">
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            </div>
        </div>
    </div>

    <script>
        let gameState = 'idle';
        let startTime = 0;
        let timeoutId = null;

        let timerState = 'stopped';
        let timerStartTime = 0;
        let timerElapsed = 0;
        let timerIntervalId = null;
        let timerType = 'millisecond';

        let mathScore = 0;
        let mathTotal = 0;
        let currentAnswer = 0;
        let acceptableAnswers = [];

        function startGame(event) {
            if (event) {
                event.stopPropagation();
            }
            gameState = 'waiting';
            hideAllScreens();
            document.getElementById('waitingScreen').classList.remove('hidden');
            document.body.className = 'color-waiting';
            document.getElementById('gameContainer').style.display = 'none';

            const waitTime = Math.random() * 7000 + 3000;

            timeoutId = setTimeout(() => {
                gameState = 'ready';
                document.getElementById('waitingScreen').classList.add('hidden');
                document.getElementById('clickScreen').classList.remove('hidden');
                document.body.className = 'color-ready';
                startTime = Date.now();
            }, waitTime);
        }

        function handleClick() {
            if (gameState === 'timer' || gameState === 'math') {
                return;
            }
            if (gameState === 'waiting') {
                clearTimeout(timeoutId);
                gameState = 'tooEarly';
                showTooEarly();
            } else if (gameState === 'ready') {
                const reactionTime = Date.now() - startTime;
                gameState = 'result';
                showResult(reactionTime);
            }
        }

        function showTooEarly() {
            hideAllScreens();
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('tooEarlyScreen').classList.remove('hidden');
            document.body.className = 'color-default';
        }

        function showResult(time) {
            hideAllScreens();
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('resultScreen').classList.remove('hidden');
            document.getElementById('resultTime').textContent = time + ' æ¯«ç§’';
            document.body.className = 'color-default';

            let rating = '';
            if (time < 200) {
                rating = 'ğŸš€ å¤ªå‰å®³äº†ï¼é—ªç”µèˆ¬çš„é€Ÿåº¦ï¼';
            } else if (time < 300) {
                rating = 'ğŸ”¥ éå¸¸æ£’ï¼ååº”å¾ˆå¿«ï¼';
            } else if (time < 400) {
                rating = 'ğŸ‘ ä¸é”™å“¦ï¼ååº”åŠ›å¾ˆå¥½ï¼';
            } else if (time < 500) {
                rating = 'ğŸ˜Š è¿˜ä¸é”™ï¼ç»§ç»­åŠ æ²¹ï¼';
            } else {
                rating = 'ğŸŒ æ…¢æ…¢æ¥...æˆ–è€…å¿«ä¸€ç‚¹ï¼Ÿ';
            }
            document.getElementById('resultRating').textContent = rating;
        }

        function restartGame(event) {
            if (event) {
                event.stopPropagation();
            }
            gameState = 'idle';
            hideAllScreens();
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('startScreen').classList.remove('hidden');
            document.body.className = 'color-default';
        }

        function hideAllScreens() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('clickScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('tooEarlyScreen').classList.add('hidden');
            document.getElementById('timerScreen').classList.add('hidden');
            document.getElementById('mathScreen').classList.add('hidden');
            document.getElementById('toastScreen').classList.add('hidden');
            document.getElementById('simpleGame').classList.add('hidden');
            document.getElementById('restaurantGame').classList.add('hidden');
        }

        function showTimer(event, type) {
            if (event) {
                event.stopPropagation();
            }
            timerType = type;

            const timerConfig = {
                'second': { title: 'â±ï¸ ç§’è®¡æ—¶å™¨', unit: 'ç§’' },
                'millisecond': { title: 'â±ï¸ æ¯«ç§’è®¡æ—¶å™¨', unit: 'æ¯«ç§’' },
                'microsecond': { title: 'â±ï¸ å¾®ç§’è®¡æ—¶å™¨', unit: 'å¾®ç§’' },
                'nanosecond': { title: 'â±ï¸ çº³ç§’è®¡æ—¶å™¨', unit: 'çº³ç§’' },
                'picosecond': { title: 'â±ï¸ çš®ç§’è®¡æ—¶å™¨', unit: 'çš®ç§’' }
            };

            const config = timerConfig[type];
            document.getElementById('timerTitle').textContent = config.title;
            document.getElementById('timerUnit').textContent = config.unit;

            hideAllScreens();
            document.getElementById('timerScreen').classList.remove('hidden');
            gameState = 'timer';
        }

        function startTimer(event) {
            if (event) {
                event.stopPropagation();
            }
            if (timerState === 'stopped' || timerState === 'paused') {
                timerState = 'running';
                timerStartTime = performance.now() - timerElapsed;
                timerIntervalId = setInterval(updateTimer, 1);
                document.getElementById('startTimerBtn').textContent = 'è¿è¡Œä¸­...';
                document.getElementById('startTimerBtn').disabled = true;
                document.getElementById('startTimerBtn').style.opacity = '0.6';
            }
        }

        function pauseTimer(event) {
            if (event) {
                event.stopPropagation();
            }
            if (timerState === 'running') {
                timerState = 'paused';
                clearInterval(timerIntervalId);
                timerElapsed = performance.now() - timerStartTime;
                document.getElementById('startTimerBtn').textContent = 'ç»§ç»­';
                document.getElementById('startTimerBtn').disabled = false;
                document.getElementById('startTimerBtn').style.opacity = '1';
            }
        }

        function resetTimer(event) {
            if (event) {
                event.stopPropagation();
            }
            timerState = 'stopped';
            clearInterval(timerIntervalId);
            timerElapsed = 0;
            timerStartTime = 0;
            document.getElementById('timerDisplay').textContent = '0';
            document.getElementById('startTimerBtn').textContent = 'å¼€å§‹';
            document.getElementById('startTimerBtn').disabled = false;
            document.getElementById('startTimerBtn').style.opacity = '1';
        }

        function updateTimer() {
            const currentTimeMs = performance.now() - timerStartTime;
            let displayValue = 0;

            switch (timerType) {
                case 'second':
                    displayValue = Math.floor(currentTimeMs / 1000);
                    break;
                case 'millisecond':
                    displayValue = Math.floor(currentTimeMs);
                    break;
                case 'microsecond':
                    displayValue = Math.floor(currentTimeMs * 1000);
                    break;
                case 'nanosecond':
                    displayValue = Math.floor(currentTimeMs * 1000000);
                    break;
                case 'picosecond':
                    displayValue = Math.floor(currentTimeMs * 1000000000);
                    break;
            }

            document.getElementById('timerDisplay').textContent = displayValue.toLocaleString('zh-CN');
        }

        function backToMenu(event) {
            if (event) {
                event.stopPropagation();
            }
            timerState = 'stopped';
            clearInterval(timerIntervalId);
            timerElapsed = 0;
            timerStartTime = 0;
            document.getElementById('timerDisplay').textContent = '0';
            document.getElementById('startTimerBtn').textContent = 'å¼€å§‹';
            document.getElementById('startTimerBtn').disabled = false;
            document.getElementById('startTimerBtn').style.opacity = '1';

            mathScore = 0;
            mathTotal = 0;
            document.getElementById('mathFeedback').textContent = '';

            gameState = 'idle';
            hideAllScreens();
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('startScreen').classList.remove('hidden');
            document.body.className = 'color-default';
        }

        function showMath(event) {
            if (event) {
                event.stopPropagation();
            }
            mathScore = 0;
            mathTotal = 0;
            hideAllScreens();
            document.getElementById('mathScreen').classList.remove('hidden');
            gameState = 'math';
            generateQuestion();
        }

        function generateQuestion() {
            // Reset answer first to avoid using old value
            currentAnswer = 0;
            acceptableAnswers = [];

            const probTypes = ['coin', 'dice', 'ball'];
            const probType = probTypes[Math.floor(Math.random() * probTypes.length)];

            let questionText;
            let newAnswer;

            if (probType === 'coin') {
                questionText = 'æŠ›ç¡¬å¸ï¼Œæ­£é¢æœä¸Šçš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Ÿ(è¾“å…¥0-100çš„æ•´æ•°)';
                newAnswer = 50;
                acceptableAnswers = [50];
            } else if (probType === 'dice') {
                const target = Math.floor(Math.random() * 6) + 1;
                questionText = `æ·éª°å­ï¼Œå‡ºç°${target}çš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Ÿ(è¾“å…¥0-100çš„æ•´æ•°ï¼Œ16æˆ–17éƒ½å¯¹)`;
                newAnswer = 17;
                acceptableAnswers = [16, 17];
            } else {
                const total = Math.floor(Math.random() * 4) + 4;
                const red = Math.floor(Math.random() * (total - 1)) + 1;
                const exactProb = (red / total) * 100;
                const prob = Math.round(exactProb);
                questionText = `è¢‹å­é‡Œæœ‰${total}ä¸ªçƒï¼Œã€å…¶ä¸­æœ‰${red}ä¸ªçº¢çƒã€‘ï¼ŒæŠ½åˆ°çº¢çƒçš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Ÿ(${red}Ã·${total}Ã—100ï¼Œè¾“å…¥0-100çš„æ•´æ•°)`;
                newAnswer = prob;

                // Accept both floor and ceil values for rounding edge cases
                const probFloor = Math.floor(exactProb);
                const probCeil = Math.ceil(exactProb);
                if (probFloor === probCeil) {
                    acceptableAnswers = [prob];
                } else {
                    acceptableAnswers = [probFloor, probCeil];
                }
            }

            // Update UI first
            document.getElementById('mathQuestion').textContent = questionText;
            document.getElementById('mathInput').value = '';
            document.getElementById('mathFeedback').textContent = '';

            // Then update answer to ensure it's synchronized
            currentAnswer = newAnswer;

            document.getElementById('mathInput').focus();
        }

        function submitAnswer(event) {
            if (event) {
                event.stopPropagation();
            }

            const userAnswer = parseInt(document.getElementById('mathInput').value);
            const feedback = document.getElementById('mathFeedback');

            if (isNaN(userAnswer)) {
                feedback.textContent = 'è¯·è¾“å…¥ä¸€ä¸ªæ•°å­—ï¼';
                feedback.className = 'math-feedback incorrect';
                return;
            }

            mathTotal++;

            if (acceptableAnswers.includes(userAnswer)) {
                mathScore++;
                feedback.textContent = 'âœ“ æ­£ç¡®ï¼';
                feedback.className = 'math-feedback correct';
            } else {
                let answerText;
                if (acceptableAnswers.length > 1) {
                    answerText = acceptableAnswers.join(' æˆ– ');
                } else {
                    answerText = currentAnswer;
                }
                feedback.textContent = `âœ— é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${answerText}ï¼ˆä½ çš„ç­”æ¡ˆï¼š${userAnswer}ï¼‰`;
                feedback.className = 'math-feedback incorrect';
            }

            document.getElementById('mathScore').textContent = `å¾—åˆ†ï¼š${mathScore} / å·²ç­”ï¼š${mathTotal}`;

            setTimeout(() => {
                generateQuestion();
            }, 1500);
        }

        function skipQuestion(event) {
            if (event) {
                event.stopPropagation();
            }
            mathTotal++;
            document.getElementById('mathScore').textContent = `å¾—åˆ†ï¼š${mathScore} / å·²ç­”ï¼š${mathTotal}`;
            // Clear feedback before generating new question
            document.getElementById('mathFeedback').textContent = '';
            // Generate new question with new answer
            generateQuestion();
        }

        // Restaurant Game (é¤å…å¤§å¨) - çœŸå®åˆ¶ä½œç‰ˆ
        let restaurantData = {
            money: 0,
            rating: 5.0,
            orders: [],  // é¡¾å®¢è®¢å•
            oven: [],    // çƒ¤ç®±é‡Œçš„é£Ÿæ
            pan: [],     // å¹³åº•é”…é‡Œçš„é£Ÿæ
            pot: [],     // ç…®é”…é‡Œçš„é£Ÿæ
            plates: [],  // åˆ¶ä½œå°ä¸Šçš„ç›˜å­
            completed: 0,
            maxOven: 4,
            maxPan: 4,
            maxPot: 4,
            maxPlates: 4,
            maxOrders: 4,
            nextOrderId: 0,
            selectedPlate: null // å½“å‰é€‰ä¸­çš„ç›˜å­
        };

        // åŸæ–™ï¼ˆå¸¦çƒ¹é¥ªæ–¹æ³•ï¼‰
        const rawIngredients = {
            'ç”Ÿé¢åŒ…': { emoji: 'ğŸ', cooked: 'çƒ¤é¢åŒ…', cookTime: 15, tool: 'oven', toolName: 'çƒ¤ç®±' },
            'ç”Ÿè‚‰é¥¼': { emoji: 'ğŸ¥©', cooked: 'çƒ¤è‚‰é¥¼', cookTime: 25, tool: 'oven', toolName: 'çƒ¤ç®±' },
            'ç”Ÿé¸¡è›‹': { emoji: 'ğŸ¥š', cooked: 'ç‚’é¸¡è›‹', cookTime: 10, tool: 'pan', toolName: 'å¹³åº•é”…' },
            'ç”ŸåŸ¹æ ¹': { emoji: 'ğŸ¥“', cooked: 'ç†ŸåŸ¹æ ¹', cookTime: 15, tool: 'pan', toolName: 'å¹³åº•é”…' },
            'é¢é¥¼': { emoji: 'ğŸ«“', cooked: 'çƒ¤é¥¼', cookTime: 20, tool: 'oven', toolName: 'çƒ¤ç®±' },
            'ç”Ÿç±³é¥­': { emoji: 'ğŸš', cooked: 'ç†Ÿç±³é¥­', cookTime: 30, tool: 'pot', toolName: 'ç…®é”…' },
            'ç”Ÿé¢æ¡': { emoji: 'ğŸœ', cooked: 'ç†Ÿé¢æ¡', cookTime: 20, tool: 'pot', toolName: 'ç…®é”…' }
        };

        // ä¸éœ€è¦çƒ¹é¥ªçš„é…æ–™
        const readyIngredients = {
            'ç”Ÿèœ': { emoji: 'ğŸ¥¬' },
            'ç•ªèŒ„': { emoji: 'ğŸ…' },
            'å¥¶é…ª': { emoji: 'ğŸ§€' },
            'èƒ¡èåœ': { emoji: 'ğŸ¥•' },
            'è¾£æ¤’': { emoji: 'ğŸŒ¶ï¸' }
        };

        // è°ƒæ–™
        const sauces = {
            'é…±æ²¹': { emoji: 'ğŸ¥«', bonus: 0.3 },
            'èƒ¡æ¤’ç²‰': { emoji: 'ğŸŒ¶ï¸', bonus: 0.2 },
            'èœ‚èœœ': { emoji: 'ğŸ¯', bonus: 0.25 }
        };

        // èœå“é…æ–¹
        const recipes = {
            'æ±‰å ¡': {
                emoji: 'ğŸ”',
                price: 40,
                layers: ['çƒ¤é¢åŒ…', 'çƒ¤è‚‰é¥¼', 'ç”Ÿèœ', 'ç•ªèŒ„', 'çƒ¤é¢åŒ…'],
                steps: 'çƒ¤ç®±ï¼šç”Ÿé¢åŒ…â†’çƒ¤é¢åŒ…ã€ç”Ÿè‚‰é¥¼â†’çƒ¤è‚‰é¥¼ | ç›´æ¥ç”¨ï¼šç”Ÿèœã€ç•ªèŒ„',
                orderCount: [1, 2]
            },
            'ä¸‰æ˜æ²»': {
                emoji: 'ğŸ¥ª',
                price: 30,
                layers: ['çƒ¤é¢åŒ…', 'ç†ŸåŸ¹æ ¹', 'ç”Ÿèœ', 'å¥¶é…ª'],
                steps: 'çƒ¤ç®±ï¼šç”Ÿé¢åŒ…â†’çƒ¤é¢åŒ… | å¹³åº•é”…ï¼šç”ŸåŸ¹æ ¹â†’ç†ŸåŸ¹æ ¹ | ç›´æ¥ç”¨ï¼šç”Ÿèœã€å¥¶é…ª',
                orderCount: [1, 2]
            },
            'æŠ«è¨': {
                emoji: 'ğŸ•',
                price: 50,
                layers: ['çƒ¤é¥¼', 'å¥¶é…ª', 'ç•ªèŒ„', 'è¾£æ¤’'],
                steps: 'çƒ¤ç®±ï¼šé¢é¥¼â†’çƒ¤é¥¼ | ç›´æ¥ç”¨ï¼šå¥¶é…ªã€ç•ªèŒ„ã€è¾£æ¤’',
                orderCount: [1, 1]
            },
            'ç‚’é¥­': {
                emoji: 'ğŸš',
                price: 35,
                layers: ['ç†Ÿç±³é¥­', 'ç‚’é¸¡è›‹', 'èƒ¡èåœ'],
                steps: 'ç…®é”…ï¼šç”Ÿç±³é¥­â†’ç†Ÿç±³é¥­ | å¹³åº•é”…ï¼šç”Ÿé¸¡è›‹â†’ç‚’é¸¡è›‹ | ç›´æ¥ç”¨ï¼šèƒ¡èåœ',
                orderCount: [1, 2]
            },
            'é¢æ¡': {
                emoji: 'ğŸœ',
                price: 30,
                layers: ['ç†Ÿé¢æ¡', 'ç•ªèŒ„', 'ç‚’é¸¡è›‹'],
                steps: 'ç…®é”…ï¼šç”Ÿé¢æ¡â†’ç†Ÿé¢æ¡ | å¹³åº•é”…ï¼šç”Ÿé¸¡è›‹â†’ç‚’é¸¡è›‹ | ç›´æ¥ç”¨ï¼šç•ªèŒ„',
                orderCount: [1, 2]
            }
        };

        function showRestaurantGame(event) {
            if (event) event.stopPropagation();
            hideAllScreens();
            document.getElementById('restaurantGame').classList.remove('hidden');
            gameState = 'restaurant';
            initRestaurant();
        }

        function initRestaurant() {
            restaurantData = {
                money: 0,
                rating: 5.0,
                orders: [],
                oven: [],
                pan: [],
                pot: [],
                plates: [],
                completed: 0,
                maxOven: 4,
                maxPan: 4,
                maxPot: 4,
                maxPlates: 4,
                maxOrders: 4,
                nextOrderId: 0,
                selectedPlate: null
            };

            // åˆ›å»ºèœè°±æŒ‰é’®
            const recipeButtons = document.getElementById('recipeButtons');
            recipeButtons.innerHTML = '';
            Object.keys(recipes).forEach(dishName => {
                const recipe = recipes[dishName];
                const btn = document.createElement('button');
                btn.className = 'btn btn-timer';
                btn.style.cssText = 'padding: 6px; font-size: 0.85em;';
                btn.innerHTML = `${recipe.emoji}<br><small>${dishName}</small>`;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    showRecipe(dishName);
                };
                recipeButtons.appendChild(btn);
            });

            // åˆ›å»ºåŸæ–™æŒ‰é’®
            const ingredientsArea = document.getElementById('ingredientsArea');
            ingredientsArea.innerHTML = '';

            // ç”Ÿçš„åŸæ–™
            Object.keys(rawIngredients).forEach(name => {
                const ing = rawIngredients[name];
                const btn = document.createElement('button');
                btn.className = 'btn btn-timer';
                btn.style.cssText = 'padding: 6px; font-size: 0.85em;';
                btn.innerHTML = `${ing.emoji}<br><small>${name}</small>`;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    putInTool(name);
                };
                ingredientsArea.appendChild(btn);
            });

            // ç†Ÿçš„é…æ–™
            Object.keys(readyIngredients).forEach(name => {
                const ing = readyIngredients[name];
                const btn = document.createElement('button');
                btn.className = 'btn btn-timer';
                btn.style.cssText = 'padding: 6px; font-size: 0.85em;';
                btn.innerHTML = `${ing.emoji}<br><small>${name}</small>`;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    addToPlate(name, ing.emoji);
                };
                ingredientsArea.appendChild(btn);
            });

            // è°ƒæ–™
            Object.keys(sauces).forEach(name => {
                const sauce = sauces[name];
                const btn = document.createElement('button');
                btn.className = 'btn btn-start';
                btn.style.cssText = 'padding: 6px; font-size: 0.85em;';
                btn.innerHTML = `${sauce.emoji}<br><small>${name}</small>`;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    addSauceToPlate(name);
                };
                ingredientsArea.appendChild(btn);
            });

            document.getElementById('recipeDetail').innerHTML = '<div style="color: #999;">ç‚¹å‡»èœè°±æŸ¥çœ‹é…æ–¹</div>';
            updateRestaurantUI();
            startOrderGeneration();
        }

        function showRecipe(dishName) {
            const recipe = recipes[dishName];
            const layersText = recipe.layers.join('ã€');
            document.getElementById('recipeDetail').innerHTML = `
                <strong>${recipe.emoji} ${dishName}</strong> (${recipe.price}å…ƒ)<br>
                <span style="color: #666;">éœ€è¦é£Ÿæï¼š${layersText}</span><br>
                <span style="color: #009688; font-size: 0.9em;">${recipe.steps}</span>
            `;
        }

        let orderGenerationInterval = null;
        function startOrderGeneration() {
            if (orderGenerationInterval) clearInterval(orderGenerationInterval);
            generateNewOrder();
            orderGenerationInterval = setInterval(() => {
                if (restaurantData.orders.length < restaurantData.maxOrders) {
                    generateNewOrder();
                }
            }, 10000); // æ¯10ç§’å°è¯•ç”Ÿæˆ
        }

        function generateNewOrder() {
            if (restaurantData.orders.length >= restaurantData.maxOrders) return;

            const dishNames = Object.keys(recipes);
            const dishName = dishNames[Math.floor(Math.random() * dishNames.length)];
            const recipe = recipes[dishName];

            // é¡¾å®¢å¯èƒ½ç‚¹å¤šä¸ª
            const countRange = recipe.orderCount;
            const count = Math.floor(Math.random() * (countRange[1] - countRange[0] + 1)) + countRange[0];

            const order = {
                id: restaurantData.nextOrderId++,
                dishName: dishName,
                recipe: recipe,
                count: count,
                waitTime: 120,
                originalWait: 120
            };

            restaurantData.orders.push(order);

            order.timer = setInterval(() => {
                order.waitTime--;
                if (order.waitTime <= 0) {
                    clearInterval(order.timer);
                    removeOrder(order.id, true);
                }
                updateRestaurantUI();
            }, 1000);

            updateRestaurantUI();
        }

        function removeOrder(orderId, timeout = false) {
            const index = restaurantData.orders.findIndex(o => o.id === orderId);
            if (index === -1) return;

            const order = restaurantData.orders[index];
            if (order.timer) clearInterval(order.timer);

            if (timeout) {
                restaurantData.rating = Math.max(1, restaurantData.rating - 0.5);
            }

            restaurantData.orders.splice(index, 1);
            updateRestaurantUI();
        }

        function putInTool(ingredientName) {
            const ing = rawIngredients[ingredientName];
            const tool = ing.tool;

            // æ£€æŸ¥å¯¹åº”å·¥å…·æ˜¯å¦æ»¡äº†
            if (tool === 'oven' && restaurantData.oven.length >= restaurantData.maxOven) {
                alert('çƒ¤ç®±æ»¡äº†ï¼');
                return;
            }
            if (tool === 'pan' && restaurantData.pan.length >= restaurantData.maxPan) {
                alert('å¹³åº•é”…æ»¡äº†ï¼');
                return;
            }
            if (tool === 'pot' && restaurantData.pot.length >= restaurantData.maxPot) {
                alert('ç…®é”…æ»¡äº†ï¼');
                return;
            }

            const item = {
                id: Date.now() + Math.random(),
                rawName: ingredientName,
                cookedName: ing.cooked,
                emoji: ing.emoji,
                timeLeft: ing.cookTime,
                originalTime: ing.cookTime
            };

            restaurantData[tool].push(item);

            item.timer = setInterval(() => {
                item.timeLeft--;
                if (item.timeLeft <= 0) {
                    clearInterval(item.timer);
                }
                updateRestaurantUI();
            }, 1000);

            updateRestaurantUI();
        }

        function takeFromTool(tool, itemId) {
            const index = restaurantData[tool].findIndex(i => i.id === itemId);
            if (index === -1) return;

            const item = restaurantData[tool][index];
            if (item.timeLeft > 0) {
                alert('è¿˜æ²¡åšå¥½ï¼');
                return;
            }

            clearInterval(item.timer);
            const cookedName = item.cookedName;
            const emoji = item.emoji;
            restaurantData[tool].splice(index, 1);

            // ç›´æ¥æ·»åŠ åˆ°é€‰ä¸­çš„ç›˜å­
            addToPlate(cookedName, emoji);
            updateRestaurantUI();
        }

        function createNewPlate(event) {
            if (event) event.stopPropagation();

            if (restaurantData.plates.length >= restaurantData.maxPlates) {
                alert('ç›˜å­æ»¡äº†ï¼');
                return;
            }

            const plate = {
                id: Date.now(),
                layers: [],
                sauces: []
            };

            restaurantData.plates.push(plate);
            restaurantData.selectedPlate = plate.id;
            updateRestaurantUI();
        }

        function selectPlate(plateId) {
            restaurantData.selectedPlate = plateId;
            updateRestaurantUI();
        }

        function addToPlate(ingredientName, emoji) {
            if (!restaurantData.selectedPlate) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç›˜å­ï¼æˆ–ç‚¹å‡»"æ–°å»ºç›˜å­"');
                return;
            }

            const plate = restaurantData.plates.find(p => p.id === restaurantData.selectedPlate);
            if (!plate) return;

            plate.layers.push({ name: ingredientName, emoji: emoji });
            updateRestaurantUI();
        }

        function addSauceToPlate(sauceName) {
            if (!restaurantData.selectedPlate) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç›˜å­ï¼');
                return;
            }

            const plate = restaurantData.plates.find(p => p.id === restaurantData.selectedPlate);
            if (!plate) return;

            if (!plate.sauces.includes(sauceName)) {
                plate.sauces.push(sauceName);
                updateRestaurantUI();
            }
        }

        function arraysEqualIgnoreOrder(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;

            const sorted1 = [...arr1].sort();
            const sorted2 = [...arr2].sort();

            for (let i = 0; i < sorted1.length; i++) {
                if (sorted1[i] !== sorted2[i]) return false;
            }
            return true;
        }

        function deletePlate(plateId) {
            const index = restaurantData.plates.findIndex(p => p.id === plateId);
            if (index === -1) return;

            restaurantData.plates.splice(index, 1);
            if (restaurantData.selectedPlate === plateId) {
                restaurantData.selectedPlate = null;
            }
            updateRestaurantUI();
        }

        function servePlate(plateId) {
            const plateIndex = restaurantData.plates.findIndex(p => p.id === plateId);
            if (plateIndex === -1) return;

            const plate = restaurantData.plates[plateIndex];

            if (plate.layers.length === 0) {
                alert('ç›˜å­æ˜¯ç©ºçš„ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦åŒ¹é…æŸä¸ªèœè°±ï¼ˆä¸è¦æ±‚é¡ºåºï¼‰
            const plateLayers = plate.layers.map(l => l.name);
            let matchedDish = null;

            // è°ƒè¯•ä¿¡æ¯
            console.log('ç›˜å­é‡Œçš„é£Ÿæï¼š', plateLayers);

            for (const dishName in recipes) {
                const recipe = recipes[dishName];
                const recipeLayers = recipe.layers;

                console.log(`æ£€æŸ¥ ${dishName}:`, recipeLayers);
                console.log('æ˜¯å¦åŒ¹é…:', arraysEqualIgnoreOrder(plateLayers, recipeLayers));

                if (arraysEqualIgnoreOrder(plateLayers, recipeLayers)) {
                    matchedDish = { name: dishName, recipe: recipe };
                    break;
                }
            }

            if (!matchedDish) {
                const plateText = plateLayers.join('ã€');
                alert(`è¿™ä¸æ˜¯ä»»ä½•èœå“...\nç›˜å­é‡Œæœ‰ï¼š${plateText}\n\nè¯·æŸ¥çœ‹èœè°±ï¼`);
                restaurantData.plates.splice(plateIndex, 1);
                if (restaurantData.selectedPlate === plateId) {
                    restaurantData.selectedPlate = null;
                }
                updateRestaurantUI();
                return;
            }

            // æŸ¥æ‰¾è®¢å•
            const orderIndex = restaurantData.orders.findIndex(o => o.dishName === matchedDish.name);

            if (orderIndex !== -1) {
                const order = restaurantData.orders[orderIndex];

                let earned = matchedDish.recipe.price;
                plate.sauces.forEach(sauceName => {
                    earned += Math.floor(matchedDish.recipe.price * sauces[sauceName].bonus);
                });

                const timeRatio = order.waitTime / order.originalWait;
                if (timeRatio > 0.7) earned += 15;

                restaurantData.money += earned;
                restaurantData.completed++;
                if (restaurantData.rating < 5) {
                    restaurantData.rating = Math.min(5, restaurantData.rating + 0.1);
                }

                order.count--;
                if (order.count <= 0) {
                    clearInterval(order.timer);
                    restaurantData.orders.splice(orderIndex, 1);
                }

                alert(`ä¸ŠèœæˆåŠŸï¼${matchedDish.recipe.emoji} ${matchedDish.name} +${earned}å…ƒ`);
            } else {
                restaurantData.rating = Math.max(1, restaurantData.rating - 0.2);
                const earned = Math.floor(matchedDish.recipe.price * 0.3);
                restaurantData.money += earned;
                alert(`æ²¡äººç‚¹è¿™ä¸ª...åªå–äº†${earned}å…ƒ`);
            }

            restaurantData.plates.splice(plateIndex, 1);
            if (restaurantData.selectedPlate === plateId) {
                restaurantData.selectedPlate = null;
            }
            updateRestaurantUI();
        }

        function updateRestaurantUI() {
            // è®¢å•
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '';
            restaurantData.orders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.style.cssText = 'background: white; padding: 6px; border-radius: 5px; border: 2px solid #ffc107;';
                orderDiv.innerHTML = `
                    <div style="font-size: 1.1em;">${order.recipe.emoji} ${order.dishName} x${order.count}</div>
                    <div style="color: ${order.waitTime < 30 ? '#dc3545' : '#666'}; font-size: 0.8em; margin-top: 2px;">
                        â° ${order.waitTime}ç§’
                    </div>
                `;
                ordersList.appendChild(orderDiv);
            });

            if (restaurantData.orders.length === 0) {
                ordersList.innerHTML = '<div style="color: #999; text-align: center; padding: 8px;">æš‚æ— è®¢å•</div>';
            }

            // çƒ¤ç®±
            const ovenArea = document.getElementById('ovenArea');
            document.getElementById('ovenCount').textContent = `${restaurantData.oven.length}/${restaurantData.maxOven}`;
            ovenArea.innerHTML = '';
            restaurantData.oven.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = `background: ${item.timeLeft === 0 ? '#90EE90' : '#FFA500'}; padding: 5px; border-radius: 5px; cursor: pointer; text-align: center;`;
                itemDiv.innerHTML = `
                    <div style="font-size: 1.3em;">${item.emoji}</div>
                    <div style="font-size: 0.7em; margin-top: 2px;">${item.timeLeft === 0 ? 'âœ“å¥½äº†' : item.timeLeft + 's'}</div>
                `;
                itemDiv.onclick = () => takeFromTool('oven', item.id);
                ovenArea.appendChild(itemDiv);
            });
            if (restaurantData.oven.length === 0) {
                ovenArea.innerHTML = '<div style="color: #999; font-size: 0.75em; text-align: center; padding: 8px; grid-column: 1/-1;">ç©º</div>';
            }

            // å¹³åº•é”…
            const panArea = document.getElementById('panArea');
            document.getElementById('panCount').textContent = `${restaurantData.pan.length}/${restaurantData.maxPan}`;
            panArea.innerHTML = '';
            restaurantData.pan.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = `background: ${item.timeLeft === 0 ? '#90EE90' : '#FFA500'}; padding: 5px; border-radius: 5px; cursor: pointer; text-align: center;`;
                itemDiv.innerHTML = `
                    <div style="font-size: 1.3em;">${item.emoji}</div>
                    <div style="font-size: 0.7em; margin-top: 2px;">${item.timeLeft === 0 ? 'âœ“å¥½äº†' : item.timeLeft + 's'}</div>
                `;
                itemDiv.onclick = () => takeFromTool('pan', item.id);
                panArea.appendChild(itemDiv);
            });
            if (restaurantData.pan.length === 0) {
                panArea.innerHTML = '<div style="color: #999; font-size: 0.75em; text-align: center; padding: 8px; grid-column: 1/-1;">ç©º</div>';
            }

            // ç…®é”…
            const potArea = document.getElementById('potArea');
            document.getElementById('potCount').textContent = `${restaurantData.pot.length}/${restaurantData.maxPot}`;
            potArea.innerHTML = '';
            restaurantData.pot.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = `background: ${item.timeLeft === 0 ? '#90EE90' : '#FFA500'}; padding: 5px; border-radius: 5px; cursor: pointer; text-align: center;`;
                itemDiv.innerHTML = `
                    <div style="font-size: 1.3em;">${item.emoji}</div>
                    <div style="font-size: 0.7em; margin-top: 2px;">${item.timeLeft === 0 ? 'âœ“å¥½äº†' : item.timeLeft + 's'}</div>
                `;
                itemDiv.onclick = () => takeFromTool('pot', item.id);
                potArea.appendChild(itemDiv);
            });
            if (restaurantData.pot.length === 0) {
                potArea.innerHTML = '<div style="color: #999; font-size: 0.75em; text-align: center; padding: 8px; grid-column: 1/-1;">ç©º</div>';
            }

            // ç›˜å­
            const platesArea = document.getElementById('platesArea');
            document.getElementById('plateCount').textContent = `${restaurantData.plates.length}/${restaurantData.maxPlates}`;
            platesArea.innerHTML = '';
            restaurantData.plates.forEach(plate => {
                const plateDiv = document.createElement('div');
                const isSelected = plate.id === restaurantData.selectedPlate;
                plateDiv.style.cssText = `background: white; padding: 8px; border-radius: 5px; border: 3px solid ${isSelected ? '#007bff' : '#ddd'}; cursor: pointer;`;
                plateDiv.onclick = () => selectPlate(plate.id);

                const layersHTML = plate.layers.map(l => l.emoji).join(' ');
                const saucesHTML = plate.sauces.length > 0 ? `<div style="font-size: 0.75em; margin-top: 3px;">è°ƒæ–™: ${plate.sauces.join(', ')}</div>` : '';

                plateDiv.innerHTML = `
                    <div style="font-size: 1.5em; min-height: 30px;">${layersHTML || 'ç©ºç›˜'}</div>
                    ${saucesHTML}
                    <button class="btn btn-start" style="width: 100%; padding: 4px; font-size: 0.8em; margin-top: 5px;" onclick="event.stopPropagation(); servePlate(${plate.id})">ä¸Šèœ</button>
                    <button class="btn btn-restart" style="width: 100%; padding: 4px; font-size: 0.8em; margin-top: 3px;" onclick="event.stopPropagation(); deletePlate(${plate.id})">æ‰”æ‰</button>
                `;
                platesArea.appendChild(plateDiv);
            });

            if (restaurantData.plates.length === 0) {
                platesArea.innerHTML = '<div style="color: #999; text-align: center; padding: 20px; grid-column: 1/-1;">ç‚¹å‡»"æ–°å»ºç›˜å­"å¼€å§‹åˆ¶ä½œ</div>';
            }

            // åˆ†æ•°
            document.getElementById('restaurantScore').textContent =
                `ğŸ’° ${restaurantData.money}å…ƒ | â­ ${restaurantData.rating.toFixed(1)} | å®Œæˆ: ${restaurantData.completed}`;
        }

        // Toast Game (çƒ¤é¢åŒ…)
        let toastLevel = 0;
        let toastInterval = null;
        let toastStarted = false;

        let toastData = {
            breadType: null,
            hasButter: false,
            temperature: 'medium',
            toasting: false,
            level: 0,
            score: 0
        };

        function showToastGame(event) {
            if (event) event.stopPropagation();
            hideAllScreens();
            document.getElementById('toastScreen').classList.remove('hidden');
            gameState = 'toast';
            resetToast();
        }

        function resetToast() {
            toastLevel = 0;
            toastStarted = false;
            toastData = { breadType: null, hasButter: false, temperature: 'medium', toasting: false, level: 0, score: 0 };
            if (toastInterval) clearInterval(toastInterval);

            document.getElementById('toastBread').style.backgroundColor = '#FFF';
            document.getElementById('toastBread').innerHTML = '';
            document.getElementById('toastMessage').innerHTML = 'ğŸ é€‰æ‹©é¢åŒ…ç±»å‹å¼€å§‹';
            document.getElementById('toastScore').textContent = 'æ€»åˆ†ï¼š0';

            const controls = document.querySelector('#toastScreen .timer-controls');
            controls.innerHTML = `
                <button class="btn btn-timer btn-control" onclick="selectBread(event, 'ç™½é¢åŒ…', 'ğŸ')">ç™½é¢åŒ…</button>
                <button class="btn btn-timer btn-control" onclick="selectBread(event, 'å…¨éº¦é¢åŒ…', 'ğŸ¥–')">å…¨éº¦</button>
                <button class="btn btn-timer btn-control" onclick="selectBread(event, 'æ³•æ£', 'ğŸ¥–')">æ³•æ£</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function selectBread(event, type, emoji) {
            if (event) event.stopPropagation();
            toastData.breadType = type;
            document.getElementById('toastBread').textContent = emoji;
            document.getElementById('toastBread').style.backgroundColor = '#FFEFD5';
            document.getElementById('toastMessage').innerHTML = `å·²é€‰æ‹©ï¼š${type}<br>è¦æ¶‚é»„æ²¹å—ï¼Ÿ`;

            const controls = document.querySelector('#toastScreen .timer-controls');
            controls.innerHTML = `
                <button class="btn btn-start btn-control" onclick="addButter(event, true)">æ¶‚é»„æ²¹ ğŸ§ˆ</button>
                <button class="btn btn-restart btn-control" onclick="addButter(event, false)">ä¸æ¶‚</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function addButter(event, hasButter) {
            if (event) event.stopPropagation();
            toastData.hasButter = hasButter;
            if (hasButter) {
                document.getElementById('toastMessage').innerHTML = 'âœ¨ å·²æ¶‚é»„æ²¹ï¼<br>é€‰æ‹©çƒ¤åˆ¶æ¸©åº¦ï¼š';
            } else {
                document.getElementById('toastMessage').innerHTML = 'é€‰æ‹©çƒ¤åˆ¶æ¸©åº¦ï¼š';
            }

            const controls = document.querySelector('#toastScreen .timer-controls');
            controls.innerHTML = `
                <button class="btn btn-timer btn-control" onclick="setTemp(event, 'low')">ğŸ”µ ä½æ¸©</button>
                <button class="btn btn-timer btn-control" onclick="setTemp(event, 'medium')">ğŸŸ¡ ä¸­æ¸©</button>
                <button class="btn btn-timer btn-control" onclick="setTemp(event, 'high')">ğŸ”´ é«˜æ¸©</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function setTemp(event, temp) {
            if (event) event.stopPropagation();
            toastData.temperature = temp;
            const tempNames = { 'low': 'ä½æ¸©', 'medium': 'ä¸­æ¸©', 'high': 'é«˜æ¸©' };
            document.getElementById('toastMessage').innerHTML = `æ¸©åº¦ï¼š${tempNames[temp]}<br>å¼€å§‹çƒ¤åˆ¶ï¼`;

            const controls = document.querySelector('#toastScreen .timer-controls');
            controls.innerHTML = `
                <button class="btn btn-start btn-control" onclick="startToast(event)" id="toastStartBtn">å¼€å§‹çƒ¤</button>
                <button class="btn btn-restart btn-control" onclick="stopToast(event)" id="toastStopBtn" disabled>åœæ­¢ï¼</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function startToast(event) {
            if (event) event.stopPropagation();
            if (!toastData.breadType) return;

            toastStarted = true;
            toastData.toasting = true;
            toastLevel = 0;
            document.getElementById('toastStartBtn').disabled = true;
            document.getElementById('toastStopBtn').disabled = false;
            document.getElementById('toastMessage').textContent = 'é¢åŒ…æ­£åœ¨çƒ¤...å¿«ç‚¹åœæ­¢ï¼';

            const speeds = { 'low': 150, 'medium': 100, 'high': 60 };
            const speed = speeds[toastData.temperature];

            toastInterval = setInterval(() => {
                toastLevel += 1;
                toastData.level = toastLevel;
                let color = `hsl(${40 - toastLevel * 2}, 70%, ${70 - toastLevel}%)`;
                document.getElementById('toastBread').style.backgroundColor = color;

                if (toastLevel >= 50) {
                    clearInterval(toastInterval);
                    document.getElementById('toastMessage').textContent = 'çƒ¤ç„¦äº†ï¼ğŸ˜­';
                    document.getElementById('toastStopBtn').disabled = true;
                    setTimeout(() => nextRound(), 2000);
                }
            }, speed);
        }

        function stopToast(event) {
            if (event) event.stopPropagation();
            if (!toastStarted) return;
            clearInterval(toastInterval);
            document.getElementById('toastStopBtn').disabled = true;
            toastData.toasting = false;

            let score = 0;
            let message = '';

            const perfectRange = toastData.temperature === 'medium' ? [10, 20] :
                toastData.temperature === 'low' ? [15, 25] : [8, 15];

            if (toastLevel < perfectRange[0]) {
                message = 'å¤ªç”Ÿäº†ï¼ğŸ¤¢';
                score = toastLevel * 3;
            } else if (toastLevel >= perfectRange[0] && toastLevel <= perfectRange[1]) {
                message = 'å®Œç¾ï¼ğŸ‘';
                score = 100;
                if (toastData.hasButter) score += 20;
            } else if (toastLevel <= 35) {
                message = 'æœ‰ç‚¹ç„¦äº† ğŸ˜…';
                score = Math.max(0, 100 - (toastLevel - perfectRange[1]) * 4);
            } else {
                message = 'çƒ¤å¾—å¤ªè¿‡äº†ï¼ğŸ˜µ';
                score = Math.max(0, 30 - (toastLevel - 35) * 2);
            }

            toastData.score += score;
            document.getElementById('toastMessage').innerHTML = `${message}<br>æœ¬è½®å¾—åˆ†ï¼š${score}`;
            document.getElementById('toastScore').textContent = `æ€»åˆ†ï¼š${toastData.score}`;

            const controls = document.querySelector('#toastScreen .timer-controls');
            controls.innerHTML = `
                <button class="btn btn-timer btn-control" onclick="addJam(event)">æ¶‚æœé…± ğŸ“</button>
                <button class="btn btn-start btn-control" onclick="makeSandwich(event)">åšä¸‰æ˜æ²» ğŸ¥ª</button>
                <button class="btn btn-restart btn-control" onclick="nextRound(event)">ä¸‹ä¸€è½®</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function addJam(event) {
            if (event) event.stopPropagation();
            toastData.score += 15;
            document.getElementById('toastMessage').innerHTML = 'âœ¨ æ¶‚ä¸Šæœé…±ï¼+15åˆ†';
            document.getElementById('toastScore').textContent = `æ€»åˆ†ï¼š${toastData.score}`;
            setTimeout(() => nextRound(), 1500);
        }

        function makeSandwich(event) {
            if (event) event.stopPropagation();
            toastData.score += 30;
            document.getElementById('toastMessage').innerHTML = 'ğŸ¥ª åšæˆä¸‰æ˜æ²»ï¼+30åˆ†';
            document.getElementById('toastScore').textContent = `æ€»åˆ†ï¼š${toastData.score}`;
            setTimeout(() => nextRound(), 1500);
        }

        function nextRound(event) {
            if (event) event.stopPropagation();
            document.getElementById('toastMessage').innerHTML = `æ€»åˆ†ï¼š${toastData.score}<br>ç»§ç»­ä¸‹ä¸€è½®ï¼Ÿ`;
            const controls = document.querySelector('#toastScreen .timer-controls');
            controls.innerHTML = `
                <button class="btn btn-start btn-control" onclick="resetToast()">ç»§ç»­</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        // Simple Games Manager
        let simpleGameType = '';
        let simpleGameData = {};

        function showSimpleGame(type, title, initFunc) {
            hideAllScreens();
            document.getElementById('simpleGame').classList.remove('hidden');
            document.getElementById('simpleGameTitle').textContent = title;
            simpleGameType = type;
            gameState = type;
            initFunc();
        }

        // Noodle Game (ç…®æ³¡é¢)
        function showNoodleGame(event) {
            if (event) event.stopPropagation();
            showSimpleGame('noodle', 'ğŸœ ç…®æ³¡é¢å¤§å¸ˆ', initNoodleGame);
        }

        function initNoodleGame() {
            simpleGameData = { cooking: false, time: 0, interval: null, ingredients: [], score: 0 };
            document.getElementById('simpleGameContent').innerHTML = `
                <div style="font-size: 2em; margin: 20px 0;">é€‰æ‹©æ³¡é¢ç±»å‹</div>
                <div id="noodleDisplay" style="font-size: 5em; margin: 20px 0;">ğŸœ</div>
            `;
            document.getElementById('simpleGameScore').textContent = 'å¾—åˆ†ï¼š0';
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-timer btn-control" onclick="selectNoodleType(event, 'æ–¹ä¾¿é¢', 180)">æ–¹ä¾¿é¢(3åˆ†)</button>
                <button class="btn btn-timer btn-control" onclick="selectNoodleType(event, 'æ‹‰é¢', 240)">æ‹‰é¢(4åˆ†)</button>
                <button class="btn btn-timer btn-control" onclick="selectNoodleType(event, 'ä¹Œå†¬é¢', 300)">ä¹Œå†¬é¢(5åˆ†)</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function selectNoodleType(event, type, seconds) {
            if (event) event.stopPropagation();
            simpleGameData.noodleType = type;
            simpleGameData.cookTime = seconds;

            document.getElementById('simpleGameContent').innerHTML = `
                <div style="font-size: 1.5em; margin: 10px 0;">é€‰æ‹©ï¼š${type}</div>
                <div id="noodleDisplay" style="font-size: 4em; margin: 20px 0;">ğŸœ</div>
                <div style="font-size: 1.2em;">é€‰æ‹©è°ƒæ–™ï¼š</div>
                <div id="ingredientsList" style="margin: 10px 0; min-height: 40px; font-size: 2em;"></div>
            `;
            document.getElementById('simpleGameScore').textContent = 'é€‰æ‹©è°ƒæ–™å¢åŠ åˆ†æ•°ï¼';
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-timer btn-control" onclick="addNoodleIngredient(event, 'ğŸ¥š', 10)">åŠ è›‹</button>
                <button class="btn btn-timer btn-control" onclick="addNoodleIngredient(event, 'ğŸ¥¬', 10)">é’èœ</button>
                <button class="btn btn-timer btn-control" onclick="addNoodleIngredient(event, 'ğŸ¥“', 15)">åŸ¹æ ¹</button>
                <button class="btn btn-timer btn-control" onclick="addNoodleIngredient(event, 'ğŸŒ¶ï¸', 5)">è¾£æ¤’</button>
                <button class="btn btn-start btn-control" onclick="startCookingNoodle(event)">å¼€å§‹ç…®ï¼</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function addNoodleIngredient(event, ingredient, points) {
            if (event) event.stopPropagation();
            simpleGameData.ingredients.push({ item: ingredient, points: points });
            document.getElementById('ingredientsList').textContent =
                simpleGameData.ingredients.map(i => i.item).join(' ');
        }

        function startCookingNoodle(event) {
            if (event) event.stopPropagation();
            if (simpleGameData.cooking) return;

            simpleGameData.cooking = true;
            simpleGameData.time = simpleGameData.cookTime;

            document.getElementById('simpleGameContent').innerHTML = `
                <div style="font-size: 1.5em; margin: 10px 0;">${simpleGameData.noodleType}çƒ¹é¥ªä¸­...</div>
                <div id="noodleDisplay" style="font-size: 5em; margin: 20px 0; animation: shake 0.5s infinite;">ğŸ²</div>
                <div id="noodleTime" style="font-size: 3em; color: #667eea;">--:--</div>
                <style>
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        25% { transform: translateX(-5px); }
                        75% { transform: translateX(5px); }
                    }
                </style>
            `;
            document.getElementById('simpleGameScore').textContent = 'æ³¨æ„æ—¶é—´ï¼';
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-restart btn-control" onclick="finishNoodle(event)">å®Œæˆï¼</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;

            simpleGameData.interval = setInterval(() => {
                simpleGameData.time--;
                let min = Math.floor(simpleGameData.time / 60);
                let sec = simpleGameData.time % 60;
                document.getElementById('noodleTime').textContent =
                    `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;

                if (simpleGameData.time <= 0) {
                    clearInterval(simpleGameData.interval);
                    document.getElementById('noodleTime').style.color = '#e74c3c';
                    document.getElementById('simpleGameScore').textContent = 'âŒ ç…®è¿‡å¤´äº†ï¼æ³¡é¢ç³Šäº†ï¼';
                    setTimeout(() => initNoodleGame(), 3000);
                }
            }, 1000);
        }

        function finishNoodle(event) {
            if (event) event.stopPropagation();
            clearInterval(simpleGameData.interval);
            simpleGameData.cooking = false;

            const timeLeft = simpleGameData.time;
            const totalTime = simpleGameData.cookTime;
            const timeScore = timeLeft > 10 ? 50 : Math.max(0, timeLeft * 5);
            const ingredientScore = simpleGameData.ingredients.reduce((sum, i) => sum + i.points, 0);
            const totalScore = timeScore + ingredientScore;
            simpleGameData.score += totalScore;

            document.getElementById('noodleDisplay').textContent = 'ğŸœâœ¨';
            document.getElementById('noodleDisplay').style.animation = 'none';
            document.getElementById('noodleTime').style.color = '#2ecc71';
            document.getElementById('simpleGameScore').textContent =
                `âœ¨ å®Œæˆï¼æœ¬è½®+${totalScore}åˆ† | æ€»åˆ†ï¼š${simpleGameData.score}`;

            setTimeout(() => initNoodleGame(), 3000);
        }

        // Claw Game (æŠ“å¨ƒå¨ƒ)
        function showClawGame(event) {
            if (event) event.stopPropagation();
            showSimpleGame('claw', 'ğŸª æŠ“å¨ƒå¨ƒæœº', initClawGame);
        }

        function initClawGame() {
            simpleGameData = { score: 0, attempts: 10, clawPosition: 50, grabbing: false };
            document.getElementById('simpleGameContent').innerHTML = `
                <div style="position: relative; width: 400px; height: 350px; margin: 0 auto; border: 3px solid #8B4513; border-radius: 10px; background: linear-gradient(to bottom, #87CEEB 0%, #FFF8DC 100%);">
                    <div id="clawMachine" style="position: absolute; top: 0; left: 45%; transition: left 0.3s;">
                        <div style="font-size: 3em;">ğŸ¦¾</div>
                        <div style="width: 2px; height: 50px; background: #333; margin: 0 auto;" id="clawString"></div>
                    </div>
                    <div style="position: absolute; bottom: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 90%; left: 5%;">
                        <div style="font-size: 3em;">ğŸ§¸</div>
                        <div style="font-size: 3em;">ğŸ€</div>
                        <div style="font-size: 3em;">ğŸ§¸</div>
                        <div style="font-size: 3em;">ğŸ</div>
                    </div>
                </div>
            `;
            document.getElementById('simpleGameScore').textContent = `æŠ“åˆ°ï¼š${simpleGameData.score} / å‰©ä½™æ¬¡æ•°ï¼š${simpleGameData.attempts}`;
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-restart btn-control" onclick="moveClawLeft(event)">â¬…ï¸ å·¦ç§»</button>
                <button class="btn btn-start btn-control" onclick="grabClaw(event)" id="grabBtn">æŠ“å–ï¼</button>
                <button class="btn btn-restart btn-control" onclick="moveClawRight(event)">â¡ï¸ å³ç§»</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function moveClawLeft(event) {
            if (event) event.stopPropagation();
            if (simpleGameData.grabbing) return;
            simpleGameData.clawPosition = Math.max(10, simpleGameData.clawPosition - 10);
            document.getElementById('clawMachine').style.left = simpleGameData.clawPosition + '%';
        }

        function moveClawRight(event) {
            if (event) event.stopPropagation();
            if (simpleGameData.grabbing) return;
            simpleGameData.clawPosition = Math.min(80, simpleGameData.clawPosition + 10);
            document.getElementById('clawMachine').style.left = simpleGameData.clawPosition + '%';
        }

        function grabClaw(event) {
            if (event) event.stopPropagation();
            if (simpleGameData.grabbing || simpleGameData.attempts <= 0) return;

            simpleGameData.grabbing = true;
            simpleGameData.attempts--;
            document.getElementById('grabBtn').disabled = true;

            const clawString = document.getElementById('clawString');
            let height = 50;

            const descendInterval = setInterval(() => {
                height += 10;
                clawString.style.height = height + 'px';
                if (height >= 200) {
                    clearInterval(descendInterval);

                    const baseSuccess = 0.35;
                    const positionBonus = (simpleGameData.clawPosition >= 20 && simpleGameData.clawPosition <= 70) ? 0.15 : 0;
                    const success = Math.random() < (baseSuccess + positionBonus);

                    setTimeout(() => {
                        const ascendInterval = setInterval(() => {
                            height -= 10;
                            clawString.style.height = height + 'px';
                            if (height <= 50) {
                                clearInterval(ascendInterval);
                                simpleGameData.grabbing = false;
                                document.getElementById('grabBtn').disabled = false;

                                if (success) {
                                    simpleGameData.score++;
                                    document.getElementById('simpleGameScore').textContent =
                                        `âœ¨ æŠ“åˆ°äº†ï¼ å¾—åˆ†ï¼š${simpleGameData.score} / å‰©ä½™ï¼š${simpleGameData.attempts}`;
                                } else {
                                    document.getElementById('simpleGameScore').textContent =
                                        `ğŸ’” æ²¡æŠ“åˆ°... å¾—åˆ†ï¼š${simpleGameData.score} / å‰©ä½™ï¼š${simpleGameData.attempts}`;
                                }

                                if (simpleGameData.attempts <= 0) {
                                    setTimeout(() => {
                                        document.getElementById('simpleGameContent').innerHTML =
                                            `<div style="font-size: 2em; color: #667eea;">æ¸¸æˆç»“æŸï¼<br>å…±æŠ“åˆ° ${simpleGameData.score} ä¸ªå¨ƒå¨ƒï¼</div>`;
                                        document.getElementById('simpleGameControls').innerHTML = `
                                            <button class="btn btn-start btn-control" onclick="initClawGame()">å†ç©ä¸€æ¬¡</button>
                                            <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
                                        `;
                                    }, 1500);
                                }
                            }
                        }, 50);
                    }, 500);
                }
            }, 50);
        }

        // Fish Game (é’“é±¼)
        const fishTypes = [
            { emoji: 'ğŸŸ', name: 'å°é±¼', points: 10, chance: 0.5 },
            { emoji: 'ğŸ ', name: 'çƒ­å¸¦é±¼', points: 20, chance: 0.25 },
            { emoji: 'ğŸ¡', name: 'æ²³è±š', points: 30, chance: 0.15 },
            { emoji: 'ğŸ¦ˆ', name: 'é²¨é±¼', points: 50, chance: 0.08 },
            { emoji: 'ğŸ™', name: 'ç« é±¼', points: 40, chance: 0.02 }
        ];

        function showFishGame(event) {
            if (event) event.stopPropagation();
            showSimpleGame('fish', 'ğŸ£ é’“é±¼å¤§å¸ˆ', initFishGame);
        }

        function initFishGame() {
            simpleGameData = { score: 0, count: 0, fishing: false, waitTime: 0, currentFish: null, combo: 0 };
            document.getElementById('simpleGameContent').innerHTML = `<div style="font-size: 5em;">ğŸŒŠ</div>`;
            document.getElementById('simpleGameScore').textContent = `å¾—åˆ†ï¼š0 | é’“åˆ°ï¼š0æ¡ | è¿å‡»ï¼š0`;
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-start btn-control" id="fishBtn" onclick="fishAction(event)">æŠ›ç«¿</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function getFishByChance() {
            const rand = Math.random();
            let cumulative = 0;
            for (const fish of fishTypes) {
                cumulative += fish.chance;
                if (rand < cumulative) return fish;
            }
            return fishTypes[0];
        }

        function fishAction(event) {
            if (event) event.stopPropagation();
            const btn = document.getElementById('fishBtn');

            if (!simpleGameData.fishing) {
                simpleGameData.fishing = true;
                btn.textContent = 'ç­‰å¾…...';
                btn.disabled = true;
                document.getElementById('simpleGameContent').innerHTML = '<div style="font-size: 5em;">ğŸ£ ç­‰å¾…...</div>';

                const waitTime = Math.random() * 3000 + 1500;
                simpleGameData.timeout = setTimeout(() => {
                    if (simpleGameData.fishing) {
                        simpleGameData.currentFish = getFishByChance();
                        document.getElementById('simpleGameContent').innerHTML =
                            `<div style="font-size: 5em; color: #2ecc71; animation: bounce 0.5s infinite;">${simpleGameData.currentFish.emoji}</div>
                            <div style="font-size: 1.5em; margin-top: 10px;">ä¸Šé’©äº†ï¼</div>
                            <style>
                                @keyframes bounce {
                                    0%, 100% { transform: translateY(0); }
                                    50% { transform: translateY(-10px); }
                                }
                            </style>`;
                        btn.textContent = 'å¿«æ”¶ç«¿ï¼';
                        btn.disabled = false;
                        simpleGameData.waitTime = Date.now();

                        simpleGameData.escapeTimeout = setTimeout(() => {
                            if (simpleGameData.fishing) {
                                document.getElementById('simpleGameContent').innerHTML =
                                    '<div style="font-size: 3em; color: #e74c3c;">ğŸ’¨ é±¼è·‘äº†...</div>';
                                simpleGameData.fishing = false;
                                simpleGameData.combo = 0;
                                btn.textContent = 'æŠ›ç«¿';
                                updateFishScore();
                                setTimeout(() => {
                                    document.getElementById('simpleGameContent').innerHTML = '<div style="font-size: 5em;">ğŸŒŠ</div>';
                                }, 1000);
                            }
                        }, 2500);
                    }
                }, waitTime);
            } else {
                clearTimeout(simpleGameData.escapeTimeout);
                const reactionTime = Date.now() - simpleGameData.waitTime;

                if (reactionTime < 2500 && simpleGameData.currentFish) {
                    const fish = simpleGameData.currentFish;
                    simpleGameData.count++;
                    simpleGameData.combo++;
                    const comboBonus = Math.min(simpleGameData.combo - 1, 5) * 5;
                    const totalPoints = fish.points + comboBonus;
                    simpleGameData.score += totalPoints;

                    document.getElementById('simpleGameContent').innerHTML =
                        `<div style="font-size: 5em;">${fish.emoji}âœ¨</div>
                        <div style="font-size: 1.5em; color: #2ecc71;">é’“åˆ°${fish.name}ï¼+${totalPoints}åˆ†</div>
                        ${simpleGameData.combo > 1 ? `<div style="font-size: 1.2em; color: #ff6b6b;">ğŸ”¥ è¿å‡» x${simpleGameData.combo}!</div>` : ''}`;
                    updateFishScore();
                }

                simpleGameData.fishing = false;
                simpleGameData.currentFish = null;
                btn.textContent = 'æŠ›ç«¿';
                btn.disabled = false;
                setTimeout(() => {
                    document.getElementById('simpleGameContent').innerHTML = '<div style="font-size: 5em;">ğŸŒŠ</div>';
                }, 1500);
            }
        }

        function updateFishScore() {
            document.getElementById('simpleGameScore').textContent =
                `å¾—åˆ†ï¼š${simpleGameData.score} | é’“åˆ°ï¼š${simpleGameData.count}æ¡ | è¿å‡»ï¼š${simpleGameData.combo}`;
        }

        // Fruit Game (åˆ‡æ°´æœ)
        function showFruitGame(event) {
            if (event) event.stopPropagation();
            showSimpleGame('fruit', 'ğŸ‰ åˆ‡æ°´æœå¤§å¸ˆ', initFruitGame);
        }

        function initFruitGame() {
            simpleGameData = { score: 0, playing: false, interval: null, combo: 0 };
            document.getElementById('simpleGameContent').innerHTML = `<div style="font-size: 5em;" id="fruitDisplay">ğŸ</div>`;
            document.getElementById('simpleGameScore').textContent = `å¾—åˆ†ï¼š0 | è¿å‡»ï¼š0`;
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-start btn-control" onclick="startFruitGame(event)">å¼€å§‹æ¸¸æˆ</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function startFruitGame(event) {
            if (event) event.stopPropagation();
            if (simpleGameData.playing) return;

            simpleGameData.playing = true;
            simpleGameData.score = 0;
            simpleGameData.combo = 0;
            simpleGameData.lastClick = 0;
            const fruits = ['ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'â­', 'ğŸ’', 'ğŸ’£'];
            let timeLeft = 20;

            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-restart btn-control">æ—¶é—´ï¼š${timeLeft}ç§’</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;

            const countdown = setInterval(() => {
                timeLeft--;
                document.getElementById('simpleGameControls').innerHTML = `
                    <button class="btn btn-restart btn-control">æ—¶é—´ï¼š${timeLeft}ç§’</button>
                    <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
                `;
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    clearInterval(simpleGameData.interval);
                    simpleGameData.playing = false;
                    document.getElementById('fruitDisplay').innerHTML = `<div style="font-size:2em;">ç»“æŸï¼å¾—åˆ†ï¼š${simpleGameData.score}</div>`;
                    setTimeout(() => initFruitGame(), 3000);
                }
            }, 1000);

            simpleGameData.interval = setInterval(() => {
                const rand = Math.random();
                let fruit = '';
                if (rand < 0.05) fruit = 'ğŸ’';
                else if (rand < 0.1) fruit = 'â­';
                else if (rand < 0.25) fruit = 'ğŸ’£';
                else fruit = fruits[Math.floor(Math.random() * 6)];

                const display = document.getElementById('fruitDisplay');
                display.textContent = fruit;
                display.onclick = function (e) {
                    e.stopPropagation();
                    const now = Date.now();

                    if (fruit === 'ğŸ’£') {
                        simpleGameData.score = Math.max(0, simpleGameData.score - 10);
                        simpleGameData.combo = 0;
                        display.textContent = 'ğŸ’¥';
                    } else {
                        if (now - simpleGameData.lastClick < 1000) {
                            simpleGameData.combo++;
                        } else {
                            simpleGameData.combo = 1;
                        }
                        simpleGameData.lastClick = now;

                        let points = 1;
                        if (fruit === 'â­') points = 5;
                        else if (fruit === 'ğŸ’') points = 10;

                        const bonus = Math.floor(simpleGameData.combo / 3);
                        simpleGameData.score += points + bonus;
                        display.textContent = 'âœ¨';
                    }
                    document.getElementById('simpleGameScore').textContent =
                        `å¾—åˆ†ï¼š${simpleGameData.score} | è¿å‡»ï¼š${simpleGameData.combo} ${simpleGameData.combo >= 5 ? 'ğŸ”¥' : ''}`;

                    setTimeout(() => {
                        const rand2 = Math.random();
                        let newFruit = '';
                        if (rand2 < 0.05) newFruit = 'ğŸ’';
                        else if (rand2 < 0.1) newFruit = 'â­';
                        else if (rand2 < 0.25) newFruit = 'ğŸ’£';
                        else newFruit = fruits[Math.floor(Math.random() * 6)];
                        display.textContent = newFruit;
                    }, 200);
                };
            }, 800);
        }

        // RPS Game (çŒœæ‹³)
        function showRPSGame(event) {
            if (event) event.stopPropagation();
            showSimpleGame('rps', 'âœŠ çŸ³å¤´å‰ªåˆ€å¸ƒå¤§å¸ˆ', initRPSGame);
        }

        function initRPSGame() {
            simpleGameData = { wins: 0, losses: 0, ties: 0, winStreak: 0, bestStreak: 0 };
            document.getElementById('simpleGameContent').innerHTML = `<div style="font-size: 5em;">âœŠ âœ‹ âœŒï¸</div>`;
            document.getElementById('simpleGameScore').textContent = `èƒœï¼š0 / è´Ÿï¼š0 / å¹³ï¼š0 | è¿èƒœï¼š0`;
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-start btn-control" onclick="playRPS(event, 0)">âœŠçŸ³å¤´</button>
                <button class="btn btn-start btn-control" onclick="playRPS(event, 1)">âœ‹å¸ƒ</button>
                <button class="btn btn-start btn-control" onclick="playRPS(event, 2)">âœŒï¸å‰ªåˆ€</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function playRPS(event, playerChoice) {
            if (event) event.stopPropagation();
            const choices = ['âœŠ', 'âœ‹', 'âœŒï¸'];
            const names = ['çŸ³å¤´', 'å¸ƒ', 'å‰ªåˆ€'];
            const cpuChoice = Math.floor(Math.random() * 3);

            let result = '';
            let emoji = '';

            if (playerChoice === cpuChoice) {
                simpleGameData.ties++;
                result = 'å¹³å±€ï¼';
                emoji = 'ğŸ˜';
            } else if ((playerChoice === 0 && cpuChoice === 2) ||
                (playerChoice === 1 && cpuChoice === 0) ||
                (playerChoice === 2 && cpuChoice === 1)) {
                simpleGameData.wins++;
                simpleGameData.winStreak++;
                if (simpleGameData.winStreak > simpleGameData.bestStreak) {
                    simpleGameData.bestStreak = simpleGameData.winStreak;
                }
                result = 'ä½ èµ¢äº†ï¼ğŸ‰';
                emoji = 'ğŸ˜Š';

                if (simpleGameData.winStreak >= 5) {
                    result += '<br>ğŸ”¥ğŸ”¥ğŸ”¥ è¿èƒœ5åœºï¼å¤ªå¼ºäº†ï¼';
                } else if (simpleGameData.winStreak >= 3) {
                    result += '<br>ğŸ”¥ è¿èƒœ3åœºï¼ç»§ç»­åŠ æ²¹ï¼';
                }
            } else {
                simpleGameData.losses++;
                simpleGameData.winStreak = 0;
                result = 'ä½ è¾“äº†ï¼ğŸ˜¢';
                emoji = 'ğŸ˜¢';
            }

            document.getElementById('simpleGameContent').innerHTML =
                `<div style="font-size: 3em;">ä½ ï¼š${choices[playerChoice]} ${emoji} ${choices[cpuChoice]} :ç”µè„‘</div>
                <div style="font-size: 1.5em; margin-top: 20px;">${result}</div>`;

            document.getElementById('simpleGameScore').textContent =
                `èƒœï¼š${simpleGameData.wins} / è´Ÿï¼š${simpleGameData.losses} / å¹³ï¼š${simpleGameData.ties} | è¿èƒœï¼š${simpleGameData.winStreak} ğŸ†æœ€ä½³ï¼š${simpleGameData.bestStreak}`;

            setTimeout(() => {
                document.getElementById('simpleGameContent').innerHTML = '<div style="font-size: 5em;">âœŠ âœ‹ âœŒï¸</div>';
            }, 2000);
        }

        // Piano Game (éŸ³ç¬¦è®°å¿†)
        function showPianoGame(event) {
            if (event) event.stopPropagation();
            showSimpleGame('piano', 'ğŸ¹ éŸ³ç¬¦è®°å¿†å¤§å¸ˆ', initPianoGame);
        }

        function initPianoGame() {
            simpleGameData = { sequence: [], userInput: [], level: 1, playing: false, lives: 3, bestLevel: 1 };
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'];
            const keyCount = Math.min(4 + Math.floor((simpleGameData.level - 1) / 3), 6);

            document.getElementById('simpleGameContent').innerHTML = `
                <div style="font-size: 2em; margin-bottom: 20px;">å…³å¡ï¼š${simpleGameData.level} | â¤ï¸ x${simpleGameData.lives}</div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 400px; margin: 0 auto;">
                    <button class="btn btn-start" style="height: 80px; font-size: 2em; background: #e74c3c;" onclick="pianoKey(event, 0)">ğŸµ</button>
                    <button class="btn btn-start" style="height: 80px; font-size: 2em; background: #3498db;" onclick="pianoKey(event, 1)">ğŸ¶</button>
                    <button class="btn btn-start" style="height: 80px; font-size: 2em; background: #2ecc71;" onclick="pianoKey(event, 2)">ğŸ¼</button>
                    <button class="btn btn-start" style="height: 80px; font-size: 2em; background: #f39c12;" onclick="pianoKey(event, 3)">ğŸ¸</button>
                </div>
            `;
            document.getElementById('simpleGameScore').textContent = `æœ€é«˜è®°å½•ï¼š${simpleGameData.bestLevel}å…³`;
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-start btn-control" onclick="startPianoLevel(event)">å¼€å§‹ç¬¬${simpleGameData.level}å…³</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function startPianoLevel(event) {
            if (event) event.stopPropagation();
            if (simpleGameData.playing) return;

            simpleGameData.playing = true;
            simpleGameData.userInput = [];
            simpleGameData.sequence.push(Math.floor(Math.random() * 4));

            document.getElementById('simpleGameScore').textContent = `ğŸ‘€ è§‚çœ‹å¹¶è®°ä½...ï¼ˆåºåˆ—é•¿åº¦ï¼š${simpleGameData.sequence.length}ï¼‰`;

            let i = 0;
            const showSequence = setInterval(() => {
                if (i < simpleGameData.sequence.length) {
                    const buttons = document.querySelectorAll('#simpleGameContent button');
                    buttons[simpleGameData.sequence[i]].style.transform = 'scale(1.3)';
                    buttons[simpleGameData.sequence[i]].style.boxShadow = '0 0 20px yellow';
                    setTimeout(() => {
                        buttons[simpleGameData.sequence[i]].style.transform = 'scale(1)';
                        buttons[simpleGameData.sequence[i]].style.boxShadow = 'none';
                    }, 400);
                    i++;
                } else {
                    clearInterval(showSequence);
                    document.getElementById('simpleGameScore').textContent = `ğŸ® ç°åœ¨è½®åˆ°ä½ äº†ï¼`;
                }
            }, 700);
        }

        function pianoKey(event, key) {
            if (event) event.stopPropagation();
            if (!simpleGameData.playing || simpleGameData.userInput.length >= simpleGameData.sequence.length) return;

            simpleGameData.userInput.push(key);

            const buttons = document.querySelectorAll('#simpleGameContent button');
            buttons[key].style.transform = 'scale(1.2)';
            setTimeout(() => buttons[key].style.transform = 'scale(1)', 200);

            if (simpleGameData.userInput[simpleGameData.userInput.length - 1] !==
                simpleGameData.sequence[simpleGameData.userInput.length - 1]) {
                simpleGameData.lives--;
                if (simpleGameData.lives <= 0) {
                    document.getElementById('simpleGameScore').textContent = `ğŸ’” æ¸¸æˆç»“æŸï¼æœ€ç»ˆå…³å¡ï¼š${simpleGameData.level}`;
                    simpleGameData.playing = false;
                    simpleGameData.sequence = [];
                    simpleGameData.level = 1;
                    simpleGameData.lives = 3;
                    setTimeout(() => initPianoGame(), 3000);
                } else {
                    document.getElementById('simpleGameScore').textContent = `âŒ é”™äº†ï¼å‰©ä½™ç”Ÿå‘½ï¼š${simpleGameData.lives}`;
                    simpleGameData.playing = false;
                    simpleGameData.userInput = [];
                    setTimeout(() => {
                        document.getElementById('simpleGameContent').innerHTML =
                            `<div style="font-size: 2em; margin-bottom: 20px;">å…³å¡ï¼š${simpleGameData.level} | â¤ï¸ x${simpleGameData.lives}</div>` +
                            document.getElementById('simpleGameContent').innerHTML.split('</div>').slice(1).join('</div>');
                        document.getElementById('simpleGameScore').textContent = `æœ€é«˜è®°å½•ï¼š${simpleGameData.bestLevel}å…³`;
                    }, 2000);
                }
                return;
            }

            if (simpleGameData.userInput.length === simpleGameData.sequence.length) {
                simpleGameData.level++;
                if (simpleGameData.level > simpleGameData.bestLevel) {
                    simpleGameData.bestLevel = simpleGameData.level;
                }
                let bonus = '';
                if (simpleGameData.level % 5 === 0) {
                    simpleGameData.lives = Math.min(simpleGameData.lives + 1, 5);
                    bonus = ' å¥–åŠ±+1ç”Ÿå‘½ï¼';
                }
                document.getElementById('simpleGameScore').textContent = `âœ… æ­£ç¡®ï¼è¿›å…¥å…³å¡ ${simpleGameData.level}${bonus}`;
                document.getElementById('simpleGameContent').innerHTML =
                    `<div style="font-size: 2em; margin-bottom: 20px;">å…³å¡ï¼š${simpleGameData.level} | â¤ï¸ x${simpleGameData.lives}</div>` +
                    document.getElementById('simpleGameContent').innerHTML.split('</div>').slice(1).join('</div>');
                simpleGameData.playing = false;
                setTimeout(() => startPianoLevel(), 2000);
            }
        }

        // Catch Game (æ¥ä¸œè¥¿)
        const catchItems = {
            normal: [
                { emoji: 'ğŸ', points: 1, name: 'è‹¹æœ' },
                { emoji: 'ğŸŠ', points: 1, name: 'æ©˜å­' },
                { emoji: 'ğŸ‹', points: 1, name: 'æŸ æª¬' },
                { emoji: 'ğŸ‰', points: 2, name: 'è¥¿ç“œ' },
                { emoji: 'ğŸ‡', points: 1, name: 'è‘¡è„' }
            ],
            special: [
                { emoji: 'â­', points: 5, name: 'æ˜Ÿæ˜Ÿ' },
                { emoji: 'ğŸ’', points: 10, name: 'é’»çŸ³' },
                { emoji: 'ğŸ', effect: 'slow', name: 'ç¤¼ç‰©' }
            ],
            bad: [
                { emoji: 'ğŸ’£', points: -10, name: 'ç‚¸å¼¹' },
                { emoji: 'â˜ ï¸', points: -5, name: 'éª·é«…' }
            ]
        };

        function showCatchGame(event) {
            if (event) event.stopPropagation();
            showSimpleGame('catch', 'ğŸ¯ æ¥ä¸œè¥¿å¤§å¸ˆ', initCatchGame);
        }

        function initCatchGame() {
            simpleGameData = { score: 0, playing: false, position: 50, interval: null, combo: 0, speed: 1 };
            document.getElementById('simpleGameContent').innerHTML = `
                <div style="position: relative; width: 400px; height: 300px; margin: 0 auto; border: 2px solid #333; background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%);">
                    <div id="fallingItem" style="position: absolute; top: 0; left: 50%; font-size: 3em;">ğŸ</div>
                    <div id="basket" style="position: absolute; bottom: 0; left: 45%; font-size: 3em;">ğŸ§º</div>
                </div>
            `;
            document.getElementById('simpleGameScore').textContent = `å¾—åˆ†ï¼š0 | è¿å‡»ï¼š0`;
            document.getElementById('simpleGameControls').innerHTML = `
                <button class="btn btn-start btn-control" onclick="startCatchGame(event)">å¼€å§‹æ¸¸æˆ</button>
                <button class="btn btn-restart btn-control" onclick="moveBasket(event, -1)">â† å·¦ç§»</button>
                <button class="btn btn-restart btn-control" onclick="moveBasket(event, 1)">å³ç§» â†’</button>
                <button class="btn btn-back btn-control" onclick="backToMenu(event)">è¿”å›èœå•</button>
            `;
        }

        function getRandomCatchItem() {
            const rand = Math.random();
            if (rand < 0.05) return catchItems.special[Math.floor(Math.random() * catchItems.special.length)];
            if (rand < 0.2) return catchItems.bad[Math.floor(Math.random() * catchItems.bad.length)];
            return catchItems.normal[Math.floor(Math.random() * catchItems.normal.length)];
        }

        function startCatchGame(event) {
            if (event) event.stopPropagation();
            if (simpleGameData.playing) return;

            simpleGameData.playing = true;
            simpleGameData.score = 0;
            simpleGameData.combo = 0;
            simpleGameData.speed = 1;
            simpleGameData.position = 50;
            let timeLeft = 30;

            const countdown = setInterval(() => {
                timeLeft--;
                document.getElementById('simpleGameScore').textContent =
                    `å¾—åˆ†ï¼š${simpleGameData.score} | è¿å‡»ï¼š${simpleGameData.combo} | æ—¶é—´ï¼š${timeLeft}ç§’`;
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    clearInterval(simpleGameData.interval);
                    simpleGameData.playing = false;
                    document.getElementById('fallingItem').innerHTML =
                        `<div style="font-size: 0.6em; text-align: center; margin-top: 100px;">æ¸¸æˆç»“æŸï¼<br>æœ€ç»ˆå¾—åˆ†ï¼š${simpleGameData.score}</div>`;
                    setTimeout(initCatchGame, 3000);
                }
            }, 1000);

            simpleGameData.interval = setInterval(() => {
                const item = getRandomCatchItem();
                const itemPos = Math.random() * 80 + 10;
                const fallingEl = document.getElementById('fallingItem');
                fallingEl.textContent = item.emoji;
                fallingEl.style.left = itemPos + '%';
                fallingEl.style.top = '0';

                let fallPos = 0;
                const fallSpeed = 5 * simpleGameData.speed;
                const fallInterval = setInterval(() => {
                    fallPos += fallSpeed;
                    fallingEl.style.top = fallPos + 'px';

                    if (fallPos >= 250) {
                        clearInterval(fallInterval);
                        if (Math.abs(itemPos - simpleGameData.position) < 15) {
                            if (item.effect === 'slow') {
                                simpleGameData.speed = 0.7;
                                fallingEl.textContent = 'ğŸ å‡é€Ÿï¼';
                                setTimeout(() => { simpleGameData.speed = 1; }, 5000);
                            } else if (item.points < 0) {
                                simpleGameData.score = Math.max(0, simpleGameData.score + item.points);
                                simpleGameData.combo = 0;
                                fallingEl.textContent = `ğŸ’¥ ${item.points}`;
                            } else {
                                simpleGameData.combo++;
                                const bonus = Math.floor(simpleGameData.combo / 5);
                                simpleGameData.score += item.points + bonus;
                                fallingEl.textContent = `âœ¨ +${item.points + bonus}`;
                            }
                            document.getElementById('simpleGameScore').textContent =
                                `å¾—åˆ†ï¼š${simpleGameData.score} | è¿å‡»ï¼š${simpleGameData.combo} ${simpleGameData.combo >= 5 ? 'ğŸ”¥' : ''}| æ—¶é—´ï¼š${timeLeft}ç§’`;
                        } else {
                            if (item.points > 0) simpleGameData.combo = 0;
                        }
                    }
                }, 50);
            }, 1200 / simpleGameData.speed);
        }

        function moveBasket(event, direction) {
            if (event) event.stopPropagation();
            simpleGameData.position = Math.max(5, Math.min(85, simpleGameData.position + direction * 10));
            document.getElementById('basket').style.left = simpleGameData.position + '%';
        }

        // ========== é€šç”¨æ¸¸æˆæ•°æ® ==========
        let universalGameData = {
            currentGame: '',
            score: 0,
            gameInterval: null,
            gameData: {} // æ¯ä¸ªæ¸¸æˆä¸“ç”¨æ•°æ®
        };

        function showUniversalGame(gameName, initFunction) {
            if (event) event.stopPropagation();
            hideAllScreens();
            document.getElementById('universalGame').classList.remove('hidden');
            universalGameData.currentGame = gameName;
            universalGameData.score = 0;
            universalGameData.gameData = {};
            gameState = 'universal_' + gameName;
            initFunction();
        }

        // ========== 1. è°ƒé…’å¸ˆæ¸¸æˆï¼ˆå‡çº§ç‰ˆï¼‰==========
        function showBartenderGame(event) {
            showUniversalGame('bartender', initBartenderGame);
        }

        function initBartenderGame() {
            document.getElementById('universalGameTitle').textContent = 'ğŸ¹ è°ƒé…’å¸ˆé…’å§';

            universalGameData.gameData = {
                money: 200,
                reputation: 100,
                completed: 0,
                failed: 0,
                customers: [],
                currentDrink: [],
                shaking: false,
                shakeTime: 0,
                drinks: {
                    'é©¬å¤©å°¼': { ingredients: ['ğŸ¸ä¼ç‰¹åŠ ', 'ğŸŒ¿è‹¦è‰¾é…’'], needShake: true, price: 80, difficulty: 1 },
                    'è«å‰æ‰˜': { ingredients: ['ğŸ¥ƒæœ—å§†é…’', 'ğŸ‹é’æŸ ', 'ğŸŒ¿è–„è·', 'ğŸ§Šå†°å—'], needShake: false, price: 70, difficulty: 1 },
                    'ç›æ ¼ä¸½ç‰¹': { ingredients: ['ğŸ¥ƒé¾™èˆŒå…°', 'ğŸ‹é’æŸ ', 'ğŸ§‚ç›'], needShake: true, price: 75, difficulty: 1 },
                    'é•¿å²›å†°èŒ¶': { ingredients: ['ğŸ¸ä¼ç‰¹åŠ ', 'ğŸ¥ƒæœ—å§†é…’', 'ğŸ¥ƒé¾™èˆŒå…°', 'ğŸ‹æŸ æª¬', 'ğŸ¥¤å¯ä¹'], needShake: true, price: 90, difficulty: 2 }
                }
            };

            if (universalGameData.gameInterval) clearInterval(universalGameData.gameInterval);
            universalGameData.gameInterval = setInterval(updateBar, 1000);

            generateBarCustomer();
            renderBartenderUI();
        }

        function updateBar() {
            const data = universalGameData.gameData;

            data.customers.forEach((customer, index) => {
                customer.patience--;
                if (customer.patience <= 0) {
                    data.customers.splice(index, 1);
                    data.failed++;
                    data.reputation -= 10;
                    alert('âŒ é¡¾å®¢ç­‰å¤ªä¹…ç¦»å¼€äº†ï¼å£°èª‰-10');
                }
            });

            if (data.shaking && data.shakeTime > 0) {
                data.shakeTime--;
                if (data.shakeTime === 0) {
                    data.shaking = false;
                }
            }

            renderBartenderUI();
        }

        function generateBarCustomer() {
            const data = universalGameData.gameData;
            if (data.customers.length >= 4) return;

            const drinkNames = Object.keys(data.drinks);
            const drinkName = drinkNames[Math.floor(Math.random() * drinkNames.length)];
            const drink = data.drinks[drinkName];

            data.customers.push({
                name: drinkName,
                recipe: drink,
                patience: 25,
                maxPatience: 25,
                satisfaction: 100
            });

            setTimeout(() => generateBarCustomer(), Math.random() * 8000 + 5000);
        }

        function addBarIngredient(ingredient) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (data.shaking) {
                alert('æ­£åœ¨æ‘‡æ™ƒä¸­ï¼ç­‰ä¸€ä¸‹ï¼');
                return;
            }

            data.currentDrink.push(ingredient);
            renderBartenderUI();
        }

        function shakeDrink() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (data.currentDrink.length === 0) {
                alert('æ¯å­æ˜¯ç©ºçš„ï¼');
                return;
            }

            data.shaking = true;
            data.shakeTime = 3;
            renderBartenderUI();
        }

        function serveBarDrink() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (data.shaking) {
                alert('è¿˜åœ¨æ‘‡æ™ƒï¼ç­‰ä¸€ä¸‹ï¼');
                return;
            }

            if (data.currentDrink.length === 0) {
                alert('æ¯å­æ˜¯ç©ºçš„ï¼');
                return;
            }

            let matched = null;
            for (const customer of data.customers) {
                const sorted1 = [...data.currentDrink].sort();
                const sorted2 = [...customer.recipe.ingredients].sort();
                if (sorted1.length === sorted2.length && sorted1.every((val, idx) => val === sorted2[idx])) {
                    matched = customer;
                    break;
                }
            }

            if (matched) {
                const patienceBonus = Math.floor(matched.patience / matched.maxPatience * 20);
                const shakeBonus = matched.recipe.needShake && data.shakeTime === 0 ? 10 : 0;
                const totalEarning = matched.recipe.price + patienceBonus + shakeBonus;

                data.money += totalEarning;
                data.completed++;
                data.reputation += 3;
                alert(`âœ… å®Œç¾ï¼èµšäº† ${totalEarning} å…ƒï¼${shakeBonus > 0 ? '\næ‘‡æ™ƒæŠ€å·§+10ï¼' : ''}`);
                data.customers = data.customers.filter(c => c !== matched);
            } else {
                data.money -= 25;
                data.failed++;
                data.reputation -= 5;
                alert('âŒ è°ƒé”™äº†ï¼èµ”äº†25å…ƒï¼');
            }

            data.currentDrink = [];
            renderBartenderUI();
        }

        function clearBarDrink() {
            if (event) event.stopPropagation();
            universalGameData.gameData.currentDrink = [];
            renderBartenderUI();
        }

        function renderBartenderUI() {
            const data = universalGameData.gameData;

            let html = '';

            html += `
                <div style="background: #fff3cd; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸ§‘â€ğŸ¤â€ğŸ§‘ é¡¾å®¢ (${data.customers.length}/4)</strong>
                    ${data.customers.length === 0 ? '<div style="text-align: center; color: #999; margin-top: 8px;">ç­‰å¾…é¡¾å®¢ä¸­...</div>' : ''}
                    ${data.customers.map(c => {
                const pPercent = (c.patience / c.maxPatience * 100).toFixed(0);
                return `
                            <div style="background: white; padding: 8px; border-radius: 5px; margin-top: 8px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>${c.name}</strong>
                                    <span>${c.recipe.price}å…ƒ</span>
                                </div>
                                <div style="font-size: 0.85em; color: #666;">
                                    ${c.recipe.ingredients.join(' + ')} ${c.recipe.needShake ? 'ğŸ¥ƒæ‘‡æ™ƒ' : ''}
                                </div>
                                <div style="margin-top: 5px;">
                                    <strong style="font-size: 0.9em;">è€å¿ƒï¼š${c.patience}ç§’</strong>
                                    <div style="background: #ddd; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 3px;">
                                        <div style="background: ${c.patience > 12 ? '#28a745' : '#dc3545'}; height: 100%; width: ${pPercent}%;"></div>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;

            html += `
                <div style="background: ${data.shaking ? '#ffcccc' : '#e7f3ff'}; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸ¸ è°ƒé…’å°</strong>
                    <div style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0; min-height: 60px;">
                        <div style="font-size: 1.3em; text-align: center;">
                            ${data.currentDrink.length > 0 ? data.currentDrink.join(' + ') : 'ç©ºæ¯å­'}
                            ${data.shaking ? `<br><span style="color: #ff6b6b;">ğŸ¥ƒ æ‘‡æ™ƒä¸­... ${data.shakeTime}ç§’</span>` : ''}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <button class="btn" onclick="shakeDrink()" style="background: #ffc107;" ${data.shaking ? 'disabled' : ''}>ğŸ¥ƒ æ‘‡æ™ƒ (3ç§’)</button>
                        <button class="btn" onclick="serveBarDrink()" style="background: #28a745;">âœ… ä¸Šé…’</button>
                        <button class="btn" onclick="clearBarDrink()" style="background: #dc3545;">ğŸ—‘ï¸ å€’æ‰</button>
                    </div>
                </div>
            `;

            html += `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸ§ª åŸæ–™åº“</strong>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                        <button class="btn" onclick="addBarIngredient('ğŸ¸ä¼ç‰¹åŠ ')" ${data.shaking ? 'disabled' : ''}>ğŸ¸ä¼ç‰¹åŠ </button>
                        <button class="btn" onclick="addBarIngredient('ğŸ¥ƒæœ—å§†é…’')" ${data.shaking ? 'disabled' : ''}>ğŸ¥ƒæœ—å§†é…’</button>
                        <button class="btn" onclick="addBarIngredient('ğŸ¥ƒé¾™èˆŒå…°')" ${data.shaking ? 'disabled' : ''}>ğŸ¥ƒé¾™èˆŒå…°</button>
                        <button class="btn" onclick="addBarIngredient('ğŸŒ¿è‹¦è‰¾é…’')" ${data.shaking ? 'disabled' : ''}>ğŸŒ¿è‹¦è‰¾é…’</button>
                        <button class="btn" onclick="addBarIngredient('ğŸŒ¿è–„è·')" ${data.shaking ? 'disabled' : ''}>ğŸŒ¿è–„è·</button>
                        <button class="btn" onclick="addBarIngredient('ğŸ‹é’æŸ ')" ${data.shaking ? 'disabled' : ''}>ğŸ‹é’æŸ </button>
                        <button class="btn" onclick="addBarIngredient('ğŸ‹æŸ æª¬')" ${data.shaking ? 'disabled' : ''}>ğŸ‹æŸ æª¬</button>
                        <button class="btn" onclick="addBarIngredient('ğŸ§‚ç›')" ${data.shaking ? 'disabled' : ''}>ğŸ§‚ç›</button>
                        <button class="btn" onclick="addBarIngredient('ğŸ§Šå†°å—')" ${data.shaking ? 'disabled' : ''}>ğŸ§Šå†°å—</button>
                        <button class="btn" onclick="addBarIngredient('ğŸ¥¤å¯ä¹')" ${data.shaking ? 'disabled' : ''}>ğŸ¥¤å¯ä¹</button>
                    </div>
                </div>

                <div style="background: #d1ecf1; padding: 10px; border-radius: 10px; font-size: 0.85em; text-align: center;">
                    ğŸ’¡ åŠ åŸæ–™â†’éœ€è¦çš„è¯æ‘‡æ™ƒâ†’ä¸Šé…’ï¼<br>
                    æ‘‡æ™ƒéœ€è¦3ç§’ï¼Œæ­£ç¡®æ‘‡æ™ƒæœ‰é¢å¤–å¥–åŠ±ï¼
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent =
                `ğŸ’° ${data.money}å…ƒ | â­ ${data.reputation}å£°èª‰ | âœ… ${data.completed}æ¯ | âŒ ${data.failed}æ¯`;
        }

        // ========== 2. å’–å•¡åº—æ¸¸æˆ ==========
        function showCafeGame(event) {
            showUniversalGame('cafe', initCafeGame);
        }

        function initCafeGame() {
            document.getElementById('universalGameTitle').textContent = 'â˜• å’–å•¡åº—';

            const coffeeTypes = {
                'ç¾å¼å’–å•¡': { steps: ['â˜•å’–å•¡', 'ğŸ’§çƒ­æ°´'], price: 25 },
                'æ‹¿é“': { steps: ['â˜•å’–å•¡', 'ğŸ¥›ç‰›å¥¶'], price: 35 },
                'å¡å¸ƒå¥‡è¯º': { steps: ['â˜•å’–å•¡', 'ğŸ¥›ç‰›å¥¶', 'ğŸ«§å¥¶æ³¡'], price: 38 },
                'æ‘©å¡': { steps: ['â˜•å’–å•¡', 'ğŸ¥›ç‰›å¥¶', 'ğŸ«å·§å…‹åŠ›'], price: 40 }
            };

            universalGameData.gameData = {
                coffeeTypes: coffeeTypes,
                currentOrder: null,
                currentCup: [],
                money: 0,
                completed: 0
            };

            renderCafeUI();
            generateCafeOrder();
        }

        function generateCafeOrder() {
            const types = Object.keys(universalGameData.gameData.coffeeTypes);
            const coffeeName = types[Math.floor(Math.random() * types.length)];
            universalGameData.gameData.currentOrder = {
                name: coffeeName,
                recipe: universalGameData.gameData.coffeeTypes[coffeeName]
            };
            renderCafeUI();
        }

        function addCoffeeStep(step) {
            if (event) event.stopPropagation();
            universalGameData.gameData.currentCup.push(step);
            renderCafeUI();
        }

        function serveCoffee() {
            if (event) event.stopPropagation();
            const order = universalGameData.gameData.currentOrder;
            const current = universalGameData.gameData.currentCup;

            const sorted1 = [...current].sort();
            const sorted2 = [...order.recipe.steps].sort();
            const isCorrect = sorted1.length === sorted2.length &&
                sorted1.every((val, idx) => val === sorted2[idx]);

            if (isCorrect) {
                universalGameData.gameData.money += order.recipe.price;
                universalGameData.gameData.completed++;
                alert(`âœ… å®Œç¾ï¼èµšäº† ${order.recipe.price} å…ƒï¼`);
            } else {
                universalGameData.gameData.money -= 15;
                alert(`âŒ é”™è¯¯ï¼èµ”äº† 15 å…ƒï¼`);
            }

            universalGameData.gameData.currentCup = [];
            generateCafeOrder();
        }

        function clearCoffee() {
            if (event) event.stopPropagation();
            universalGameData.gameData.currentCup = [];
            renderCafeUI();
        }

        function renderCafeUI() {
            const data = universalGameData.gameData;
            const order = data.currentOrder;

            let html = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸ“‹ å®¢äººç‚¹å•ï¼š${order.name}</strong><br>
                    <span style="color: #666;">éœ€è¦ï¼š${order.recipe.steps.join(' â†’ ')}</span><br>
                    <span style="color: #28a745;">ğŸ’° ${order.recipe.price}å…ƒ</span>
                </div>

                <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>â˜• å½“å‰åˆ¶ä½œï¼š</strong><br>
                    <div style="font-size: 1.5em; margin: 10px 0; min-height: 40px;">
                        ${data.currentCup.join(' + ') || 'ç©ºæ¯å­'}
                    </div>
                    <button class="btn" onclick="serveCoffee()" style="background: #28a745; margin-right: 5px;">âœ… ä¸Šå’–å•¡</button>
                    <button class="btn" onclick="clearCoffee()" style="background: #dc3545;">ğŸ—‘ï¸ å€’æ‰</button>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                    <strong>â˜• ææ–™ï¼š</strong><br>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                        <button class="btn" onclick="addCoffeeStep('â˜•å’–å•¡')">â˜•å’–å•¡</button>
                        <button class="btn" onclick="addCoffeeStep('ğŸ’§çƒ­æ°´')">ğŸ’§çƒ­æ°´</button>
                        <button class="btn" onclick="addCoffeeStep('ğŸ¥›ç‰›å¥¶')">ğŸ¥›ç‰›å¥¶</button>
                        <button class="btn" onclick="addCoffeeStep('ğŸ«§å¥¶æ³¡')">ğŸ«§å¥¶æ³¡</button>
                        <button class="btn" onclick="addCoffeeStep('ğŸ«å·§å…‹åŠ›')">ğŸ«å·§å…‹åŠ›</button>
                    </div>
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent =
                `ğŸ’° ${data.money}å…ƒ | å®Œæˆ: ${data.completed} æ¯`;
        }

        // ========== 3. å†œåœºæ¸¸æˆ ==========
        function showFarmGame(event) {
            showUniversalGame('farm', initFarmGame);
        }

        function initFarmGame() {
            document.getElementById('universalGameTitle').textContent = 'ğŸŒ¾ å†œåœº';

            universalGameData.gameData = {
                money: 100,
                plots: [
                    { id: 0, crop: null, stage: 0, maxStage: 3 },
                    { id: 1, crop: null, stage: 0, maxStage: 3 },
                    { id: 2, crop: null, stage: 0, maxStage: 3 },
                    { id: 3, crop: null, stage: 0, maxStage: 3 }
                ],
                crops: {
                    'ğŸŒ¾å°éº¦': { cost: 20, sellPrice: 50, emoji: 'ğŸŒ¾', stages: ['ğŸŸ«', 'ğŸŒ±', 'ğŸŒ¿', 'ğŸŒ¾'] },
                    'ğŸ¥•èåœ': { cost: 30, sellPrice: 70, emoji: 'ğŸ¥•', stages: ['ğŸŸ«', 'ğŸŒ±', 'ğŸŒ¿', 'ğŸ¥•'] },
                    'ğŸŒ½ç‰ç±³': { cost: 40, sellPrice: 100, emoji: 'ğŸŒ½', stages: ['ğŸŸ«', 'ğŸŒ±', 'ğŸŒ¿', 'ğŸŒ½'] }
                }
            };

            renderFarmUI();
        }

        function plantCrop(plotId, cropName) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const plot = data.plots[plotId];
            const crop = data.crops[cropName];

            if (plot.crop) {
                alert('è¿™å—åœ°å·²ç»ç§äº†ä¸œè¥¿ï¼');
                return;
            }

            if (data.money < crop.cost) {
                alert('é’±ä¸å¤Ÿï¼');
                return;
            }

            data.money -= crop.cost;
            plot.crop = cropName;
            plot.stage = 1;
            renderFarmUI();
        }

        function waterCrop(plotId) {
            if (event) event.stopPropagation();
            const plot = universalGameData.gameData.plots[plotId];

            if (!plot.crop) {
                alert('è¿™å—åœ°æ²¡ç§ä¸œè¥¿ï¼');
                return;
            }

            if (plot.stage >= plot.maxStage) {
                alert('å·²ç»æˆç†Ÿäº†ï¼å¿«æ”¶è·å§ï¼');
                return;
            }

            plot.stage++;
            renderFarmUI();
        }

        function harvestCrop(plotId) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const plot = data.plots[plotId];

            if (!plot.crop) {
                alert('è¿™å—åœ°æ²¡ç§ä¸œè¥¿ï¼');
                return;
            }

            if (plot.stage < plot.maxStage) {
                alert('è¿˜æ²¡æˆç†Ÿï¼');
                return;
            }

            const crop = data.crops[plot.crop];
            data.money += crop.sellPrice;
            alert(`âœ… æ”¶è·äº†${crop.emoji}ï¼å–äº† ${crop.sellPrice} å…ƒï¼`);

            plot.crop = null;
            plot.stage = 0;
            renderFarmUI();
        }

        function renderFarmUI() {
            const data = universalGameData.gameData;

            let plotsHtml = '';
            data.plots.forEach(plot => {
                const crop = plot.crop ? data.crops[plot.crop] : null;
                const stageEmoji = crop ? crop.stages[plot.stage] : 'ğŸŸ«';
                const canHarvest = plot.crop && plot.stage >= plot.maxStage;

                plotsHtml += `
                    <div style="background: #8B4513; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em; margin: 10px 0;">${stageEmoji}</div>
                        <div style="margin-top: 5px;">
                            ${!plot.crop ? `
                                <select id="cropSelect${plot.id}" style="padding: 5px; margin-bottom: 5px; width: 100%;">
                                    <option value="">é€‰æ‹©ä½œç‰©</option>
                                    ${Object.keys(data.crops).map(name =>
                    `<option value="${name}">${name} (${data.crops[name].cost}å…ƒ)</option>`
                ).join('')}
                                </select>
                                <button class="btn" onclick="plantCrop(${plot.id}, document.getElementById('cropSelect${plot.id}').value)" style="font-size: 0.8em; padding: 5px 10px; width: 100%;">æ’­ç§</button>
                            ` : canHarvest ? `
                                <button class="btn" onclick="harvestCrop(${plot.id})" style="background: #28a745; font-size: 0.8em; padding: 5px 10px; width: 100%;">ğŸŒ¾ æ”¶è·</button>
                            ` : `
                                <button class="btn" onclick="waterCrop(${plot.id})" style="background: #17a2b8; font-size: 0.8em; padding: 5px 10px; width: 100%;">ğŸ’§ æµ‡æ°´</button>
                            `}
                        </div>
                    </div>
                `;
            });

            let html = `
                <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                    <strong>ğŸ’° å†œåœºèµ„é‡‘ï¼š${data.money} å…ƒ</strong>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    ${plotsHtml}
                </div>

                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 10px; font-size: 0.9em;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>æ’­ç§ â†’ æµ‡æ°´ â†’ æµ‡æ°´ â†’ æ”¶è·
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent = `ğŸ’° ${data.money}å…ƒ`;
        }

        // ========== 4. ä¾¿åˆ©åº—æ¸¸æˆï¼ˆå‡çº§ç‰ˆï¼‰==========
        function showConvenienceGame(event) {
            showUniversalGame('convenience', initConvenienceGame);
        }

        function initConvenienceGame() {
            document.getElementById('universalGameTitle').textContent = 'ğŸª ä¾¿åˆ©åº—ç»è¥';

            universalGameData.gameData = {
                money: 200,
                reputation: 100,
                day: 1,
                customersServed: 0,
                customersLost: 0,
                customerQueue: [],
                currentCustomer: null,
                inventory: {
                    'ğŸé¢åŒ…': { stock: 10, shelfStock: 5, price: 8, cost: 3 },
                    'ğŸ¥›ç‰›å¥¶': { stock: 10, shelfStock: 5, price: 12, cost: 5 },
                    'ğŸ«å·§å…‹åŠ›': { stock: 10, shelfStock: 5, price: 10, cost: 4 },
                    'ğŸè‹¹æœ': { stock: 10, shelfStock: 5, price: 6, cost: 2 },
                    'ğŸ¥¤é¥®æ–™': { stock: 10, shelfStock: 5, price: 10, cost: 4 },
                    'ğŸœæ³¡é¢': { stock: 0, shelfStock: 0, price: 15, cost: 6, unlocked: false }
                },
                stage: 'waiting', // waiting, serving, restocking
                nextCustomerTime: 5
            };

            // å¼€å§‹æ¸¸æˆå¾ªç¯
            if (universalGameData.gameInterval) clearInterval(universalGameData.gameInterval);
            universalGameData.gameInterval = setInterval(updateConvenienceStore, 1000);

            renderConvenienceUI();
        }

        function updateConvenienceStore() {
            const data = universalGameData.gameData;

            // ç”Ÿæˆæ–°é¡¾å®¢
            data.nextCustomerTime--;
            if (data.nextCustomerTime <= 0 && data.customerQueue.length < 3) {
                generateStoreCustomer();
                data.nextCustomerTime = Math.floor(Math.random() * 5) + 3;
            }

            // é¡¾å®¢ç­‰å¾…è¶…æ—¶
            data.customerQueue.forEach((customer, index) => {
                customer.patience--;
                if (customer.patience <= 0) {
                    data.customerQueue.splice(index, 1);
                    data.customersLost++;
                    data.reputation -= 5;
                    alert('âŒ é¡¾å®¢ç­‰å¤ªä¹…ç¦»å¼€äº†ï¼å£°èª‰-5');
                }
            });

            // è‡ªåŠ¨æœåŠ¡ç¬¬ä¸€ä¸ªé¡¾å®¢
            if (data.stage === 'waiting' && data.customerQueue.length > 0 && !data.currentCustomer) {
                data.currentCustomer = data.customerQueue.shift();
                data.stage = 'serving';
            }

            renderConvenienceUI();
        }

        function generateStoreCustomer() {
            const data = universalGameData.gameData;
            const availableItems = Object.keys(data.inventory).filter(name => {
                const item = data.inventory[name];
                return item.shelfStock > 0 && (item.unlocked !== false);
            });

            if (availableItems.length === 0) {
                alert('âš ï¸ è´§æ¶ç©ºäº†ï¼å¿«è¡¥è´§ï¼');
                return;
            }

            const numItems = Math.floor(Math.random() * 2) + 1;
            const wantedItems = [];
            for (let i = 0; i < numItems; i++) {
                const itemName = availableItems[Math.floor(Math.random() * availableItems.length)];
                wantedItems.push({
                    name: itemName,
                    price: data.inventory[itemName].price
                });
            }

            data.customerQueue.push({
                items: wantedItems,
                patience: 15,
                maxPatience: 15
            });
        }

        function serveCustomer() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const customer = data.currentCustomer;

            if (!customer) return;

            // æ£€æŸ¥åº“å­˜
            let canServe = true;
            customer.items.forEach(item => {
                if (data.inventory[item.name].shelfStock <= 0) {
                    canServe = false;
                }
            });

            if (!canServe) {
                alert('âŒ è´§æ¶ä¸Šæ²¡è´§äº†ï¼è¯·å…ˆè¡¥è´§ï¼');
                return;
            }

            // æ‰£é™¤åº“å­˜
            let total = 0;
            customer.items.forEach(item => {
                data.inventory[item.name].shelfStock--;
                total += item.price;
            });

            // æ‰¾é›¶è®¡ç®—
            const userChange = parseInt(document.getElementById('changeInput').value);
            const payment = total + Math.floor(Math.random() * 15) + 5;
            const correctChange = payment - total;

            if (userChange === correctChange) {
                data.money += total;
                data.customersServed++;
                data.reputation += 2;
                alert(`âœ… æ­£ç¡®ï¼èµšäº† ${total} å…ƒï¼`);

                data.currentCustomer = null;
                data.stage = 'waiting';
            } else {
                alert(`âŒ æ‰¾é›¶é”™è¯¯ï¼åº”è¯¥æ‰¾ ${correctChange} å…ƒï¼\nå£°èª‰-3`);
                data.reputation -= 3;
            }

            renderConvenienceUI();
        }

        function restockShelf(itemName) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const item = data.inventory[itemName];

            if (item.stock <= 0) {
                alert('ä»“åº“æ²¡è´§äº†ï¼è¯·å…ˆè¿›è´§ï¼');
                return;
            }

            const amount = Math.min(5, item.stock);
            item.stock -= amount;
            item.shelfStock += amount;

            renderConvenienceUI();
        }

        function purchaseStock(itemName) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const item = data.inventory[itemName];

            const purchaseAmount = 10;
            const totalCost = item.cost * purchaseAmount;

            if (data.money < totalCost) {
                alert(`é’±ä¸å¤Ÿï¼éœ€è¦ ${totalCost} å…ƒï¼`);
                return;
            }

            data.money -= totalCost;
            item.stock += purchaseAmount;
            alert(`âœ… è¿›è´§æˆåŠŸï¼èŠ±è´¹ ${totalCost} å…ƒ`);

            renderConvenienceUI();
        }

        function unlockNewProduct() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (data.inventory['ğŸœæ³¡é¢'].unlocked) {
                alert('å·²ç»è§£é”äº†ï¼');
                return;
            }

            if (data.money < 100) {
                alert('é’±ä¸å¤Ÿï¼éœ€è¦ 100 å…ƒï¼');
                return;
            }

            data.money -= 100;
            data.inventory['ğŸœæ³¡é¢'].unlocked = true;
            data.inventory['ğŸœæ³¡é¢'].stock = 10;
            data.inventory['ğŸœæ³¡é¢'].shelfStock = 5;
            alert('âœ… è§£é”æ–°å•†å“ï¼šğŸœæ³¡é¢ï¼');

            renderConvenienceUI();
        }

        function renderConvenienceUI() {
            const data = universalGameData.gameData;

            let html = '';

            // å½“å‰æœåŠ¡çš„é¡¾å®¢
            if (data.currentCustomer) {
                const customer = data.currentCustomer;
                const patiencePercent = (customer.patience / customer.maxPatience * 100).toFixed(0);
                const total = customer.items.reduce((sum, item) => sum + item.price, 0);
                const payment = total + Math.floor(Math.random() * 15) + 5;

                html += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 3px solid #ff6b6b;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>ğŸ§‘ å½“å‰é¡¾å®¢</strong>
                            <div>
                                <strong>è€å¿ƒï¼š${customer.patience}ç§’</strong>
                                <div style="background: #ddd; height: 8px; width: 100px; border-radius: 5px; overflow: hidden; display: inline-block; margin-left: 10px;">
                                    <div style="background: ${customer.patience > 5 ? '#28a745' : '#dc3545'}; height: 100%; width: ${patiencePercent}%;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            ${customer.items.map(item => `${item.name} ${item.price}å…ƒ`).join('<br>')}
                        </div>
                        <div style="border-top: 2px solid #000; padding-top: 8px; margin-bottom: 10px;">
                            <strong>æ€»è®¡ï¼š${total} å…ƒ</strong><br>
                            <strong style="color: #007bff;">é¡¾å®¢æ”¯ä»˜ï¼š${payment} å…ƒ</strong>
                        </div>
                        <input type="number" id="changeInput" placeholder="è¾“å…¥æ‰¾é›¶é‡‘é¢" style="width: 100%; padding: 8px; margin-bottom: 8px; font-size: 1em; border: 2px solid #007bff; border-radius: 5px;">
                        <button class="btn" onclick="serveCustomer()" style="background: #28a745; width: 100%; padding: 10px;">ğŸ’µ æ”¶é“¶ç»“è´¦</button>
                    </div>
                `;
            }

            // æ’é˜Ÿé¡¾å®¢
            if (data.customerQueue.length > 0) {
                html += `
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>ğŸ‘¥ æ’é˜Ÿä¸­ï¼š${data.customerQueue.length} äºº</strong>
                        <div style="margin-top: 8px;">
                            ${data.customerQueue.map((c, i) => `
                                <div style="display: inline-block; margin: 3px; padding: 5px 10px; background: white; border-radius: 5px; font-size: 0.85em;">
                                    ğŸ§‘ ${c.patience}ç§’
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (!data.currentCustomer) {
                html += `
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                        <strong>âœ“ æš‚æ— é¡¾å®¢</strong><br>
                        <span style="font-size: 0.9em; color: #666;">ä¸‹ä¸€ä¸ªé¡¾å®¢ ${data.nextCustomerTime} ç§’ååˆ°è¾¾</span>
                    </div>
                `;
            }

            // è´§æ¶åº“å­˜
            html += `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸª è´§æ¶ç®¡ç†</strong>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px;">
                        ${Object.entries(data.inventory).filter(([_, item]) => item.unlocked !== false).map(([name, item]) => `
                            <div style="background: white; padding: 8px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${name}</strong> ${item.price}å…ƒ
                                    <div style="font-size: 0.85em; color: #666;">
                                        è´§æ¶ï¼š${item.shelfStock} | ä»“åº“ï¼š${item.stock}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn" onclick="restockShelf('${name}')" style="background: #17a2b8; font-size: 0.8em; padding: 5px 10px; margin-right: 3px;">ğŸ“¦ è¡¥è´§</button>
                                    <button class="btn" onclick="purchaseStock('${name}')" style="background: #ffc107; font-size: 0.8em; padding: 5px 10px;">ğŸ’° è¿›è´§(${item.cost * 10}å…ƒ)</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="background: #d1ecf1; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸ å•†åº—å‡çº§</strong><br>
                    <button class="btn" onclick="unlockNewProduct()" style="background: #ff6b6b; margin-top: 8px; font-size: 0.9em; padding: 8px 15px;"
                        ${data.inventory['ğŸœæ³¡é¢'].unlocked ? 'disabled' : ''}>
                        ${data.inventory['ğŸœæ³¡é¢'].unlocked ? 'âœ“ å·²è§£é”æ³¡é¢' : 'ğŸ”“ è§£é”æ–°å•†å“ï¼šğŸœæ³¡é¢ (100å…ƒ)'}
                    </button>
                </div>

                <div style="background: #fff3cd; padding: 10px; border-radius: 10px; font-size: 0.85em; text-align: center;">
                    ğŸ’¡ åŠæ—¶è¡¥è´§ä¸Šæ¶ï¼æœåŠ¡é¡¾å®¢è¦ç®—å‡†æ‰¾é›¶ï¼<br>
                    è¿›è´§æœ‰æˆæœ¬ï¼Œå–å‡ºæ‰èµšé’±ï¼
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent =
                `ğŸ’° ${data.money}å…ƒ | â­ ${data.reputation}å£°èª‰ | âœ… ${data.customersServed}äºº | âŒ ${data.customersLost}äºº`;
        }

        // ========== 5. è›‹ç³•åº—æ¸¸æˆï¼ˆå‡çº§ç‰ˆï¼‰==========
        function showCakeGame(event) {
            showUniversalGame('cake', initCakeGame);
        }

        function initCakeGame() {
            document.getElementById('universalGameTitle').textContent = 'ğŸ‚ è›‹ç³•åº—çƒ˜ç„™';

            universalGameData.gameData = {
                money: 300,
                reputation: 100,
                completed: 0,
                failed: 0,
                orders: [],
                oven: null,
                stage: 'idle',
                recipes: {
                    'è‰è“è›‹ç³•': { base: 'ğŸ°è›‹ç³•èƒš', toppings: ['ğŸ“è‰è“', 'ğŸ¦å¥¶æ²¹'], bakeTime: 8, price: 80 },
                    'å·§å…‹åŠ›è›‹ç³•': { base: 'ğŸ«å·§å…‹åŠ›èƒš', toppings: ['ğŸ«å·§å…‹åŠ›é…±'], bakeTime: 10, price: 90 },
                    'æ°´æœè›‹ç³•': { base: 'ğŸ°è›‹ç³•èƒš', toppings: ['ğŸ“è‰è“', 'ğŸ«è“è“', 'ğŸŒé¦™è•‰'], bakeTime: 8, price: 120 },
                    'å¥¶æ²¹è›‹ç³•': { base: 'ğŸ°è›‹ç³•èƒš', toppings: ['ğŸ¦å¥¶æ²¹', 'ğŸ’æ¨±æ¡ƒ'], bakeTime: 8, price: 85 }
                }
            };

            if (universalGameData.gameInterval) clearInterval(universalGameData.gameInterval);
            universalGameData.gameInterval = setInterval(updateCakeShop, 1000);

            renderCakeUI();
            generateCakeOrder();
        }

        function updateCakeShop() {
            const data = universalGameData.gameData;

            // è®¢å•è¶…æ—¶
            data.orders.forEach((order, index) => {
                order.timeLeft--;
                if (order.timeLeft <= 0) {
                    data.orders.splice(index, 1);
                    data.failed++;
                    data.reputation -= 10;
                    alert('âŒ è®¢å•è¶…æ—¶ï¼å£°èª‰-10');
                }
            });

            // çƒ˜ç„™è¿›åº¦
            if (data.oven && data.oven.baking) {
                data.oven.timeLeft--;
                if (data.oven.timeLeft <= 0) {
                    data.oven.baking = false;
                    data.oven.done = true;
                }
            }

            renderCakeUI();
        }

        function generateCakeOrder() {
            const data = universalGameData.gameData;
            if (data.orders.length >= 3) return;

            const recipeNames = Object.keys(data.recipes);
            const recipeName = recipeNames[Math.floor(Math.random() * recipeNames.length)];
            const recipe = data.recipes[recipeName];

            data.orders.push({
                name: recipeName,
                recipe: recipe,
                timeLeft: 30,
                maxTime: 30
            });

            setTimeout(() => generateCakeOrder(), Math.random() * 10000 + 5000);
        }

        function startBaking(cakeType) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (data.oven && (data.oven.baking || data.oven.done)) {
                alert('çƒ¤ç®±è¿˜æœ‰è›‹ç³•ï¼å…ˆå–å‡ºæ¥ï¼');
                return;
            }

            const recipe = data.recipes[cakeType];
            data.oven = {
                cakeType: cakeType,
                base: recipe.base,
                toppings: [],
                baking: true,
                done: false,
                timeLeft: recipe.bakeTime,
                maxTime: recipe.bakeTime
            };

            renderCakeUI();
        }

        function takeFromOven() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (!data.oven || !data.oven.done) {
                alert('è›‹ç³•è¿˜æ²¡çƒ¤å¥½ï¼');
                return;
            }

            data.oven.baking = false;
            data.stage = 'decorating';
            renderCakeUI();
        }

        function addTopping(topping) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (!data.oven || data.oven.baking) {
                alert('è¯·å…ˆä»çƒ¤ç®±å–å‡ºè›‹ç³•ï¼');
                return;
            }

            data.oven.toppings.push(topping);
            renderCakeUI();
        }

        function serveCakeOrder() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (!data.oven || data.oven.baking) {
                alert('è¿˜æ²¡åšå¥½è›‹ç³•ï¼');
                return;
            }

            // æŸ¥æ‰¾åŒ¹é…çš„è®¢å•
            let matchedOrder = null;
            for (const order of data.orders) {
                const recipe = order.recipe;
                if (data.oven.base === recipe.base) {
                    const sorted1 = [...data.oven.toppings].sort();
                    const sorted2 = [...recipe.toppings].sort();
                    if (sorted1.length === sorted2.length && sorted1.every((val, idx) => val === sorted2[idx])) {
                        matchedOrder = order;
                        break;
                    }
                }
            }

            if (matchedOrder) {
                const timeBonus = Math.floor(matchedOrder.timeLeft / matchedOrder.maxTime * 30);
                const totalEarning = matchedOrder.recipe.price + timeBonus;
                data.money += totalEarning;
                data.completed++;
                data.reputation += 5;
                alert(`âœ… å®Œç¾ï¼èµšäº† ${totalEarning} å…ƒï¼`);
                data.orders = data.orders.filter(o => o !== matchedOrder);
            } else {
                data.money -= 30;
                data.failed++;
                data.reputation -= 5;
                alert('âŒ è›‹ç³•ä¸å¯¹ï¼èµ”äº†30å…ƒï¼');
            }

            data.oven = null;
            data.stage = 'idle';
            renderCakeUI();
        }

        function renderCakeUI() {
            const data = universalGameData.gameData;

            let html = '';

            // è®¢å•åˆ—è¡¨
            html += `
                <div style="background: #fff3cd; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸ“‹ è®¢å•åˆ—è¡¨ (${data.orders.length}/3)</strong>
                    ${data.orders.length === 0 ? '<div style="text-align: center; color: #999; margin-top: 8px;">ç­‰å¾…è®¢å•ä¸­...</div>' : ''}
                    ${data.orders.map(order => {
                const timePercent = (order.timeLeft / order.maxTime * 100).toFixed(0);
                return `
                            <div style="background: white; padding: 8px; border-radius: 5px; margin-top: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${order.name}</strong>
                                    <span>${order.recipe.price}å…ƒ</span>
                                </div>
                                <div style="font-size: 0.85em; color: #666;">éœ€è¦ï¼š${order.recipe.base} + ${order.recipe.toppings.join('ã€')}</div>
                                <div style="margin-top: 5px;">
                                    <strong style="font-size: 0.9em;">å‰©ä½™ï¼š${order.timeLeft}ç§’</strong>
                                    <div style="background: #ddd; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 3px;">
                                        <div style="background: ${order.timeLeft > 15 ? '#28a745' : '#dc3545'}; height: 100%; width: ${timePercent}%;"></div>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;

            // çƒ¤ç®±åŒºåŸŸ
            if (!data.oven) {
                html += `
                    <div style="background: #ffe7f0; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>ğŸ”¥ çƒ¤ç®±ï¼ˆç©ºé—²ï¼‰</strong>
                        <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            ${Object.keys(data.recipes).map(name => `
                                <button class="btn" onclick="startBaking('${name}')" style="background: #ff6b6b; font-size: 0.9em; padding: 10px;">
                                    çƒ¤${name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (data.oven.baking) {
                const progress = ((data.oven.maxTime - data.oven.timeLeft) / data.oven.maxTime * 100).toFixed(0);
                html += `
                    <div style="background: #ffcccc; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>ğŸ”¥ çƒ¤ç®±ï¼ˆçƒ˜ç„™ä¸­ï¼š${data.oven.cakeType}ï¼‰</strong>
                        <div style="font-size: 2em; text-align: center; margin: 15px 0;">ğŸ”¥</div>
                        <div style="margin-top: 10px;">
                            <strong>çƒ˜ç„™è¿›åº¦ï¼š${data.oven.timeLeft}ç§’</strong>
                            <div style="background: #ddd; height: 15px; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                                <div style="background: #ff6b6b; height: 100%; width: ${progress}%;"></div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.oven.done) {
                html += `
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>âœ“ çƒ¤ç®±ï¼ˆçƒ˜ç„™å®Œæˆï¼‰</strong>
                        <div style="font-size: 2em; text-align: center; margin: 15px 0;">${data.oven.base}</div>
                        <button class="btn" onclick="takeFromOven()" style="background: #28a745; width: 100%; padding: 12px;">ğŸ“¤ å–å‡ºè›‹ç³•</button>
                    </div>
                `;
            } else if (data.stage === 'decorating') {
                html += `
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>ğŸ¨ è£…é¥°è›‹ç³•</strong>
                        <div style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            <div style="font-size: 1.5em; text-align: center;">
                                ${data.oven.base}
                                ${data.oven.toppings.length > 0 ? '<br>+<br>' + data.oven.toppings.join(' + ') : ''}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                            <button class="btn" onclick="addTopping('ğŸ“è‰è“')" style="background: #ff6b6b;">ğŸ“è‰è“</button>
                            <button class="btn" onclick="addTopping('ğŸ«è“è“')" style="background: #4169e1;">ğŸ«è“è“</button>
                            <button class="btn" onclick="addTopping('ğŸŒé¦™è•‰')" style="background: #ffd700;">ğŸŒé¦™è•‰</button>
                            <button class="btn" onclick="addTopping('ğŸ«å·§å…‹åŠ›é…±')" style="background: #8b4513;">ğŸ«å·§å…‹åŠ›é…±</button>
                            <button class="btn" onclick="addTopping('ğŸ¦å¥¶æ²¹')" style="background: #f0e68c;">ğŸ¦å¥¶æ²¹</button>
                            <button class="btn" onclick="addTopping('ğŸ’æ¨±æ¡ƒ')" style="background: #dc143c;">ğŸ’æ¨±æ¡ƒ</button>
                        </div>
                        <button class="btn" onclick="serveCakeOrder()" style="background: #28a745; width: 100%; padding: 12px;">âœ… äº¤ä»˜è®¢å•</button>
                    </div>
                `;
            }

            html += `
                <div style="background: #d1ecf1; padding: 10px; border-radius: 10px; font-size: 0.85em; text-align: center;">
                    ğŸ’¡ é€‰è›‹ç³•â†’æ”¾çƒ¤ç®±â†’å–å‡ºâ†’è£…é¥°â†’äº¤ä»˜ï¼<br>
                    åŠæ—¶å®Œæˆè®¢å•æœ‰æ—¶é—´å¥–åŠ±ï¼
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent =
                `ğŸ’° ${data.money}å…ƒ | â­ ${data.reputation}å£°èª‰ | âœ… ${data.completed}ä¸ª | âŒ ${data.failed}ä¸ª`;
        }

        // ========== 6. æŒ–çŸ¿æ¸¸æˆ ==========
        function showMiningGame(event) {
            showUniversalGame('mining', initMiningGame);
        }

        function initMiningGame() {
            document.getElementById('universalGameTitle').textContent = 'â›ï¸ æŒ–çŸ¿';

            universalGameData.gameData = {
                money: 0,
                energy: 100,
                pickaxeLevel: 1,
                ores: {
                    'ğŸª¨çŸ³å¤´': { chance: 0.5, value: 2 },
                    'ğŸŸ«é“œçŸ¿': { chance: 0.25, value: 10 },
                    'âšªé“çŸ¿': { chance: 0.15, value: 25 },
                    'ğŸŸ¡é‡‘çŸ¿': { chance: 0.08, value: 50 },
                    'ğŸ’é’»çŸ³': { chance: 0.02, value: 200 }
                }
            };

            renderMiningUI();
        }

        function mineOre() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (data.energy <= 0) {
                alert('ä½“åŠ›ä¸è¶³ï¼å‡çº§é•å­å‡å°‘ä½“åŠ›æ¶ˆè€—ï¼');
                return;
            }

            data.energy -= Math.max(1, 10 - data.pickaxeLevel);

            // éšæœºæŒ–åˆ°çŸ¿çŸ³
            const rand = Math.random();
            let cumulative = 0;
            let found = null;

            for (const [name, ore] of Object.entries(data.ores)) {
                cumulative += ore.chance;
                if (rand <= cumulative) {
                    found = { name, value: ore.value };
                    break;
                }
            }

            if (found) {
                data.money += found.value;
                alert(`â›ï¸ æŒ–åˆ°äº† ${found.name}ï¼+${found.value}å…ƒï¼`);
            }

            renderMiningUI();
        }

        function upgradePickaxe() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const cost = data.pickaxeLevel * 100;

            if (data.money < cost) {
                alert(`é’±ä¸å¤Ÿï¼éœ€è¦ ${cost} å…ƒï¼`);
                return;
            }

            data.money -= cost;
            data.pickaxeLevel++;
            alert(`âœ… å‡çº§æˆåŠŸï¼é•å­ç­‰çº§ï¼š${data.pickaxeLevel}`);
            renderMiningUI();
        }

        function restEnergy() {
            if (event) event.stopPropagation();
            universalGameData.gameData.energy = 100;
            renderMiningUI();
        }

        function renderMiningUI() {
            const data = universalGameData.gameData;

            let html = `
                <div style="background: #6c757d; color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 1.2em; margin-bottom: 10px;">
                        ğŸ’ª ä½“åŠ›ï¼š${data.energy}/100
                    </div>
                    <div style="background: #495057; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: ${data.energy}%; transition: width 0.3s;"></div>
                    </div>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <div style="font-size: 5em; margin-bottom: 20px;">â›°ï¸</div>
                    <button class="btn" onclick="mineOre()" style="background: #ff6b6b; font-size: 1.3em; padding: 15px 40px;">
                        â›ï¸ æŒ–çŸ¿
                    </button>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <strong>ğŸ”§ é•å­ç­‰çº§ï¼š${data.pickaxeLevel}</strong><br>
                    <span style="color: #666; font-size: 0.9em;">æ¯æ¬¡æ¶ˆè€—ä½“åŠ›ï¼š${Math.max(1, 10 - data.pickaxeLevel)}</span><br>
                    <button class="btn" onclick="upgradePickaxe()" style="background: #ffc107; margin-top: 10px;">
                        â¬†ï¸ å‡çº§é•å­ (${data.pickaxeLevel * 100}å…ƒ)
                    </button>
                    <button class="btn" onclick="restEnergy()" style="background: #17a2b8; margin-top: 10px; margin-left: 5px;">
                        ğŸ˜´ ä¼‘æ¯æ¢å¤
                    </button>
                </div>

                <div style="background: #d1ecf1; padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 0.85em;">
                    <strong>ğŸ’ çŸ¿çŸ³ä»·å€¼ï¼š</strong>
                    ${Object.entries(data.ores).map(([name, ore]) =>
                `${name} ${ore.value}å…ƒ`
            ).join(' | ')}
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent = `ğŸ’° ${data.money}å…ƒ`;
        }

        // ========== 7. å® ç‰©åº—æ¸¸æˆ ==========
        function showPetGame(event) {
            showUniversalGame('pet', initPetGame);
        }

        function initPetGame() {
            document.getElementById('universalGameTitle').textContent = 'ğŸ¶ å® ç‰©åº—';

            universalGameData.gameData = {
                money: 0,
                pet: {
                    type: 'ğŸ¶',
                    name: 'æ—ºè´¢',
                    hunger: 50,
                    happiness: 50,
                    cleanliness: 50
                },
                customers: 0
            };

            renderPetUI();
        }

        function feedPet() {
            if (event) event.stopPropagation();
            const pet = universalGameData.gameData.pet;
            pet.hunger = Math.min(100, pet.hunger + 30);
            pet.happiness = Math.min(100, pet.happiness + 10);
            renderPetUI();
        }

        function playWithPet() {
            if (event) event.stopPropagation();
            const pet = universalGameData.gameData.pet;
            pet.happiness = Math.min(100, pet.happiness + 30);
            pet.hunger = Math.max(0, pet.hunger - 10);
            renderPetUI();
        }

        function bathePet() {
            if (event) event.stopPropagation();
            const pet = universalGameData.gameData.pet;
            pet.cleanliness = 100;
            pet.happiness = Math.min(100, pet.happiness + 10);
            renderPetUI();
        }

        function adoptPet() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const pet = data.pet;

            if (pet.hunger < 70 || pet.happiness < 70 || pet.cleanliness < 70) {
                alert('å® ç‰©çŠ¶æ€ä¸å¤Ÿå¥½ï¼Œæ²¡äººé¢†å…»ï¼éœ€è¦ä¸‰é¡¹éƒ½â‰¥70ï¼');
                return;
            }

            const price = Math.floor((pet.hunger + pet.happiness + pet.cleanliness) / 3);
            data.money += price;
            data.customers++;
            alert(`âœ… é¢†å…»æˆåŠŸï¼èµšäº† ${price} å…ƒï¼`);

            // é‡ç½®å® ç‰©
            pet.hunger = 50;
            pet.happiness = 50;
            pet.cleanliness = 50;
            renderPetUI();
        }

        function renderPetUI() {
            const data = universalGameData.gameData;
            const pet = data.pet;

            let html = `
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 5em;">${pet.type}</div>
                    <div style="font-size: 1.2em; margin-top: 10px;">${pet.name}</div>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="margin-bottom: 10px;">
                        <strong>ğŸ– é¥¥é¥¿åº¦ï¼š${pet.hunger}</strong>
                        <div style="background: #ddd; height: 15px; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                            <div style="background: ${pet.hunger > 50 ? '#28a745' : '#dc3545'}; height: 100%; width: ${pet.hunger}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>ğŸ˜Š å¿«ä¹åº¦ï¼š${pet.happiness}</strong>
                        <div style="background: #ddd; height: 15px; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                            <div style="background: ${pet.happiness > 50 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${pet.happiness}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div>
                        <strong>ğŸ› æ¸…æ´åº¦ï¼š${pet.cleanliness}</strong>
                        <div style="background: #ddd; height: 15px; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                            <div style="background: ${pet.cleanliness > 50 ? '#17a2b8' : '#dc3545'}; height: 100%; width: ${pet.cleanliness}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                    <button class="btn" onclick="feedPet()" style="background: #28a745;">ğŸ– å–‚é£Ÿ</button>
                    <button class="btn" onclick="playWithPet()" style="background: #ffc107;">ğŸ¾ ç©è€</button>
                    <button class="btn" onclick="bathePet()" style="background: #17a2b8;">ğŸ› æ´—æ¾¡</button>
                    <button class="btn" onclick="adoptPet()" style="background: #ff6b6b;">ğŸ’ é€å…»</button>
                </div>

                <div style="background: #d4edda; padding: 10px; border-radius: 10px; text-align: center; font-size: 0.9em;">
                    ğŸ’¡ ä¸‰é¡¹éƒ½â‰¥70æ‰èƒ½é€å…»ï¼
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent =
                `ğŸ’° ${data.money}å…ƒ | é€å…»: ${data.customers} åª`;
        }

        // ========== 8. ç¾æœ¯é¦†æ¸¸æˆ ==========
        function showArtGame(event) {
            showUniversalGame('art', initArtGame);
        }

        function initArtGame() {
            document.getElementById('universalGameTitle').textContent = 'ğŸ¨ ç¾æœ¯é¦†';

            universalGameData.gameData = {
                money: 0,
                fame: 0,
                currentPainting: {
                    colors: [],
                    value: 0
                }
            };

            renderArtUI();
        }

        function addColor(color) {
            if (event) event.stopPropagation();
            const painting = universalGameData.gameData.currentPainting;

            if (painting.colors.length >= 6) {
                alert('ç”»å¸ƒæ»¡äº†ï¼');
                return;
            }

            painting.colors.push(color);
            painting.value += 10;
            renderArtUI();
        }

        function sellPainting() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const painting = data.currentPainting;

            if (painting.colors.length === 0) {
                alert('è¿˜æ²¡å¼€å§‹ç”»ï¼');
                return;
            }

            const bonus = painting.colors.length >= 5 ? 50 : 0;
            const totalValue = painting.value + bonus + data.fame * 2;

            data.money += totalValue;
            data.fame += Math.floor(painting.colors.length / 2);

            alert(`ğŸ¨ å–äº† ${totalValue} å…ƒï¼${bonus > 0 ? 'è‰²å½©ä¸°å¯Œ+50ï¼' : ''}`);

            painting.colors = [];
            painting.value = 0;
            renderArtUI();
        }

        function clearCanvas() {
            if (event) event.stopPropagation();
            universalGameData.gameData.currentPainting = {
                colors: [],
                value: 0
            };
            renderArtUI();
        }

        function renderArtUI() {
            const data = universalGameData.gameData;
            const painting = data.currentPainting;

            let html = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 3px solid #333; min-height: 150px;">
                    <strong>ğŸ–¼ï¸ å½“å‰ç”»ä½œï¼š</strong><br>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; min-height: 60px;">
                        ${painting.colors.map(color =>
                `<div style="width: 50px; height: 50px; background: ${color}; border-radius: 5px; border: 2px solid #666;"></div>`
            ).join('')}
                    </div>
                    <div style="color: #666;">
                        ä»·å€¼ï¼š${painting.value + (painting.colors.length >= 5 ? 50 : 0) + data.fame * 2} å…ƒ
                        ${painting.colors.length >= 5 ? 'âœ¨(è‰²å½©ä¸°å¯Œ+50)' : ''}
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸ¨ è°ƒè‰²ç›˜ï¼š</strong><br>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px;">
                        <button class="btn" onclick="addColor('red')" style="background: red; color: white;">çº¢</button>
                        <button class="btn" onclick="addColor('blue')" style="background: blue; color: white;">è“</button>
                        <button class="btn" onclick="addColor('yellow')" style="background: yellow;">é»„</button>
                        <button class="btn" onclick="addColor('green')" style="background: green; color: white;">ç»¿</button>
                        <button class="btn" onclick="addColor('purple')" style="background: purple; color: white;">ç´«</button>
                        <button class="btn" onclick="addColor('orange')" style="background: orange;">æ©™</button>
                        <button class="btn" onclick="addColor('pink')" style="background: pink;">ç²‰</button>
                        <button class="btn" onclick="addColor('brown')" style="background: brown; color: white;">æ£•</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn" onclick="sellPainting()" style="background: #28a745;">ğŸ’° å–ç”»</button>
                    <button class="btn" onclick="clearCanvas()" style="background: #dc3545;">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>

                <div style="background: #d1ecf1; padding: 10px; border-radius: 10px; margin-top: 10px; text-align: center;">
                    â­ åæ°”ï¼š${data.fame} (æ¯å–ä¸€å¹…ç”»å¢åŠ åæ°”ï¼Œåæ°”è¶Šé«˜ç”»è¶Šå€¼é’±ï¼)
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent =
                `ğŸ’° ${data.money}å…ƒ | â­ ${data.fame} åæ°”`;
        }

        // ========== 9. åŒ»é™¢æ¸¸æˆï¼ˆé‡æ„ç‰ˆï¼‰==========
        function showHospitalGame(event) {
            showUniversalGame('hospital', initHospitalGame);
        }

        function initHospitalGame() {
            document.getElementById('universalGameTitle').textContent = 'ğŸ¥ åŒ»é™¢è¯Šç–—æ¨¡æ‹Ÿ';

            universalGameData.gameData = {
                money: 500,
                reputation: 100,
                patientsCured: 0,
                patientsDied: 0,
                currentPatient: null,
                stage: 'waiting', // waiting, examining, diagnosed, treating
                checkResults: {},
                diagnosis: null,
                treatmentProgress: 0,
                equipment: {
                    'ğŸŒ¡ï¸ä½“æ¸©è®¡': { owned: true, cost: 0, accuracy: 0.7 },
                    'ğŸ©ºå¬è¯Šå™¨': { owned: true, cost: 0, accuracy: 0.7 },
                    'ğŸ’‰æ³¨å°„å™¨': { owned: true, cost: 0, accuracy: 0.8 },
                    'ğŸ”¬æ˜¾å¾®é•œ': { owned: false, cost: 200, accuracy: 0.9 },
                    'ğŸ“·Xå…‰æœº': { owned: false, cost: 500, accuracy: 0.95 },
                    'ğŸ’Šè¯æŸœ': { owned: false, cost: 300, accuracy: 1.0 }
                },
                medicines: {
                    'ğŸ’ŠåŸºç¡€è¯å“': { owned: true, cost: 0, effectiveness: 0.6 },
                    'ğŸ’Šé«˜çº§è¯å“': { owned: false, cost: 150, effectiveness: 0.85 },
                    'ğŸ’‰ç‰¹æ•ˆé’ˆå‰‚': { owned: false, cost: 250, effectiveness: 1.0 }
                }
            };

            generateHospitalPatient();
        }

        function generateHospitalPatient() {
            const diseases = [
                {
                    name: 'æ™®é€šæ„Ÿå†’',
                    emoji: 'ğŸ¤§',
                    symptoms: ['æµé¼»æ¶•', 'è½»å¾®å‘çƒ­', 'å’³å—½'],
                    checkResults: { 'ğŸŒ¡ï¸ä½“æ¸©è®¡': '37.5â„ƒ è½»å¾®å‘çƒ­', 'ğŸ©ºå¬è¯Šå™¨': 'å‘¼å¸éŸ³æ­£å¸¸', 'ğŸ”¬æ˜¾å¾®é•œ': 'ç™½ç»†èƒæ­£å¸¸', 'ğŸ“·Xå…‰æœº': 'è‚ºéƒ¨æ­£å¸¸' },
                    correctTreatment: ['ğŸ’ŠåŸºç¡€è¯å“', 'è§‚å¯Ÿä¼‘æ¯'],
                    health: 80,
                    maxHealth: 100,
                    price: 100,
                    urgency: 'low'
                },
                {
                    name: 'é‡åº¦æµæ„Ÿ',
                    emoji: 'ğŸ¤’',
                    symptoms: ['é«˜çƒ§', 'å…¨èº«é…¸ç—›', 'ä¸¥é‡å’³å—½'],
                    checkResults: { 'ğŸŒ¡ï¸ä½“æ¸©è®¡': '39.5â„ƒ é«˜çƒ§ï¼', 'ğŸ©ºå¬è¯Šå™¨': 'è‚ºéƒ¨æœ‰æ‚éŸ³', 'ğŸ”¬æ˜¾å¾®é•œ': 'ç™½ç»†èƒåé«˜', 'ğŸ“·Xå…‰æœº': 'è‚ºéƒ¨è½»å¾®æ„ŸæŸ“' },
                    correctTreatment: ['ğŸ’Šé«˜çº§è¯å“', 'ğŸ’‰ç‰¹æ•ˆé’ˆå‰‚', 'è§‚å¯Ÿä¼‘æ¯'],
                    health: 50,
                    maxHealth: 100,
                    price: 200,
                    urgency: 'medium'
                },
                {
                    name: 'æ€¥æ€§è‚ºç‚',
                    emoji: 'ğŸ˜·',
                    symptoms: ['å‘¼å¸å›°éš¾', 'èƒ¸ç—›', 'é«˜çƒ§ä¸é€€'],
                    checkResults: { 'ğŸŒ¡ï¸ä½“æ¸©è®¡': '40â„ƒ å±é™©é«˜çƒ§ï¼', 'ğŸ©ºå¬è¯Šå™¨': 'è‚ºéƒ¨ä¸¥é‡æ‚éŸ³', 'ğŸ”¬æ˜¾å¾®é•œ': 'ç™½ç»†èƒä¸¥é‡è¶…æ ‡', 'ğŸ“·Xå…‰æœº': 'è‚ºéƒ¨ä¸¥é‡æ„ŸæŸ“' },
                    correctTreatment: ['ğŸ’‰ç‰¹æ•ˆé’ˆå‰‚', 'ğŸ’Šé«˜çº§è¯å“', 'ğŸ’ŠåŸºç¡€è¯å“'],
                    health: 30,
                    maxHealth: 100,
                    price: 350,
                    urgency: 'high'
                },
                {
                    name: 'èƒƒç‚',
                    emoji: 'ğŸ¤¢',
                    symptoms: ['è…¹ç—›', 'æ¶å¿ƒ', 'é£Ÿæ¬²ä¸æŒ¯'],
                    checkResults: { 'ğŸŒ¡ï¸ä½“æ¸©è®¡': '36.8â„ƒ æ­£å¸¸', 'ğŸ©ºå¬è¯Šå™¨': 'è‚ é¸£éŸ³å¼‚å¸¸', 'ğŸ”¬æ˜¾å¾®é•œ': 'èƒƒéƒ¨ç‚ç—‡', 'ğŸ“·Xå…‰æœº': 'èƒƒéƒ¨è½»å¾®ç—…å˜' },
                    correctTreatment: ['ğŸ’Šé«˜çº§è¯å“', 'è§‚å¯Ÿä¼‘æ¯'],
                    health: 70,
                    maxHealth: 100,
                    price: 150,
                    urgency: 'low'
                },
                {
                    name: 'éª¨æŠ˜',
                    emoji: 'ğŸ¤•',
                    symptoms: ['å‰§çƒˆç–¼ç—›', 'è‚¿èƒ€', 'æ— æ³•æ´»åŠ¨'],
                    checkResults: { 'ğŸŒ¡ï¸ä½“æ¸©è®¡': '37â„ƒ æ­£å¸¸', 'ğŸ©ºå¬è¯Šå™¨': 'æ— å¼‚å¸¸', 'ğŸ”¬æ˜¾å¾®é•œ': 'æ— æ„ŸæŸ“', 'ğŸ“·Xå…‰æœº': 'éª¨éª¼æ–­è£‚ï¼' },
                    correctTreatment: ['ğŸ’‰ç‰¹æ•ˆé’ˆå‰‚', 'æ‰‹æœ¯æ²»ç–—'],
                    health: 40,
                    maxHealth: 100,
                    price: 300,
                    urgency: 'high'
                }
            ];

            const disease = diseases[Math.floor(Math.random() * diseases.length)];
            universalGameData.gameData.currentPatient = {
                ...disease,
                timeLeft: disease.urgency === 'high' ? 30 : disease.urgency === 'medium' ? 45 : 60,
                maxTime: disease.urgency === 'high' ? 30 : disease.urgency === 'medium' ? 45 : 60
            };
            universalGameData.gameData.stage = 'examining';
            universalGameData.gameData.checkResults = {};
            universalGameData.gameData.diagnosis = null;
            universalGameData.gameData.treatmentProgress = 0;

            // å¼€å§‹å€’è®¡æ—¶
            if (universalGameData.gameInterval) clearInterval(universalGameData.gameInterval);
            universalGameData.gameInterval = setInterval(updatePatientCondition, 1000);

            renderHospitalUI();
        }

        function updatePatientCondition() {
            const patient = universalGameData.gameData.currentPatient;
            if (!patient) return;

            patient.timeLeft--;

            // ç—…æƒ…æ¶åŒ–
            if (universalGameData.gameData.stage !== 'treating') {
                if (patient.urgency === 'high') {
                    patient.health -= 2;
                } else if (patient.urgency === 'medium') {
                    patient.health -= 1;
                }
            }

            // ç—…äººæ­»äº¡
            if (patient.health <= 0 || patient.timeLeft <= 0) {
                clearInterval(universalGameData.gameInterval);
                universalGameData.gameData.patientsDied++;
                universalGameData.gameData.reputation -= 20;
                universalGameData.gameData.money -= 100;
                alert('âŒ ç—…äººæŠ¢æ•‘å¤±è´¥ï¼\nå£°èª‰-20ï¼Œèµ”å¿-100å…ƒ');
                generateHospitalPatient();
                return;
            }

            renderHospitalUI();
        }

        function useEquipment(equipName) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const equip = data.equipment[equipName];
            const patient = data.currentPatient;

            if (!equip.owned) {
                alert('è¿˜æ²¡è´­ä¹°è¿™ä¸ªè®¾å¤‡ï¼');
                return;
            }

            if (data.checkResults[equipName]) {
                alert('å·²ç»æ£€æŸ¥è¿‡äº†ï¼');
                return;
            }

            // æ ¹æ®è®¾å¤‡å‡†ç¡®åº¦éšæœºæ˜¾ç¤ºç»“æœ
            const result = Math.random() < equip.accuracy
                ? patient.checkResults[equipName]
                : 'æ£€æŸ¥ç»“æœä¸æ˜ç¡®';

            data.checkResults[equipName] = result;
            alert(`${equipName} æ£€æŸ¥å®Œæˆï¼š\n${result}`);
            renderHospitalUI();
        }

        function makeDiagnosis(diseaseName) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const patient = data.currentPatient;

            // è‡³å°‘è¦åš2é¡¹æ£€æŸ¥æ‰èƒ½è¯Šæ–­
            if (Object.keys(data.checkResults).length < 2) {
                alert('è¯·å…ˆåšè‡³å°‘2é¡¹æ£€æŸ¥ï¼');
                return;
            }

            data.diagnosis = diseaseName;

            if (diseaseName === patient.name) {
                alert('âœ… è¯Šæ–­æ­£ç¡®ï¼å¼€å§‹æ²»ç–—ï¼');
                data.stage = 'treating';
                data.treatmentProgress = 0;
            } else {
                alert('âŒ è¯Šæ–­é”™è¯¯ï¼ç—…æƒ…æ¶åŒ–ï¼');
                patient.health -= 20;
                data.reputation -= 10;
                data.diagnosis = null;
            }

            renderHospitalUI();
        }

        function applyTreatment(treatmentName) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const patient = data.currentPatient;

            if (data.stage !== 'treating') {
                alert('è¯·å…ˆå®Œæˆè¯Šæ–­ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰è¿™ä¸ªæ²»ç–—æ‰‹æ®µ
            if (treatmentName !== 'è§‚å¯Ÿä¼‘æ¯' && treatmentName !== 'æ‰‹æœ¯æ²»ç–—') {
                const medicine = data.medicines[treatmentName];
                if (!medicine || !medicine.owned) {
                    alert('æ²¡æœ‰è¿™ä¸ªè¯å“ï¼');
                    return;
                }
            }

            // åˆ¤æ–­æ²»ç–—æ˜¯å¦æ­£ç¡®
            if (patient.correctTreatment.includes(treatmentName)) {
                const effectiveness = treatmentName === 'è§‚å¯Ÿä¼‘æ¯' || treatmentName === 'æ‰‹æœ¯æ²»ç–—'
                    ? 0.3
                    : data.medicines[treatmentName].effectiveness;

                data.treatmentProgress += effectiveness * 100;
                patient.health = Math.min(patient.maxHealth, patient.health + 10);

                alert(`âœ… æ²»ç–—æœ‰æ•ˆï¼\nè¿›åº¦ï¼š${Math.floor(data.treatmentProgress)}%`);

                // æ²»ç–—å®Œæˆ
                if (data.treatmentProgress >= 100) {
                    clearInterval(universalGameData.gameInterval);

                    // æ ¹æ®å‰©ä½™æ—¶é—´è®¡ç®—å¥–åŠ±
                    const timeBonus = Math.floor(patient.timeLeft / patient.maxTime * 100);
                    const totalEarning = patient.price + timeBonus;

                    data.money += totalEarning;
                    data.patientsCured++;
                    data.reputation += 10;

                    alert(`ğŸ‰ æ²»æ„ˆæˆåŠŸï¼\nè·å¾—ï¼š${totalEarning}å…ƒ\nï¼ˆåŸºç¡€${patient.price} + é€Ÿåº¦å¥–åŠ±${timeBonus}ï¼‰\nå£°èª‰+10`);

                    generateHospitalPatient();
                }
            } else {
                alert('âŒ æ²»ç–—æ–¹æ¡ˆä¸å½“ï¼');
                patient.health -= 15;
                data.reputation -= 5;
            }

            renderHospitalUI();
        }

        function buyHospitalItem(category, itemName) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;
            const item = data[category][itemName];

            if (item.owned) {
                alert('å·²ç»æ‹¥æœ‰äº†ï¼');
                return;
            }

            if (data.money < item.cost) {
                alert(`é’±ä¸å¤Ÿï¼éœ€è¦ ${item.cost} å…ƒï¼`);
                return;
            }

            data.money -= item.cost;
            item.owned = true;
            alert(`âœ… è´­ä¹°æˆåŠŸï¼š${itemName}`);
            renderHospitalUI();
        }

        function renderHospitalUI() {
            const data = universalGameData.gameData;
            const patient = data.currentPatient;

            let html = '';

            // ç—…äººä¿¡æ¯åŒº
            if (patient) {
                const healthPercent = (patient.health / patient.maxHealth * 100).toFixed(0);
                const timePercent = (patient.timeLeft / patient.maxTime * 100).toFixed(0);
                const urgencyColor = patient.urgency === 'high' ? '#dc3545' : patient.urgency === 'medium' ? '#ffc107' : '#28a745';

                html += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <span style="font-size: 2.5em;">${patient.emoji}</span>
                                <strong style="font-size: 1.2em; margin-left: 10px;">${patient.name}</strong>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${urgencyColor}; font-weight: bold;">
                                    ${patient.urgency === 'high' ? 'âš ï¸ ç´§æ€¥' : patient.urgency === 'medium' ? 'âš¡ ä¸­ç­‰' : 'âœ“ ç¨³å®š'}
                                </div>
                                <div style="color: #28a745;">ğŸ’° ${patient.price}å…ƒ</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <strong>â¤ï¸ å¥åº·ï¼š${patient.health}/${patient.maxHealth}</strong>
                            <div style="background: #ddd; height: 15px; border-radius: 10px; overflow: hidden; margin-top: 3px;">
                                <div style="background: ${patient.health > 50 ? '#28a745' : '#dc3545'}; height: 100%; width: ${healthPercent}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <div>
                            <strong>â±ï¸ å‰©ä½™æ—¶é—´ï¼š${patient.timeLeft}ç§’</strong>
                            <div style="background: #ddd; height: 15px; border-radius: 10px; overflow: hidden; margin-top: 3px;">
                                <div style="background: ${urgencyColor}; height: 100%; width: ${timePercent}%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                            <strong>ğŸ” ç—‡çŠ¶ï¼š</strong>${patient.symptoms.join('ã€')}
                        </div>
                    </div>
                `;

                // æ£€æŸ¥é˜¶æ®µ
                if (data.stage === 'examining') {
                    html += `
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong>ğŸ”¬ ä½¿ç”¨è®¾å¤‡æ£€æŸ¥ï¼š</strong>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;">
                                ${Object.entries(data.equipment).map(([name, equip]) => `
                                    <button class="btn" onclick="useEquipment('${name}')" 
                                        style="background: ${equip.owned ? (data.checkResults[name] ? '#28a745' : '#007bff') : '#6c757d'}; font-size: 0.9em; padding: 8px;"
                                        ${!equip.owned ? 'disabled' : ''}>
                                        ${name} ${data.checkResults[name] ? 'âœ“' : ''}
                                        ${!equip.owned ? 'ğŸ”’' : ''}
                                    </button>
                                `).join('')}
                            </div>

                            ${Object.keys(data.checkResults).length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 5px; font-size: 0.9em;">
                                    <strong>ğŸ“‹ æ£€æŸ¥ç»“æœï¼š</strong><br>
                                    ${Object.entries(data.checkResults).map(([name, result]) =>
                        `â€¢ ${name}: ${result}`
                    ).join('<br>')}
                                </div>
                            ` : ''}
                        </div>

                        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong>ğŸ©º åšå‡ºè¯Šæ–­ï¼š</strong>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px;">
                                <button class="btn" onclick="makeDiagnosis('æ™®é€šæ„Ÿå†’')" style="background: #17a2b8;">æ™®é€šæ„Ÿå†’</button>
                                <button class="btn" onclick="makeDiagnosis('é‡åº¦æµæ„Ÿ')" style="background: #ffc107;">é‡åº¦æµæ„Ÿ</button>
                                <button class="btn" onclick="makeDiagnosis('æ€¥æ€§è‚ºç‚')" style="background: #dc3545;">æ€¥æ€§è‚ºç‚</button>
                                <button class="btn" onclick="makeDiagnosis('èƒƒç‚')" style="background: #28a745;">èƒƒç‚</button>
                                <button class="btn" onclick="makeDiagnosis('éª¨æŠ˜')" style="background: #6c757d;">éª¨æŠ˜</button>
                            </div>
                        </div>
                    `;
                }

                // æ²»ç–—é˜¶æ®µ
                if (data.stage === 'treating') {
                    html += `
                        <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong>ğŸ’Š è¿›è¡Œæ²»ç–—ï¼ˆè¯Šæ–­ï¼š${data.diagnosis}ï¼‰</strong>
                            <div style="margin: 10px 0;">
                                <strong>æ²»ç–—è¿›åº¦ï¼š${Math.floor(data.treatmentProgress)}%</strong>
                                <div style="background: #ddd; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                                    <div style="background: #28a745; height: 100%; width: ${data.treatmentProgress}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px;">
                                ${Object.entries(data.medicines).map(([name, med]) => `
                                    <button class="btn" onclick="applyTreatment('${name}')" 
                                        style="background: ${med.owned ? '#007bff' : '#6c757d'};"
                                        ${!med.owned ? 'disabled' : ''}>
                                        ${name} ${!med.owned ? 'ğŸ”’' : `(æ•ˆæœ${(med.effectiveness * 100).toFixed(0)}%)`}
                                    </button>
                                `).join('')}
                                <button class="btn" onclick="applyTreatment('è§‚å¯Ÿä¼‘æ¯')" style="background: #17a2b8;">ğŸ›ï¸ è§‚å¯Ÿä¼‘æ¯</button>
                                <button class="btn" onclick="applyTreatment('æ‰‹æœ¯æ²»ç–—')" style="background: #dc3545;">ğŸ”ª æ‰‹æœ¯æ²»ç–—</button>
                            </div>
                        </div>
                    `;
                }
            }

            // å•†åº—åŒº
            html += `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸª åŒ»ç–—å•†åº—</strong>
                    <div style="margin-top: 10px; font-size: 0.9em;">
                        <div style="margin-bottom: 8px;"><strong>è®¾å¤‡ï¼š</strong></div>
                        ${Object.entries(data.equipment).filter(([_, e]) => !e.owned).map(([name, equip]) => `
                            <button class="btn" onclick="buyHospitalItem('equipment', '${name}')" 
                                style="background: #ffc107; font-size: 0.85em; padding: 6px; margin: 2px;">
                                ${name} ${equip.cost}å…ƒ (å‡†ç¡®åº¦${(equip.accuracy * 100).toFixed(0)}%)
                            </button>
                        `).join('')}
                        ${Object.entries(data.equipment).every(([_, e]) => e.owned) ? '<span style="color: #999;">å…¨éƒ¨æ‹¥æœ‰</span>' : ''}
                        
                        <div style="margin: 8px 0;"><strong>è¯å“ï¼š</strong></div>
                        ${Object.entries(data.medicines).filter(([_, m]) => !m.owned).map(([name, med]) => `
                            <button class="btn" onclick="buyHospitalItem('medicines', '${name}')" 
                                style="background: #28a745; font-size: 0.85em; padding: 6px; margin: 2px;">
                                ${name} ${med.cost}å…ƒ (æ•ˆæœ${(med.effectiveness * 100).toFixed(0)}%)
                            </button>
                        `).join('')}
                        ${Object.entries(data.medicines).every(([_, m]) => m.owned) ? '<span style="color: #999;">å…¨éƒ¨æ‹¥æœ‰</span>' : ''}
                    </div>
                </div>

                <div style="background: #d1ecf1; padding: 10px; border-radius: 10px; font-size: 0.85em; text-align: center;">
                    ğŸ’¡ å…ˆç”¨è®¾å¤‡æ£€æŸ¥ â†’ åšå‡ºè¯Šæ–­ â†’ é€‰æ‹©æ²»ç–—æ–¹æ¡ˆï¼<br>
                    è´­ä¹°æ›´å¥½çš„è®¾å¤‡å’Œè¯å“å¯ä»¥æé«˜æˆåŠŸç‡ï¼
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent =
                `ğŸ’° ${data.money}å…ƒ | â­ ${data.reputation}å£°èª‰ | âœ… ${data.patientsCured}äºº | âŒ ${data.patientsDied}äºº`;
        }

        // ========== 10. é©¬æˆå›¢æ¸¸æˆ ==========
        function showCircusGame(event) {
            showUniversalGame('circus', initCircusGame);
        }

        function initCircusGame() {
            document.getElementById('universalGameTitle').textContent = 'ğŸª é©¬æˆå›¢';

            universalGameData.gameData = {
                money: 0,
                shows: 0,
                performance: []
            };

            renderCircusUI();
        }

        function addPerformance(act) {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (data.performance.length >= 5) {
                alert('èŠ‚ç›®å¤ªå¤šäº†ï¼');
                return;
            }

            data.performance.push(act);
            renderCircusUI();
        }

        function startShow() {
            if (event) event.stopPropagation();
            const data = universalGameData.gameData;

            if (data.performance.length < 3) {
                alert('è‡³å°‘éœ€è¦3ä¸ªèŠ‚ç›®ï¼');
                return;
            }

            const basePrice = data.performance.length * 30;
            const variety = new Set(data.performance).size;
            const varietyBonus = variety >= 4 ? 50 : 0;
            const totalEarnings = basePrice + varietyBonus;

            data.money += totalEarnings;
            data.shows++;

            alert(`ğŸª æ¼”å‡ºæˆåŠŸï¼èµšäº† ${totalEarnings} å…ƒï¼${varietyBonus > 0 ? '\nèŠ‚ç›®ä¸°å¯Œ+50ï¼' : ''}`);

            data.performance = [];
            renderCircusUI();
        }

        function clearPerformance() {
            if (event) event.stopPropagation();
            universalGameData.gameData.performance = [];
            renderCircusUI();
        }

        function renderCircusUI() {
            const data = universalGameData.gameData;

            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <strong style="font-size: 1.2em;">ğŸª ä»Šæ—¥èŠ‚ç›®å•ï¼š</strong><br>
                    <div style="font-size: 1.5em; margin: 15px 0; min-height: 60px;">
                        ${data.performance.length > 0 ? data.performance.join(' â†’ ') : 'è¿˜æ²¡å®‰æ’èŠ‚ç›®'}
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.9;">
                        èŠ‚ç›®æ•°ï¼š${data.performance.length}/5 | 
                        é¢„è®¡æ”¶å…¥ï¼š${data.performance.length * 30 + (new Set(data.performance).size >= 4 ? 50 : 0)}å…ƒ
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>ğŸ­ é€‰æ‹©èŠ‚ç›®ï¼š</strong><br>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                        <button class="btn" onclick="addPerformance('ğŸ¤¹æ‚è€')" style="background: #ff6b6b;">ğŸ¤¹ æ‚è€</button>
                        <button class="btn" onclick="addPerformance('ğŸªé­”æœ¯')" style="background: #4ecdc4;">ğŸª é­”æœ¯</button>
                        <button class="btn" onclick="addPerformance('ğŸ¦é©¯å…½')" style="background: #feca57;">ğŸ¦ é©¯å…½</button>
                        <button class="btn" onclick="addPerformance('ğŸ¯é£åˆ€')" style="background: #a29bfe;">ğŸ¯ é£åˆ€</button>
                        <button class="btn" onclick="addPerformance('ğŸªå°ä¸‘')" style="background: #fd79a8;">ğŸª å°ä¸‘</button>
                        <button class="btn" onclick="addPerformance('ğŸ æ—‹è½¬æœ¨é©¬')" style="background: #74b9ff;">ğŸ  æœ¨é©¬</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn" onclick="startShow()" style="background: #28a745; font-size: 1.1em; padding: 12px;">
                        ğŸ‰ å¼€å§‹æ¼”å‡º
                    </button>
                    <button class="btn" onclick="clearPerformance()" style="background: #dc3545;">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>

                <div style="background: #d1ecf1; padding: 10px; border-radius: 10px; margin-top: 10px; text-align: center; font-size: 0.9em;">
                    ğŸ’¡ è‡³å°‘3ä¸ªèŠ‚ç›®æ‰èƒ½æ¼”å‡ºï¼èŠ‚ç›®ç§ç±»è¶Šå¤šï¼Œæ”¶å…¥è¶Šé«˜ï¼
                </div>
            `;

            document.getElementById('universalGameContent').innerHTML = html;
            document.getElementById('universalGameScore').textContent =
                `ğŸ’° ${data.money}å…ƒ | æ¼”å‡º: ${data.shows} åœº`;
        }

        document.body.addEventListener('click', handleClick);
        document.body.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && gameState !== 'timer' && gameState !== 'math') {
                e.preventDefault();
                handleClick();
            }
            if (e.code === 'Enter' && gameState === 'math') {
                e.preventDefault();
                submitAnswer();
            }
        });
    </script>
</body>

</html>