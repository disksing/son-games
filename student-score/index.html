<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Â≠¶ÁîüÁßØÂàÜÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* ÂÖ®Áè≠ÁªüËÆ° - Âè≥‰∏äËßí */
        .class-stats {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            min-width: 120px;
        }

        .class-stats .stats-title {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .class-stats .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .class-stats .stats-row .label {
            color: #666;
        }

        .class-stats .stats-row .value {
            font-weight: bold;
        }

        .class-stats .stats-row .value.total {
            color: #667eea;
        }

        .class-stats .stats-row .value.added {
            color: #2b8a3e;
        }

        .class-stats .stats-row .value.subtracted {
            color: #c92a2a;
        }

        .class-stats .exchange-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .class-stats .exchange-row .coin-icon {
            width: 24px;
            height: 24px;
            margin-right: 6px;
        }

        .class-stats .exchange-row .exchange-value {
            font-size: 18px;
            font-weight: bold;
            color: #f59f00;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* ÈáëÂ∏ÅSVGÊ†∑Âºè */
        .coin-svg {
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3));
        }

        .students-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .student-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100px;
        }

        .student-card:active {
            transform: scale(0.95);
        }

        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            border: 3px solid white;
            overflow: hidden;
        }

        .avatar svg {
            width: 100%;
            height: 100%;
        }

        .avatar .score-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            background: #ff6b6b;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 22px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .avatar .score-badge.positive {
            background: #51cf66;
        }

        .student-name {
            margin-top: 6px;
            color: white;
            font-size: 13px;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .student-stats {
            margin-top: 5px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        .student-stats .total {
            font-weight: bold;
            color: #ffd43b;
            margin-right: 3px;
        }

        .student-stats .added {
            color: #8ce99a;
            margin-right: 3px;
        }

        .student-stats .subtracted {
            color: #ffa8a8;
        }

        .student-exchange {
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .student-exchange .coin-icon {
            width: 16px;
            height: 16px;
            margin-right: 3px;
        }

        .student-exchange .exchange-num {
            font-size: 13px;
            font-weight: bold;
            color: #ffd43b;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Ê∑ªÂä†Â≠¶ÁîüÊåâÈíÆ */
        .add-student {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 100px;
        }

        .add-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px dashed rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s;
        }

        .add-student:active .add-avatar {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        .add-label {
            margin-top: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }

        /* ÂºπÁ™óÈÅÆÁΩ© */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 24px;
            padding: 30px 25px;
            width: 90%;
            max-width: 360px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border: none;
            background: #f1f1f1;
            border-radius: 50%;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #e0e0e0;
        }

        .modal h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 22px;
        }

        /* ËæìÂÖ•Ê°Ü */
        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 18px;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            border-color: #667eea;
        }

        /* ÊÄßÂà´ÈÄâÊã© */
        .gender-select {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .gender-btn {
            flex: 1;
            padding: 20px;
            border-radius: 16px;
            border: 3px solid #e0e0e0;
            background: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .gender-btn:active {
            transform: scale(0.98);
        }

        .gender-btn.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .gender-btn .icon {
            font-size: 50px;
            margin-bottom: 8px;
        }

        .gender-btn .label {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        /* ÊåâÈíÆ */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-cancel {
            background: #f1f1f1;
            color: #666;
            margin-top: 12px;
        }

        /* ÁßØÂàÜÊìç‰ΩúËèúÂçï */
        .score-menu {
            text-align: center;
        }

        .score-menu .student-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .score-menu .student-info .avatar-display {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .score-menu .student-info .avatar-display svg {
            width: 100%;
            height: 100%;
        }

        .score-menu .student-info .name {
            margin-top: 12px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .score-menu .student-info .current-score {
            margin-top: 8px;
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .score-section {
            margin-bottom: 18px;
        }

        .score-section h3 {
            font-size: 15px;
            color: #666;
            margin-bottom: 12px;
        }

        .score-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .score-btn {
            padding: 14px 8px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .score-btn:active {
            transform: scale(0.9);
        }

        .score-btn.add {
            background: #d3f9d8;
            color: #2b8a3e;
        }

        .score-btn.sub {
            background: #ffe3e3;
            color: #c92a2a;
        }

        /* ÁßØÂàÜÂçï‰ΩçËæìÂÖ• */
        .score-unit-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 12px 0 8px;
        }

        .score-unit-row .unit-label {
            font-size: 14px;
            color: #666;
            font-weight: 700;
            white-space: nowrap;
        }

        .score-unit-row input {
            flex: 1;
            min-width: 140px;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            text-align: center;
        }

        .score-unit-row input:focus {
            border-color: #667eea;
        }

        .score-unit-row .unit-reset {
            padding: 10px 12px;
            border: none;
            border-radius: 12px;
            background: #f1f1f1;
            color: #666;
            font-weight: 800;
            cursor: pointer;
        }

        .score-unit-hint {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
            text-align: center;
        }

        .score-btn.score-input-btn {
            background: #e7f5ff;
            color: #1c7ed6;
        }

        .score-input-preview {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin: 10px 0 18px;
        }

        .score-input-preview .value {
            font-weight: 800;
            color: #333;
        }

        .exchange-input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 18px;
            outline: none;
            text-align: center;
        }

        .exchange-input-group input:focus {
            border-color: #ffd43b;
        }

        .exchange-input-group .btn-exchange {
            padding: 12px 24px;
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #333;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }


        /* Âä®ÁîªÊïàÊûú */
        @keyframes scorePopup {
            0% {
                transform: scale(0.5) translateY(0);
                opacity: 1;
            }

            100% {
                transform: scale(1.5) translateY(-40px);
                opacity: 0;
            }
        }

        .score-popup {
            position: fixed;
            font-size: 36px;
            font-weight: bold;
            pointer-events: none;
            animation: scorePopup 0.8s ease-out forwards;
            z-index: 2000;
        }

        .score-popup.positive {
            color: #51cf66;
        }

        .score-popup.negative {
            color: #ff6b6b;
        }

        /* ÂÖëÊç¢ÊàêÂäüÂä®Áîª */
        @keyframes exchangeSuccess {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .exchange-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 35px 55px;
            border-radius: 24px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 3000;
            animation: exchangeSuccess 0.5s ease-out;
        }

        .exchange-success .icon {
            font-size: 70px;
            margin-bottom: 15px;
        }

        .exchange-success .text {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        /* Â∫ïÈÉ®ÂØºËà™Ê†è */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 20px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px 20px;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .nav-btn:active {
            background: #f0f0f0;
            transform: scale(0.95);
        }

        .nav-btn .nav-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 4px;
        }

        .nav-btn .nav-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        /* ÂïÜÂ∫óÂºπÁ™ó */
        .shop-modal .modal {
            max-width: 400px;
            padding: 20px;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .shop-item {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .shop-item:active {
            transform: scale(0.98);
            border-color: #667eea;
        }

        .shop-item .item-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
        }

        .shop-item .item-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .shop-item .item-price {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #f59f00;
        }

        .shop-item .item-price .coin-icon {
            width: 18px;
            height: 18px;
            margin-right: 4px;
        }

        /* ÂÖ®Â±èÊàøÈó¥ */
        .fullscreen-room {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
        }

        .fullscreen-room.active {
            display: block;
        }

        /* 3DÁ´ã‰ΩìÂÆ§ÂÜÖÂú∫ÊôØ */
        .room-indoor {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            perspective: 800px;
            background: #1a1a2e;
        }

        /* 3DÊàøÈó¥ÂÆπÂô® */
        .room-3d {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }

        /* Âú∞Êùø - 3DÈÄèËßÜ */
        .room-floor {
            position: absolute;
            bottom: 0;
            left: -20%;
            width: 140%;
            height: 45%;
            background: linear-gradient(180deg, #8B6914 0%, #5D4E37 100%);
            transform: rotateX(60deg);
            transform-origin: bottom center;
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.3);
        }

        /* Âú∞ÊùøÊ†ºÂ≠êÁ∫πÁêÜ */
        .room-floor::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(90deg, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* ÂêéÂ¢ô */
        .room-back-wall {
            position: absolute;
            top: 5%;
            left: 10%;
            width: 80%;
            height: 50%;
            background: linear-gradient(180deg, #ffecd2 0%, #e8c9a0 100%);
            border: 8px solid #8B4513;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.1);
        }

        /* Â∑¶Â¢ô */
        .room-left-wall {
            position: absolute;
            top: 5%;
            left: 0;
            width: 10%;
            height: 50%;
            background: linear-gradient(90deg, #d4a574 0%, #e8c9a0 100%);
            transform: skewY(-10deg);
            transform-origin: top right;
        }

        /* Âè≥Â¢ô */
        .room-right-wall {
            position: absolute;
            top: 5%;
            right: 0;
            width: 10%;
            height: 50%;
            background: linear-gradient(270deg, #d4a574 0%, #e8c9a0 100%);
            transform: skewY(10deg);
            transform-origin: top left;
        }

        /* Èó® */
        .room-door {
            position: absolute;
            bottom: 0;
            right: 12%;
            width: 15%;
            max-width: 80px;
            height: 45%;
            background: linear-gradient(180deg, #654321 0%, #3d2510 100%);
            border: 4px solid #2d1a0a;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 50;
        }

        .room-door:hover {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .room-door::before {
            content: 'üö™';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
        }

        .room-door::after {
            content: 'Ëµ∞Âà∞ËøôÈáåÂá∫Èó®';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #ffd43b;
            white-space: nowrap;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Èó®ÊääÊâã */
        .door-handle {
            position: absolute;
            top: 50%;
            right: 15%;
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        /* ÊüúÂ≠ê - 3DÊïàÊûú */
        .room-cabinet-3d {
            position: absolute;
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            max-width: 350px;
            z-index: 40;
        }

        .cabinet-top {
            background: linear-gradient(180deg, #5D3A1A 0%, #4a2e15 100%);
            height: 15px;
            border-radius: 8px 8px 0 0;
            transform: perspective(200px) rotateX(-5deg);
            transform-origin: bottom;
        }

        .cabinet-body {
            background: linear-gradient(180deg, #654321 0%, #3d2510 100%);
            padding: 15px;
            border: 3px solid #2d1a0a;
            border-top: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .cabinet-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .cabinet-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .cabinet-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            border-color: #ffd43b;
        }

        .cabinet-item .item-icon {
            width: 35px;
            height: 35px;
        }

        .cabinet-item .item-count {
            font-size: 10px;
            color: #ffd43b;
            font-weight: bold;
        }

        /* ÂÆ§ÂÜÖÁé©ÂÆ∂ */
        .indoor-player {
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: 100;
            transition: all 0.15s ease-out;
        }

        .indoor-player .avatar-wrap {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* ====== 3DÁ´ã‰ΩìÂÆ§Â§ñÂú∫ÊôØ ====== */
        .room-outdoor {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            perspective: 1200px;
        }

        /* Â§©Á©∫ */
        .outdoor-sky {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 45%;
            background: linear-gradient(180deg, #4a90d9 0%, #87ceeb 50%, #b0e0e6 100%);
        }

        /* Â§™Èò≥ */
        .outdoor-sun {
            position: absolute;
            top: 8%;
            right: 15%;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #fff700 0%, #ffa500 100%);
            border-radius: 50%;
            box-shadow: 0 0 60px #ffa500, 0 0 100px #ff8c00;
        }

        /* ‰∫ëÊúµ */
        .outdoor-cloud {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.9;
        }

        .cloud1 {
            top: 10%;
            left: 10%;
            width: 80px;
            height: 30px;
            box-shadow: 25px -10px 0 10px white, 50px 0 0 5px white;
        }

        .cloud2 {
            top: 18%;
            left: 60%;
            width: 60px;
            height: 25px;
            box-shadow: 20px -8px 0 8px white, 40px 0 0 4px white;
        }

        /* 3DËçâÂú∞ */
        .outdoor-ground-3d {
            position: absolute;
            bottom: 0;
            left: -30%;
            width: 160%;
            height: 60%;
            background: linear-gradient(180deg, #7cba4f 0%, #5a9a32 50%, #4a8830 100%);
            transform: rotateX(65deg);
            transform-origin: bottom center;
        }

        /* ËçâÂú∞Á∫πÁêÜ */
        .outdoor-ground-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: radial-gradient(circle, rgba(100, 180, 70, 0.5) 2px, transparent 2px);
            background-size: 20px 20px;
        }

        /* Â∞èË∑Ø */
        .garden-path {
            position: absolute;
            bottom: 0;
            left: 45%;
            width: 10%;
            height: 100%;
            background: linear-gradient(90deg, #c9a66b 0%, #d4b07a 50%, #c9a66b 100%);
            transform: rotateX(65deg);
            transform-origin: bottom center;
        }

        /* ÊàøÂ≠êÂÖ•Âè£ */
        .house-entrance {
            position: absolute;
            bottom: 55%;
            left: 42%;
            width: 16%;
            max-width: 100px;
            height: 25%;
            background: linear-gradient(180deg, #8B4513 0%, #654321 100%);
            border: 4px solid #3d2510;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            z-index: 50;
        }

        .house-entrance::before {
            content: 'üè†';
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 35px;
        }

        .house-entrance::after {
            content: 'ÂõûÊàøÈó¥';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #ffd43b;
            background: rgba(0, 0, 0, 0.6);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Âñ∑Ê≥â */
        .fountain {
            position: absolute;
            bottom: 38%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
        }

        .fountain-base {
            width: 80px;
            height: 25px;
            background: linear-gradient(180deg, #708090 0%, #4a5568 100%);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .fountain-pillar {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 40px;
            background: linear-gradient(90deg, #708090 0%, #a0aec0 50%, #708090 100%);
        }

        .fountain-top {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 15px;
            background: linear-gradient(180deg, #a0aec0 0%, #708090 100%);
            border-radius: 50%;
        }

        .fountain-water {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 30px;
            background: linear-gradient(180deg, rgba(135, 206, 250, 0.8) 0%, rgba(135, 206, 250, 0) 100%);
            animation: waterSpray 1s ease-in-out infinite;
        }

        @keyframes waterSpray {

            0%,
            100% {
                height: 25px;
                opacity: 0.8;
            }

            50% {
                height: 35px;
                opacity: 1;
            }
        }

        .water-drops {
            position: absolute;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 20px;
        }

        .water-drop {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(135, 206, 250, 0.8);
            border-radius: 50%;
            animation: dropFall 1s ease-in infinite;
        }

        .water-drop:nth-child(1) {
            left: 0;
            animation-delay: 0s;
        }

        .water-drop:nth-child(2) {
            left: 13px;
            animation-delay: 0.3s;
        }

        .water-drop:nth-child(3) {
            left: 26px;
            animation-delay: 0.6s;
        }

        @keyframes dropFall {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(40px);
                opacity: 0;
            }
        }

        /* Ê≤ôÂùë */
        .sandbox-3d {
            position: absolute;
            bottom: 25%;
            right: 12%;
            width: 100px;
            height: 50px;
            z-index: 55;
        }

        .sandbox-pit {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #f4d03f 0%, #dab32a 100%);
            border-radius: 50%;
            border: 5px solid #8B4513;
            box-shadow: inset 0 -15px 25px rgba(0, 0, 0, 0.3), 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .sandbox-hint {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #ffd43b;
            background: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        /* Ê†ëÊú® */
        .tree {
            position: absolute;
            z-index: 50;
        }

        .tree-trunk {
            width: 15px;
            height: 40px;
            background: linear-gradient(90deg, #5D4E37 0%, #8B7355 50%, #5D4E37 100%);
            margin: 0 auto;
        }

        .tree-leaves {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #228B22 0%, #006400 100%);
            border-radius: 50%;
            margin-top: -10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .tree1 {
            bottom: 30%;
            left: 8%;
        }

        .tree2 {
            bottom: 35%;
            left: 18%;
            transform: scale(0.8);
        }

        .tree3 {
            bottom: 32%;
            right: 25%;
            transform: scale(0.9);
        }

        /* Ëä±Êúµ */
        .flower {
            position: absolute;
            z-index: 45;
        }

        .flower::before {
            content: 'üå∏';
            font-size: 20px;
        }

        .flower1 {
            bottom: 22%;
            left: 25%;
        }

        .flower2 {
            bottom: 20%;
            left: 35%;
        }

        .flower3 {
            bottom: 23%;
            right: 30%;
        }

        .flower4 {
            bottom: 18%;
            right: 22%;
        }

        /* Áé©ÂÆ∂ËßíËâ≤ */
        .player {
            position: absolute;
            width: 50px;
            height: 50px;
            z-index: 100;
            transition: all 0.12s ease-out;
        }

        .player .avatar-wrap {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        /* ËôöÊãüÊëáÊùÜ */
        .virtual-joystick {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 400;
            display: none;
            touch-action: none;
        }

        .virtual-joystick.active {
            display: block;
        }

        .joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.4);
        }

        .joystick-knob {
            position: absolute;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(200,200,200,0.9) 100%);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        /* È£ûÊú∫Â∞èÂè∑ËôöÊãüÊëáÊùÜÔºàÈ£ûË°åÊ®°ÂºèÊåáÁ§∫Âô®Ôºâ */
        .plane-joystick {
            position: absolute;
            bottom: 20px;
            left: 160px;  /* ÊîæÂú®ÊôÆÈÄöÊëáÊùÜÂè≥Ëæπ */
            width: 80px;
            height: 80px;
            z-index: 500;
            display: none;
            touch-action: none;
        }

        .plane-joystick.active {
            display: block;
        }

        .plane-joystick .joystick-base {
            background: rgba(255, 100, 100, 0.2);
            border: 2px solid rgba(255, 100, 100, 0.5);
        }

        .plane-joystick .joystick-knob {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
            box-shadow: 0 3px 10px rgba(201, 42, 42, 0.4);
        }

        /* È£ûÊú∫ÊéßÂà∂Èù¢Êùø */
        .plane-control-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: none;
            flex-direction: row;
            gap: 10px;
            z-index: 500;
        }

        .plane-control-panel.active {
            display: flex;
        }

        .plane-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            white-space: nowrap;
        }

        .plane-btn:hover {
            transform: scale(1.05);
        }

        .plane-btn.hover-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .plane-btn.land-btn {
            background: linear-gradient(135deg, #51cf66 0%, #2b8a3e 100%);
            color: white;
        }

        .plane-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ÂÆ§ÂÜÖÈ£ûÊú∫ */
        .indoor-plane {
            position: absolute;
            width: 60px;
            height: 40px;
            z-index: 150;
            transition: none;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));
        }

        .indoor-plane.flying {
            animation: planeTilt 0.5s ease-in-out infinite alternate;
        }

        /* Âù†ÊØÅÊïàÊûú */
        .crash-effect {
            position: absolute;
            font-size: 40px;
            animation: crashBounce 0.5s ease-out;
            z-index: 200;
        }

        @keyframes crashBounce {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); opacity: 0.8; }
        }

        /* Ë≠¶ÂëäÊèêÁ§∫ÔºàÂ∏¶‰∏âËßíÊù°ÂíåËøõÂ∫¶Ôºâ */
        .plane-warning-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: stretch;
            z-index: 10000;
            animation: warningSlideIn 0.3s ease-out;
        }

        @keyframes warningSlideIn {
            from { transform: translateX(-50%) scale(0.8); opacity: 0; }
            to { transform: translateX(-50%) scale(1); opacity: 1; }
        }

        @keyframes warningSlideOut {
            from { transform: translateX(-50%) scale(1); opacity: 1; }
            to { transform: translateX(-50%) scale(0.8); opacity: 0; }
        }

        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
        }

        .warning-arrow {
            width: 0;
            height: 0;
            border-top: 25px solid transparent;
            border-bottom: 25px solid transparent;
            border-right: 35px solid #ff0000;
            filter: drop-shadow(2px 0 4px rgba(0,0,0,0.3));
            align-self: center;
        }

        .warning-message {
            background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
            white-space: nowrap;
            display: flex;
            align-items: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Áé©ÂÆ∂ÂæΩÁ´† */
        .player-badges {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }

        .player-badges .badge {
            width: 25px;
            height: 25px;
            animation: badgeBounce 2s ease-in-out infinite;
        }

        @keyframes badgeBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        /* ÈÅ•ÊéßÈ£ûÊú∫ */
        .rc-plane {
            position: absolute;
            width: 70px;
            height: 50px;
            z-index: 200;
            transition: all 0.08s linear;
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.3));
        }

        .rc-plane.flying {
            animation: planeTilt 0.5s ease-in-out infinite alternate;
        }

        @keyframes planeTilt {
            0% {
                transform: rotate(-3deg);
            }

            100% {
                transform: rotate(3deg);
            }
        }

        /* ÊàøÈó¥UI */
        .room-ui {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 300;
        }

        .room-back-btn {
            padding: 12px 24px;
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .room-back-btn:hover {
            transform: scale(1.05);
        }

        .room-student-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .room-student-info .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .room-student-info .name {
            font-weight: bold;
            color: #333;
        }

        /* Êê∫Â∏¶Áâ©ÂìÅÊ†è */
        .carry-items {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 300;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .carry-item {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .carry-item:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .carry-item.active {
            background: rgba(255, 215, 0, 0.4);
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .carry-item .item-icon {
            width: 32px;
            height: 32px;
        }

        /* Êìç‰ΩúÊèêÁ§∫ */
        .control-hint {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 13px;
            z-index: 300;
            text-align: center;
            line-height: 1.5;
        }

        /* Âú∞ÂõæÂºπÁ™ó */
        .map-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            z-index: 500;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .map-modal.active {
            display: block;
        }

        .map-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .map-content {
            background: linear-gradient(180deg, #7cba4f 0%, #5a9a32 100%);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            min-height: 200px;
        }

        .map-item {
            position: absolute;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 8px;
        }

        .map-fountain {
            top: 40%;
            left: 45%;
        }

        .map-sandbox {
            top: 30%;
            right: 15%;
        }

        .map-house {
            top: 10%;
            left: 40%;
        }

        .map-you {
            background: #ffd700 !important;
            font-weight: bold;
        }

        /* Èõ®Â§©ÊïàÊûú */
        .rain-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 180;
            overflow: hidden;
        }

        .raindrop {
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(180deg, transparent 0%, rgba(174, 194, 224, 0.8) 100%);
            animation: rainFall 0.5s linear infinite;
        }

        @keyframes rainFall {
            0% {
                transform: translateY(-20px);
            }

            100% {
                transform: translateY(100vh);
            }
        }

        /* Èõ®Â§©ÊèêÁ§∫ */
        .weather-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 20px;
            z-index: 500;
            text-align: center;
        }

        .weather-warning .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .weather-warning .text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .weather-warning .countdown {
            font-size: 48px;
            font-weight: bold;
            color: #ff6b6b;
        }

        /* Ê∑ãÊπøÊïàÊûú */
        .got-wet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(74, 144, 226, 0.5);
            z-index: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .got-wet-overlay .icon {
            font-size: 80px;
            animation: shake 0.5s ease-in-out infinite;
        }

        .got-wet-overlay .text {
            font-size: 24px;
            color: white;
            margin-top: 20px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Êâì‰ºûÁä∂ÊÄÅ */
        .player-with-umbrella::after {
            content: '‚òÇÔ∏è';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
        }

        /* Â§©Ê∞îÊòæÁ§∫ */
        .weather-display {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 200;
        }

        .map-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Âú∫ÊôØÈÄâÊã©ÊåâÈíÆ */
        .scene-select-btn {
            position: absolute;
            bottom: 8%;
            right: 5%;
            padding: 10px 15px;
            background: linear-gradient(180deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            z-index: 60;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .scene-select-btn:hover {
            transform: scale(1.05);
        }

        /* Âú∫ÊôØÈÄâÊã©ÂºπÁ™ó */
        .scene-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 400;
            overflow-y: auto;
            padding: 20px;
        }

        .scene-modal.active {
            display: block;
        }

        .scene-modal-content {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
        }

        .scene-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .scene-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .scene-modal-close {
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .scene-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 5px;
        }

        .scene-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            border: 3px solid transparent;
        }

        .scene-item:hover {
            transform: scale(1.05);
        }

        .scene-item.active {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .scene-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .scene-item.locked::after {
            content: 'üîí';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }

        .scene-preview {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .scene-sky {
            height: 40%;
        }

        .scene-ground {
            height: 60%;
        }

        .scene-number {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        .scene-info {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .scene-info-text {
            font-size: 14px;
            color: #666;
        }

        .scene-info-count {
            font-size: 18px;
            font-weight: bold;
            color: #9b59b6;
            margin-top: 5px;
        }

        /* ÁïôÂá∫Â∫ïÈÉ®ÂØºËà™Ê†èÁ©∫Èó¥ */
        .students-grid {
            padding-bottom: 100px;
        }

        /* ËÆ∞ÂΩïÊåâÈíÆ */
        .record-btn {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 28px;
            height: 28px;
            background: #667eea;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .class-stats {
            position: fixed;
            top: 15px;
            right: 15px;
        }

        /* ËÆ∞ÂΩïË°®ÂºπÁ™ó */
        .record-modal .modal {
            max-width: 400px;
            max-height: 80vh;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background: #f8f9fa;
            margin-bottom: 8px;
        }

        .record-item .record-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 18px;
        }

        .record-item .record-icon.add {
            background: #d3f9d8;
        }

        .record-item .record-icon.sub {
            background: #ffe3e3;
        }

        .record-item .record-icon.buy {
            background: #fff3bf;
        }

        .record-item .record-info {
            flex: 1;
        }

        .record-item .record-info .record-text {
            font-size: 14px;
            color: #333;
        }

        .record-item .record-info .record-time {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }

        .record-item .record-delete {
            width: 28px;
            height: 28px;
            background: #ffe3e3;
            border: none;
            border-radius: 50%;
            color: #c92a2a;
            cursor: pointer;
            font-size: 14px;
        }

        .record-empty {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        /* ÂØÜÁ†ÅÂºπÁ™ó */
        .password-modal .modal {
            max-width: 300px;
            text-align: center;
        }

        .password-modal .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 20px;
            text-align: center;
            letter-spacing: 8px;
            margin: 20px 0;
        }

        .password-modal .password-input:focus {
            border-color: #667eea;
            outline: none;
        }

        /* ÈÄâÊã©Â≠¶ÁîüÂºπÁ™ó */
        .select-student-modal .modal {
            max-width: 360px;
        }

        .select-student-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .select-student-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            margin-bottom: 8px;
            background: #f8f9fa;
        }

        .select-student-item:active {
            transform: scale(0.98);
        }

        .select-student-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .select-student-item:not(.disabled):hover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .select-student-item .student-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .select-student-item .student-avatar svg {
            width: 100%;
            height: 100%;
        }

        .select-student-item .student-info {
            flex: 1;
        }

        .select-student-item .student-info .name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .select-student-item .student-info .score {
            font-size: 14px;
            color: #667eea;
            font-weight: bold;
        }

        .select-student-item .student-info .not-enough {
            font-size: 12px;
            color: #c92a2a;
        }

        .purchase-item-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .purchase-item-preview .item-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }

        .purchase-item-preview .item-details .item-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .purchase-item-preview .item-details .item-price {
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: #f59f00;
            margin-top: 4px;
        }

        .purchase-item-preview .item-details .item-price .coin-icon {
            width: 16px;
            height: 16px;
            margin-right: 4px;
        }
    </style>
</head>

<body>
    <!-- ÂÖ®Áè≠ÁªüËÆ° - Âè≥‰∏äËßí -->
    <div class="class-stats" id="classStats">
        <button class="record-btn" onclick="openPasswordModal()">üìã</button>
        <div class="stats-title">üìä ÂÖ®Áè≠ÁªüËÆ°</div>
        <div class="stats-row">
            <span class="label">ÊÄªÂàÜ</span>
            <span class="value total" id="classTotalScore">0</span>
        </div>
        <div class="stats-row">
            <span class="label">Âä†ÂàÜ</span>
            <span class="value added" id="classTotalAdded">+0</span>
        </div>
        <div class="stats-row">
            <span class="label">Êâ£ÂàÜ</span>
            <span class="value subtracted" id="classTotalSubtracted">-0</span>
        </div>
        <div class="exchange-row">
            <svg class="coin-icon coin-svg" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="coinGold" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFD700" />
                        <stop offset="30%" style="stop-color:#FFEC8B" />
                        <stop offset="50%" style="stop-color:#FFD700" />
                        <stop offset="70%" style="stop-color:#DAA520" />
                        <stop offset="100%" style="stop-color:#B8860B" />
                    </linearGradient>
                    <linearGradient id="coinShine" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFFACD;stop-opacity:0.8" />
                        <stop offset="100%" style="stop-color:#FFD700;stop-opacity:0" />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="url(#coinGold)" stroke="#B8860B" stroke-width="4" />
                <circle cx="50" cy="50" r="35" fill="none" stroke="#DAA520" stroke-width="2" />
                <text x="50" y="58" font-size="28" font-weight="bold" fill="#B8860B" text-anchor="middle">$</text>
                <ellipse cx="35" cy="30" rx="12" ry="8" fill="url(#coinShine)" />
            </svg>
            <span class="exchange-value" id="classTotalExchanged">0</span>
        </div>
    </div>

    <div class="header">
        <h1>üåü Â≠¶ÁîüÁßØÂàÜÁ≥ªÁªü üåü</h1>
    </div>

    <div class="students-grid" id="studentsGrid">
        <!-- Â≠¶ÁîüÂç°Áâá‰ºöÂä®ÊÄÅÊ∑ªÂä† -->
    </div>

    <!-- Ê∑ªÂä†Â≠¶ÁîüÂºπÁ™ó -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="modal-close" onclick="closeAddModal()">‚úï</button>
            <h2>Ê∑ªÂä†Â≠¶Áîü</h2>

            <div class="input-group">
                <label>Â≠¶ÁîüÂêçÂ≠ó</label>
                <input type="text" id="studentName" placeholder="ËØ∑ËæìÂÖ•Â≠¶ÁîüÂêçÂ≠ó">
            </div>

            <div class="input-group">
                <label>ÈÄâÊã©ÊÄßÂà´</label>
                <div class="gender-select">
                    <div class="gender-btn" data-gender="female" onclick="selectGender('female')">
                        <span class="icon">üëß</span>
                        <span class="label">Â•≥Áîü</span>
                    </div>
                    <div class="gender-btn" data-gender="male" onclick="selectGender('male')">
                        <span class="icon">üë¶</span>
                        <span class="label">Áî∑Áîü</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="confirmAddStudent()">Ê∑ªÂä†Â≠¶Áîü</button>
        </div>
    </div>

    <!-- ÁßØÂàÜÊìç‰ΩúÂºπÁ™ó -->
    <div class="modal-overlay" id="scoreModal">
        <div class="modal score-menu">
            <button class="modal-close" onclick="closeScoreModal()">‚úï</button>

            <div class="student-info">
                <div class="avatar-display" id="menuAvatar"></div>
                <div class="name" id="menuName"></div>
                <div class="current-score">ÁßØÂàÜ: <span id="menuScore">0</span></div>
            </div>

            <div class="score-unit-row">
                <span class="unit-label">Âçï‰Ωç</span>
                <input type="text" id="scoreUnitInput" list="scoreUnitList" placeholder="‰∏™">
                <button class="unit-reset" onclick="resetScoreUnit()">‰∏™</button>
            </div>
            <div class="score-unit-hint">ÊèêÁ§∫ÔºöËæìÂÖ•Âçï‰ΩçÔºàÂ¶Ç ‰∏á/‰∫ø/ÈÇ£Áî±‰ªñÔºâÔºåÂÜçÁÇπ‰∏ãÈù¢ÂúÜÂúàÂä†/Êâ£</div>
            <datalist id="scoreUnitList">
                <option value="‰∏™"></option>
                <option value="ÂçÅ"></option>
                <option value="Áôæ"></option>
                <option value="ÂçÉ"></option>
                <option value="‰∏á"></option>
                <option value="‰∫ø"></option>
                <option value="ÂÖÜ"></option>
                <option value="‰∫¨"></option>
                <option value="Âûì"></option>
                <option value="Áß≠"></option>
                <option value="Á©∞"></option>
                <option value="Ê≤ü"></option>
                <option value="Ê∂ß"></option>
                <option value="Ê≠£"></option>
                <option value="ËΩΩ"></option>
                <option value="ÊûÅ"></option>
                <option value="ÊÅíÊ≤≥Ê≤ô"></option>
                <option value="ÈòøÂÉßÁ•á"></option>
                <option value="ÈÇ£Áî±‰ªñ"></option>
                <option value="‰∏çÂèØÊÄùËÆÆ"></option>
                <option value="Êó†ÈáèÂ§ßÊï∞"></option>
            </datalist>

            <div class="score-section">
                <h3>‚ûï Âä†ÁßØÂàÜ</h3>
                <div class="score-buttons">
                    <button class="score-btn add" onclick="addScore(1)">+1</button>
                    <button class="score-btn add" onclick="addScore(2)">+2</button>
                    <button class="score-btn add" onclick="addScore(3)">+3</button>
                    <button class="score-btn add" onclick="addScore(4)">+4</button>
                    <button class="score-btn add" onclick="addScore(5)">+5</button>
                    <button class="score-btn add" onclick="addScore(6)">+6</button>
                    <button class="score-btn add" onclick="addScore(7)">+7</button>
                    <button class="score-btn add" onclick="addScore(8)">+8</button>
                    <button class="score-btn add" onclick="addScore(9)">+9</button>
                    <button class="score-btn add" onclick="addScore(10)">+10</button>
                    <button class="score-btn score-input-btn" onclick="openScoreInputModal('add')">ËæìÂÖ•+</button>
                </div>
            </div>

            <div class="score-section">
                <h3>‚ûñ Êâ£ÁßØÂàÜ</h3>
                <div class="score-buttons">
                    <button class="score-btn sub" onclick="subScore(1)">-1</button>
                    <button class="score-btn sub" onclick="subScore(2)">-2</button>
                    <button class="score-btn sub" onclick="subScore(3)">-3</button>
                    <button class="score-btn sub" onclick="subScore(4)">-4</button>
                    <button class="score-btn sub" onclick="subScore(5)">-5</button>
                    <button class="score-btn sub" onclick="subScore(6)">-6</button>
                    <button class="score-btn sub" onclick="subScore(7)">-7</button>
                    <button class="score-btn sub" onclick="subScore(8)">-8</button>
                    <button class="score-btn sub" onclick="subScore(9)">-9</button>
                    <button class="score-btn sub" onclick="subScore(10)">-10</button>
                    <button class="score-btn score-input-btn" onclick="openScoreInputModal('sub')">ËæìÂÖ•-</button>
                </div>
            </div>

        </div>
    </div>

    <!-- ËæìÂÖ•Âä†/Êâ£ÁßØÂàÜÂºπÁ™ó -->
    <div class="modal-overlay" id="scoreInputModal">
        <div class="modal">
            <button class="modal-close" onclick="closeScoreInputModal()">‚úï</button>
            <h2 id="scoreInputTitle">ËæìÂÖ•ÁßØÂàÜ</h2>

            <div class="input-group">
                <label>Êï∞ÂÄº</label>
                <input type="text" id="scoreInputAmount" placeholder="ËØ∑ËæìÂÖ•Êï∞Â≠ó" inputmode="numeric">
            </div>

            <div class="input-group">
                <label>Âçï‰Ωç</label>
                <input type="text" id="scoreInputUnit" list="scoreUnitList" placeholder="‰∏™">
            </div>

            <div class="score-input-preview" id="scoreInputPreview"></div>

            <button class="btn btn-primary" id="scoreInputConfirmBtn" onclick="confirmScoreInput()">Á°ÆËÆ§</button>
            <button class="btn btn-cancel" onclick="closeScoreInputModal()">ÂèñÊ∂à</button>
        </div>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <div class="bottom-nav">
        <div class="nav-btn" onclick="openShopModal()">
            <svg class="nav-icon" viewBox="0 0 100 100">
                <!-- Á§ºÁâ©Áõí -->
                <defs>
                    <linearGradient id="giftRed" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff6b6b" />
                        <stop offset="100%" style="stop-color:#c92a2a" />
                    </linearGradient>
                    <linearGradient id="giftYellow" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffd43b" />
                        <stop offset="100%" style="stop-color:#fab005" />
                    </linearGradient>
                </defs>
                <!-- ÁõíË∫´ -->
                <rect x="15" y="40" width="70" height="50" rx="5" fill="url(#giftRed)" />
                <!-- ÁõíÁõñ -->
                <rect x="10" y="30" width="80" height="15" rx="3" fill="url(#giftRed)" stroke="#a61e1e"
                    stroke-width="2" />
                <!-- ‰∏ùÂ∏¶Á´ñ -->
                <rect x="43" y="30" width="14" height="60" fill="url(#giftYellow)" />
                <!-- ‰∏ùÂ∏¶Ê®™ -->
                <rect x="10" y="33" width="80" height="10" fill="url(#giftYellow)" />
                <!-- Ëù¥Ëù∂Áªì -->
                <ellipse cx="38" cy="25" rx="12" ry="8" fill="url(#giftYellow)" stroke="#e6a500" stroke-width="1" />
                <ellipse cx="62" cy="25" rx="12" ry="8" fill="url(#giftYellow)" stroke="#e6a500" stroke-width="1" />
                <circle cx="50" cy="28" r="6" fill="url(#giftYellow)" stroke="#e6a500" stroke-width="1" />
            </svg>
            <span class="nav-label">ÂïÜÂ∫ó</span>
        </div>
        <div class="nav-btn" onclick="openRoomModal()">
            <svg class="nav-icon" viewBox="0 0 100 100">
                <!-- ÊàøÂ≠ê -->
                <defs>
                    <linearGradient id="roofColor" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#e64980" />
                        <stop offset="100%" style="stop-color:#a61e4d" />
                    </linearGradient>
                    <linearGradient id="houseColor" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffecd2" />
                        <stop offset="100%" style="stop-color:#fcb69f" />
                    </linearGradient>
                </defs>
                <!-- Â±ãÈ°∂ -->
                <polygon points="50,10 10,45 90,45" fill="url(#roofColor)" stroke="#7b1e3a" stroke-width="2" />
                <!-- ÊàøË∫´ -->
                <rect x="18" y="45" width="64" height="45" fill="url(#houseColor)" stroke="#d4a574" stroke-width="2" />
                <!-- Èó® -->
                <rect x="40" y="55" width="20" height="35" rx="2" fill="#8B4513" stroke="#5D3A1A" stroke-width="2" />
                <circle cx="55" cy="75" r="2" fill="#ffd43b" />
                <!-- Á™óÊà∑ -->
                <rect x="25" y="55" width="12" height="12" fill="#87ceeb" stroke="#5D3A1A" stroke-width="1" />
                <rect x="63" y="55" width="12" height="12" fill="#87ceeb" stroke="#5D3A1A" stroke-width="1" />
            </svg>
            <span class="nav-label">ÊàøÈó¥</span>
        </div>
    </div>

    <!-- ÂïÜÂ∫óÂºπÁ™ó -->
    <div class="modal-overlay shop-modal" id="shopModal">
        <div class="modal">
            <button class="modal-close" onclick="closeShopModal()">‚úï</button>
            <h2>üéÅ ÁßØÂàÜÂïÜÂ∫ó</h2>
            <div class="shop-grid" id="shopGrid">
                <!-- ÂïÜÂìÅ‰ºöÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- ÈÄâÊã©Â≠¶ÁîüË¥≠‰π∞ÂºπÁ™ó -->
    <div class="modal-overlay select-student-modal" id="selectStudentModal">
        <div class="modal">
            <button class="modal-close" onclick="closeSelectStudentModal()">‚úï</button>
            <h2>ÈÄâÊã©Â≠¶ÁîüË¥≠‰π∞</h2>
            <div class="purchase-item-preview" id="purchaseItemPreview">
                <!-- ÂïÜÂìÅÈ¢ÑËßà‰ºöÂä®ÊÄÅÁîüÊàê -->
            </div>
            <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 10px;">ÈÄâÊã©Áî®Ë∞ÅÁöÑÁßØÂàÜË¥≠‰π∞Ôºö</p>
            <div class="select-student-list" id="selectStudentList">
                <!-- Â≠¶ÁîüÂàóË°®‰ºöÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- ÈÄâÊã©Â≠¶ÁîüËøõÂÖ•ÊàøÈó¥ÂºπÁ™ó -->
    <div class="modal-overlay select-student-modal" id="selectRoomStudentModal">
        <div class="modal">
            <button class="modal-close" onclick="closeSelectRoomStudentModal()">‚úï</button>
            <h2>üè† ÈÄâÊã©Â≠¶ÁîüËøõÂÖ•ÊàøÈó¥</h2>
            <div class="select-student-list" id="selectRoomStudentList">
                <!-- Â≠¶ÁîüÂàóË°®‰ºöÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- ÂÖ®Â±èÊàøÈó¥ -->
    <div class="fullscreen-room" id="fullscreenRoom">
        <!-- 3DÂÆ§ÂÜÖÂú∫ÊôØ -->
        <div class="room-indoor" id="roomIndoor">
            <div class="room-3d">
                <!-- Â¢ôÂ£Å -->
                <div class="room-back-wall"></div>
                <div class="room-left-wall"></div>
                <div class="room-right-wall"></div>
                <!-- Âú∞Êùø -->
                <div class="room-floor"></div>
                <!-- Èó® -->
                <div class="room-door" id="roomDoor">
                    <div class="door-handle"></div>
                </div>
                <!-- ÊüúÂ≠ê -->
                <div class="room-cabinet-3d">
                    <div class="cabinet-top"></div>
                    <div class="cabinet-body">
                        <div class="cabinet-grid" id="roomCabinetGrid">
                            <!-- ÊüúÂ≠êÁâ©ÂìÅ -->
                        </div>
                    </div>
                </div>
                <!-- Âú∫ÊôØÈÄâÊã©ÊåâÈíÆ -->
                <button class="scene-select-btn" onclick="openSceneModal()">üé® Êç¢Âú∫ÊôØ</button>
                <!-- ÂÆ§ÂÜÖÁé©ÂÆ∂ -->
                <div class="indoor-player" id="indoorPlayer" style="left:40%;bottom:25%;">
                    <div class="player-badges" id="indoorPlayerBadges"></div>
                    <div class="avatar-wrap" id="indoorPlayerAvatar"></div>
                </div>
                <!-- ÂÆ§ÂÜÖÈ£ûÊú∫ -->
                <div class="indoor-plane" id="indoorPlane" style="display:none;left:50%;bottom:50%;">
                </div>
            </div>
        </div>

        <!-- 3DÂÆ§Â§ñÂú∫ÊôØ -->
        <div class="room-outdoor" id="roomOutdoor" style="display:none;">
            <!-- Â§©Á©∫ -->
            <div class="outdoor-sky"></div>
            <div class="outdoor-sun"></div>
            <div class="outdoor-cloud cloud1"></div>
            <div class="outdoor-cloud cloud2"></div>

            <!-- 3DËçâÂú∞ -->
            <div class="outdoor-ground-3d"></div>
            <div class="garden-path"></div>

            <!-- ÊàøÂ≠êÂÖ•Âè£ -->
            <div class="house-entrance" id="houseEntrance"></div>

            <!-- Âñ∑Ê≥â -->
            <div class="fountain">
                <div class="fountain-top"></div>
                <div class="fountain-pillar"></div>
                <div class="fountain-base"></div>
                <div class="fountain-water"></div>
                <div class="water-drops">
                    <div class="water-drop"></div>
                    <div class="water-drop"></div>
                    <div class="water-drop"></div>
                </div>
            </div>

            <!-- Ê≤ôÂùë -->
            <div class="sandbox-3d" id="sandbox">
                <div class="sandbox-pit"></div>
                <div class="sandbox-hint" id="sandboxHint">Â∏¶ÊåñÊ≤ôÂ•óË£ÖÊù•Áé©</div>
            </div>

            <!-- Ê†ëÊú® -->
            <div class="tree tree1">
                <div class="tree-leaves"></div>
                <div class="tree-trunk"></div>
            </div>
            <div class="tree tree2">
                <div class="tree-leaves"></div>
                <div class="tree-trunk"></div>
            </div>
            <div class="tree tree3">
                <div class="tree-leaves"></div>
                <div class="tree-trunk"></div>
            </div>

            <!-- Ëä±Êúµ -->
            <div class="flower flower1"></div>
            <div class="flower flower2"></div>
            <div class="flower flower3"></div>
            <div class="flower flower4"></div>

            <!-- Áé©ÂÆ∂ -->
            <div class="player" id="player" style="left:50%;bottom:45%;">
                <div class="player-badges" id="playerBadges"></div>
                <div class="avatar-wrap" id="playerAvatar"></div>
            </div>

            <!-- ÈÅ•ÊéßÈ£ûÊú∫ -->
            <div class="rc-plane" id="rcPlane" style="display:none;left:50%;bottom:60%;"></div>

            <!-- Èõ®Êª¥Â±Ç -->
            <div class="rain-overlay" id="rainOverlay" style="display:none;"></div>
        </div>

        <!-- Â§©Ê∞îÊòæÁ§∫ -->
        <div class="weather-display" id="weatherDisplay" style="display:none;">
            <span id="weatherIcon">‚òÄÔ∏è</span> <span id="weatherText">Êô¥Â§©</span>
        </div>

        <!-- ÊàøÈó¥UI -->
        <div class="room-ui">
            <button class="room-back-btn" onclick="exitRoom()">‚Üê ÈÄÄÂá∫</button>
            <div class="room-student-info" id="roomStudentInfo">
                <div class="avatar" id="roomStudentAvatar"></div>
                <span class="name" id="roomStudentName"></span>
            </div>
            <div style="display:flex;gap:10px;">
                <!-- Âú∞ÂõæÊåâÈíÆÂ∑≤ÁßªÈô§,ÊåâMÊü•Áúã -->
            </div>
        </div>

        <!-- Êê∫Â∏¶Áâ©ÂìÅÊ†è -->
        <div class="carry-items" id="carryItems">
            <!-- Êê∫Â∏¶ÁöÑÁâ©ÂìÅ -->
        </div>

        <!-- Êìç‰ΩúÊèêÁ§∫ -->
        <div class="control-hint" id="controlHint">
            WASDÁßªÂä® | QÊéßÂà∂È£ûÊú∫ | MÂú∞Âõæ
        </div>

        <!-- ËôöÊãüÊëáÊùÜ -->
        <div class="virtual-joystick" id="virtualJoystick">
            <div class="joystick-base"></div>
            <div class="joystick-knob" id="joystickKnob"></div>
        </div>

        <!-- È£ûÊú∫Â∞èÂè∑ËôöÊãüÊëáÊùÜÔºàÈ£ûË°åÊ®°ÂºèÊåáÁ§∫Âô®Ôºâ -->
        <div class="plane-joystick" id="planeJoystick">
            <div class="joystick-base"></div>
            <div class="joystick-knob" id="planeJoystickKnob"></div>
        </div>

        <!-- È£ûÊú∫ÊéßÂà∂Èù¢Êùø -->
        <div class="plane-control-panel" id="planeControlPanel">
            <button class="plane-btn hover-btn" id="hoverBtn" onclick="toggleHoverMode()">üöÅ ÁõòÊóã</button>
            <button class="plane-btn land-btn" id="landBtn" onclick="emergencyLand()">üõ¨ ÈôçËêΩ</button>
        </div>

        <!-- Âú∞ÂõæÂºπÁ™ó -->
        <div class="map-modal" id="mapModal">
            <span class="map-close" onclick="closeMap()">‚úï</span>
            <div class="map-title">üó∫Ô∏è Ëä±Âõ≠Âú∞Âõæ</div>
            <div class="map-content">
                <div class="map-item map-house">üè† ÊàøÈó¥</div>
                <div class="map-item map-fountain">‚õ≤ Âñ∑Ê≥â</div>
                <div class="map-item map-sandbox">üèñÔ∏è Ê≤ôÂùë</div>
                <div class="map-item map-you" id="mapYou">üìç ‰Ω†</div>
            </div>
        </div>

        <!-- Âú∫ÊôØÈÄâÊã©ÂºπÁ™ó -->
        <div class="scene-modal" id="sceneModal">
            <div class="scene-modal-content">
                <div class="scene-modal-header">
                    <div class="scene-modal-title">üé® ÈÄâÊã©Âú∫ÊôØ</div>
                    <span class="scene-modal-close" onclick="closeSceneModal()">‚úï</span>
                </div>
                <div class="scene-info">
                    <div class="scene-info-text">Â∑≤Ëß£ÈîÅÂú∫ÊôØ</div>
                    <div class="scene-info-count" id="sceneUnlockedCount">1 / 100</div>
                </div>
                <div class="scene-grid" id="sceneGrid">
                    <!-- Âú∫ÊôØ‰ºöÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>
    </div>

    <!-- ÂØÜÁ†ÅÂºπÁ™ó -->
    <div class="modal-overlay password-modal" id="passwordModal">
        <div class="modal">
            <button class="modal-close" onclick="closePasswordModal()">‚úï</button>
            <h2>üîê ËæìÂÖ•ÂØÜÁ†Å</h2>
            <p style="color: #666; font-size: 14px;">ÈúÄË¶ÅÂØÜÁ†ÅÊâçËÉΩÊü•ÁúãÂíåÁÆ°ÁêÜËÆ∞ÂΩï</p>
            <input type="password" class="password-input" id="passwordInput" placeholder="******" maxlength="6">
            <button class="btn btn-primary" onclick="checkPassword()">Á°ÆËÆ§</button>
        </div>
    </div>

    <!-- ËÆ∞ÂΩïË°®ÂºπÁ™ó -->
    <div class="modal-overlay record-modal" id="recordModal">
        <div class="modal">
            <button class="modal-close" onclick="closeRecordModal()">‚úï</button>
            <h2>üìã Êìç‰ΩúËÆ∞ÂΩï</h2>
            <div class="record-list" id="recordList">
                <!-- ËÆ∞ÂΩï‰ºöÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <script>
        // ÁÆ°ÁêÜÂØÜÁ†Å
        const ADMIN_PASSWORD = '123456';

        // ÁßØÂàÜÂçï‰ΩçÔºà10ËøõÂà∂ÂπÇÔºâ
        const SCORE_UNIT_DEFINITIONS = [
            { name: '‰∏™', exp: 0 },
            { name: 'ÂçÅ', exp: 1 },
            { name: 'Áôæ', exp: 2 },
            { name: 'ÂçÉ', exp: 3 },
            { name: '‰∏á', exp: 4 },
            { name: '‰∫ø', exp: 8 },
            { name: 'ÂÖÜ', exp: 12 },
            { name: '‰∫¨', exp: 16 },
            { name: 'Âûì', exp: 20 },
            { name: 'Áß≠', exp: 24 },
            { name: 'Á©∞', exp: 28 },
            { name: 'Ê≤ü', exp: 32 },
            { name: 'Ê∂ß', exp: 36 },
            { name: 'Ê≠£', exp: 40 },
            { name: 'ËΩΩ', exp: 44 },
            { name: 'ÊûÅ', exp: 48 },
            { name: 'ÊÅíÊ≤≥Ê≤ô', exp: 52 },
            { name: 'ÈòøÂÉßÁ•á', exp: 56 },
            { name: 'ÈÇ£Áî±‰ªñ', exp: 60 },
            { name: '‰∏çÂèØÊÄùËÆÆ', exp: 64 },
            { name: 'Êó†ÈáèÂ§ßÊï∞', exp: 68 },
        ];

        const SCORE_UNIT_MULTIPLIER = Object.fromEntries(
            SCORE_UNIT_DEFINITIONS.map(u => [u.name, 10n ** BigInt(u.exp)])
        );

        function bigIntReplacer(key, value) {
            return typeof value === 'bigint' ? value.toString() : value;
        }

        function parseBigIntValue(value, fallback = 0n) {
            if (typeof value === 'bigint') return value;
            if (typeof value === 'number') {
                if (!Number.isFinite(value)) return fallback;
                return BigInt(Math.trunc(value));
            }
            if (typeof value === 'string') {
                const trimmed = value.trim();
                if (trimmed === '') return fallback;
                if (/^-?\d+$/.test(trimmed)) return BigInt(trimmed);
            }
            return fallback;
        }

        function formatScore(value) {
            const big = parseBigIntValue(value, 0n);
            const sign = big < 0n ? '-' : '';
            const abs = big < 0n ? -big : big;

            if (abs < 10000n) return sign + abs.toString();

            let selected = SCORE_UNIT_DEFINITIONS[4]; // ‰∏á
            for (let i = 4; i < SCORE_UNIT_DEFINITIONS.length; i++) {
                const unit = SCORE_UNIT_DEFINITIONS[i];
                const multiplier = SCORE_UNIT_MULTIPLIER[unit.name];
                if (abs >= multiplier) selected = unit;
            }

            const multiplier = SCORE_UNIT_MULTIPLIER[selected.name];
            const intPart = abs / multiplier;
            const remainder = abs % multiplier;

            let decimals = '';
            if (remainder !== 0n) {
                const decimalValue = (remainder * 100n) / multiplier;
                const decimalText = decimalValue.toString().padStart(2, '0').replace(/0+$/, '');
                if (decimalText) decimals = '.' + decimalText;
            }

            return sign + intPart.toString() + decimals + selected.name;
        }

        function getUnitNameOrDefault(input) {
            const trimmed = (input || '').trim();
            return trimmed || '‰∏™';
        }

        function getUnitMultiplierOrNull(unitName) {
            const normalized = getUnitNameOrDefault(unitName);
            return SCORE_UNIT_MULTIPLIER[normalized] || null;
        }

        function getActiveScoreUnit() {
            const input = document.getElementById('scoreUnitInput');
            return getUnitNameOrDefault(input ? input.value : '');
        }

        function saveActiveScoreUnit() {
            localStorage.setItem('scoreUnit', getActiveScoreUnit());
        }

        function resetScoreUnit() {
            const input = document.getElementById('scoreUnitInput');
            if (!input) return;
            input.value = '‰∏™';
            saveActiveScoreUnit();
        }

        function loadStudentsFromStorage() {
            const raw = localStorage.getItem('students');
            if (!raw) return [];
            let parsed;
            try {
                parsed = JSON.parse(raw);
            } catch {
                return [];
            }
            if (!Array.isArray(parsed)) return [];

            return parsed.map(s => ({
                ...s,
                score: parseBigIntValue(s.score, 0n),
                totalAdded: parseBigIntValue(s.totalAdded, 0n),
                totalSubtracted: parseBigIntValue(s.totalSubtracted, 0n),
                totalExchanged: parseBigIntValue(s.totalExchanged, 0n),
            }));
        }

        function loadRecordsFromStorage() {
            const raw = localStorage.getItem('records');
            if (!raw) return [];
            let parsed;
            try {
                parsed = JSON.parse(raw);
            } catch {
                return [];
            }
            if (!Array.isArray(parsed)) return [];

            return parsed.map(r => ({
                ...r,
                amount: parseBigIntValue(r.amount, 0n),
            }));
        }

        function loadBigIntFromStorage(key, fallback = 0n) {
            return parseBigIntValue(localStorage.getItem(key), fallback);
        }

        // Êìç‰ΩúËÆ∞ÂΩï
        let records = loadRecordsFromStorage();

        // ÂïÜÂìÅÊï∞ÊçÆ
        const shopItems = [
            {
                id: 'badge_gift',
                name: 'Á§ºÁâ©ÁõíÂæΩÁ´†',
                price: 15,
                icon: `<svg viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#ffd43b" stroke="#e6a500" stroke-width="3"/>
                    <rect x="30" y="45" width="40" height="30" rx="3" fill="#ff6b6b"/>
                    <rect x="45" y="45" width="10" height="30" fill="#ffd43b"/>
                    <rect x="30" y="40" width="40" height="8" rx="2" fill="#ff6b6b"/>
                    <rect x="30" y="42" width="40" height="5" fill="#ffd43b"/>
                    <ellipse cx="43" cy="38" rx="8" ry="5" fill="#ffd43b"/>
                    <ellipse cx="57" cy="38" rx="8" ry="5" fill="#ffd43b"/>
                </svg>`
            },
            {
                id: 'sand_set',
                name: 'ÊåñÊ≤ôÂ•óË£Ö',
                price: 30,
                icon: `<svg viewBox="0 0 100 100">
                    <!-- Ê≤ôÊª©ËÉåÊôØ -->
                    <ellipse cx="50" cy="85" rx="40" ry="10" fill="#f4d03f"/>
                    <!-- Ê∞¥Ê°∂ -->
                    <path d="M25 50 L30 80 L50 80 L55 50 Z" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
                    <ellipse cx="40" cy="50" rx="15" ry="5" fill="#5dade2" stroke="#2980b9" stroke-width="2"/>
                    <path d="M30 45 Q40 35 50 45" stroke="#2980b9" stroke-width="3" fill="none"/>
                    <!-- Èì≤Â≠ê -->
                    <rect x="60" y="30" width="6" height="45" fill="#8B4513" rx="2"/>
                    <path d="M55 75 L73 75 L66 90 L62 90 Z" fill="#bdc3c7" stroke="#7f8c8d" stroke-width="1"/>
                    <!-- Áª≥Â≠ê -->
                    <path d="M28 48 Q20 40 35 35 Q50 30 55 48" stroke="#d4a574" stroke-width="3" fill="none" stroke-dasharray="3,2"/>
                </svg>`
            },
            {
                id: 'badge_1',
                name: 'ÂæΩÁ´†(1‰∏™)',
                price: 5,
                icon: `<svg viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="35" fill="#ff6b6b" stroke="#c92a2a" stroke-width="3"/>
                    <text x="50" y="58" font-size="24" fill="white" text-anchor="middle" font-weight="bold">‚òÖ</text>
                </svg>`
            },
            {
                id: 'badge_3',
                name: 'ÂæΩÁ´†ÁªÑ(3‰∏™)',
                price: 12,
                icon: `<svg viewBox="0 0 100 100">
                    <circle cx="30" cy="40" r="18" fill="#ff6b6b" stroke="#c92a2a" stroke-width="2"/>
                    <text x="30" y="45" font-size="12" fill="white" text-anchor="middle" font-weight="bold">‚òÖ</text>
                    <circle cx="70" cy="40" r="18" fill="#51cf66" stroke="#2b8a3e" stroke-width="2"/>
                    <text x="70" y="45" font-size="12" fill="white" text-anchor="middle" font-weight="bold">‚òÖ</text>
                    <circle cx="50" cy="70" r="18" fill="#339af0" stroke="#1864ab" stroke-width="2"/>
                    <text x="50" y="75" font-size="12" fill="white" text-anchor="middle" font-weight="bold">‚òÖ</text>
                </svg>`
            },
            {
                id: 'badge_5',
                name: 'ÂæΩÁ´†ÁªÑ(5‰∏™)',
                price: 18,
                icon: `<svg viewBox="0 0 100 100">
                    <circle cx="25" cy="35" r="14" fill="#ff6b6b" stroke="#c92a2a" stroke-width="2"/>
                    <circle cx="50" cy="25" r="14" fill="#ffd43b" stroke="#e6a500" stroke-width="2"/>
                    <circle cx="75" cy="35" r="14" fill="#51cf66" stroke="#2b8a3e" stroke-width="2"/>
                    <circle cx="35" cy="65" r="14" fill="#339af0" stroke="#1864ab" stroke-width="2"/>
                    <circle cx="65" cy="65" r="14" fill="#cc5de8" stroke="#9c36b5" stroke-width="2"/>
                </svg>`
            },
            {
                id: 'badge_8',
                name: 'ÂæΩÁ´†ÁªÑ(8‰∏™)',
                price: 28,
                icon: `<svg viewBox="0 0 100 100">
                    <circle cx="20" cy="30" r="12" fill="#ff6b6b" stroke="#c92a2a" stroke-width="2"/>
                    <circle cx="50" cy="20" r="12" fill="#ffd43b" stroke="#e6a500" stroke-width="2"/>
                    <circle cx="80" cy="30" r="12" fill="#51cf66" stroke="#2b8a3e" stroke-width="2"/>
                    <circle cx="20" cy="55" r="12" fill="#339af0" stroke="#1864ab" stroke-width="2"/>
                    <circle cx="50" cy="50" r="12" fill="#cc5de8" stroke="#9c36b5" stroke-width="2"/>
                    <circle cx="80" cy="55" r="12" fill="#f59f00" stroke="#e67700" stroke-width="2"/>
                    <circle cx="35" cy="78" r="12" fill="#20c997" stroke="#0ca678" stroke-width="2"/>
                    <circle cx="65" cy="78" r="12" fill="#845ef7" stroke="#7048e8" stroke-width="2"/>
                </svg>`
            },
            {
                id: 'badge_10',
                name: 'ÂæΩÁ´†ÁªÑ(10‰∏™)',
                price: 35,
                icon: `<svg viewBox="0 0 100 100">
                    <circle cx="15" cy="25" r="10" fill="#ff6b6b" stroke="#c92a2a" stroke-width="1"/>
                    <circle cx="38" cy="18" r="10" fill="#ffd43b" stroke="#e6a500" stroke-width="1"/>
                    <circle cx="62" cy="18" r="10" fill="#51cf66" stroke="#2b8a3e" stroke-width="1"/>
                    <circle cx="85" cy="25" r="10" fill="#339af0" stroke="#1864ab" stroke-width="1"/>
                    <circle cx="20" cy="50" r="10" fill="#cc5de8" stroke="#9c36b5" stroke-width="1"/>
                    <circle cx="50" cy="45" r="10" fill="#f59f00" stroke="#e67700" stroke-width="1"/>
                    <circle cx="80" cy="50" r="10" fill="#20c997" stroke="#0ca678" stroke-width="1"/>
                    <circle cx="28" cy="75" r="10" fill="#845ef7" stroke="#7048e8" stroke-width="1"/>
                    <circle cx="50" cy="80" r="10" fill="#e64980" stroke="#a61e4d" stroke-width="1"/>
                    <circle cx="72" cy="75" r="10" fill="#fab005" stroke="#f59f00" stroke-width="1"/>
                </svg>`
            },
            {
                id: 'rc_plane',
                name: 'ÈÅ•ÊéßÈ£ûÊú∫',
                price: 20,
                icon: `<svg viewBox="0 0 100 100">
                    <!-- Êú∫Ë∫´ -->
                    <ellipse cx="50" cy="50" rx="35" ry="10" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
                    <!-- Êú∫Áøº -->
                    <path d="M30 50 L10 35 L10 40 L30 50 L10 60 L10 65 L30 50" fill="#3498db" stroke="#2980b9" stroke-width="1"/>
                    <path d="M70 50 L90 35 L90 40 L70 50 L90 60 L90 65 L70 50" fill="#3498db" stroke="#2980b9" stroke-width="1"/>
                    <!-- Â∞æÁøº -->
                    <path d="M15 50 L5 40 L5 60 Z" fill="#f39c12" stroke="#d68910" stroke-width="1"/>
                    <!-- Êú∫Â§¥ -->
                    <ellipse cx="85" cy="50" rx="5" ry="6" fill="#2c3e50"/>
                    <!-- È©æÈ©∂Ëà± -->
                    <ellipse cx="60" cy="48" rx="8" ry="4" fill="#87ceeb" stroke="#5dade2" stroke-width="1"/>
                    <!-- ÈÅ•ÊéßÂ§©Á∫ø -->
                    <line x1="50" y1="40" x2="50" y2="25" stroke="#333" stroke-width="2"/>
                    <circle cx="50" cy="23" r="3" fill="#e74c3c"/>
                </svg>`
            },
            {
                id: 'umbrella',
                name: 'Â∞è‰ºû',
                price: 5,
                icon: `<svg viewBox="0 0 100 100">
                    <!-- ‰ºûÈù¢ -->
                    <path d="M10 50 Q50 10 90 50 Q70 55 50 50 Q30 55 10 50" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
                    <!-- ‰ºûÈ™® -->
                    <line x1="50" y1="50" x2="25" y2="48" stroke="#d4a574" stroke-width="1"/>
                    <line x1="50" y1="50" x2="75" y2="48" stroke="#d4a574" stroke-width="1"/>
                    <line x1="50" y1="50" x2="15" y2="50" stroke="#d4a574" stroke-width="1"/>
                    <line x1="50" y1="50" x2="85" y2="50" stroke="#d4a574" stroke-width="1"/>
                    <!-- ‰ºûÊüÑ -->
                    <line x1="50" y1="50" x2="50" y2="85" stroke="#8B4513" stroke-width="4" stroke-linecap="round"/>
                    <!-- ‰ºûÈí© -->
                    <path d="M50 85 Q50 95 40 95 Q30 95 30 88" stroke="#8B4513" stroke-width="4" fill="none" stroke-linecap="round"/>
                    <!-- ‰ºûÈ°∂ -->
                    <circle cx="50" cy="30" r="4" fill="#ffd43b" stroke="#e6a500" stroke-width="1"/>
                </svg>`
            },
            {
                id: 'new_scene',
                name: 'Êñ∞Âú∫ÊôØ',
                price: 50,
                icon: `<svg viewBox="0 0 100 100">
                    <!-- ËÉåÊôØ -->
                    <rect x="5" y="5" width="90" height="90" rx="10" fill="#87ceeb"/>
                    <!-- Â§™Èò≥ -->
                    <circle cx="75" cy="25" r="12" fill="#ffd700"/>
                    <!-- Â±± -->
                    <path d="M0 90 L30 50 L60 90 Z" fill="#228B22"/>
                    <path d="M40 90 L70 40 L100 90 Z" fill="#2d8a2d"/>
                    <!-- Ê†ë -->
                    <circle cx="20" cy="65" r="10" fill="#006400"/>
                    <rect x="18" y="70" width="4" height="15" fill="#8B4513"/>
                    <!-- Ëä± -->
                    <circle cx="50" cy="80" r="4" fill="#ff69b4"/>
                    <circle cx="80" cy="75" r="4" fill="#ffeb3b"/>
                    <!-- NEWÊ†áÁ≠æ -->
                    <rect x="55" y="10" width="35" height="18" rx="4" fill="#e74c3c"/>
                    <text x="72" y="23" font-size="10" fill="white" text-anchor="middle" font-weight="bold">NEW</text>
                </svg>`
            }
        ];

        // Â•≥ÁîüÂ§¥ÂÉè SVG Ê®°Êùø - ÂèØÁà±È£éÊ†º
        const femaleAvatarTemplates = [
            // Á≤âËâ≤ÂèåÈ©¨Â∞æÂ•≥Â≠©
            (colors) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${colors.bg}"/><circle cx="50" cy="55" r="30" fill="${colors.skin}"/><ellipse cx="25" cy="35" rx="12" ry="15" fill="${colors.hair}"/><ellipse cx="75" cy="35" rx="12" ry="15" fill="${colors.hair}"/><path d="M20 45 Q50 20 80 45 Q50 30 20 45" fill="${colors.hair}"/><circle cx="40" cy="52" r="4" fill="#333"/><circle cx="60" cy="52" r="4" fill="#333"/><circle cx="41" cy="51" r="1.5" fill="white"/><circle cx="61" cy="51" r="1.5" fill="white"/><ellipse cx="35" cy="60" rx="5" ry="3" fill="#ffb3ba" opacity="0.6"/><ellipse cx="65" cy="60" rx="5" ry="3" fill="#ffb3ba" opacity="0.6"/><path d="M45 65 Q50 70 55 65" stroke="#e57373" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`,
            // Áü≠ÂèëÂèØÁà±Â•≥Â≠©
            (colors) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${colors.bg}"/><circle cx="50" cy="55" r="28" fill="${colors.skin}"/><ellipse cx="50" cy="35" rx="32" ry="20" fill="${colors.hair}"/><rect x="20" y="30" width="60" height="15" rx="5" fill="${colors.hair}"/><circle cx="40" cy="52" r="4" fill="#333"/><circle cx="60" cy="52" r="4" fill="#333"/><circle cx="41" cy="51" r="1.5" fill="white"/><circle cx="61" cy="51" r="1.5" fill="white"/><path d="M43 66 Q50 72 57 66" stroke="#e57373" stroke-width="2.5" fill="none" stroke-linecap="round"/><ellipse cx="33" cy="58" rx="6" ry="4" fill="#ffb3ba" opacity="0.5"/><ellipse cx="67" cy="58" rx="6" ry="4" fill="#ffb3ba" opacity="0.5"/></svg>`,
            // ÈïøÂèëÂÖ¨‰∏ª
            (colors) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${colors.bg}"/><ellipse cx="50" cy="70" rx="25" ry="30" fill="${colors.hair}"/><circle cx="50" cy="50" r="26" fill="${colors.skin}"/><path d="M24 40 Q50 15 76 40 L76 55 Q50 45 24 55 Z" fill="${colors.hair}"/><circle cx="40" cy="48" r="3.5" fill="#333"/><circle cx="60" cy="48" r="3.5" fill="#333"/><circle cx="41" cy="47" r="1.2" fill="white"/><circle cx="61" cy="47" r="1.2" fill="white"/><path d="M45 60 Q50 65 55 60" stroke="#e57373" stroke-width="2" fill="none" stroke-linecap="round"/><path d="M38 42 Q40 40 43 42" stroke="${colors.hair}" stroke-width="2" fill="none"/><path d="M57 42 Q60 40 62 42" stroke="${colors.hair}" stroke-width="2" fill="none"/></svg>`,
            // ‰∏∏Â≠êÂ§¥Â•≥Â≠©
            (colors) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${colors.bg}"/><circle cx="50" cy="20" r="12" fill="${colors.hair}"/><circle cx="50" cy="55" r="28" fill="${colors.skin}"/><path d="M22 50 Q50 25 78 50 Q50 40 22 50" fill="${colors.hair}"/><circle cx="40" cy="52" r="4" fill="#333"/><circle cx="60" cy="52" r="4" fill="#333"/><circle cx="41" cy="51" r="1.5" fill="white"/><circle cx="61" cy="51" r="1.5" fill="white"/><path d="M44 65 Q50 70 56 65" stroke="#e57373" stroke-width="2" fill="none" stroke-linecap="round"/><ellipse cx="34" cy="58" rx="5" ry="3" fill="#ffb3ba" opacity="0.5"/><ellipse cx="66" cy="58" rx="5" ry="3" fill="#ffb3ba" opacity="0.5"/></svg>`,
        ];

        // Áî∑ÁîüÂ§¥ÂÉè SVG Ê®°Êùø - ÈÖ∑ÈÖ∑È£éÊ†º
        const maleAvatarTemplates = [
            // ÈÖ∑ÈÖ∑Âà∫Â§¥Áî∑Â≠©
            (colors) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${colors.bg}"/><circle cx="50" cy="55" r="28" fill="${colors.skin}"/><path d="M25 45 L35 20 L45 40 L50 15 L55 40 L65 20 L75 45 Q50 35 25 45" fill="${colors.hair}"/><rect x="35" y="48" width="10" height="5" rx="2" fill="#333"/><rect x="55" y="48" width="10" height="5" rx="2" fill="#333"/><path d="M32 45 L40 48" stroke="${colors.hair}" stroke-width="2.5"/><path d="M68 45 L60 48" stroke="${colors.hair}" stroke-width="2.5"/><path d="M45 67 L55 67" stroke="#666" stroke-width="2.5" stroke-linecap="round"/></svg>`,
            // Êà¥Â∏ΩÂ≠êÁî∑Â≠©
            (colors) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${colors.bg}"/><circle cx="50" cy="58" r="26" fill="${colors.skin}"/><ellipse cx="50" cy="30" rx="28" ry="12" fill="${colors.hair}"/><rect x="22" y="28" width="56" height="8" rx="2" fill="${colors.accent}"/><rect x="35" y="22" width="30" height="15" rx="3" fill="${colors.accent}"/><circle cx="40" cy="55" r="3.5" fill="#333"/><circle cx="60" cy="55" r="3.5" fill="#333"/><path d="M44 68 L56 68" stroke="#666" stroke-width="2.5" stroke-linecap="round"/></svg>`,
            // ‰æßÂàÜÂ§¥Áî∑Â≠©
            (colors) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${colors.bg}"/><circle cx="50" cy="55" r="27" fill="${colors.skin}"/><path d="M23 50 Q30 25 75 35 L78 50 Q50 40 23 50" fill="${colors.hair}"/><path d="M30 40 Q35 30 50 28" stroke="${colors.hair}" stroke-width="8" fill="none" stroke-linecap="round"/><circle cx="40" cy="52" r="3.5" fill="#333"/><circle cx="60" cy="52" r="3.5" fill="#333"/><path d="M35 48 L43 50" stroke="#333" stroke-width="2"/><path d="M65 48 L57 50" stroke="#333" stroke-width="2"/><path d="M45 66 L55 66" stroke="#666" stroke-width="2.5" stroke-linecap="round"/></svg>`,
            // ËøêÂä®Áî∑Â≠©
            (colors) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${colors.bg}"/><circle cx="50" cy="55" r="27" fill="${colors.skin}"/><ellipse cx="50" cy="38" rx="25" ry="12" fill="${colors.hair}"/><circle cx="40" cy="52" r="4" fill="#333"/><circle cx="60" cy="52" r="4" fill="#333"/><circle cx="41" cy="51" r="1.5" fill="white"/><circle cx="61" cy="51" r="1.5" fill="white"/><path d="M43 67 Q50 72 57 67" stroke="#666" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M28 40 Q30 30 40 32" stroke="${colors.accent}" stroke-width="4" fill="none" stroke-linecap="round"/></svg>`,
        ];

        // È¢úËâ≤ÈÖçÁΩÆ
        const femaleColors = [
            { bg: '#ffe4ec', skin: '#ffecd2', hair: '#8B4513', accent: '#ff69b4' },
            { bg: '#e8f5e9', skin: '#ffe0bd', hair: '#2d1b00', accent: '#4caf50' },
            { bg: '#fff3e0', skin: '#ffd5b4', hair: '#4a3000', accent: '#ff9800' },
            { bg: '#f3e5f5', skin: '#ffe4c4', hair: '#1a1a2e', accent: '#9c27b0' },
            { bg: '#e3f2fd', skin: '#ffdbac', hair: '#654321', accent: '#2196f3' },
            { bg: '#fce4ec', skin: '#f5cba7', hair: '#3d2914', accent: '#e91e63' },
        ];

        const maleColors = [
            { bg: '#e3f2fd', skin: '#ffecd2', hair: '#1a1a2e', accent: '#1976d2' },
            { bg: '#e8f5e9', skin: '#ffe0bd', hair: '#2d1b00', accent: '#388e3c' },
            { bg: '#fff8e1', skin: '#ffd5b4', hair: '#3d2914', accent: '#f57c00' },
            { bg: '#fce4ec', skin: '#ffe4c4', hair: '#4a3000', accent: '#c2185b' },
            { bg: '#ede7f6', skin: '#ffdbac', hair: '#1a0f00', accent: '#7b1fa2' },
            { bg: '#e0f7fa', skin: '#f5cba7', hair: '#2c1810', accent: '#0097a7' },
        ];

        // ÁîüÊàêÈöèÊú∫Â§¥ÂÉè
        function generateRandomAvatar(gender) {
            if (gender === 'female') {
                const template = femaleAvatarTemplates[Math.floor(Math.random() * femaleAvatarTemplates.length)];
                const colors = femaleColors[Math.floor(Math.random() * femaleColors.length)];
                return template(colors);
            } else {
                const template = maleAvatarTemplates[Math.floor(Math.random() * maleAvatarTemplates.length)];
                const colors = maleColors[Math.floor(Math.random() * maleColors.length)];
                return template(colors);
            }
        }

        // Êï∞ÊçÆ
        let students = loadStudentsFromStorage();
        let totalExchanged = loadBigIntFromStorage('totalExchanged', 0n);
        let inventory = JSON.parse(localStorage.getItem('inventory') || '{}');
        let currentStudentId = null;
        let currentScoreInputType = null;
        let selectedGender = null;

        // ÂàùÂßãÂåñ
        function init() {
            initScoreUnitInput();
            initScoreInputModal();
            renderStudents();
            updateClassStats();
            renderShop();
            renderRoomCabinet();
            detectControlType();
            initVirtualJoystick();
        }

        // ‰øùÂ≠òÂ∫ìÂ≠òÊï∞ÊçÆ
        function saveInventory() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
        }

        // Ê∏≤ÊüìÂïÜÂ∫ó
        function renderShop() {
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = '';

            const coinSvg = `<svg class="coin-icon coin-svg" viewBox="0 0 100 100">
                <defs><linearGradient id="coinGold3" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFD700"/><stop offset="50%" style="stop-color:#FFEC8B"/>
                    <stop offset="100%" style="stop-color:#B8860B"/></linearGradient></defs>
                <circle cx="50" cy="50" r="45" fill="url(#coinGold3)" stroke="#B8860B" stroke-width="4"/>
                <text x="50" y="58" font-size="28" font-weight="bold" fill="#B8860B" text-anchor="middle">$</text>
            </svg>`;

            shopItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.onclick = () => buyItem(item);
                div.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${coinSvg}<span>${item.price}</span></div>
                `;
                grid.appendChild(div);
            });
        }

        // ÂΩìÂâçË¶ÅË¥≠‰π∞ÁöÑÂïÜÂìÅ
        let currentPurchaseItem = null;

        // Ë¥≠‰π∞ÂïÜÂìÅ - ÊâìÂºÄÈÄâÊã©Â≠¶ÁîüÂºπÁ™ó
        function buyItem(item) {
            if (students.length === 0) {
                alert('ËøòÊ≤°ÊúâÂ≠¶ÁîüÂë¢ÔºåÂÖàÊ∑ªÂä†Â≠¶ÁîüÂêßÔºÅ');
                return;
            }

            currentPurchaseItem = item;
            renderSelectStudentList(item);
            closeShopModal();
            document.getElementById('selectStudentModal').classList.add('active');
        }

        // Ê∏≤ÊüìÈÄâÊã©Â≠¶ÁîüÂàóË°®
        function renderSelectStudentList(item) {
            const coinSvg = `<svg class="coin-icon coin-svg" viewBox="0 0 100 100">
                <defs><linearGradient id="coinGold4" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFD700"/><stop offset="50%" style="stop-color:#FFEC8B"/>
                    <stop offset="100%" style="stop-color:#B8860B"/></linearGradient></defs>
                <circle cx="50" cy="50" r="45" fill="url(#coinGold4)" stroke="#B8860B" stroke-width="4"/>
                <text x="50" y="58" font-size="28" font-weight="bold" fill="#B8860B" text-anchor="middle">$</text>
            </svg>`;

            // ÊòæÁ§∫ÂïÜÂìÅÈ¢ÑËßà
            const preview = document.getElementById('purchaseItemPreview');
            preview.innerHTML = `
                <div class="item-icon">${item.icon}</div>
                <div class="item-details">
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${coinSvg}<span>${item.price}</span></div>
                </div>
            `;

            // ÊòæÁ§∫Â≠¶ÁîüÂàóË°®
            const list = document.getElementById('selectStudentList');
            list.innerHTML = '';

            const itemPrice = BigInt(item.price);
            students.forEach(student => {
                const canAfford = student.score >= itemPrice;
                const div = document.createElement('div');
                div.className = 'select-student-item' + (canAfford ? '' : ' disabled');
                div.innerHTML = `
                    <div class="student-avatar">${student.avatar}</div>
                    <div class="student-info">
                        <div class="name">${student.name}</div>
                        <div class="score">ÁßØÂàÜ: ${formatScore(student.score)}</div>
                        ${!canAfford ? '<div class="not-enough">ÁßØÂàÜ‰∏çË∂≥</div>' : ''}
                    </div>
                `;
                if (canAfford) {
                    div.onclick = () => confirmPurchase(student.id);
                }
                list.appendChild(div);
            });
        }

        // Á°ÆËÆ§Ë¥≠‰π∞
        function confirmPurchase(studentId) {
            const student = students.find(s => s.id === studentId);
            const item = currentPurchaseItem;

            if (!student || !item) return;

            const itemPrice = BigInt(item.price);
            if (student.score < itemPrice) {
                alert('ÁßØÂàÜ‰∏çË∂≥ÔºÅ');
                return;
            }

            // Êâ£Èô§ÁßØÂàÜ
            student.score -= itemPrice;

            // Á¥ØËÆ°ÂÖëÊç¢ÁßØÂàÜ
            totalExchanged += itemPrice;
            student.totalExchanged = (student.totalExchanged || 0n) + itemPrice;

            // ÁâπÊÆäÂ§ÑÁêÜÔºöÊñ∞Âú∫ÊôØ
            if (item.id === 'new_scene') {
                // ‰∏∫ËØ•Â≠¶ÁîüËß£ÈîÅ‰∏Ä‰∏™Êñ∞Âú∫ÊôØ
                const newSceneId = unlockNewScene(studentId);
                if (newSceneId !== null) {
                    // Ê∑ªÂä†ËÆ∞ÂΩï
                    addRecord('buy', student.name, itemPrice, `${item.name} (Âú∫ÊôØ${newSceneId + 1})`);

                    saveData();
                    renderStudents();
                    closeSelectStudentModal();

                    // ÊòæÁ§∫Ëß£ÈîÅÊàêÂäü
                    const success = document.createElement('div');
                    success.className = 'exchange-success';
                    success.innerHTML = `
                        <div style="font-size:50px;">üé®</div>
                        <div class="text">${student.name} Ëß£ÈîÅ‰∫ÜÂú∫ÊôØ ${newSceneId + 1}ÔºÅ</div>
                    `;
                    document.body.appendChild(success);
                    setTimeout(() => {
                        success.style.opacity = '0';
                        success.style.transition = 'opacity 0.3s';
                        setTimeout(() => success.remove(), 300);
                    }, 1500);
                } else {
                    // Â∑≤ÁªèÂÖ®ÈÉ®Ëß£ÈîÅ‰∫ÜÔºåÈÄÄËøòÁßØÂàÜ
                    student.score += itemPrice;
                    totalExchanged -= itemPrice;
                    student.totalExchanged -= itemPrice;
                    alert('ËØ•Â≠¶ÁîüÂ∑≤Ëß£ÈîÅÂÖ®ÈÉ®100‰∏™Âú∫ÊôØÔºÅ');
                }
                return;
            }

            // ÊôÆÈÄöÁâ©ÂìÅÊ∑ªÂä†Âà∞Â∫ìÂ≠ò
            inventory[item.id] = (inventory[item.id] || 0) + 1;

            // Ê∑ªÂä†ËÆ∞ÂΩï
            addRecord('buy', student.name, itemPrice, item.name);

            saveData();
            saveInventory();
            renderStudents();
            renderRoomCabinet();

            closeSelectStudentModal();

            // ÊòæÁ§∫Ë¥≠‰π∞ÊàêÂäü
            showPurchaseSuccess(item, student.name);
        }

        // ÂÖ≥Èó≠ÈÄâÊã©Â≠¶ÁîüÂºπÁ™ó
        function closeSelectStudentModal() {
            document.getElementById('selectStudentModal').classList.remove('active');
            currentPurchaseItem = null;
        }

        // ÊòæÁ§∫Ë¥≠‰π∞ÊàêÂäü
        function showPurchaseSuccess(item, studentName) {
            const success = document.createElement('div');
            success.className = 'exchange-success';
            success.innerHTML = `
                <div class="icon" style="font-size:50px;">${item.icon}</div>
                <div class="text">${studentName} Ë¥≠‰π∞‰∫Ü ${item.name}ÔºÅ</div>
            `;
            document.body.appendChild(success);

            setTimeout(() => {
                success.style.opacity = '0';
                success.style.transition = 'opacity 0.3s';
                setTimeout(() => success.remove(), 300);
            }, 1500);
        }

        // ÊâìÂºÄÂïÜÂ∫ó
        function openShopModal() {
            renderShop();
            document.getElementById('shopModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ÂïÜÂ∫ó
        function closeShopModal() {
            document.getElementById('shopModal').classList.remove('active');
        }

        // ÊàøÈó¥Áõ∏ÂÖ≥ÂèòÈáè
        let currentRoomStudentId = null;
        let isOutdoor = false;
        let indoorPlayerPos = { x: 40, y: 25 };
        let playerPos = { x: 50, y: 45 };
        let planePos = { x: 50, y: 60 };
        let planeActive = false;
        let planeCrashed = false;      // È£ûÊú∫ÊòØÂê¶Â∑≤Âù†ÊØÅ
        let planeHovering = false;     // È£ûÊú∫ÊòØÂê¶Ê≠£Âú®ÁõòÊóã
        let planeWarningTimer = null;  // ÂÆ§ÂÜÖÈ£ûË°åË≠¶ÂëäÂÆöÊó∂Âô®
        let planeCrashTimer = null;    // Âù†ÊØÅÊ£ÄÊµãÂÆöÊó∂Âô®
        let indoorPlanePos = { x: 50, y: 50, z: 30 }; // ÂÆ§ÂÜÖÈ£ûÊú∫3D‰ΩçÁΩÆ (x%, y%, zÈ´òÂ∫¶%)
        let planeVelocity = { x: 0, y: 0, z: 0 };     // È£ûÊú∫ÈÄüÂ∫¶ÂêëÈáè
        let carryingItems = [];
        let isDigging = false;

        // Â§©Ê∞îÁ≥ªÁªü
        let isRaining = false;
        let hasUmbrella = false;
        let rainCountdown = 0;
        let rainTimer = null;
        let gotWet = false;

        // Âú∫ÊôØÁ≥ªÁªü - ÊØè‰∏™Â≠¶ÁîüÊúâËá™Â∑±ÁöÑÂú∫ÊôØÊï∞ÊçÆ
        // Â≠¶ÁîüÂú∫ÊôØÊï∞ÊçÆÂ≠òÂÇ®Âú® student.unlockedScenes Âíå student.currentSceneId

        // ÁîüÊàê100‰∏™Âú∫ÊôØÈÖçÁΩÆ
        const sceneConfigs = [];
        (function generateScenes() {
            // Â§©Á©∫È¢úËâ≤
            const skyColors = [
                ['#87ceeb', '#b0e0e6'], // Êô¥Â§©
                ['#ff7e5f', '#feb47b'], // ÈªÑÊòè
                ['#1a1a2e', '#16213e'], // Â§úÊôö
                ['#a8c0ff', '#3f2b96'], // Á¥´Ëâ≤Â§©Á©∫
                ['#11998e', '#38ef7d'], // ÊûÅÂÖâ
                ['#fc466b', '#3f5efb'], // Ê¢¶Âπª
                ['#f5af19', '#f12711'], // ÁÅ´ÁÉß‰∫ë
                ['#00c6ff', '#0072ff'], // Ê∑±Ëìù
                ['#ffecd2', '#fcb69f'], // Á≤âËâ≤
                ['#667eea', '#764ba2'], // Á¥´ÁΩóÂÖ∞
            ];
            // ËçâÂú∞È¢úËâ≤
            const grassColors = [
                ['#7cba4f', '#5a9a32'], // ÁªøËâ≤
                ['#a8e063', '#56ab2f'], // ÊµÖÁªø
                ['#134e5e', '#71b280'], // Ê∑±Áªø
                ['#f7971e', '#ffd200'], // ÈáëÈªÑÔºàÁßãÂ§©Ôºâ
                ['#c9d6ff', '#e2e2e2'], // Èõ™Âú∞
                ['#614385', '#516395'], // Á¥´Ëâ≤Ëä±Áî∞
                ['#f093fb', '#f5576c'], // Á≤âËâ≤Ëä±Êµ∑
                ['#4facfe', '#00f2fe'], // ÂÜ∞Èúú
                ['#43e97b', '#38f9d7'], // Áø†Áªø
                ['#fa709a', '#fee140'], // ÂΩ©Ëôπ
            ];
            // Ë£ÖÈ•∞Áâ©Á±ªÂûã
            const decorTypes = ['fountain', 'pond', 'statue', 'swing', 'bench', 'well', 'gazebo', 'bridge', 'windmill', 'campfire'];
            // Ê†ëÊú®Êï∞ÈáèÂíåÁ±ªÂûã
            const treeStyles = ['normal', 'pine', 'cherry', 'palm', 'willow'];
            // Ëä±ÊúµÁ±ªÂûã
            const flowerTypes = ['üå∏', 'üå∫', 'üåª', 'üå∑', 'üåπ', 'üíê', 'ü™ª', 'üåº', 'üíÆ', 'üèµÔ∏è'];

            for (let i = 0; i < 100; i++) {
                const skyIndex = i % skyColors.length;
                const grassIndex = Math.floor(i / 10) % grassColors.length;
                const decorIndex = i % decorTypes.length;
                const treeStyle = treeStyles[i % treeStyles.length];
                const flowerType = flowerTypes[i % flowerTypes.length];
                const treeCount = 2 + (i % 4);
                const flowerCount = 3 + (i % 5);
                const hasSun = i % 3 !== 2; // Â§úÊôöÂú∫ÊôØÊ≤°ÊúâÂ§™Èò≥
                const hasCloud = i % 4 !== 3;
                const hasSandbox = i % 2 === 0;

                sceneConfigs.push({
                    id: i,
                    name: `Âú∫ÊôØ ${i + 1}`,
                    skyColors: skyColors[skyIndex],
                    grassColors: grassColors[grassIndex],
                    decorType: decorTypes[decorIndex],
                    treeStyle: treeStyle,
                    treeCount: treeCount,
                    flowerType: flowerType,
                    flowerCount: flowerCount,
                    hasSun: hasSun,
                    hasCloud: hasCloud,
                    hasSandbox: hasSandbox,
                    // ÁâπÊÆäË£ÖÈ•∞‰ΩçÁΩÆ
                    decorX: 40 + (i % 20),
                    decorY: 35 + (i % 10),
                });
            }
        })();

        // Ëé∑ÂèñÂ≠¶ÁîüÁöÑÂú∫ÊôØÊï∞ÊçÆ
        function getStudentSceneData(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return { unlockedScenes: [0], currentSceneId: 0 };

            // ÂàùÂßãÂåñÂú∫ÊôØÊï∞ÊçÆÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            if (!student.unlockedScenes) {
                student.unlockedScenes = [0];
            }
            if (student.currentSceneId === undefined) {
                student.currentSceneId = 0;
            }

            return {
                unlockedScenes: student.unlockedScenes,
                currentSceneId: student.currentSceneId
            };
        }

        // Ëß£ÈîÅÊñ∞Âú∫ÊôØÔºà‰∏∫ÊåáÂÆöÂ≠¶ÁîüÔºâ
        function unlockNewScene(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return null;

            // ÂàùÂßãÂåñ
            if (!student.unlockedScenes) {
                student.unlockedScenes = [0];
            }

            // Êâæ‰∏Ä‰∏™ËøòÊ≤°Ëß£ÈîÅÁöÑÂú∫ÊôØ
            for (let i = 0; i < 100; i++) {
                if (!student.unlockedScenes.includes(i)) {
                    student.unlockedScenes.push(i);
                    saveData();
                    return i;
                }
            }
            return null; // ÂÖ®ÈÉ®Ëß£ÈîÅ‰∫Ü
        }

        // Â∫îÁî®Âú∫ÊôØ
        function applyScene(sceneId) {
            const scene = sceneConfigs[sceneId];
            if (!scene) return;

            // ‰øùÂ≠òÂà∞ÂΩìÂâçÂ≠¶Áîü
            const student = students.find(s => s.id === currentRoomStudentId);
            if (student) {
                student.currentSceneId = sceneId;
                saveData();
            }

            const outdoor = document.getElementById('roomOutdoor');
            if (!outdoor) return;

            // Â∫îÁî®Â§©Á©∫È¢úËâ≤
            const sky = outdoor.querySelector('.outdoor-sky');
            if (sky) {
                sky.style.background = `linear-gradient(180deg, ${scene.skyColors[0]} 0%, ${scene.skyColors[1]} 100%)`;
            }

            // Â∫îÁî®ËçâÂú∞È¢úËâ≤
            const ground = outdoor.querySelector('.outdoor-ground-3d');
            if (ground) {
                ground.style.background = `linear-gradient(180deg, ${scene.grassColors[0]} 0%, ${scene.grassColors[1]} 100%)`;
            }

            // Â§™Èò≥
            const sun = outdoor.querySelector('.outdoor-sun');
            if (sun) {
                sun.style.display = scene.hasSun ? 'block' : 'none';
            }

            // ‰∫ëÊúµ
            outdoor.querySelectorAll('.outdoor-cloud').forEach(cloud => {
                cloud.style.display = scene.hasCloud ? 'block' : 'none';
            });

            // Ê≤ôÂùë
            const sandbox = outdoor.querySelector('.sandbox-3d');
            if (sandbox) {
                sandbox.style.display = scene.hasSandbox ? 'block' : 'none';
            }

            // Êõ¥Êñ∞Ê†ëÊú®Ê†∑Âºè
            const trees = outdoor.querySelectorAll('.tree');
            trees.forEach((tree, idx) => {
                tree.style.display = idx < scene.treeCount ? 'block' : 'none';
                const leaves = tree.querySelector('.tree-leaves');
                if (leaves) {
                    switch (scene.treeStyle) {
                        case 'pine':
                            leaves.style.background = 'radial-gradient(circle, #1a5f1a 0%, #0d3d0d 100%)';
                            leaves.style.borderRadius = '0 50% 50% 50%';
                            break;
                        case 'cherry':
                            leaves.style.background = 'radial-gradient(circle, #ffb7c5 0%, #ff69b4 100%)';
                            leaves.style.borderRadius = '50%';
                            break;
                        case 'palm':
                            leaves.style.background = 'radial-gradient(circle, #32cd32 0%, #228b22 100%)';
                            leaves.style.borderRadius = '20% 80% 20% 80%';
                            break;
                        case 'willow':
                            leaves.style.background = 'radial-gradient(circle, #90ee90 0%, #3cb371 100%)';
                            leaves.style.borderRadius = '50% 50% 80% 80%';
                            break;
                        default:
                            leaves.style.background = 'radial-gradient(circle, #228B22 0%, #006400 100%)';
                            leaves.style.borderRadius = '50%';
                    }
                }
            });

            // Êõ¥Êñ∞Ëä±Êúµ
            const flowers = outdoor.querySelectorAll('.flower');
            flowers.forEach((flower, idx) => {
                flower.style.display = idx < scene.flowerCount ? 'block' : 'none';
                flower.textContent = '';
                flower.style.setProperty('--flower-emoji', `"${scene.flowerType}"`);
            });

            // Êõ¥Êñ∞Ë£ÖÈ•∞Áâ©ÔºàÁî®Âñ∑Ê≥âÂÖÉÁ¥†Êù•ÊòæÁ§∫‰∏çÂêåË£ÖÈ•∞Ôºâ
            const fountain = outdoor.querySelector('.fountain');
            if (fountain) {
                updateDecoration(fountain, scene.decorType);
            }
        }

        // Êõ¥Êñ∞Ë£ÖÈ•∞Áâ©Â§ñËßÇ
        function updateDecoration(element, decorType) {
            const water = element.querySelector('.fountain-water');
            const drops = element.querySelector('.water-drops');

            switch (decorType) {
                case 'fountain':
                    if (water) water.style.display = 'block';
                    if (drops) drops.style.display = 'block';
                    break;
                case 'pond':
                    if (water) water.style.display = 'none';
                    if (drops) drops.style.display = 'none';
                    element.querySelector('.fountain-base').style.background = 'linear-gradient(180deg, #4a90d9 0%, #2c5aa0 100%)';
                    break;
                case 'statue':
                    if (water) water.style.display = 'none';
                    if (drops) drops.style.display = 'none';
                    element.querySelector('.fountain-pillar').style.height = '60px';
                    break;
                default:
                    if (water) water.style.display = 'block';
                    if (drops) drops.style.display = 'block';
            }
        }

        // ÊâìÂºÄÂú∫ÊôØÈÄâÊã©ÂºπÁ™ó
        function openSceneModal() {
            renderSceneGrid();
            document.getElementById('sceneModal').classList.add('active');
        }

        // ÂÖ≥Èó≠Âú∫ÊôØÈÄâÊã©ÂºπÁ™ó
        function closeSceneModal() {
            document.getElementById('sceneModal').classList.remove('active');
        }

        // Ê∏≤ÊüìÂú∫ÊôØÈÄâÊã©ÁΩëÊ†º
        function renderSceneGrid() {
            const grid = document.getElementById('sceneGrid');
            grid.innerHTML = '';

            const sceneData = getStudentSceneData(currentRoomStudentId);
            const student = students.find(s => s.id === currentRoomStudentId);
            const currentScene = student ? (student.currentSceneId || 0) : 0;

            // Êõ¥Êñ∞Ëß£ÈîÅÊï∞ÈáèÊòæÁ§∫
            document.getElementById('sceneUnlockedCount').textContent =
                `${sceneData.unlockedScenes.length} / 100`;

            // Ê∏≤ÊüìÊâÄÊúâÂú∫ÊôØ
            for (let i = 0; i < 100; i++) {
                const scene = sceneConfigs[i];
                const isUnlocked = sceneData.unlockedScenes.includes(i);
                const isActive = currentScene === i;

                const div = document.createElement('div');
                div.className = 'scene-item' + (isActive ? ' active' : '') + (isUnlocked ? '' : ' locked');

                // ÂàõÂª∫3DÁ´ã‰ΩìÈ¢ÑËßà
                div.innerHTML = `
                    <div class="scene-preview">
                        <div class="scene-sky" style="background: linear-gradient(180deg, ${scene.skyColors[0]} 0%, ${scene.skyColors[1]} 100%); position:relative;">
                            ${scene.hasSun ? '<div style="position:absolute;top:5px;right:8px;width:15px;height:15px;background:radial-gradient(circle,#fff700,#ffa500);border-radius:50%;"></div>' : ''}
                            ${scene.hasCloud ? '<div style="position:absolute;top:8px;left:5px;width:20px;height:8px;background:white;border-radius:10px;opacity:0.8;"></div>' : ''}
                        </div>
                        <div class="scene-ground" style="background: linear-gradient(180deg, ${scene.grassColors[0]} 0%, ${scene.grassColors[1]} 100%); position:relative; transform: perspective(50px) rotateX(5deg); transform-origin: top;">
                            <div style="position:absolute;bottom:20%;left:50%;transform:translateX(-50%);font-size:12px;">${scene.decorType === 'fountain' ? '‚õ≤' : scene.decorType === 'pond' ? 'üíß' : 'üóø'}</div>
                            <div style="position:absolute;bottom:10%;left:20%;font-size:10px;">üå≥</div>
                            <div style="position:absolute;bottom:5%;right:25%;font-size:8px;">${scene.flowerType}</div>
                            ${scene.hasSandbox ? '<div style="position:absolute;bottom:15%;right:10%;width:15px;height:8px;background:#f4d03f;border-radius:50%;border:1px solid #8B4513;"></div>' : ''}
                        </div>
                    </div>
                    <div class="scene-number">${i + 1}</div>
                `;

                if (isUnlocked) {
                    div.onclick = () => selectScene(i);
                }

                grid.appendChild(div);
            }
        }

        // ÈÄâÊã©Âú∫ÊôØ
        function selectScene(sceneId) {
            applyScene(sceneId);
            renderSceneGrid();

            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:15px 30px;border-radius:15px;z-index:9999;font-size:16px;';
            toast.textContent = `Â∑≤ÂàáÊç¢Âà∞Âú∫ÊôØ ${sceneId + 1}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1500);
        }

        // ÊâìÂºÄÊàøÈó¥ÔºàÈÄâÊã©Â≠¶ÁîüÔºâ
        function openRoomModal() {
            renderSelectRoomStudentList();
            document.getElementById('selectRoomStudentModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ÈÄâÊã©ÊàøÈó¥Â≠¶ÁîüÂºπÁ™ó
        function closeSelectRoomStudentModal() {
            document.getElementById('selectRoomStudentModal').classList.remove('active');
        }

        // Ê∏≤ÊüìÈÄâÊã©ËøõÂÖ•ÊàøÈó¥ÁöÑÂ≠¶ÁîüÂàóË°®
        function renderSelectRoomStudentList() {
            const list = document.getElementById('selectRoomStudentList');
            list.innerHTML = '';

            if (students.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ËøòÊ≤°ÊúâÂ≠¶Áîü</div>';
                return;
            }

            students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'select-student-item';
                div.innerHTML = `
                    <div class="student-avatar">${student.avatar}</div>
                    <div class="student-info">
                        <div class="name">${student.name}</div>
                        <div class="score">ÁßØÂàÜ: ${formatScore(student.score)}</div>
                    </div>
                `;
                div.onclick = () => enterRoom(student.id);
                list.appendChild(div);
            });
        }

        // ËøõÂÖ•ÊàøÈó¥
        function enterRoom(studentId) {
            currentRoomStudentId = studentId;
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            closeSelectRoomStudentModal();

            // ËÆæÁΩÆÂ≠¶Áîü‰ø°ÊÅØ
            document.getElementById('roomStudentAvatar').innerHTML = student.avatar;
            document.getElementById('roomStudentName').textContent = student.name;

            // ÂàùÂßãÂåñÊàøÈó¥Áä∂ÊÄÅ
            isOutdoor = false;
            carryingItems = [];
            indoorPlayerPos = { x: 40, y: 25 };
            playerPos = { x: 50, y: 45 };

            // Â∫îÁî®ËØ•Â≠¶ÁîüÁöÑÂΩìÂâçÂú∫ÊôØ
            const sceneId = student.currentSceneId || 0;
            applyScene(sceneId);

            // ÊòæÁ§∫ÂÆ§ÂÜÖ
            document.getElementById('roomIndoor').style.display = 'block';
            document.getElementById('roomOutdoor').style.display = 'none';
            updateControlUI();

            // Ê∏≤ÊüìÊüúÂ≠êÂíåÂÆ§ÂÜÖÁé©ÂÆ∂
            renderRoomCabinet();
            renderCarryItems();
            renderIndoorPlayer();

            // ÊòæÁ§∫ÂÖ®Â±èÊàøÈó¥
            document.getElementById('fullscreenRoom').classList.add('active');

            // Ê∑ªÂä†ÈîÆÁõòÁõëÂê¨
            document.addEventListener('keydown', handleRoomKeydown);
        }

        // Ê∏≤ÊüìÂÆ§ÂÜÖÁé©ÂÆ∂
        function renderIndoorPlayer() {
            const student = students.find(s => s.id === currentRoomStudentId);
            if (!student) return;

            const player = document.getElementById('indoorPlayer');
            const avatar = document.getElementById('indoorPlayerAvatar');
            const badges = document.getElementById('indoorPlayerBadges');

            avatar.innerHTML = student.avatar;
            player.style.left = indoorPlayerPos.x + '%';
            player.style.bottom = indoorPlayerPos.y + '%';

            // Ê∏≤ÊüìÂæΩÁ´†
            badges.innerHTML = '';
            carryingItems.filter(id => id.includes('badge')).forEach(itemId => {
                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;
                const badge = document.createElement('div');
                badge.className = 'badge';
                badge.innerHTML = item.icon;
                badges.appendChild(badge);
            });
        }

        // ÈÄÄÂá∫ÊàøÈó¥
        function exitRoom() {
            document.getElementById('fullscreenRoom').classList.remove('active');
            document.removeEventListener('keydown', handleRoomKeydown);
            
            // ÂÅúÊ≠¢È£ûÊú∫Áõ∏ÂÖ≥
            planeActive = false;
            planeHovering = false;
            stopIndoorWarning();
            stopCrashDetection();
            hidePlaneControls();
            if (hoverInterval) {
                clearInterval(hoverInterval);
                hoverInterval = null;
            }
            
            currentRoomStudentId = null;
            closeMap();
            // ÂÅúÊ≠¢ÊëáÊùÜÂä®Áîª
            if (joystickAnimationId) {
                cancelAnimationFrame(joystickAnimationId);
                joystickAnimationId = null;
            }
        }

        // ÂéªÊà∑Â§ñÔºà‰ªéÈó®Âè£Âá∫ÂéªÔºâ
        function goOutdoor() {
            // Ê£ÄÊü•ÊòØÂê¶Â∏¶‰ºû
            hasUmbrella = carryingItems.includes('umbrella');

            // ÈöèÊú∫Â§©Ê∞îÔºö70%Êô¥Â§©Ôºå30%Èõ®Â§©
            isRaining = Math.random() > 0.7;

            isOutdoor = true;
            
            // Â¶ÇÊûúÂú®ÂÆ§ÂÜÖÈ£ûË°åÈ£ûÊú∫ÔºåÂÅúÊ≠¢ÂÆ§ÂÜÖÈ£ûË°å
            if (planeActive) {
                stopIndoorWarning();
                stopCrashDetection();
                document.getElementById('indoorPlane').style.display = 'none';
                // ÂàáÊç¢Âà∞Êà∑Â§ñÈ£ûÊú∫
                document.getElementById('rcPlane').style.display = 'block';
                planePos = { x: 50, y: 52 };
                const plane = document.getElementById('rcPlane');
                plane.style.left = planePos.x + '%';
                plane.style.bottom = planePos.y + '%';
            }
            
            document.getElementById('roomIndoor').style.display = 'none';
            document.getElementById('roomOutdoor').style.display = 'block';
            playerPos = { x: 50, y: 52 }; // ‰ªéÊàøÂ≠êÈó®Âè£Âá∫Êù•
            renderPlayer();
            updateSandboxHint();

            // ÊòæÁ§∫Â§©Ê∞î
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherIcon = document.getElementById('weatherIcon');
            const weatherText = document.getElementById('weatherText');
            weatherDisplay.style.display = 'block';

            if (isRaining) {
                weatherIcon.textContent = 'üåßÔ∏è';
                weatherText.textContent = 'Èõ®Â§©';
                startRain();

                if (!hasUmbrella) {
                    // Ê≤°Â∏¶‰ºûÔºåÂºÄÂßã5ÁßíÂÄíËÆ°Êó∂
                    startRainCountdown();
                    const hintText = controlType === 'touch' ? '‚ö†Ô∏è ‰∏ãÈõ®‰∫ÜÔºÅ5ÁßíÂÜÖÂõûÊàøÈó¥ÔºÅ' : '‚ö†Ô∏è ‰∏ãÈõ®‰∫ÜÔºÅ5ÁßíÂÜÖÂõûÊàøÈó¥ÔºÅ';
                    document.getElementById('controlHint').innerHTML = hintText;
                } else {
                    // Â∏¶‰∫Ü‰ºûÔºåÂÆâÂÖ®
                    document.getElementById('player').classList.add('player-with-umbrella');
                    const hintText = controlType === 'touch' ? '‚òÇÔ∏è ÊâìÁùÄ‰ºûÔºåÈõ®‰∏≠Êº´Ê≠•~' : '‚òÇÔ∏è ÊâìÁùÄ‰ºûÔºåÈõ®‰∏≠Êº´Ê≠•~';
                    document.getElementById('controlHint').innerHTML = hintText;
                }
            } else {
                weatherIcon.textContent = '‚òÄÔ∏è';
                weatherText.textContent = 'Êô¥Â§©';
                stopRain();
                updateControlUI();
            }
        }

        // ÂºÄÂßã‰∏ãÈõ®ÊïàÊûú
        function startRain() {
            const rainOverlay = document.getElementById('rainOverlay');
            rainOverlay.style.display = 'block';
            rainOverlay.innerHTML = '';

            // ÂàõÂª∫Èõ®Êª¥
            for (let i = 0; i < 100; i++) {
                const drop = document.createElement('div');
                drop.className = 'raindrop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.animationDelay = Math.random() * 0.5 + 's';
                drop.style.animationDuration = (0.3 + Math.random() * 0.3) + 's';
                rainOverlay.appendChild(drop);
            }
        }

        // ÂÅúÊ≠¢‰∏ãÈõ®
        function stopRain() {
            document.getElementById('rainOverlay').style.display = 'none';
            document.getElementById('player').classList.remove('player-with-umbrella');
            if (rainTimer) {
                clearInterval(rainTimer);
                rainTimer = null;
            }
        }

        // ÂºÄÂßãÈõ®Â§©ÂÄíËÆ°Êó∂
        function startRainCountdown() {
            rainCountdown = 5;
            gotWet = false;

            // ÊòæÁ§∫ÂÄíËÆ°Êó∂Ë≠¶Âëä
            const warning = document.createElement('div');
            warning.className = 'weather-warning';
            warning.id = 'rainWarning';
            warning.innerHTML = `
                <div class="icon">üåßÔ∏è</div>
                <div class="text">‰∏ãÈõ®‰∫ÜÔºÅÂø´ÂõûÊàøÈó¥ÔºÅ</div>
                <div class="countdown" id="rainCountdownDisplay">${rainCountdown}</div>
            `;
            document.body.appendChild(warning);

            rainTimer = setInterval(() => {
                rainCountdown--;
                const display = document.getElementById('rainCountdownDisplay');
                if (display) {
                    display.textContent = rainCountdown;
                }

                if (rainCountdown <= 0) {
                    // Êó∂Èó¥Âà∞ÔºåÊ∑ãÊπø‰∫Ü
                    clearInterval(rainTimer);
                    rainTimer = null;
                    const warningEl = document.getElementById('rainWarning');
                    if (warningEl) warningEl.remove();

                    if (isOutdoor && !hasUmbrella && !gotWet) {
                        getWet();
                    }
                }
            }, 1000);
        }

        // Ê∑ãÊπøÊïàÊûú
        function getWet() {
            gotWet = true;
            stopRain();

            // ÊòæÁ§∫Ê∑ãÊπøÊïàÊûú
            const wetOverlay = document.createElement('div');
            wetOverlay.className = 'got-wet-overlay';
            wetOverlay.id = 'wetOverlay';
            wetOverlay.innerHTML = `
                <div class="icon">üí¶</div>
                <div class="text">ÂïäÔºÅË¢´Ê∑ãÊπø‰∫ÜÔºÅ</div>
            `;
            document.body.appendChild(wetOverlay);

            // Âº∫Âà∂ÂõûÊàøÈó¥
            setTimeout(() => {
                const overlay = document.getElementById('wetOverlay');
                if (overlay) overlay.remove();
                goIndoor();
            }, 2000);
        }

        // ÂõûÊàøÈó¥Ôºà‰ªéÊàøÂ≠êÂÖ•Âè£ËøõÂÖ•Ôºâ
        function goIndoor() {
            // Ê∏ÖÁêÜÈõ®Â§©Áä∂ÊÄÅ
            const warning = document.getElementById('rainWarning');
            if (warning) warning.remove();
            if (rainTimer) {
                clearInterval(rainTimer);
                rainTimer = null;
            }
            stopRain();
            document.getElementById('weatherDisplay').style.display = 'none';
            gotWet = false;

            isOutdoor = false;
            
            // Â¶ÇÊûúÂú®È£ûË°åÈ£ûÊú∫ÔºåÂÖ≥Èó≠È£ûÊú∫
            if (planeActive) {
                planeActive = false;
                planeHovering = false;
                document.getElementById('rcPlane').style.display = 'none';
                document.getElementById('indoorPlane').style.display = 'none';
                hidePlaneControls();
                if (hoverInterval) {
                    clearInterval(hoverInterval);
                    hoverInterval = null;
                }
            }
            
            document.getElementById('roomIndoor').style.display = 'block';
            document.getElementById('roomOutdoor').style.display = 'none';
            updateControlUI();
            indoorPlayerPos = { x: 40, y: 25 };
            renderIndoorPlayer();
            closeMap();
        }

        // Ê∏≤ÊüìÊàøÈó¥ÊüúÂ≠ê
        function renderRoomCabinet() {
            const grid = document.getElementById('roomCabinetGrid');
            grid.innerHTML = '';

            const ownedItems = Object.entries(inventory).filter(([id, count]) => count > 0);

            if (ownedItems.length === 0) {
                grid.innerHTML = '<div style="text-align:center;color:#ffd43b;padding:20px;grid-column:1/-1;">ÊüúÂ≠êÊòØÁ©∫ÁöÑ~<br>ÂéªÂïÜÂ∫ó‰π∞‰∫õ‰∏úË•øÂêßÔºÅ</div>';
                return;
            }

            ownedItems.forEach(([itemId, count]) => {
                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;

                const div = document.createElement('div');
                div.className = 'cabinet-item';
                div.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-count">x${count}</div>
                `;
                div.onclick = () => takeItem(itemId);
                grid.appendChild(div);
            });
        }

        // ÊãøÂèñÁâ©ÂìÅ
        function takeItem(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊê∫Â∏¶‰∫Ü
            if (carryingItems.includes(itemId)) {
                alert('Â∑≤ÁªèÊê∫Â∏¶‰∫ÜËøô‰∏™Áâ©ÂìÅÔºÅ');
                return;
            }

            // ÊúÄÂ§öÊê∫Â∏¶4‰∏™Áâ©ÂìÅ
            if (carryingItems.length >= 4) {
                alert('ÊúÄÂ§öÂè™ËÉΩÊê∫Â∏¶4‰∏™Áâ©ÂìÅÔºÅ');
                return;
            }

            carryingItems.push(itemId);
            renderCarryItems();

            // Â¶ÇÊûúÊòØÂæΩÁ´†ÔºåÊõ¥Êñ∞Áé©ÂÆ∂ÊòæÁ§∫
            if (itemId.includes('badge')) {
                renderIndoorPlayer();
                if (isOutdoor) renderPlayer();
            }
        }

        // Ê∏≤ÊüìÊê∫Â∏¶Áâ©ÂìÅ
        function renderCarryItems() {
            const container = document.getElementById('carryItems');
            container.innerHTML = '';

            carryingItems.forEach((itemId, index) => {
                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;

                const div = document.createElement('div');
                div.className = 'carry-item' + (itemId === 'rc_plane' && planeActive ? ' active' : '');
                div.innerHTML = `<div class="item-icon">${item.icon}</div>`;
                div.onclick = () => useItem(itemId);
                container.appendChild(div);
            });

            // Â¶ÇÊûúÊ≤°ÊúâÊê∫Â∏¶Áâ©ÂìÅÔºåÊòæÁ§∫ÊèêÁ§∫
            if (carryingItems.length === 0) {
                container.innerHTML = '<div style="color:rgba(255,255,255,0.5);font-size:12px;">ÁÇπÂáªÊüúÂ≠ê‰∏≠ÁöÑÁâ©ÂìÅÊê∫Â∏¶</div>';
            }
        }

        // ‰ΩøÁî®Áâ©ÂìÅ
        function useItem(itemId) {
            if (itemId === 'rc_plane') {
                togglePlane();
            } else if (itemId === 'sand_set') {
                if (!isOutdoor) {
                    alert('ÊåñÊ≤ôÂ•óË£ÖÈúÄË¶ÅÂéªÊà∑Â§ñÊ≤ôÂùëÊâçËÉΩÁî®ÔºÅ');
                    return;
                }
                // Ê£ÄÊü•ÊòØÂê¶Âú®Ê≤ôÂùëÈôÑËøë
                if (isNearSandbox()) {
                    startDigging();
                } else {
                    alert('Ëµ∞Âà∞Ê≤ôÂùëÊóÅËæπÊâçËÉΩÊåñÊ≤ôÂì¶ÔºÅ');
                }
            }
        }

        // ÂàáÊç¢ÈÅ•ÊéßÈ£ûÊú∫
        function togglePlane() {
            if (!carryingItems.includes('rc_plane')) {
                alert('ÈúÄË¶ÅÂÖà‰ªéÊüúÂ≠êÈáåÊãøÈÅ•ÊéßÈ£ûÊú∫ÔºÅ');
                return;
            }

            // Â¶ÇÊûúÈ£ûÊú∫Â∑≤Âù†ÊØÅÔºå‰∏çËÉΩËµ∑È£û
            if (planeCrashed) {
                alert('È£ûÊú∫Â∑≤ÁªèÊëîÂùè‰∫ÜÔºÅÈúÄË¶ÅÂéªÂïÜÂ∫ó‰π∞Êñ∞ÁöÑ„ÄÇ');
                return;
            }

            planeActive = !planeActive;
            
            if (isOutdoor) {
                // Êà∑Â§ñÈ£ûË°å
                toggleOutdoorPlane();
            } else {
                // ÂÆ§ÂÜÖÈ£ûË°å
                toggleIndoorPlane();
            }
            
            renderCarryItems();
        }

        // ÂàáÊç¢Êà∑Â§ñÈ£ûÊú∫
        function toggleOutdoorPlane() {
            const plane = document.getElementById('rcPlane');
            if (planeActive) {
                plane.style.display = 'block';
                plane.innerHTML = shopItems.find(i => i.id === 'rc_plane').icon;
                plane.classList.add('flying');
                planePos = { x: playerPos.x, y: playerPos.y + 15 };
                plane.style.left = planePos.x + '%';
                plane.style.bottom = planePos.y + '%';
                showPlaneControls();
            } else {
                plane.style.display = 'none';
                plane.classList.remove('flying');
                hidePlaneControls();
            }
        }

        // ÂàáÊç¢ÂÆ§ÂÜÖÈ£ûÊú∫
        function toggleIndoorPlane() {
            const plane = document.getElementById('indoorPlane');
            if (planeActive) {
                // ÂàùÂßãÂåñÂÆ§ÂÜÖÈ£ûÊú∫‰ΩçÁΩÆÔºà3DÁ©∫Èó¥Ôºâ
                indoorPlanePos = { x: 50, y: 50, z: 30 }; // x, y, z(È´òÂ∫¶)
                planeVelocity = { x: 0, y: 0, z: 0 };
                plane.style.display = 'block';
                plane.innerHTML = shopItems.find(i => i.id === 'rc_plane').icon;
                plane.classList.add('flying');
                updateIndoorPlanePosition();
                
                // ÊòæÁ§∫ÊéßÂà∂Èù¢Êùø
                showPlaneControls();
                
                // ÂºÄÂßãÂÆ§ÂÜÖÈ£ûË°åË≠¶Âëä
                startIndoorWarning();
                
                // ÂºÄÂßãÂù†ÊØÅÊ£ÄÊµã
                startCrashDetection();
            } else {
                plane.style.display = 'none';
                plane.classList.remove('flying');
                hidePlaneControls();
                stopIndoorWarning();
                stopCrashDetection();
            }
        }

        // ÊòæÁ§∫È£ûÊú∫ÊéßÂà∂Èù¢ÊùøÂíåÊëáÊùÜ
        function showPlaneControls() {
            const panel = document.getElementById('planeControlPanel');
            panel.classList.add('active');
            
            // Ê†πÊçÆÊéßÂà∂ÊñπÂºèÊòæÁ§∫‰∏çÂêåÁöÑÊéßÂà∂ÁïåÈù¢
            if (controlType === 'touch' || controlType === 'gamepad') {
                // ÊòæÁ§∫Â§ßÂè∑ÊëáÊùÜ
                document.getElementById('planeJoystick').classList.add('active');
                initPlaneJoystick();
            }
            
            updatePlaneControlHint();
        }

        // ÈöêËóèÈ£ûÊú∫ÊéßÂà∂Èù¢Êùø
        function hidePlaneControls() {
            document.getElementById('planeControlPanel').classList.remove('active');
            document.getElementById('planeJoystick').classList.remove('active');
            planeHovering = false;
            updateControlUI();
        }

        // Êõ¥Êñ∞È£ûÊú∫ÊéßÂà∂ÊèêÁ§∫
        function updatePlaneControlHint() {
            const hint = document.getElementById('controlHint');
            if (isOutdoor) {
                if (controlType === 'keyboard') {
                    hint.innerHTML = '‚Üë‚Üì‚Üê‚ÜíÊéßÂà∂È£ûÊú∫ | QÈôçËêΩ | HÁõòÊóã';
                } else {
                    hint.innerHTML = 'ÊëáÊùÜÊéßÂà∂È£ûÊú∫ | ÁõòÊóã/ÈôçËêΩÊåâÈíÆ';
                }
            } else {
                // ÂÆ§ÂÜÖ
                if (controlType === 'keyboard') {
                    hint.innerHTML = '‚ö†Ô∏èÂÆ§ÂÜÖÈ£ûË°åÔºÅ‚Üë‚ÜìÂçáÈôç ‚Üê‚ÜíËΩ¨Âêë | QÈôçËêΩ | HÁõòÊóã';
                } else {
                    hint.innerHTML = '‚ö†Ô∏èÂÆ§ÂÜÖÈ£ûË°åÔºÅÊëáÊùÜÊéßÂà∂ | ÁõòÊóã/ÈôçËêΩÊåâÈíÆ';
                }
            }
        }

        // ÂÆ§ÂÜÖÈ£ûË°åË≠¶ÂëäÁ≥ªÁªü
        function startIndoorWarning() {
            let warningCount = 0;
            planeWarningTimer = setInterval(() => {
                warningCount++;
                
                if (warningCount === 1) {
                    // Á¨¨‰∏ÄÊ¨°Ë≠¶Âëä
                    showPlaneWarning('‰∏çËÉΩÂú®ÂÆ§ÂÜÖÈ£ûÈ£ûÊú∫ (1/3)', true);
                } else if (warningCount === 2) {
                    // Á¨¨‰∫åÊ¨°Ë≠¶Âëä
                    showPlaneWarning('‰∏çËÉΩÂú®ÂÆ§ÂÜÖÈ£ûÈ£ûÊú∫ (2/3)', true);
                } else if (warningCount >= 3) {
                    // Á¨¨‰∏âÊ¨° - È£ûÊú∫Ëá™Âä®Âù†ÊØÅÔºàÊíûÂ¢ô->ÂºπÂà∞Â±ãÈ°∂->ÊéâÂà∞Âú∞‰∏äÔºâ
                    showPlaneWarning('‰∏çËÉΩÂú®ÂÆ§ÂÜÖÈ£ûÈ£ûÊú∫ (3/3)', false);
                    setTimeout(() => {
                        stopIndoorWarning();
                        crashPlaneAuto();
                    }, 500);
                }
            }, 1000);
        }

        // ÂÅúÊ≠¢ÂÆ§ÂÜÖË≠¶Âëä
        function stopIndoorWarning() {
            if (planeWarningTimer) {
                clearInterval(planeWarningTimer);
                planeWarningTimer = null;
            }
            // ÁßªÈô§Ë≠¶ÂëäÊèêÁ§∫
            const existingWarning = document.querySelector('.plane-warning-container');
            if (existingWarning) existingWarning.remove();
        }

        // ÊòæÁ§∫È£ûÊú∫Ë≠¶ÂëäÔºàÂ∏¶‰∏âËßíË≠¶ÂëäÊù°Ê†∑ÂºèÔºâ
        function showPlaneWarning(text, isCountdown) {
            // ÁßªÈô§Áé∞ÊúâË≠¶Âëä
            const existingWarning = document.querySelector('.plane-warning-container');
            if (existingWarning) existingWarning.remove();
            
            // ÂàõÂª∫Ë≠¶ÂëäÂÆπÂô®
            const container = document.createElement('div');
            container.className = 'plane-warning-container';
            container.id = 'planeWarning' + Date.now();
            
            // Á∫¢Ëâ≤‰∏âËßíË≠¶ÂëäÊù°ÔºàCSSÁÆ≠Â§¥Ôºâ
            const arrow = document.createElement('div');
            arrow.className = 'warning-arrow';
            
            // Ë≠¶ÂëäÊñáÂ≠ó
            const message = document.createElement('div');
            message.className = 'warning-message';
            message.textContent = text;
            
            container.appendChild(arrow);
            container.appendChild(message);
            document.body.appendChild(container);
            
            // Âº∫Âà∂ÈáçÁªòÁ°Æ‰øùÊòæÁ§∫
            container.offsetHeight;
            
            // ÈùûÊåÅÁª≠Ë≠¶Âëä3ÁßíÂêéÁßªÈô§
            if (!isCountdown) {
                setTimeout(() => {
                    if (container.parentNode) {
                        container.style.animation = 'warningSlideOut 0.3s ease-in';
                        setTimeout(() => container.remove(), 300);
                    }
                }, 3000);
            }
            
            return container;
        }

        // Ëá™Âä®Âù†ÊØÅÔºàË≠¶ÂëäÁ¨¨‰∏âÊ¨°ÂêéËß¶ÂèëÔºâÔºöÊíûÂ¢ô -> ÂºπÂà∞Â±ãÈ°∂ -> ÊéâÂà∞Âú∞‰∏ä
        function crashPlaneAuto() {
            if (!planeActive || isOutdoor) return;
            
            planeActive = false;
            planeCrashed = true;
            
            const plane = document.getElementById('indoorPlane');
            plane.classList.remove('flying');
            
            // Âù†ÊØÅÈò∂ÊÆµÔºö0=È£ûÂêëÂ¢ôÂ£Å, 1=ÊíûÂ¢ôÂºπÂà∞Â±ãÈ°∂, 2=ÊéâÂà∞Âú∞‰∏ä
            let crashPhase = 0;
            
            // Á°ÆÂÆöÊíûÂ¢ôÊñπÂêëÔºàÈÄâÊã©ÊúÄËøëÁöÑÂ¢ôÔºâ
            const hitLeftWall = indoorPlanePos.x < 50;
            
            const crashAnimation = setInterval(() => {
                if (crashPhase === 0) {
                    // Èò∂ÊÆµ1ÔºöÈ£ûÂêëÂ¢ôÂ£Å
                    if (hitLeftWall) {
                        indoorPlanePos.x -= 1.5;
                        if (indoorPlanePos.x <= 10) crashPhase = 1;
                    } else {
                        indoorPlanePos.x += 1.5;
                        if (indoorPlanePos.x >= 90) crashPhase = 1;
                    }
                } else if (crashPhase === 1) {
                    // Èò∂ÊÆµ2ÔºöÊíûÂ¢ôÂêéÂºπÂà∞Â±ãÈ°∂
                    indoorPlanePos.z += 2; // Âêë‰∏äÈ£ûÂà∞Â±ãÈ°∂
                    // Á®çÂæÆÂõûÂºπ‰∏ÄÁÇπ
                    if (hitLeftWall) {
                        indoorPlanePos.x += 0.5;
                    } else {
                        indoorPlanePos.x -= 0.5;
                    }
                    
                    if (indoorPlanePos.z >= 55) crashPhase = 2;
                } else if (crashPhase === 2) {
                    // Èò∂ÊÆµ3ÔºöÊéâÂà∞Âú∞‰∏ä
                    indoorPlanePos.z -= 3;
                    indoorPlanePos.y -= 0.3; // Á®çÂæÆÂêëÂêéÊéâ
                    
                    if (indoorPlanePos.z <= 5) {
                        // Âù†ÊØÅÂÆåÊàê
                        clearInterval(crashAnimation);
                        indoorPlanePos.z = 5;
                        updateIndoorPlanePosition();
                        
                        // ÊòæÁ§∫Âù†ÊØÅÊïàÊûú
                        const crashEffect = document.createElement('div');
                        crashEffect.className = 'crash-effect';
                        crashEffect.textContent = 'üí•üî•';
                        crashEffect.style.left = plane.style.left;
                        crashEffect.style.bottom = plane.style.bottom;
                        document.getElementById('roomIndoor').appendChild(crashEffect);
                        
                        // 3ÁßíÂêéÊ∏ÖÁêÜÂπ∂ÊèêÁ§∫
                        setTimeout(() => {
                            crashEffect.remove();
                            plane.style.display = 'none';
                            hidePlaneControls();
                            
                            // ‰ªéÊê∫Â∏¶Áâ©ÂìÅ‰∏≠ÁßªÈô§ÊçüÂùèÁöÑÈ£ûÊú∫
                            const index = carryingItems.indexOf('rc_plane');
                            if (index > -1) {
                                carryingItems.splice(index, 1);
                            }
                            planeCrashed = false; // ÈáçÁΩÆÁä∂ÊÄÅÔºå‰ΩÜÈ£ûÊú∫Â∑≤‰ªéËÉåÂåÖÁßªÈô§
                            renderCarryItems();
                            
                            // Âè™ÊòæÁ§∫ÁÆÄÊ¥ÅÁöÑÂù†ÊØÅÊèêÁ§∫
                            alert('È£ûÊú∫Âù†ÊØÅÔºå‰Ω†Â§±Âéª‰∫ÜÈ£ûÊú∫');
                        }, 1000);
                    }
                }
                
                updateIndoorPlanePosition();
            }, 50);
        }

        // Âù†ÊØÅÊ£ÄÊµãÁ≥ªÁªüÔºà‰øùÁïôÁî®‰∫éÊ£ÄÊµãÁî®Êà∑‰∏ªÂä®ÊíûÂ¢ôÔºâ
        function startCrashDetection() {
            planeCrashTimer = setInterval(() => {
                if (!planeActive || isOutdoor) return;
                
                // Ê£ÄÊü•ËæπÁïåÁ¢∞ÊíûÔºàÁî®Êà∑‰∏ªÂä®ÊéßÂà∂ÊíûÂ¢ôÔºâ
                const bounds = {
                    xMin: 5, xMax: 95,  // Â∑¶Âè≥Â¢ô
                    yMin: 5, yMax: 95,  // ÂâçÂêéÂ¢ô
                    zMin: 5,  zMax: 65  // Âú∞ÊùøÂíåÂ§©Ëä±Êùø
                };
                
                const hitWall = indoorPlanePos.x <= bounds.xMin || indoorPlanePos.x >= bounds.xMax ||
                               indoorPlanePos.y <= bounds.yMin || indoorPlanePos.y >= bounds.yMax;
                const hitCeiling = indoorPlanePos.z >= bounds.zMax;
                const hitFloor = indoorPlanePos.z <= bounds.zMin && indoorPlanePos.z > 0;
                
                if (hitWall || hitCeiling || hitFloor) {
                    crashPlaneManual(hitWall ? 'wall' : hitCeiling ? 'ceiling' : 'floor');
                }
                
                // Êõ¥Êñ∞‰ΩçÁΩÆ
                updateIndoorPlanePosition();
            }, 50); // ÊØè50msÊ£ÄÊµã‰∏ÄÊ¨°
        }

        // ÂÅúÊ≠¢Âù†ÊØÅÊ£ÄÊµã
        function stopCrashDetection() {
            if (planeCrashTimer) {
                clearInterval(planeCrashTimer);
                planeCrashTimer = null;
            }
        }

        // ÊâãÂä®Âù†ÊØÅÔºàÁî®Êà∑ÊéßÂà∂ÊíûÂ¢ôÔºâ
        function crashPlaneManual(hitType) {
            planeActive = false;
            planeCrashed = true;
            stopIndoorWarning();
            stopCrashDetection();
            
            const plane = document.getElementById('indoorPlane');
            plane.classList.remove('flying');
            
            // ÊòæÁ§∫Âù†ÊØÅÊïàÊûú
            const crashEffect = document.createElement('div');
            crashEffect.className = 'crash-effect';
            crashEffect.textContent = 'üí•üî•';
            crashEffect.style.left = plane.style.left;
            crashEffect.style.bottom = plane.style.bottom;
            document.getElementById('roomIndoor').appendChild(crashEffect);
            
            // 3ÁßíÂêéÊ∏ÖÁêÜÂπ∂ÊèêÁ§∫
            setTimeout(() => {
                crashEffect.remove();
                plane.style.display = 'none';
                hidePlaneControls();
                
                // ‰ªéÊê∫Â∏¶Áâ©ÂìÅ‰∏≠ÁßªÈô§ÊçüÂùèÁöÑÈ£ûÊú∫
                const index = carryingItems.indexOf('rc_plane');
                if (index > -1) {
                    carryingItems.splice(index, 1);
                }
                planeCrashed = false; // ÈáçÁΩÆÁä∂ÊÄÅÔºå‰ΩÜÈ£ûÊú∫Â∑≤‰ªéËÉåÂåÖÁßªÈô§
                renderCarryItems();
                
                // Âè™ÊòæÁ§∫ÁÆÄÊ¥ÅÁöÑÂù†ÊØÅÊèêÁ§∫
                alert('È£ûÊú∫Âù†ÊØÅÔºå‰Ω†Â§±Âéª‰∫ÜÈ£ûÊú∫');
            }, 1000);
        }

        // Êõ¥Êñ∞ÂÆ§ÂÜÖÈ£ûÊú∫‰ΩçÁΩÆÔºà3DÊïàÊûúÔºâ
        function updateIndoorPlanePosition() {
            const plane = document.getElementById('indoorPlane');
            // Ê†πÊçÆÈ´òÂ∫¶Ë∞ÉÊï¥Â§ßÂ∞èÔºàÈÄèËßÜÊïàÊûúÔºâ
            const scale = 0.5 + (indoorPlanePos.z / 100) * 0.5;
            plane.style.left = indoorPlanePos.x + '%';
            plane.style.bottom = indoorPlanePos.y + '%';
            plane.style.transform = `scale(${scale})`;
            plane.style.zIndex = Math.floor(100 + indoorPlanePos.z);
        }

        // ÁõòÊóãÊ®°Âºè
        function toggleHoverMode() {
            if (!planeActive) return;
            planeHovering = !planeHovering;
            
            const btn = document.getElementById('hoverBtn');
            if (planeHovering) {
                btn.textContent = 'üöÅ ÂÅúÊ≠¢ÁõòÊóã';
                btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%)';
                startHovering();
            } else {
                btn.textContent = 'üöÅ ÁõòÊóãËßÇËµè';
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }

        // ÂºÄÂßãÁõòÊóã
        let hoverAngle = 0;
        let hoverInterval = null;
        function startHovering() {
            if (hoverInterval) clearInterval(hoverInterval);
            
            const centerX = isOutdoor ? playerPos.x : indoorPlanePos.x;
            const centerY = isOutdoor ? playerPos.y : indoorPlanePos.y;
            const radius = isOutdoor ? 10 : 15;
            
            hoverInterval = setInterval(() => {
                if (!planeHovering || !planeActive) {
                    clearInterval(hoverInterval);
                    hoverInterval = null;
                    return;
                }
                
                hoverAngle += 0.05;
                const newX = centerX + Math.cos(hoverAngle) * radius;
                const newY = centerY + Math.sin(hoverAngle) * radius;
                
                if (isOutdoor) {
                    planePos.x = newX;
                    planePos.y = newY;
                    const plane = document.getElementById('rcPlane');
                    plane.style.left = planePos.x + '%';
                    plane.style.bottom = planePos.y + '%';
                } else {
                    indoorPlanePos.x = newX;
                    indoorPlanePos.y = newY;
                    updateIndoorPlanePosition();
                }
            }, 50);
        }

        // Á¥ßÊÄ•ÈôçËêΩ
        function emergencyLand() {
            if (!planeActive) return;
            
            planeHovering = false;
            if (hoverInterval) {
                clearInterval(hoverInterval);
                hoverInterval = null;
            }
            
            // Âπ≥ÊªëÈôçËêΩÂä®Áîª
            const landInterval = setInterval(() => {
                if (isOutdoor) {
                    // Êà∑Â§ñÈôçËêΩÂà∞Áé©ÂÆ∂‰ΩçÁΩÆ
                    const dx = playerPos.x - planePos.x;
                    const dy = playerPos.y - planePos.y;
                    planePos.x += dx * 0.1;
                    planePos.y += dy * 0.1;
                    
                    const plane = document.getElementById('rcPlane');
                    plane.style.left = planePos.x + '%';
                    plane.style.bottom = planePos.y + '%';
                    
                    if (Math.abs(dx) < 1 && Math.abs(dy) < 1) {
                        clearInterval(landInterval);
                        togglePlane(); // ÂÖ≥Èó≠È£ûÊú∫
                    }
                } else {
                    // ÂÆ§ÂÜÖÈôçËêΩÂà∞Âú∞Èù¢
                    indoorPlanePos.z -= 1;
                    updateIndoorPlanePosition();
                    
                    if (indoorPlanePos.z <= 5) {
                        clearInterval(landInterval);
                        togglePlane(); // ÂÖ≥Èó≠È£ûÊú∫
                    }
                }
            }, 50);
        }

        // ÂàùÂßãÂåñÈ£ûÊú∫Â§ßÂè∑ÊëáÊùÜ
        let planeJoystickActive = false;
        let planeJoystickVector = { x: 0, y: 0 };
        function initPlaneJoystick() {
            const joystick = document.getElementById('planeJoystick');
            const knob = document.getElementById('planeJoystickKnob');
            const base = joystick.querySelector('.joystick-base');
            
            let startX, startY;
            let joystickCenterX, joystickCenterY;
            const maxDistance = 22; // ÈÄÇÂ∫îÂ∞èÂè∑ÊëáÊùÜÔºà80pxÔºâ

            function handleTouchStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = base.getBoundingClientRect();
                joystickCenterX = rect.left + rect.width / 2;
                joystickCenterY = rect.top + rect.height / 2;
                startX = touch.clientX;
                startY = touch.clientY;
                planeJoystickActive = true;
            }

            function handleTouchMove(e) {
                if (!planeJoystickActive) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const dx = touch.clientX - joystickCenterX;
                const dy = touch.clientY - joystickCenterY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                let moveX = dx;
                let moveY = dy;
                
                if (distance > maxDistance) {
                    const ratio = maxDistance / distance;
                    moveX = dx * ratio;
                    moveY = dy * ratio;
                }
                
                knob.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
                
                planeJoystickVector.x = moveX / maxDistance;
                planeJoystickVector.y = -(moveY / maxDistance);
            }

            function handleTouchEnd(e) {
                e.preventDefault();
                planeJoystickActive = false;
                planeJoystickVector.x = 0;
                planeJoystickVector.y = 0;
                knob.style.transform = 'translate(-50%, -50%)';
            }

            // ÁªëÂÆöËß¶Êë∏‰∫ã‰ª∂
            joystick.addEventListener('touchstart', handleTouchStart, { passive: false });
            joystick.addEventListener('touchmove', handleTouchMove, { passive: false });
            joystick.addEventListener('touchend', handleTouchEnd, { passive: false });
            joystick.addEventListener('touchcancel', handleTouchEnd, { passive: false });
        }

        // Ê£ÄÊü•ÊòØÂê¶Âú®Ê≤ôÂùëÈôÑËøë
        function isNearSandbox() {
            return playerPos.x > 75 && playerPos.y < 35;
        }

        // Êõ¥Êñ∞Ê≤ôÂùëÊèêÁ§∫
        function updateSandboxHint() {
            const hint = document.getElementById('sandboxHint');
            if (carryingItems.includes('sand_set')) {
                if (isNearSandbox()) {
                    hint.textContent = 'ÁÇπÂáª‰ΩøÁî®ÊåñÊ≤ôÂ•óË£ÖÔºÅ';
                    hint.style.background = 'rgba(76, 175, 80, 0.9)';
                } else {
                    hint.textContent = 'Ëµ∞ËøáÊù•ÊåñÊ≤ôÂêßÔºÅ';
                    hint.style.background = 'rgba(0, 0, 0, 0.7)';
                }
            } else {
                hint.textContent = 'Â∏¶ÊåñÊ≤ôÂ•óË£ÖÊù•Áé©';
                hint.style.background = 'rgba(0, 0, 0, 0.7)';
            }
        }

        // ÂºÄÂßãÊåñÊ≤ô
        function startDigging() {
            isDigging = true;
            alert('ÂºÄÂßãÊåñÊ≤ôÂï¶ÔºÅüèñÔ∏è Â•ΩÂ•ΩÁé©Âêß~');
            setTimeout(() => { isDigging = false; }, 2000);
        }

        // Ê∏≤ÊüìÊà∑Â§ñÁé©ÂÆ∂
        function renderPlayer() {
            const student = students.find(s => s.id === currentRoomStudentId);
            if (!student) return;

            const player = document.getElementById('player');
            const avatar = document.getElementById('playerAvatar');
            const badges = document.getElementById('playerBadges');

            avatar.innerHTML = student.avatar;
            player.style.left = playerPos.x + '%';
            player.style.bottom = playerPos.y + '%';

            // Ê∏≤ÊüìÂæΩÁ´†
            badges.innerHTML = '';
            carryingItems.filter(id => id.includes('badge')).forEach(itemId => {
                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;
                const badge = document.createElement('div');
                badge.className = 'badge';
                badge.innerHTML = item.icon;
                badges.appendChild(badge);
            });
        }

        // Ê∏≤ÊüìÁé©ÂÆ∂ÂæΩÁ´†ÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
        function renderPlayerBadges() {
            if (isOutdoor) {
                renderPlayer();
            } else {
                renderIndoorPlayer();
            }
        }

        // ÊâìÂºÄÂú∞Âõæ
        function openMap() {
            document.getElementById('mapModal').classList.add('active');
            updateMapPosition();
        }

        // ÂÖ≥Èó≠Âú∞Âõæ
        function closeMap() {
            document.getElementById('mapModal').classList.remove('active');
        }

        // Êõ¥Êñ∞Âú∞Âõæ‰∏äÁöÑ‰ΩçÁΩÆ
        function updateMapPosition() {
            const mapYou = document.getElementById('mapYou');
            // ÊääÁé©ÂÆ∂‰ΩçÁΩÆÊò†Â∞ÑÂà∞Âú∞Âõæ‰∏ä
            const mapX = 10 + (playerPos.x / 100) * 80;
            const mapY = 10 + ((100 - playerPos.y) / 100) * 80;
            mapYou.style.left = mapX + '%';
            mapYou.style.top = mapY + '%';
        }

        // ÊéßÂà∂ÊñπÂºèÊ£ÄÊµã
        let controlType = 'unknown'; // 'keyboard', 'touch'
        let joystickActive = false;
        let joystickVector = { x: 0, y: 0 };
        let joystickAnimationId = null;

        // Ê£ÄÊµãÊéßÂà∂ÊñπÂºè
        function detectControlType() {
            // Ê£ÄÊµãÊòØÂê¶‰∏∫Ëß¶Êë∏ËÆæÂ§á
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            // ÁõëÂê¨ÈîÆÁõò‰∫ã‰ª∂Êù•Ê£ÄÊµãÈîÆÁõòÊéßÂà∂
            document.addEventListener('keydown', function onKeyDown() {
                if (controlType !== 'keyboard') {
                    controlType = 'keyboard';
                    updateControlUI();
                }
            }, { once: true });

            // ÁõëÂê¨Ëß¶Êë∏‰∫ã‰ª∂Êù•Ê£ÄÊµãËß¶Êë∏ÊéßÂà∂
            document.addEventListener('touchstart', function onTouchStart() {
                if (controlType !== 'touch') {
                    controlType = 'touch';
                    updateControlUI();
                }
            }, { once: true });

            // ÂàùÂßãÊ†πÊçÆËÆæÂ§áÁ±ªÂûãËÆæÁΩÆ
            if (isTouchDevice) {
                controlType = 'touch';
            } else {
                controlType = 'keyboard';
            }
            updateControlUI();
        }

        // Êõ¥Êñ∞ÊéßÂà∂UI
        function updateControlUI() {
            const joystick = document.getElementById('virtualJoystick');
            const hint = document.getElementById('controlHint');
            
            // Ëß¶Êë∏ËÆæÂ§áÂßãÁªàÊòæÁ§∫ÊëáÊùÜ
            if (controlType === 'touch') {
                joystick.classList.add('active');
            } else {
                joystick.classList.remove('active');
            }
            
            // Â¶ÇÊûúÈ£ûÊú∫Ê≠£Âú®È£ûË°åÔºåÊòæÁ§∫È£ûÊú∫ÊéßÂà∂ÊèêÁ§∫
            if (planeActive) {
                updatePlaneControlHint();
                return;
            }
            
            // ÊôÆÈÄöÁßªÂä®ÊèêÁ§∫
            if (controlType === 'touch') {
                if (isOutdoor) {
                    hint.innerHTML = 'ÊãñÂä®ÊëáÊùÜÁßªÂä® | QÈ£ûÊú∫ | MÂú∞Âõæ';
                } else {
                    hint.innerHTML = 'ÊãñÂä®ÊëáÊùÜÁßªÂä® | Ëµ∞Âà∞Èó®Âè£Âá∫Èó®';
                }
            } else {
                if (isOutdoor) {
                    hint.innerHTML = 'WASDÁßªÂä® | QÊéßÂà∂È£ûÊú∫ | MÂú∞Âõæ';
                } else {
                    hint.innerHTML = 'WASDÁßªÂä® | Ëµ∞Âà∞Èó®Âè£Âá∫Èó®';
                }
            }
        }

        // ÂàùÂßãÂåñËôöÊãüÊëáÊùÜ
        function initVirtualJoystick() {
            const joystick = document.getElementById('virtualJoystick');
            const knob = document.getElementById('joystickKnob');
            const base = joystick.querySelector('.joystick-base');
            
            let startX, startY;
            let joystickCenterX, joystickCenterY;
            const maxDistance = 35; // ÊëáÊùÜÊúÄÂ§ßÁßªÂä®Ë∑ùÁ¶ª

            function handleTouchStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = base.getBoundingClientRect();
                joystickCenterX = rect.left + rect.width / 2;
                joystickCenterY = rect.top + rect.height / 2;
                startX = touch.clientX;
                startY = touch.clientY;
                joystickActive = true;
            }

            function handleTouchMove(e) {
                if (!joystickActive) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const dx = touch.clientX - joystickCenterX;
                const dy = touch.clientY - joystickCenterY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                let moveX = dx;
                let moveY = dy;
                
                if (distance > maxDistance) {
                    const ratio = maxDistance / distance;
                    moveX = dx * ratio;
                    moveY = dy * ratio;
                }
                
                knob.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
                
                // ËÆ°ÁÆóÊñπÂêëÂêëÈáè (-1 Âà∞ 1)
                joystickVector.x = moveX / maxDistance;
                joystickVector.y = -(moveY / maxDistance); // YËΩ¥ÂèçËΩ¨
            }

            function handleTouchEnd(e) {
                e.preventDefault();
                joystickActive = false;
                joystickVector.x = 0;
                joystickVector.y = 0;
                knob.style.transform = 'translate(-50%, -50%)';
            }

            // ÁªëÂÆöËß¶Êë∏‰∫ã‰ª∂
            joystick.addEventListener('touchstart', handleTouchStart, { passive: false });
            joystick.addEventListener('touchmove', handleTouchMove, { passive: false });
            joystick.addEventListener('touchend', handleTouchEnd, { passive: false });
            joystick.addEventListener('touchcancel', handleTouchEnd, { passive: false });

            // ÂêØÂä®ÊëáÊùÜÊõ¥Êñ∞Âæ™ÁéØ
            startJoystickLoop();
        }

        // ÊëáÊùÜÁßªÂä®Âæ™ÁéØ
        function startJoystickLoop() {
            // ÁúüÂÆûÊØî‰æãÈÄüÂ∫¶ËÆæÂÆöÔºö
            // ÂÆ§ÂÜÖÊàøÈó¥Á∫¶ 10m ÂÆΩÔºåÊà∑Â§ñËä±Âõ≠Á∫¶ 50m ÂÆΩ
            // ‰∫∫Ëµ∞Ë∑ØÈÄüÂ∫¶ 1.2m/sÔºåË∑ëÊ≠• 3.5m/s
            // ÊëáÊùÜÊØèÂ∏ßÊõ¥Êñ∞Á∫¶ 60fpsÔºåÈúÄË¶ÅÂπ≥ÊªëÁßªÂä®
            const indoorSpeed = 0.15;   // ÂÆ§ÂÜÖÔºöËæÉÊÖ¢ÔºåÁ∫¶ 0.15% ÊØèÂ∏ß ‚âà Ëµ∞Ë∑ØÈÄüÂ∫¶
            const outdoorSpeed = 0.12;  // Êà∑Â§ñÔºöÊõ¥ÊÖ¢ÔºåÁ∫¶ 0.12% ÊØèÂ∏ßÔºàËä±Âõ≠Êõ¥Â§ßÔºâ
            const planeSpeed = 0.3;     // È£ûÊú∫ÔºöËæÉÂø´
            
            function update() {
                // È£ûÊú∫ÊéßÂà∂Ôºö‰ΩøÁî®ÊôÆÈÄöÊëáÊùÜÊàñÈ£ûÊú∫ÊëáÊùÜÈÉΩÂèØ‰ª•ÊéßÂà∂È£ûÊú∫
                if (planeActive && (joystickActive || planeJoystickActive)) {
                    // ÂêàÂπ∂‰∏§‰∏™ÊëáÊùÜÁöÑËæìÂÖ•ÔºàÂèñÊúÄÂ§ßÂÄºÔºâ
                    const controlX = Math.abs(joystickVector.x) > Math.abs(planeJoystickVector.x) ? joystickVector.x : planeJoystickVector.x;
                    const controlY = Math.abs(joystickVector.y) > Math.abs(planeJoystickVector.y) ? joystickVector.y : planeJoystickVector.y;
                    
                    if (!isOutdoor) {
                        // ÂÆ§ÂÜÖÈ£ûÊú∫ÊéßÂà∂Ôºà3DÔºâ
                        if (Math.abs(controlY) > 0.1) {
                            // ÂâçÂêéÁßªÂä®ÔºàYËΩ¥Ôºâ
                            indoorPlanePos.y += controlY * planeSpeed;
                            indoorPlanePos.y = Math.max(10, Math.min(90, indoorPlanePos.y));
                        }
                        
                        if (Math.abs(controlX) > 0.1) {
                            // Â∑¶Âè≥ÁßªÂä®ÔºàXËΩ¥Ôºâ
                            indoorPlanePos.x += controlX * planeSpeed;
                            indoorPlanePos.x = Math.max(10, Math.min(90, indoorPlanePos.x));
                        }
                        
                        updateIndoorPlanePosition();
                    } else {
                        // Êà∑Â§ñÈ£ûÊú∫ÊéßÂà∂
                        const plane = document.getElementById('rcPlane');
                        let moved = false;

                        if (Math.abs(controlY) > 0.1) {
                            if (controlY > 0) {
                                planePos.y = Math.min(90, planePos.y + planeSpeed * Math.abs(controlY));
                            } else {
                                planePos.y = Math.max(20, planePos.y - planeSpeed * Math.abs(controlY));
                            }
                            moved = true;
                        }
                        
                        if (Math.abs(controlX) > 0.1) {
                            if (controlX < 0) {
                                planePos.x = Math.max(5, planePos.x - planeSpeed * Math.abs(controlX));
                            } else {
                                planePos.x = Math.min(95, planePos.x + planeSpeed * Math.abs(controlX));
                            }
                            moved = true;
                        }

                        if (moved) {
                            plane.style.left = planePos.x + '%';
                            plane.style.bottom = planePos.y + '%';
                        }
                    }
                } else if (joystickActive && controlType === 'touch') {
                    // Áé©ÂÆ∂ÊéßÂà∂ÔºàÈ£ûÊú∫Êú™ÊøÄÊ¥ªÊó∂Ôºâ
                    if (!isOutdoor) {
                        // ÂÆ§ÂÜÖÁßªÂä®
                        const player = document.getElementById('indoorPlayer');
                        let moved = false;

                        if (Math.abs(joystickVector.y) > 0.2) {
                            if (joystickVector.y > 0) {
                                indoorPlayerPos.y = Math.min(40, indoorPlayerPos.y + indoorSpeed * Math.abs(joystickVector.y));
                            } else {
                                indoorPlayerPos.y = Math.max(8, indoorPlayerPos.y - indoorSpeed * Math.abs(joystickVector.y));
                            }
                            moved = true;
                        }
                        
                        if (Math.abs(joystickVector.x) > 0.2) {
                            if (joystickVector.x < 0) {
                                indoorPlayerPos.x = Math.max(10, indoorPlayerPos.x - indoorSpeed * Math.abs(joystickVector.x));
                            } else {
                                indoorPlayerPos.x = Math.min(90, indoorPlayerPos.x + indoorSpeed * Math.abs(joystickVector.x));
                            }
                            moved = true;
                        }

                        if (moved) {
                            player.style.left = indoorPlayerPos.x + '%';
                            player.style.bottom = indoorPlayerPos.y + '%';

                            // Ê£ÄÊü•ÊòØÂê¶Ëµ∞Âà∞Èó®Âè£
                            if (indoorPlayerPos.x > 78) {
                                goOutdoor();
                            }
                        }
                    } else {
                        // Êà∑Â§ñÁßªÂä® - Áé©ÂÆ∂
                        const player = document.getElementById('player');
                        let moved = false;

                        if (Math.abs(joystickVector.y) > 0.2) {
                            if (joystickVector.y > 0) {
                                playerPos.y = Math.min(55, playerPos.y + outdoorSpeed * Math.abs(joystickVector.y));
                            } else {
                                playerPos.y = Math.max(18, playerPos.y - outdoorSpeed * Math.abs(joystickVector.y));
                            }
                            moved = true;
                        }
                        
                        if (Math.abs(joystickVector.x) > 0.2) {
                            if (joystickVector.x < 0) {
                                playerPos.x = Math.max(5, playerPos.x - outdoorSpeed * Math.abs(joystickVector.x));
                            } else {
                                playerPos.x = Math.min(95, playerPos.x + outdoorSpeed * Math.abs(joystickVector.x));
                            }
                            moved = true;
                        }

                        if (moved) {
                            player.style.left = playerPos.x + '%';
                            player.style.bottom = playerPos.y + '%';

                            // Ê£ÄÊü•ÊòØÂê¶Ëµ∞Âà∞ÊàøÂ≠êÂÖ•Âè£
                            if (playerPos.x > 40 && playerPos.x < 60 && playerPos.y > 52) {
                                goIndoor();
                            }

                            // Êõ¥Êñ∞Ê≤ôÂùëÊèêÁ§∫
                            updateSandboxHint();

                            // Êõ¥Êñ∞Âú∞Âõæ‰ΩçÁΩÆ
                            if (document.getElementById('mapModal').classList.contains('active')) {
                                updateMapPosition();
                            }
                        }
                    }
                }
                
                joystickAnimationId = requestAnimationFrame(update);
            }
            
            update();
        }

        // Â§ÑÁêÜÊàøÈó¥ÈîÆÁõò‰∫ã‰ª∂
        function handleRoomKeydown(e) {
            const key = e.key.toLowerCase();
            // ÁúüÂÆûÊØî‰æãÈÄüÂ∫¶Ôºö
            // ÂÆ§ÂÜÖÊàøÈó¥Á∫¶ 10m ÂÆΩÔºåÊåâ‰∏ÄÊ¨°ÈîÆÁßªÂä®Á∫¶ 0.6mÔºàËµ∞Ë∑Ø‰∏ÄÊ≠•Ôºâ
            // Êà∑Â§ñËä±Âõ≠Á∫¶ 50m ÂÆΩÔºåÊåâ‰∏ÄÊ¨°ÈîÆÁßªÂä®Á∫¶ 0.6mÔºàËµ∞Ë∑Ø‰∏ÄÊ≠•Ôºâ
            const indoorKeySpeed = 0.6;   // ÂÆ§ÂÜÖÊØèÈîÆÁßªÂä® 0.6%
            const outdoorKeySpeed = 0.25; // Êà∑Â§ñÊØèÈîÆÁßªÂä® 0.25%ÔºàËä±Âõ≠Êõ¥Â§ßÔºåÁõ∏ÂØπÁßªÂä®Êõ¥ÊÖ¢Ôºâ
            const planeKeySpeed = 0.8;    // È£ûÊú∫ÊØèÈîÆÁßªÂä® 0.8%

            // MÈîÆ - ÊâìÂºÄ/ÂÖ≥Èó≠Âú∞Âõæ
            if (key === 'm' && isOutdoor) {
                const mapModal = document.getElementById('mapModal');
                if (mapModal.classList.contains('active')) {
                    closeMap();
                } else {
                    openMap();
                }
                e.preventDefault();
                return;
            }

            // QÈîÆ - ÊéßÂà∂È£ûÊú∫ÔºàËµ∑È£û/ÈôçËêΩÔºâ
            if (key === 'q') {
                if (carryingItems.includes('rc_plane')) {
                    togglePlane();
                }
                e.preventDefault();
                return;
            }

            // HÈîÆ - ÁõòÊóãÊ®°Âºè
            if (key === 'h' && planeActive) {
                toggleHoverMode();
                e.preventDefault();
                return;
            }

            // ÂÆ§ÂÜÖÁßªÂä®
            if (!isOutdoor) {
                const player = document.getElementById('indoorPlayer');
                let moved = false;

                if (key === 'w' || key === 'arrowup') {
                    indoorPlayerPos.y = Math.min(40, indoorPlayerPos.y + indoorKeySpeed);
                    moved = true;
                } else if (key === 's' || key === 'arrowdown') {
                    indoorPlayerPos.y = Math.max(8, indoorPlayerPos.y - indoorKeySpeed);
                    moved = true;
                } else if (key === 'a' || key === 'arrowleft') {
                    indoorPlayerPos.x = Math.max(10, indoorPlayerPos.x - indoorKeySpeed);
                    moved = true;
                } else if (key === 'd' || key === 'arrowright') {
                    indoorPlayerPos.x = Math.min(90, indoorPlayerPos.x + indoorKeySpeed);
                    moved = true;
                }

                if (moved) {
                    player.style.left = indoorPlayerPos.x + '%';
                    player.style.bottom = indoorPlayerPos.y + '%';

                    // Ê£ÄÊü•ÊòØÂê¶Ëµ∞Âà∞Èó®Âè£ÔºàÈó®Âú®Âè≥ËæπÔºåx > 78% Â∞±ÁÆóÂà∞Èó®Âè£‰∫ÜÔºâ
                    if (indoorPlayerPos.x > 78) {
                        goOutdoor();
                    }
                    e.preventDefault();
                }
                return;
            }

            // Êà∑Â§ñÁßªÂä®
            if (planeActive) {
                // ÊéßÂà∂È£ûÊú∫ - ‰ΩøÁî®‰∏ä‰∏ãÂ∑¶Âè≥ÈîÆ
                const plane = document.getElementById('rcPlane');
                let moved = false;

                // ÂÆ§ÂÜÖ/Êà∑Â§ñÈ£ûÊú∫ÊéßÂà∂ÈÄªËæë
                if (isOutdoor) {
                    // Êà∑Â§ñÈ£ûÊú∫ÊéßÂà∂Ôºà2DÂπ≥Èù¢Ôºâ
                    if (key === 'arrowup') {
                        planePos.y = Math.min(90, planePos.y + planeKeySpeed);
                        moved = true;
                    } else if (key === 'arrowdown') {
                        planePos.y = Math.max(20, planePos.y - planeKeySpeed);
                        moved = true;
                    } else if (key === 'arrowleft') {
                        planePos.x = Math.max(5, planePos.x - planeKeySpeed);
                        moved = true;
                    } else if (key === 'arrowright') {
                        planePos.x = Math.min(95, planePos.x + planeKeySpeed);
                        moved = true;
                    }

                    if (moved) {
                        plane.style.left = planePos.x + '%';
                        plane.style.bottom = planePos.y + '%';
                        e.preventDefault();
                    }
                } else {
                    // ÂÆ§ÂÜÖÈ£ûÊú∫ÊéßÂà∂Ôºà3DÁ©∫Èó¥Ôºâ
                    let moved = false;
                    
                    if (key === 'arrowup') {
                        // ‰∏äÂçá
                        indoorPlanePos.z = Math.min(55, indoorPlanePos.z + planeKeySpeed);
                        moved = true;
                    } else if (key === 'arrowdown') {
                        // ‰∏ãÈôç
                        indoorPlanePos.z = Math.max(5, indoorPlanePos.z - planeKeySpeed);
                        moved = true;
                    } else if (key === 'arrowleft') {
                        // Â∑¶Áßª
                        indoorPlanePos.x = Math.max(10, indoorPlanePos.x - planeKeySpeed);
                        moved = true;
                    } else if (key === 'arrowright') {
                        // Âè≥Áßª
                        indoorPlanePos.x = Math.min(90, indoorPlanePos.x + planeKeySpeed);
                        moved = true;
                    } else if (key === 'w') {
                        // ÂâçËøõ
                        indoorPlanePos.y = Math.min(90, indoorPlanePos.y + planeKeySpeed);
                        moved = true;
                    } else if (key === 's') {
                        // ÂêéÈÄÄ
                        indoorPlanePos.y = Math.max(10, indoorPlanePos.y - planeKeySpeed);
                        moved = true;
                    }

                    if (moved) {
                        updateIndoorPlanePosition();
                        e.preventDefault();
                    }
                }
            } else {
                // ÊéßÂà∂Áé©ÂÆ∂
                const player = document.getElementById('player');
                let moved = false;

                if (key === 'w' || key === 'arrowup') {
                    playerPos.y = Math.min(55, playerPos.y + outdoorKeySpeed);
                    moved = true;
                } else if (key === 's' || key === 'arrowdown') {
                    playerPos.y = Math.max(18, playerPos.y - outdoorKeySpeed);
                    moved = true;
                } else if (key === 'a' || key === 'arrowleft') {
                    playerPos.x = Math.max(5, playerPos.x - outdoorKeySpeed);
                    moved = true;
                } else if (key === 'd' || key === 'arrowright') {
                    playerPos.x = Math.min(95, playerPos.x + outdoorKeySpeed);
                    moved = true;
                }

                if (moved) {
                    player.style.left = playerPos.x + '%';
                    player.style.bottom = playerPos.y + '%';

                    // Ê£ÄÊü•ÊòØÂê¶Ëµ∞Âà∞ÊàøÂ≠êÂÖ•Âè£
                    if (playerPos.x > 40 && playerPos.x < 60 && playerPos.y > 52) {
                        goIndoor();
                    }

                    // Êõ¥Êñ∞Ê≤ôÂùëÊèêÁ§∫
                    updateSandboxHint();

                    // Êõ¥Êñ∞Âú∞Âõæ‰ΩçÁΩÆ
                    if (document.getElementById('mapModal').classList.contains('active')) {
                        updateMapPosition();
                    }

                    e.preventDefault();
                }
            }
        }

        // ‰øùÂ≠òËÆ∞ÂΩï
        function saveRecords() {
            localStorage.setItem('records', JSON.stringify(records, bigIntReplacer));
        }

        // Ê∑ªÂä†ËÆ∞ÂΩï
        function addRecord(type, studentName, amount, itemName = null) {
            const record = {
                id: Date.now(),
                type: type, // 'add', 'sub', 'buy'
                studentName: studentName,
                amount: parseBigIntValue(amount, 0n),
                itemName: itemName,
                time: new Date().toLocaleString('zh-CN')
            };
            records.unshift(record); // Êñ∞ËÆ∞ÂΩïÊîæÊúÄÂâçÈù¢
            saveRecords();
        }

        // ÊâìÂºÄÂØÜÁ†ÅÂºπÁ™ó
        function openPasswordModal() {
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ÂØÜÁ†ÅÂºπÁ™ó
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
        }

        // Ê£ÄÊü•ÂØÜÁ†Å
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === ADMIN_PASSWORD) {
                closePasswordModal();
                openRecordModal();
            } else {
                alert('ÂØÜÁ†ÅÈîôËØØÔºÅ');
            }
        }

        // ÊâìÂºÄËÆ∞ÂΩïË°®
        function openRecordModal() {
            renderRecordList();
            document.getElementById('recordModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ËÆ∞ÂΩïË°®
        function closeRecordModal() {
            document.getElementById('recordModal').classList.remove('active');
        }

        // Ê∏≤ÊüìËÆ∞ÂΩïÂàóË°®
        function renderRecordList() {
            const list = document.getElementById('recordList');
            list.innerHTML = '';

            if (records.length === 0) {
                list.innerHTML = '<div class="record-empty">ÊöÇÊó†Êìç‰ΩúËÆ∞ÂΩï</div>';
                return;
            }

            records.forEach(record => {
                const div = document.createElement('div');
                div.className = 'record-item';

                let iconClass = '';
                let iconEmoji = '';
                let text = '';

                if (record.type === 'add') {
                    iconClass = 'add';
                    iconEmoji = '‚ûï';
                    text = `${record.studentName} Âä†‰∫Ü ${formatScore(record.amount)} ÁßØÂàÜ`;
                } else if (record.type === 'sub') {
                    iconClass = 'sub';
                    iconEmoji = '‚ûñ';
                    text = `${record.studentName} Êâ£‰∫Ü ${formatScore(record.amount)} ÁßØÂàÜ`;
                } else if (record.type === 'buy') {
                    iconClass = 'buy';
                    iconEmoji = 'üõí';
                    text = `${record.studentName} Ë¥≠‰π∞‰∫Ü ${record.itemName}Ôºà${formatScore(record.amount)}ÁßØÂàÜÔºâ`;
                }

                div.innerHTML = `
                    <div class="record-icon ${iconClass}">${iconEmoji}</div>
                    <div class="record-info">
                        <div class="record-text">${text}</div>
                        <div class="record-time">${record.time}</div>
                    </div>
                    <button class="record-delete" onclick="deleteRecord(${record.id})">üóë</button>
                `;
                list.appendChild(div);
            });
        }

        // Âà†Èô§ËÆ∞ÂΩïÔºàÊí§ÈîÄÊìç‰ΩúÔºâ
        function deleteRecord(recordId) {
            const record = records.find(r => r.id === recordId);
            if (!record) return;

            const student = students.find(s => s.name === record.studentName);

            const amountText = formatScore(record.amount);
            let confirmMsg = '';
            if (record.type === 'add') {
                confirmMsg = `Á°ÆÂÆöÊí§ÈîÄ"${record.studentName}Âä†${amountText}ÁßØÂàÜ"ÂêóÔºü\nÔºàÂ∞ÜÊâ£Âõû${amountText}ÁßØÂàÜÔºâ`;
            } else if (record.type === 'sub') {
                confirmMsg = `Á°ÆÂÆöÊí§ÈîÄ"${record.studentName}Êâ£${amountText}ÁßØÂàÜ"ÂêóÔºü\nÔºàÂ∞ÜËøîËøò${amountText}ÁßØÂàÜÔºâ`;
            } else if (record.type === 'buy') {
                confirmMsg = `Á°ÆÂÆöÊí§ÈîÄ"${record.studentName}Ë¥≠‰π∞${record.itemName}"ÂêóÔºü\nÔºàÂ∞ÜËøîËøò${amountText}ÁßØÂàÜÔºåÁßªÈô§1‰∏™${record.itemName}Ôºâ`;
            }

            if (!confirm(confirmMsg)) return;

            // Êí§ÈîÄÊìç‰Ωú
            if (student) {
                if (record.type === 'add') {
                    student.score -= record.amount;
                    student.totalAdded -= record.amount;
                } else if (record.type === 'sub') {
                    student.score += record.amount;
                    student.totalSubtracted -= record.amount;
                } else if (record.type === 'buy') {
                    student.score += record.amount;
                    // ‰ªéÂ∫ìÂ≠òÁßªÈô§
                    const item = shopItems.find(i => i.name === record.itemName);
                    if (item && inventory[item.id] > 0) {
                        inventory[item.id]--;
                    }
                    saveInventory();
                }
            }

            // Âà†Èô§ËÆ∞ÂΩï
            records = records.filter(r => r.id !== recordId);

            saveData();
            saveRecords();
            renderStudents();
            renderRecordList();
            renderRoomCabinet();
        }

        // Êõ¥Êñ∞ÂÖ®Áè≠ÁªüËÆ°
        function updateClassStats() {
            let totalScore = 0n;
            let totalAdded = 0n;
            let totalSubtracted = 0n;

            students.forEach(student => {
                totalScore += student.score || 0n;
                totalAdded += student.totalAdded || 0n;
                totalSubtracted += student.totalSubtracted || 0n;
            });

            document.getElementById('classTotalScore').textContent = formatScore(totalScore);
            document.getElementById('classTotalAdded').textContent = '+' + formatScore(totalAdded);
            document.getElementById('classTotalSubtracted').textContent = '-' + formatScore(totalSubtracted);
            document.getElementById('classTotalExchanged').textContent = formatScore(totalExchanged);
        }

        // Ê∏≤ÊüìÂ≠¶ÁîüÂàóË°®
        function renderStudents() {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = '';

            // ÈáëÂ∏ÅSVGÊ®°Êùø
            const coinSvg = `<svg class="coin-icon coin-svg" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="coinGold2" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFD700"/>
                        <stop offset="30%" style="stop-color:#FFEC8B"/>
                        <stop offset="50%" style="stop-color:#FFD700"/>
                        <stop offset="70%" style="stop-color:#DAA520"/>
                        <stop offset="100%" style="stop-color:#B8860B"/>
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="url(#coinGold2)" stroke="#B8860B" stroke-width="4"/>
                <circle cx="50" cy="50" r="35" fill="none" stroke="#DAA520" stroke-width="2"/>
                <text x="50" y="58" font-size="28" font-weight="bold" fill="#B8860B" text-anchor="middle">$</text>
            </svg>`;

            // Ê∏≤ÊüìÂ∑≤ÊúâÂ≠¶Áîü
            students.forEach(student => {
                // ÂÖºÂÆπÊóßÊï∞ÊçÆ
                if (student.score === undefined) student.score = 0n;
                if (student.totalAdded === undefined) student.totalAdded = 0n;
                if (student.totalSubtracted === undefined) student.totalSubtracted = 0n;
                if (student.totalExchanged === undefined) student.totalExchanged = 0n;

                const card = document.createElement('div');
                card.className = 'student-card';
                card.onclick = () => openScoreModal(student.id);

                card.innerHTML = `
                    <div class="avatar">
                        ${student.avatar}
                    </div>
                    <div class="student-name">${student.name}</div>
                    <div class="student-stats">
                        <span class="total">ÊÄª${formatScore(student.score)}</span>
                        <span class="added">+${formatScore(student.totalAdded)}</span>
                        <span class="subtracted">-${formatScore(student.totalSubtracted)}</span>
                    </div>
                    <div class="student-exchange">
                        ${coinSvg}
                        <span class="exchange-num">${formatScore(student.totalExchanged)}</span>
                    </div>
                `;
                grid.appendChild(card);
            });

            // Ê∑ªÂä†"Ê∑ªÂä†Â≠¶Áîü"ÊåâÈíÆ
            const addBtn = document.createElement('div');
            addBtn.className = 'add-student';
            addBtn.onclick = openAddModal;
            addBtn.innerHTML = `
                <div class="add-avatar">+</div>
                <div class="add-label">Ê∑ªÂä†Â≠¶Áîü</div>
            `;
            grid.appendChild(addBtn);
        }

        // ‰øùÂ≠òÊï∞ÊçÆ
        function saveData() {
            localStorage.setItem('students', JSON.stringify(students, bigIntReplacer));
            localStorage.setItem('totalExchanged', totalExchanged.toString());
            updateClassStats();
        }

        // ÊâìÂºÄÊ∑ªÂä†Â≠¶ÁîüÂºπÁ™ó
        function openAddModal() {
            selectedGender = null;
            document.getElementById('studentName').value = '';
            document.querySelectorAll('#addModal .gender-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('addModal').classList.add('active');
        }

        // ÂÖ≥Èó≠Ê∑ªÂä†Â≠¶ÁîüÂºπÁ™ó
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        // ÈÄâÊã©ÊÄßÂà´
        function selectGender(gender) {
            selectedGender = gender;
            document.querySelectorAll('#addModal .gender-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.gender === gender);
            });
        }

        // Á°ÆËÆ§Ê∑ªÂä†Â≠¶Áîü
        function confirmAddStudent() {
            const name = document.getElementById('studentName').value.trim();
            if (!name) {
                alert('ËØ∑ËæìÂÖ•Â≠¶ÁîüÂêçÂ≠ó');
                return;
            }
            if (!selectedGender) {
                alert('ËØ∑ÈÄâÊã©ÊÄßÂà´');
                return;
            }

            const newStudent = {
                id: Date.now(),
                name: name,
                gender: selectedGender,
                avatar: generateRandomAvatar(selectedGender),
                score: 0n,
                totalAdded: 0n,
                totalSubtracted: 0n,
                totalExchanged: 0n
            };

            students.push(newStudent);
            saveData();
            renderStudents();
            closeAddModal();
        }

        // ÊâìÂºÄÁßØÂàÜÊìç‰ΩúÂºπÁ™ó
        function openScoreModal(studentId) {
            currentStudentId = studentId;
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('menuAvatar').innerHTML = student.avatar;
            document.getElementById('menuName').textContent = student.name;
            document.getElementById('menuScore').textContent = formatScore(student.score);
            document.getElementById('scoreModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ÁßØÂàÜÊìç‰ΩúÂºπÁ™ó
        function closeScoreModal() {
            document.getElementById('scoreModal').classList.remove('active');
            currentStudentId = null;
        }

        // Êõ¥Êñ∞ÁßØÂàÜÊòæÁ§∫
        function updateScoreDisplay() {
            const student = students.find(s => s.id === currentStudentId);
            if (student) {
                document.getElementById('menuScore').textContent = formatScore(student.score);
            }
        }

        // ÊòæÁ§∫ÁßØÂàÜÂä®Áîª
        function showScoreAnimation(amount, isPositive) {
            const popup = document.createElement('div');
            popup.className = `score-popup ${isPositive ? 'positive' : 'negative'}`;
            const formatted = formatScore(amount);
            popup.textContent = isPositive ? `+${formatted}` : `-${formatted}`;

            const modal = document.querySelector('#scoreModal .modal');
            const rect = modal.getBoundingClientRect();
            popup.style.left = (rect.left + rect.width / 2) + 'px';
            popup.style.top = (rect.top + 120) + 'px';

            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 800);
        }

        function initScoreUnitInput() {
            const input = document.getElementById('scoreUnitInput');
            if (!input) return;

            input.value = getUnitNameOrDefault(localStorage.getItem('scoreUnit'));
            input.addEventListener('change', () => {
                const normalized = getUnitNameOrDefault(input.value);
                input.value = normalized;
                saveActiveScoreUnit();
            });
        }

        function initScoreInputModal() {
            const amountInput = document.getElementById('scoreInputAmount');
            const unitInput = document.getElementById('scoreInputUnit');
            if (!amountInput || !unitInput) return;

            const refreshPreview = () => updateScoreInputPreview();
            amountInput.addEventListener('input', refreshPreview);
            unitInput.addEventListener('input', refreshPreview);

            amountInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmScoreInput();
                }
            });

            unitInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmScoreInput();
                }
            });
        }

        function openScoreInputModal(type) {
            currentScoreInputType = type;
            const modal = document.getElementById('scoreInputModal');
            const title = document.getElementById('scoreInputTitle');
            const amountInput = document.getElementById('scoreInputAmount');
            const unitInput = document.getElementById('scoreInputUnit');
            const preview = document.getElementById('scoreInputPreview');
            if (!modal || !title || !amountInput || !unitInput || !preview) return;

            title.textContent = type === 'sub' ? 'ËæìÂÖ•Êâ£ÁßØÂàÜ' : 'ËæìÂÖ•Âä†ÁßØÂàÜ';
            amountInput.value = '';
            unitInput.value = getActiveScoreUnit();
            preview.textContent = '';
            modal.classList.add('active');
            setTimeout(() => amountInput.focus(), 0);
        }

        function closeScoreInputModal() {
            const modal = document.getElementById('scoreInputModal');
            if (modal) modal.classList.remove('active');
            currentScoreInputType = null;
        }

        function updateScoreInputPreview() {
            const preview = document.getElementById('scoreInputPreview');
            const amountInput = document.getElementById('scoreInputAmount');
            const unitInput = document.getElementById('scoreInputUnit');
            if (!preview || !amountInput || !unitInput) return;

            const amountStr = amountInput.value.trim();
            if (!/^\d+$/.test(amountStr)) {
                preview.textContent = '';
                return;
            }

            const unitName = getUnitNameOrDefault(unitInput.value);
            const multiplier = getUnitMultiplierOrNull(unitName);
            if (!multiplier) {
                preview.textContent = '';
                return;
            }

            const base = BigInt(amountStr);
            const delta = base * multiplier;
            const sign = currentScoreInputType === 'sub' ? '-' : '+';
            preview.innerHTML = `Êú¨Ê¨°Ôºö<span class="value">${sign}${formatScore(delta)}</span>`;
        }

        function confirmScoreInput() {
            const amountInput = document.getElementById('scoreInputAmount');
            const unitInput = document.getElementById('scoreInputUnit');
            if (!amountInput || !unitInput) return;

            const amountStr = amountInput.value.trim();
            if (!/^\d+$/.test(amountStr)) {
                alert('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊï∞Â≠ó');
                amountInput.focus();
                return;
            }

            const base = BigInt(amountStr);
            if (base <= 0n) {
                alert('Êï∞ÂÄºÂøÖÈ°ªÂ§ß‰∫é0');
                amountInput.focus();
                return;
            }

            const unitName = getUnitNameOrDefault(unitInput.value);
            const multiplier = getUnitMultiplierOrNull(unitName);
            if (!multiplier) {
                alert('Âçï‰Ωç‰∏çÊ≠£Á°ÆÔºåËØ∑‰ªéÂàóË°®‰∏≠ÈÄâÊã©ÊàñËæìÂÖ•Ê≠£Á°ÆÂçï‰Ωç');
                unitInput.focus();
                return;
            }

            const activeUnitInput = document.getElementById('scoreUnitInput');
            if (activeUnitInput) activeUnitInput.value = unitName;
            saveActiveScoreUnit();

            const delta = base * multiplier;
            applyScoreDelta(delta, currentScoreInputType === 'sub' ? 'sub' : 'add');
            closeScoreInputModal();
        }

        function applyScoreDelta(delta, type) {
            const student = students.find(s => s.id === currentStudentId);
            if (!student) return;
            if (delta <= 0n) return;

            if (type === 'sub') {
                student.score -= delta;
                student.totalSubtracted = (student.totalSubtracted || 0n) + delta;
                addRecord('sub', student.name, delta);
                showScoreAnimation(delta, false);
            } else {
                student.score += delta;
                student.totalAdded = (student.totalAdded || 0n) + delta;
                addRecord('add', student.name, delta);
                showScoreAnimation(delta, true);
            }

            saveData();
            updateScoreDisplay();
            renderStudents();
        }

        // Âä†ÁßØÂàÜ
        function addScore(amount) {
            const unitName = getActiveScoreUnit();
            const multiplier = getUnitMultiplierOrNull(unitName);
            if (!multiplier) {
                alert('Âçï‰Ωç‰∏çÊ≠£Á°ÆÔºåËØ∑‰ªéÂàóË°®‰∏≠ÈÄâÊã©ÊàñËæìÂÖ•Ê≠£Á°ÆÂçï‰Ωç');
                const unitInput = document.getElementById('scoreUnitInput');
                if (unitInput) unitInput.focus();
                return;
            }

            saveActiveScoreUnit();
            const delta = BigInt(amount) * multiplier;
            applyScoreDelta(delta, 'add');
        }

        // Êâ£ÁßØÂàÜ
        function subScore(amount) {
            const unitName = getActiveScoreUnit();
            const multiplier = getUnitMultiplierOrNull(unitName);
            if (!multiplier) {
                alert('Âçï‰Ωç‰∏çÊ≠£Á°ÆÔºåËØ∑‰ªéÂàóË°®‰∏≠ÈÄâÊã©ÊàñËæìÂÖ•Ê≠£Á°ÆÂçï‰Ωç');
                const unitInput = document.getElementById('scoreUnitInput');
                if (unitInput) unitInput.focus();
                return;
            }

            saveActiveScoreUnit();
            const delta = BigInt(amount) * multiplier;
            applyScoreDelta(delta, 'sub');
        }

        // ÂàùÂßãÂåñ
        init();
    </script>
</body>

</html>
