<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥çƒè¿›ç¯®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            overflow: hidden;
        }

        .game-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            max-width: 600px;
            width: 95%;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 42px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            letter-spacing: 2px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 12px;
            text-align: center;
            flex: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        canvas {
            display: block;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .controls {
            margin-top: 20px;
            text-align: center;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .instructions {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
        }

        .game-over {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .game-over.show {
            display: flex;
        }

        .game-over-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .game-over h2 {
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .final-score {
            font-size: 52px;
            font-weight: bold;
            margin: 30px 0;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            color: #FFD700;
        }

        .paused {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 32px;
            font-weight: bold;
            display: none;
            z-index: 100;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .paused.show {
            display: block;
        }
    </style>
</head>

<body>
    <div class="game-container">
        <div class="header">
            <h1>ğŸ€ æ¥çƒè¿›ç¯® ğŸ€</h1>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">åˆ†æ•°</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ—¶é—´</div>
                <div class="stat-value" id="time">180</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ç”Ÿå‘½</div>
                <div class="stat-value" id="lives">3</div>
            </div>
        </div>

        <div style="position: relative; display: inline-block;">
            <canvas id="gameCanvas" width="540" height="600"></canvas>
            <div class="paused" id="paused">æš‚åœ</div>
        </div>

        <div class="instructions">
            â† â†’ é”®æˆ–é¼ æ ‡ç§»åŠ¨æŒ¡æ¿ | ç©ºæ ¼é”®æš‚åœ/ç»§ç»­ | æŠŠçƒå¼¹è¿›ä¸Šæ–¹ç¯®å­å¾—10åˆ†
        </div>

        <div class="controls">
            <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
            <button id="pauseBtn">æš‚åœ</button>
            <button id="newGameBtn">æ–°æ¸¸æˆ</button>
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2 id="gameOverTitle">æ¸¸æˆç»“æŸ</h2>
            <div class="final-score" id="finalScore">0</div>
            <div style="margin-bottom: 20px; font-size: 18px;" id="gameOverMsg"></div>
            <button id="restartBtn">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // æ¸¸æˆçŠ¶æ€
        let gameState = 'ready'; // ready, playing, paused, gameover
        let score = 0;
        let timeLeft = 180; // 3åˆ†é’Ÿ = 180ç§’
        let lives = 3;
        const BALL_SPEED = 3; // å›ºå®šçƒé€Ÿï¼Œæ°¸è¿œä¸å˜
        const INITIAL_PADDLE_WIDTH = 100;
        const INITIAL_PADDLE_SPEED = 4;

        let paddle = { x: 0, y: 0, width: INITIAL_PADDLE_WIDTH, height: 15, speed: INITIAL_PADDLE_SPEED };
        let ball = { x: 0, y: 0, radius: 10, dx: 0, dy: 0 };
        let targetPaddleX = 0; // é¼ æ ‡ç›®æ ‡ä½ç½®
        let keys = { left: false, right: false };
        let lastTime = 0;
        let timerId = null;
        let hasHitPaddle = false; // æ ‡è®°çƒæ˜¯å¦ç¢°è¿‡æŒ¡æ¿ï¼ˆåªæœ‰ç¢°è¿‡æŒ¡æ¿åæ‰èƒ½è¿›ç¯®ï¼‰

        // ç¯®å­å‚æ•°ï¼ˆä¸Šæ–¹ï¼‰
        const basket = {
            x: 0,
            y: 30,
            width: 80,
            height: 60,
            rimHeight: 10,
            dx: 0, // ç¯®å­ç§»åŠ¨é€Ÿåº¦x
            dy: 0, // ç¯®å­ç§»åŠ¨é€Ÿåº¦y
            angle: 0, // è½¬åœˆè§’åº¦ï¼ˆç”¨äºè½¬åœˆæ¨¡å¼ï¼‰
            centerX: 0, // è½¬åœˆä¸­å¿ƒx
            centerY: 0, // è½¬åœˆä¸­å¿ƒy
            radius: 0 // è½¬åœˆåŠå¾„
        };
        let basketMode = 'static'; // static, slow, medium, fast, circle, random
        let successfulBaskets = 0; // æˆåŠŸè¿›ç¯®æ¬¡æ•°
        let isPreviewMode = false; // é¢„è§ˆæ¨¡å¼
        let previewLevel = 0; // é¢„è§ˆçš„å…³å¡ï¼ˆè¿›ç¯®æ¬¡æ•°ï¼‰
        let previewTimer = null; // é¢„è§ˆå®šæ—¶å™¨
        let isPreviewPaused = false; // é¢„è§ˆæ¨¡å¼æš‚åœçŠ¶æ€
        let randomBasketTimer = null; // éšæœºè¿›çƒå®šæ—¶å™¨
        let randomBasketInterval = 10000; // æ¯10ç§’éšæœºè¿›çƒä¸€æ¬¡
        let lastRandomBasketTime = 0; // ä¸Šæ¬¡éšæœºè¿›çƒæ—¶é—´
        let lastPaddleX = 0; // ä¸Šæ¬¡æŒ¡æ¿xä½ç½®ï¼ˆç”¨äºæ£€æµ‹é™æ­¢ï¼‰
        let paddleStillTime = 0; // æŒ¡æ¿é™æ­¢æ—¶é—´
        let gameStartTime = 0; // æ¸¸æˆå¼€å§‹æ—¶é—´
        let stillWarningCount = 0; // é™æ­¢è­¦å‘Šæ¬¡æ•°
        let stillCheckInterval = 1000; // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡é™æ­¢
        let lastStillCheckTime = 0; // ä¸Šæ¬¡æ£€æŸ¥é™æ­¢çš„æ—¶é—´

        // æ›´æ–°ç¯®å­ç§»åŠ¨æ¨¡å¼ï¼ˆæ ¹æ®è¿›ç¯®æ¬¡æ•°ï¼‰
        function updateBasketMode() {
            successfulBaskets = Math.floor(score / 10); // æ¯æ¬¡è¿›ç¯®å¾—10åˆ†

            if (successfulBaskets < 10) {
                // 0-9æ¬¡ï¼šä¸ç§»åŠ¨
                basketMode = 'static';
                basket.dx = 0;
                basket.dy = 0;
            } else if (successfulBaskets < 20) {
                // 10-19æ¬¡ï¼šæ…¢é€Ÿç§»åŠ¨
                basketMode = 'slow';
                basket.dx = 1;
                basket.dy = 0;
            } else if (successfulBaskets < 30) {
                // 20-29æ¬¡ï¼šä¸­é€Ÿç§»åŠ¨
                basketMode = 'medium';
                basket.dx = 2;
                basket.dy = 0;
            } else if (successfulBaskets < 40) {
                // 30-39æ¬¡ï¼šé€Ÿåº¦ç‰¹åˆ«æ…¢
                basketMode = 'slow';
                basket.dx = 0.5;
                basket.dy = 0;
            } else if (successfulBaskets < 100) {
                // 40-99æ¬¡ï¼šè½¬åœˆåœˆ
                basketMode = 'circle';
                if (basket.centerX === 0) {
                    basket.centerX = canvas.width / 2;
                    basket.centerY = 30 + basket.height / 2;
                    basket.radius = Math.min(canvas.width, canvas.height) * 0.3;
                }
                basket.angle = 0;
            } else if (successfulBaskets < 150) {
                // 100-149æ¬¡ï¼šéšæœºç§»åŠ¨ï¼ˆä¸ä¼šå¤ªå¿«ï¼‰ï¼Œå¯ä»¥ä¸Šä¸‹ç§»åŠ¨
                basketMode = 'random';
                if (Math.abs(basket.dx) < 0.5) {
                    basket.dx = (Math.random() - 0.5) * 1.5;
                    basket.dy = (Math.random() - 0.5) * 1.5;
                }
            } else if (successfulBaskets < 160) {
                // 150-159æ¬¡ï¼šæ…¢é€Ÿç§»åŠ¨
                basketMode = 'slow';
                basket.dx = 1;
                basket.dy = 0;
            } else if (successfulBaskets < 170) {
                // 160-169æ¬¡ï¼šä¸­é€Ÿç§»åŠ¨
                basketMode = 'medium';
                basket.dx = 2;
                basket.dy = 0;
            } else {
                // 170+æ¬¡ï¼šå¿«é€Ÿç§»åŠ¨
                basketMode = 'fast';
                basket.dx = 3;
                basket.dy = 0;
            }
        }

        // æ˜¾ç¤ºé™æ­¢è­¦å‘Š
        function showStillWarning() {
            // åœ¨ç”»å¸ƒä¸Šæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
            const warningMsg = document.createElement('div');
            warningMsg.id = 'stillWarning';
            warningMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 0, 0, 0.9);
                color: white;
                padding: 20px 40px;
                border-radius: 10px;
                font-size: 24px;
                font-weight: bold;
                z-index: 1000;
                pointer-events: none;
                animation: warningPulse 0.5s ease-out;
            `;
            warningMsg.textContent = `âš ï¸ è­¦å‘Š ${stillWarningCount}/3ï¼šè¯·ç§»åŠ¨æŒ¡æ¿ï¼`;
            document.body.appendChild(warningMsg);

            // 3ç§’åç§»é™¤è­¦å‘Š
            setTimeout(() => {
                if (warningMsg.parentNode) {
                    warningMsg.parentNode.removeChild(warningMsg);
                }
            }, 3000);
        }

        // æ˜¾ç¤ºæ‰£åˆ†æƒ©ç½š
        function showStillPenalty() {
            const penaltyMsg = document.createElement('div');
            penaltyMsg.id = 'stillPenalty';
            penaltyMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 100, 0, 0.95);
                color: white;
                padding: 25px 50px;
                border-radius: 10px;
                font-size: 28px;
                font-weight: bold;
                z-index: 1001;
                pointer-events: none;
                animation: penaltyShake 0.6s ease-out;
            `;
            penaltyMsg.textContent = `âŒ é™æ­¢æƒ©ç½šï¼š-100åˆ†ï¼`;
            document.body.appendChild(penaltyMsg);

            // 4ç§’åç§»é™¤
            setTimeout(() => {
                if (penaltyMsg.parentNode) {
                    penaltyMsg.parentNode.removeChild(penaltyMsg);
                }
            }, 4000);
        }

        // æ·»åŠ è­¦å‘ŠåŠ¨ç”»CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes warningPulse {
                0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                50% { transform: translate(-50%, -50%) scale(1.1); }
                100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            }
            @keyframes penaltyShake {
                0%, 100% { transform: translate(-50%, -50%) translateX(0); }
                25% { transform: translate(-50%, -50%) translateX(-10px); }
                75% { transform: translate(-50%, -50%) translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // éšæœºè¿›çƒåŠŸèƒ½
        function triggerRandomBasket() {
            if (gameState !== 'playing' || isPreviewMode) return;

            // éšæœºå°†çƒæ”¾åœ¨ç©å®¶ä¸åœ¨çš„ä½ç½®
            let ballX, ballY;
            let attempts = 0;
            do {
                // çƒéšæœºå‡ºç°åœ¨ç”»å¸ƒä¸Šæ–¹åŒºåŸŸï¼Œé¿å…å’ŒæŒ¡æ¿é‡å 
                ballX = Math.random() * (canvas.width - ball.radius * 2) + ball.radius;
                ballY = Math.random() * (canvas.height * 0.3) + 50; // ä¸ŠåŠéƒ¨åˆ†åŒºåŸŸ
                attempts++;
            } while (
                attempts < 10 &&
                (ballX + ball.radius > paddle.x &&
                    ballX - ball.radius < paddle.x + paddle.width &&
                    ballY + ball.radius > paddle.y - 50) // é¿å…å’ŒæŒ¡æ¿é‡å 
            );

            // è®¾ç½®çƒçš„ä½ç½®
            ball.x = ballX;
            ball.y = ballY;

            // éšæœºæ–¹å‘ï¼Œä½†ç¡®ä¿çƒä¼šå‘ä¸Šé£å‘ç¯®å­
            const angle = (Math.random() - 0.5) * Math.PI / 4; // -22.5 åˆ° 22.5 åº¦
            ball.dx = Math.sin(angle) * BALL_SPEED;
            ball.dy = -Math.abs(Math.cos(angle) * BALL_SPEED); // å‘ä¸Š

            // æ ‡è®°å·²ç»ç¢°è¿‡æŒ¡æ¿ï¼ˆè¿™æ ·å¯ä»¥ç›´æ¥è¿›ç¯®ï¼‰
            hasHitPaddle = true;

            // ç¯®å­ä¹Ÿå¯èƒ½éšæœºç§»åŠ¨åˆ°ä¸‹æ–¹ä½ç½®
            if (Math.random() < 0.5 && successfulBaskets >= 30) {
                // 30æ¬¡ä»¥ä¸Šæ‰æœ‰æ¦‚ç‡ç§»åŠ¨åˆ°ä¸‹æ–¹
                const randomY = canvas.height * 0.4 + Math.random() * (canvas.height * 0.3);
                basket.y = Math.max(50, Math.min(randomY, canvas.height * 0.6));
            }

            // æ·»åŠ ç‰¹æ•ˆ
            createParticles(ball.x, ball.y, '#FFD700');
        }

        // åˆå§‹åŒ–
        function init() {
            paddle.x = canvas.width / 2 - paddle.width / 2;
            paddle.y = canvas.height - 40;
            targetPaddleX = paddle.x;

            // ç¯®å­å±…ä¸­
            basket.x = canvas.width / 2 - basket.width / 2;
            basket.y = 30;
            basket.dx = 0;
            basket.dy = 0;
            basket.centerX = canvas.width / 2;
            basket.centerY = 30 + basket.height / 2;
            basket.radius = Math.min(canvas.width, canvas.height) * 0.3;
            basket.angle = 0;

            resetBall();

            score = 0;
            timeLeft = 180;
            lives = 3;
            successfulBaskets = 0;
            stillWarningCount = 0; // é‡ç½®è­¦å‘Šæ¬¡æ•°

            document.getElementById('score').textContent = score;
            // æ ¼å¼åŒ–æ—¶é—´ä¸º MM:SS
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('lives').textContent = lives;

            updateBasketMode();
            draw();
        }

        // æ ‡å‡†åŒ–çƒé€Ÿï¼šç¡®ä¿é€Ÿåº¦å§‹ç»ˆæ˜¯å›ºå®šçš„ BALL_SPEED
        function normalizeBallSpeed() {
            const currentSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
            if (currentSpeed > 0) {
                // ä¿æŒæ–¹å‘ï¼Œä½†ä½¿ç”¨å›ºå®šé€Ÿåº¦
                const scale = BALL_SPEED / currentSpeed;
                ball.dx *= scale;
                ball.dy *= scale;
            }
        }

        // é‡ç½®çƒï¼ˆä½¿ç”¨å›ºå®šé€Ÿåº¦ï¼‰
        function resetBall() {
            // çƒé‡ç½®åœ¨æŒ¡æ¿ä¸Šæ–¹é™„è¿‘ï¼Œå‘ä¸‹è¿åŠ¨
            ball.x = paddle.x + paddle.width / 2;
            ball.y = paddle.y - 50; // åœ¨æŒ¡æ¿ä¸Šæ–¹50åƒç´ 
            // åˆå§‹æ–¹å‘éšæœºï¼Œä½†æ€»ä½“å‘ä¸‹æˆ–æ–œå‘ä¸‹
            const angle = (Math.random() - 0.5) * Math.PI / 4; // -22.5 åˆ° 22.5 åº¦
            ball.dx = Math.sin(angle) * BALL_SPEED;
            ball.dy = Math.abs(Math.cos(angle) * BALL_SPEED); // å‘ä¸‹è¿åŠ¨
            hasHitPaddle = false; // é‡ç½®æ ‡è®°
        }

        // ç»˜åˆ¶
        function draw() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶ç½‘æ ¼èƒŒæ™¯
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            for (let x = 0; x < canvas.width; x += 20) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += 20) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            // ç»˜åˆ¶ç¯®å­
            // é¢„è§ˆæ¨¡å¼ä¸‹æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            if (isPreviewMode) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
                ctx.fillRect(0, 0, canvas.width, 90);

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 20px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`é¢„è§ˆæ¨¡å¼ - è¿›ç¯®æ¬¡æ•°: ${previewLevel}`, canvas.width / 2, 28);

                let modeText = '';
                if (previewLevel < 10) modeText = 'é™æ€ï¼ˆä¸ç§»åŠ¨ï¼‰';
                else if (previewLevel < 20) modeText = 'æ…¢é€Ÿç§»åŠ¨';
                else if (previewLevel < 30) modeText = 'ä¸­é€Ÿç§»åŠ¨';
                else if (previewLevel < 40) modeText = 'ç‰¹åˆ«æ…¢ç§»åŠ¨';
                else if (previewLevel < 100) modeText = 'è½¬åœˆåœˆ';
                else if (previewLevel < 150) modeText = 'éšæœºç§»åŠ¨';
                else if (previewLevel < 160) modeText = 'æ…¢é€Ÿç§»åŠ¨';
                else if (previewLevel < 170) modeText = 'ä¸­é€Ÿç§»åŠ¨';
                else modeText = 'å¿«é€Ÿç§»åŠ¨';

                ctx.font = '16px sans-serif';
                ctx.fillText(`æ¨¡å¼: ${modeText}`, canvas.width / 2, 52);

                // æ˜¾ç¤ºæš‚åœçŠ¶æ€å’Œæç¤º
                if (isPreviewPaused) {
                    ctx.font = 'bold 14px sans-serif';
                    ctx.fillStyle = '#FFD700';
                    ctx.fillText('â¸ å·²æš‚åœ - å¯ä»¥ä»”ç»†æŸ¥çœ‹å½“å‰å…³å¡ç¯®å­çš„ç§»åŠ¨', canvas.width / 2, 72);
                } else {
                    ctx.font = '12px sans-serif';
                    ctx.fillStyle = '#aaa';
                    ctx.fillText('å…³å¡è‡ªåŠ¨åˆ‡æ¢ä¸­...', canvas.width / 2, 72);
                }

                ctx.font = '12px sans-serif';
                ctx.fillStyle = '#fff';
                ctx.fillText('é¼ æ ‡å·¦é”®: æš‚åœ/ç»§ç»­æŸ¥çœ‹ | ä¸­é”®: é€€å‡ºé¢„è§ˆ', canvas.width / 2, 86);
            }

            // ç¯®å­ä¸»ä½“
            ctx.fillStyle = '#FFA500';
            ctx.fillRect(basket.x, basket.y, basket.width, basket.height);

            // ç¯®å­è¾¹æ¡†
            ctx.strokeStyle = '#FF8C00';
            ctx.lineWidth = 3;
            ctx.strokeRect(basket.x, basket.y, basket.width, basket.height);

            // ç¯®ç­ï¼ˆä¸Šæ–¹è¾¹ç¼˜ï¼‰
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(basket.x - 5, basket.y, basket.width + 10, basket.rimHeight);

            // ç¯®ç­é«˜å…‰
            ctx.strokeStyle = '#FFA500';
            ctx.lineWidth = 2;
            ctx.strokeRect(basket.x - 5, basket.y, basket.width + 10, basket.rimHeight);

            // ç¯®å­ç½‘æ ¼çº¿ï¼ˆè£…é¥°ï¼‰
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.lineWidth = 1;
            for (let i = 1; i < 4; i++) {
                const y = basket.y + (basket.height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(basket.x, y);
                ctx.lineTo(basket.x + basket.width, y);
                ctx.stroke();
            }
            for (let i = 1; i < 4; i++) {
                const x = basket.x + (basket.width / 4) * i;
                ctx.beginPath();
                ctx.moveTo(x, basket.y);
                ctx.lineTo(x, basket.y + basket.height);
                ctx.stroke();
            }

            // ç»˜åˆ¶æŒ¡æ¿
            const gradient = ctx.createLinearGradient(paddle.x, paddle.y, paddle.x + paddle.width, paddle.y);
            gradient.addColorStop(0, '#6C5CE7');
            gradient.addColorStop(1, '#A29BFE');
            ctx.fillStyle = gradient;
            ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);

            // æŒ¡æ¿é«˜å…‰
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.strokeRect(paddle.x, paddle.y, paddle.width, paddle.height);

            // ç»˜åˆ¶çƒ
            const ballGradient = ctx.createRadialGradient(
                ball.x - 3, ball.y - 3, 0,
                ball.x, ball.y, ball.radius
            );
            ballGradient.addColorStop(0, '#fff');
            ballGradient.addColorStop(1, '#74B9FF');
            ctx.fillStyle = ballGradient;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();

            // çƒçš„é«˜å…‰
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.beginPath();
            ctx.arc(ball.x - 3, ball.y - 3, ball.radius / 3, 0, Math.PI * 2);
            ctx.fill();

            // å¦‚æœæ¸¸æˆæœªå¼€å§‹ï¼Œæ˜¾ç¤ºæç¤º
            if (gameState === 'ready') {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 32px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ç‚¹å‡»å¼€å§‹æ¸¸æˆ', canvas.width / 2, canvas.height / 2);
            }
        }

        // æ›´æ–°ç¯®å­ä½ç½®
        function updateBasket() {
            // é¢„è§ˆæ¨¡å¼ä¸‹ä¹Ÿæ›´æ–°ç¯®å­
            if (gameState !== 'playing' && !isPreviewMode) return;

            if (isPreviewMode) {
                // é¢„è§ˆæ¨¡å¼ï¼šä½¿ç”¨é¢„è§ˆå…³å¡
                const tempBaskets = successfulBaskets;
                successfulBaskets = previewLevel;
                updateBasketMode();
                successfulBaskets = tempBaskets;
            } else {
                updateBasketMode();
            }

            if (basketMode === 'static') {
                // ä¸ç§»åŠ¨
                // ç¡®ä¿ç¯®å­å±…ä¸­ï¼ˆä»…åœ¨é¢„è§ˆæ¨¡å¼ä¸‹é‡ç½®ä½ç½®ï¼‰
                if (isPreviewMode && previewLevel === 0) {
                    basket.x = canvas.width / 2 - basket.width / 2;
                    basket.y = 30;
                }
                return;
            } else if (basketMode === 'slow' || basketMode === 'medium' || basketMode === 'fast') {
                // æ°´å¹³ç§»åŠ¨
                basket.x += basket.dx;

                // è¾¹ç•Œåå¼¹
                if (basket.x <= 0 || basket.x + basket.width >= canvas.width) {
                    basket.dx = -basket.dx;
                    basket.x = Math.max(0, Math.min(basket.x, canvas.width - basket.width));
                }
            } else if (basketMode === 'circle') {
                // è½¬åœˆåœˆ
                basket.angle += 0.02;
                basket.x = basket.centerX + Math.cos(basket.angle) * basket.radius - basket.width / 2;
                basket.y = basket.centerY + Math.sin(basket.angle) * basket.radius - basket.height / 2;

                // ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
                basket.x = Math.max(0, Math.min(basket.x, canvas.width - basket.width));
                basket.y = Math.max(10, Math.min(basket.y, canvas.height / 3));
            } else if (basketMode === 'random') {
                // éšæœºç§»åŠ¨ï¼ˆå¯ä»¥ä¸Šä¸‹ç§»åŠ¨ï¼‰
                basket.x += basket.dx;
                basket.y += basket.dy;

                // è¾¹ç•Œåå¼¹å¹¶æ”¹å˜æ–¹å‘
                if (basket.x <= 0 || basket.x + basket.width >= canvas.width) {
                    basket.dx = -basket.dx;
                    basket.dx = (Math.random() - 0.5) * 1.5;
                }
                // å…è®¸ç¯®å­ç§»åŠ¨åˆ°ä¸‹æ–¹ï¼Œä½†é™åˆ¶èŒƒå›´
                if (basket.y <= 10 || basket.y + basket.height >= canvas.height * 0.7) {
                    basket.dy = -basket.dy;
                    basket.dy = (Math.random() - 0.5) * 1.5;
                }

                basket.x = Math.max(0, Math.min(basket.x, canvas.width - basket.width));
                basket.y = Math.max(10, Math.min(basket.y, canvas.height * 0.7));

                // å¶å°”æ”¹å˜æ–¹å‘
                if (Math.random() < 0.05) {
                    basket.dx = (Math.random() - 0.5) * 1.5;
                    basket.dy = (Math.random() - 0.5) * 1.5;
                }
            }
        }

        // è°ƒè¯•é¢„è§ˆï¼šå±•ç¤ºä¸åŒè¿›ç¯®æ¬¡æ•°çš„ç¯®å­ç§»åŠ¨
        function startBasketPreview() {
            if (isPreviewMode) {
                // å¦‚æœå·²ç»åœ¨é¢„è§ˆï¼Œåˆ™åœæ­¢
                stopBasketPreview();
                return;
            }

            isPreviewMode = true;
            isPreviewPaused = false; // åˆå§‹ä¸æš‚åœ
            // æš‚åœæ¸¸æˆï¼ˆå¦‚æœæ­£åœ¨æ¸¸æˆï¼‰
            if (gameState === 'playing') {
                gameState = 'paused';
                if (timerId) clearInterval(timerId);
            }

            previewLevel = 0;

            // é‡ç½®ç¯®å­åˆ°åˆå§‹ä½ç½®
            basket.x = canvas.width / 2 - basket.width / 2;
            basket.y = 30;
            basket.angle = 0;
            basket.centerX = canvas.width / 2;
            basket.centerY = 30 + basket.height / 2;
            basket.radius = Math.min(canvas.width, canvas.height) * 0.3;

            // ç«‹å³æ›´æ–°ä¸€æ¬¡ç¯®å­ä½ç½®
            updateBasket();

            // æ¯1ç§’åˆ‡æ¢ä¸€ä¸ªå…³å¡ï¼ˆå¦‚æœæœªæš‚åœï¼‰
            previewTimer = setInterval(() => {
                if (!isPreviewPaused) {
                    previewLevel++;
                    if (previewLevel > 180) {
                        previewLevel = 0; // å¾ªç¯
                    }

                    // é‡ç½®ç¯®å­ä½ç½®ï¼Œç”¨äºé¢„è§ˆæ–°å…³å¡
                    basket.x = canvas.width / 2 - basket.width / 2;
                    basket.y = 30;
                    basket.angle = 0;

                    // æ›´æ–°ç¯®å­ä½ç½®ç”¨äºé¢„è§ˆ
                    updateBasket();
                }
            }, 1000);
        }

        // é¢„è§ˆæ¨¡å¼æš‚åœ/ç»§ç»­
        function togglePreviewPause() {
            if (!isPreviewMode) return;
            isPreviewPaused = !isPreviewPaused;
        }

        function stopBasketPreview() {
            if (!isPreviewMode) return;

            isPreviewMode = false;
            isPreviewPaused = false;
            if (previewTimer) {
                clearInterval(previewTimer);
                previewTimer = null;
            }

            // æ¢å¤æ­£å¸¸ç¯®å­ä½ç½®
            updateBasketMode();

            // å¦‚æœæ¸¸æˆæ˜¯æš‚åœçŠ¶æ€ï¼Œæ¢å¤æš‚åœçŠ¶æ€ï¼ˆä½†ä¿æŒæš‚åœï¼‰
            // å¦‚æœæ¸¸æˆæ˜¯è¿›è¡Œä¸­ï¼Œä¿æŒè¿›è¡Œä¸­
            if (gameState === 'paused' && !document.getElementById('paused').classList.contains('show')) {
                document.getElementById('paused').classList.add('show');
            }
        }

        // æ›´æ–°æ¸¸æˆ
        function update(deltaTime) {
            // é¢„è§ˆæ¨¡å¼ä¸‹åªæ›´æ–°ç¯®å­ï¼Œä¸æ›´æ–°æ¸¸æˆé€»è¾‘
            if (isPreviewMode) {
                updateBasket();
                return;
            }

            if (gameState !== 'playing') return;

            // æ›´æ–°ç¯®å­ä½ç½®
            updateBasket();

            // ç§»åŠ¨æŒ¡æ¿ - é”®ç›˜æ§åˆ¶
            let paddleMoved = false; // æ ‡è®°æŒ¡æ¿æ˜¯å¦ç§»åŠ¨
            if (keys.left && paddle.x > 0) {
                paddle.x -= paddle.speed;
                targetPaddleX = paddle.x; // åŒæ­¥ç›®æ ‡ä½ç½®
                lastPaddleX = paddle.x; // æ›´æ–°ä½ç½®ï¼Œé‡ç½®é™æ­¢æ—¶é—´
                paddleStillTime = 0;
                paddleMoved = true;
            }
            if (keys.right && paddle.x < canvas.width - paddle.width) {
                paddle.x += paddle.speed;
                targetPaddleX = paddle.x; // åŒæ­¥ç›®æ ‡ä½ç½®
                lastPaddleX = paddle.x; // æ›´æ–°ä½ç½®ï¼Œé‡ç½®é™æ­¢æ—¶é—´
                paddleStillTime = 0;
                paddleMoved = true;
            }

            // é¼ æ ‡å¹³æ»‘è·Ÿéš - å¦‚æœæ²¡æœ‰æŒ‰é”®
            if (!keys.left && !keys.right) {
                const diff = targetPaddleX - paddle.x;
                const speed = Math.abs(diff) * 0.15; // å¹³æ»‘è·Ÿéšé€Ÿåº¦
                if (Math.abs(diff) > 1) {
                    paddle.x += diff > 0 ? speed : -speed;
                    lastPaddleX = paddle.x; // æ›´æ–°ä½ç½®ï¼Œé‡ç½®é™æ­¢æ—¶é—´
                    paddleStillTime = 0;
                    paddleMoved = true;
                } else {
                    paddle.x = targetPaddleX;
                    // æ£€æŸ¥æ˜¯å¦é™æ­¢ï¼ˆä½ç½®æ²¡æœ‰å˜åŒ–ï¼‰
                    if (Math.abs(paddle.x - lastPaddleX) < 1) {
                        paddleStillTime += deltaTime;
                    } else {
                        lastPaddleX = paddle.x;
                        paddleStillTime = 0;
                        paddleMoved = true;
                    }
                }
                // é™åˆ¶è¾¹ç•Œ
                paddle.x = Math.max(0, Math.min(paddle.x, canvas.width - paddle.width));
            } else {
                // æœ‰æŒ‰é”®æ—¶ä¹Ÿæ£€æŸ¥ä½ç½®å˜åŒ–
                if (Math.abs(paddle.x - lastPaddleX) < 1 && !paddleMoved) {
                    paddleStillTime += deltaTime;
                } else if (!paddleMoved) {
                    lastPaddleX = paddle.x;
                    paddleStillTime = 0;
                }
            }

            // æ£€æµ‹ç©å®¶æ˜¯å¦é™æ­¢ä¸åŠ¨ï¼ˆæ¸¸æˆå¼€å§‹2ç§’åæ‰æ£€æµ‹ï¼‰
            const currentTime = Date.now();
            const timeSinceStart = currentTime - gameStartTime;
            if (timeSinceStart > 2000 && gameState === 'playing') { // å¼€å±€2ç§’åæ‰æ£€æµ‹
                // å¦‚æœæŒ¡æ¿é™æ­¢è¶…è¿‡3ç§’ï¼ˆè¿ç»­é™æ­¢3ç§’ï¼‰
                if (paddleStillTime > 3000) {
                    // è­¦å‘Šï¼ˆæœ€å¤š3æ¬¡ï¼‰
                    if (stillWarningCount < 3) {
                        stillWarningCount++;
                        showStillWarning();
                        paddleStillTime = 0; // é‡ç½®é™æ­¢æ—¶é—´ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å®Œæ•´çš„3ç§’é™æ­¢
                    } else if (stillWarningCount === 3) {
                        // ç¬¬3æ¬¡è­¦å‘Šåï¼Œæ‰£100ç§¯åˆ†
                        score = score - 100;
                        document.getElementById('score').textContent = score;

                        // æ£€æŸ¥åˆ†æ•°æ˜¯å¦ä¸ºè´Ÿæ•°
                        if (score < 0) {
                            gameOver(); // ç«‹å³æ¸¸æˆå¤±è´¥
                            return;
                        }
                        showStillPenalty();
                        stillWarningCount++; // æ ‡è®°å·²æ‰£åˆ†ï¼Œä¸å†ç»§ç»­è­¦å‘Š
                        paddleStillTime = 0;
                    }
                }
            }

            // ç§»åŠ¨çƒ
            ball.x += ball.dx;
            ball.y += ball.dy;

            // çƒç¢°æ’å·¦è¾¹ç•Œ
            if (ball.x - ball.radius <= 0) {
                ball.x = ball.radius;
                ball.dx = -ball.dx;
                normalizeBallSpeed(); // ç¡®ä¿é€Ÿåº¦å›ºå®š
            }

            // çƒç¢°æ’å³è¾¹ç•Œ
            if (ball.x + ball.radius >= canvas.width) {
                ball.x = canvas.width - ball.radius;
                ball.dx = -ball.dx;
                normalizeBallSpeed(); // ç¡®ä¿é€Ÿåº¦å›ºå®š
            }

            // çƒç¢°æ’ä¸Šè¾¹ç•Œ
            if (ball.y - ball.radius <= 0) {
                ball.y = ball.radius;
                ball.dy = -ball.dy;
                normalizeBallSpeed(); // ç¡®ä¿é€Ÿåº¦å›ºå®š
            }

            // çƒç¢°æ’æŒ¡æ¿
            if (ball.y + ball.radius >= paddle.y &&
                ball.y - ball.radius <= paddle.y + paddle.height &&
                ball.x + ball.radius >= paddle.x &&
                ball.x - ball.radius <= paddle.x + paddle.width) {

                // æ ‡è®°çƒå·²ç¢°è¿‡æŒ¡æ¿
                hasHitPaddle = true;

                // æ ¹æ®å‡»ä¸­æŒ¡æ¿çš„ä½ç½®æ”¹å˜åå¼¹è§’åº¦
                const hitPos = (ball.x - paddle.x) / paddle.width; // 0 åˆ° 1
                const angle = (hitPos - 0.5) * Math.PI / 3; // -60 åˆ° 60 åº¦
                // ä½¿ç”¨å›ºå®šçƒé€Ÿï¼Œä¸æ ¹æ®å½“å‰é€Ÿåº¦
                ball.dx = Math.sin(angle) * BALL_SPEED;
                ball.dy = -Math.abs(Math.cos(angle) * BALL_SPEED);
                // ç¡®ä¿é€Ÿåº¦æ­£ç¡®ï¼ˆè™½ç„¶å·²ç»ç”¨äº†å›ºå®šé€Ÿåº¦ï¼Œä½†åŒé‡ä¿é™©ï¼‰
                normalizeBallSpeed();

                ball.y = paddle.y - ball.radius;
            }

            // æ£€æŸ¥çƒæ˜¯å¦è¿›ç¯®ï¼ˆå¿…é¡»ç¢°è¿‡æŒ¡æ¿ä¸”ä»ä¸Šæ–¹è¿›å…¥ç¯®å­ï¼‰
            // æ›´ä¸¥æ ¼çš„æ£€æµ‹ï¼šçƒå¿…é¡»åœ¨ç¯®å­å†…éƒ¨ï¼Œä¸”ä»ä¸Šæ–¹è¿›å…¥
            const ballInBasketX = ball.x >= basket.x && ball.x <= basket.x + basket.width;
            const ballInBasketY = ball.y >= basket.y + basket.rimHeight && ball.y <= basket.y + basket.height;
            const ballEnteringFromTop = ball.dy < 0 && ball.y < basket.y + basket.height * 0.6; // çƒçš„ä¸ŠåŠéƒ¨åˆ†åœ¨ç¯®å­ä¸ŠåŠéƒ¨åˆ†

            if (hasHitPaddle && // å¿…é¡»ç¢°è¿‡æŒ¡æ¿
                ballInBasketX &&
                ballInBasketY &&
                ballEnteringFromTop) {
                // è¿›ç¯®æˆåŠŸï¼
                score += 10;
                successfulBaskets++;
                document.getElementById('score').textContent = score;

                // æ›´æ–°ç¯®å­ç§»åŠ¨æ¨¡å¼
                updateBasketMode();

                // æ·»åŠ ç²’å­æ•ˆæœ
                createParticles(basket.x + basket.width / 2, basket.y + basket.height / 2, '#FFD700');

                // é‡ç½®çƒ
                resetBall();
            }

            // çƒæ‰è½
            if (ball.y - ball.radius > canvas.height) {
                lives--;
                document.getElementById('lives').textContent = lives;

                if (lives <= 0) {
                    gameOver();
                } else {
                    resetBall();
                }
            }

            // æ£€æŸ¥æ—¶é—´
            if (timeLeft <= 0) {
                gameOver();
            }

            // éšæœºè¿›çƒåŠŸèƒ½ï¼ˆæ¯10ç§’éšæœºè§¦å‘ä¸€æ¬¡ï¼‰
            const randomBasketCurrentTime = Date.now();
            if (randomBasketCurrentTime - lastRandomBasketTime > randomBasketInterval) {
                if (Math.random() < 0.3) { // 30%çš„æ¦‚ç‡è§¦å‘éšæœºè¿›çƒ
                    triggerRandomBasket();
                    lastRandomBasketTime = randomBasketCurrentTime;
                    // éšæœºè®¾ç½®ä¸‹ä¸€æ¬¡è§¦å‘æ—¶é—´ï¼ˆ8-15ç§’ï¼‰
                    randomBasketInterval = 8000 + Math.random() * 7000;
                } else {
                    lastRandomBasketTime = randomBasketCurrentTime;
                }
            }
        }

        // åˆ›å»ºç²’å­æ•ˆæœï¼ˆç®€åŒ–ç‰ˆï¼‰
        let particles = [];
        function createParticles(x, y, color) {
            for (let i = 0; i < 5; i++) {
                particles.push({
                    x: x,
                    y: y,
                    dx: (Math.random() - 0.5) * 4,
                    dy: (Math.random() - 0.5) * 4,
                    life: 20,
                    color: color
                });
            }
        }

        // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
        function updateParticles() {
            particles = particles.filter(p => {
                p.x += p.dx;
                p.y += p.dy;
                p.life--;

                if (p.life > 0) {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life / 20;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }

                return p.life > 0;
            });
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop(currentTime) {
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;

            update(deltaTime);
            draw();
            updateParticles();

            requestAnimationFrame(gameLoop);
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            gameState = 'playing';
            document.getElementById('gameOver').classList.remove('show');
            document.getElementById('paused').classList.remove('show');
            lastTime = performance.now();

            // åˆå§‹åŒ–éšæœºè¿›çƒ
            lastRandomBasketTime = Date.now();
            randomBasketInterval = 10000;

            // åˆå§‹åŒ–é™æ­¢æ£€æµ‹
            gameStartTime = Date.now();
            lastPaddleX = paddle.x;
            paddleStillTime = 0;
            stillWarningCount = 0;
            lastStillCheckTime = Date.now();

            // å¯åŠ¨è®¡æ—¶å™¨
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                if (gameState === 'playing') {
                    timeLeft--;
                    // æ ¼å¼åŒ–æ—¶é—´ä¸º MM:SS
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    document.getElementById('time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    if (timeLeft <= 0) {
                        gameOver();
                    }
                }
            }, 1000);

            gameLoop(performance.now());
        }

        // æš‚åœ/ç»§ç»­
        function togglePause() {
            if (isPreviewMode) {
                // é¢„è§ˆæ¨¡å¼ä¸‹ä¸èƒ½æš‚åœ/ç»§ç»­
                return;
            }
            if (gameState === 'playing') {
                gameState = 'paused';
                document.getElementById('paused').classList.add('show');
                if (timerId) clearInterval(timerId);
            } else if (gameState === 'paused') {
                gameState = 'playing';
                document.getElementById('paused').classList.remove('show');
                lastTime = performance.now();
                // æ¢å¤è®¡æ—¶å™¨
                timerId = setInterval(() => {
                    if (gameState === 'playing') {
                        timeLeft--;
                        // æ ¼å¼åŒ–æ—¶é—´ä¸º MM:SS
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        document.getElementById('time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        if (timeLeft <= 0) {
                            gameOver();
                        }
                    }
                }, 1000);
            }
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameState = 'gameover';
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }

            const MIN_SCORE = 700; // æœ€ä½è¦æ±‚åˆ†æ•°
            const isScoreNegative = score < 0;
            const isScoreTooLow = score < MIN_SCORE;

            document.getElementById('finalScore').textContent = score;

            // åˆ¤æ–­å¤±è´¥åŸå› 
            if (isScoreNegative) {
                document.getElementById('gameOverTitle').textContent = 'æ¸¸æˆå¤±è´¥';
                document.getElementById('gameOverMsg').textContent = `åˆ†æ•°ä¸ºè´Ÿï¼ˆ${score}åˆ†ï¼‰ï¼éœ€è¦è¾¾åˆ°700åˆ†ä»¥ä¸Šã€‚æ¸¸æˆå°†é‡æ–°å¼€å§‹...`;
            } else if (isScoreTooLow) {
                document.getElementById('gameOverTitle').textContent = 'æ¸¸æˆå¤±è´¥';
                document.getElementById('gameOverMsg').textContent = `å¾—åˆ†ä¸è¶³ï¼ˆ${score}åˆ†ï¼‰ï¼éœ€è¦è¾¾åˆ°700åˆ†ä»¥ä¸Šæ‰èƒ½æˆåŠŸã€‚æ¸¸æˆå°†é‡æ–°å¼€å§‹...`;
            } else if (lives <= 0) {
                document.getElementById('gameOverTitle').textContent = 'ç”Ÿå‘½ç”¨å°½';
                document.getElementById('gameOverMsg').textContent = `æœ€ç»ˆå¾—åˆ†ï¼š${score} åˆ†ï¼ˆè¾¾æ ‡ï¼ï¼‰`;
            } else if (timeLeft <= 0) {
                document.getElementById('gameOverTitle').textContent = 'æ—¶é—´åˆ°';
                document.getElementById('gameOverMsg').textContent = `æœ€ç»ˆå¾—åˆ†ï¼š${score} åˆ†ï¼ˆè¾¾æ ‡ï¼ï¼‰`;
            } else {
                document.getElementById('gameOverTitle').textContent = 'æ¸¸æˆæˆåŠŸ';
                document.getElementById('gameOverMsg').textContent = `æœ€ç»ˆå¾—åˆ†ï¼š${score} åˆ†ï¼ˆè¾¾æ ‡ï¼ï¼‰`;
            }

            document.getElementById('gameOver').classList.add('show');

            // å¦‚æœåˆ†æ•°ä¸è¾¾æ ‡æˆ–ä¸ºè´Ÿæ•°ï¼Œ3ç§’åè‡ªåŠ¨é‡æ–°å¼€å§‹
            if (isScoreNegative || isScoreTooLow) {
                setTimeout(() => {
                    document.getElementById('gameOver').classList.remove('show');
                    newGame();
                    startGame();
                }, 3000);
            }
        }

        // æ–°æ¸¸æˆ
        function newGame() {
            // åœæ­¢é¢„è§ˆæ¨¡å¼
            stopBasketPreview();

            gameState = 'ready';
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }
            init();
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') keys.left = true;
            if (e.key === 'ArrowRight') keys.right = true;
            if (e.key === ' ') {
                e.preventDefault();
                if (gameState === 'playing' || gameState === 'paused') {
                    togglePause();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft') keys.left = false;
            if (e.key === 'ArrowRight') keys.right = false;
        });

        // é¼ æ ‡æ§åˆ¶æŒ¡æ¿ - è®¾ç½®ç›®æ ‡ä½ç½®ï¼Œè®©æŒ¡æ¿å¹³æ»‘è·Ÿéš
        canvas.addEventListener('mousemove', (e) => {
            if (gameState === 'playing' && !isPreviewMode) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                targetPaddleX = Math.max(0, Math.min(mouseX - paddle.width / 2, canvas.width - paddle.width));
            }
        });

        // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
        window.addEventListener('mousedown', (e) => {
            if (e.button === 1) { // ä¸­é”®ï¼šå¼€å¯/å…³é—­ç¯®å­ç§»åŠ¨é¢„è§ˆ
                e.preventDefault();
                if (isPreviewMode) {
                    stopBasketPreview();
                } else {
                    startBasketPreview();
                }
            } else if (e.button === 0 && isPreviewMode) { // å·¦é”®ï¼šé¢„è§ˆæ¨¡å¼ä¸‹æš‚åœ/ç»§ç»­
                e.preventDefault();
                togglePreviewPause();
            }
        });

        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('pauseBtn').addEventListener('click', togglePause);
        document.getElementById('newGameBtn').addEventListener('click', newGame);
        document.getElementById('restartBtn').addEventListener('click', () => {
            newGame();
            startGame();
        });

        // åˆå§‹åŒ–
        init();
        gameLoop(performance.now());

        // ========== èƒŒæ™¯éŸ³ä¹ï¼šæ‰“ç –å—ä¸»é¢˜ï¼ˆCå¤§è°ƒï¼Œè½»å¿«èŠ‚å¥ï¼‰ ==========
        let audioContext = null;
        let musicTimer = null;

        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) { /* ignore */ }
            }
        }

        function createTone(freq, duration, type = 'square', vol = 0.08, delay = 0) {
            if (!audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioContext.currentTime + delay);
            gain.gain.setValueAtTime(0, audioContext.currentTime + delay);
            gain.gain.linearRampToValueAtTime(vol, audioContext.currentTime + delay + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + delay + duration);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(audioContext.currentTime + delay);
            osc.stop(audioContext.currentTime + delay + duration);
        }

        // æ‰“ç –å—ä¸»é¢˜éŸ³ä¹ï¼šCå¤§è°ƒï¼Œè½»å¿«æ´»æ³¼çš„èŠ‚å¥
        function playBreakoutTheme() {
            // ä¸»æ—‹å¾‹ï¼šCå¤§è°ƒéŸ³é˜¶ä¸Šè¡Œå’Œä¸‹è¡Œï¼Œè½»å¿«èŠ‚å¥
            const melody = [523.25, 587.33, 659.25, 698.46, 783.99, 698.46, 659.25, 587.33]; // C5 D5 E5 F5 G5 F5 E5 D5
            const step = 0.18; // æ›´å¿«çš„èŠ‚å¥
            let t = 0;

            melody.forEach((freq, i) => {
                // ä¸»æ—‹å¾‹ä½¿ç”¨triangleæ³¢å½¢ï¼Œæ›´æŸ”å’Œ
                createTone(freq, 0.15, 'triangle', 0.07, t);
                // æ·»åŠ å…«åº¦å’Œå£°
                if (i % 2 === 0) {
                    createTone(freq * 2, 0.15, 'sine', 0.03, t + 0.01);
                }
                t += step;
            });

            // ä½éŸ³èŠ‚å¥ï¼šCå¤§è°ƒè¿›è¡Œï¼Œæ›´æ˜å¿«çš„èŠ‚å¥
            const bassLine = [130.81, 146.83, 164.81, 174.61]; // C3 D3 E3 F3
            let bt = 0;
            bassLine.forEach(root => {
                // ä½¿ç”¨squareæ³¢å½¢ï¼Œæ›´æœ‰èŠ‚å¥æ„Ÿ
                createTone(root, 0.35, 'square', 0.025, bt);
                // æ·»åŠ äº”åº¦éŸ³
                createTone(root * 1.5, 0.35, 'square', 0.018, bt);
                bt += 0.7;
            });

            // é«˜éŸ³è£…é¥°ï¼šæ¸…è„†çš„éŸ³ç¬¦
            const highNotes = [1046.50, 1174.66, 1318.51]; // C6 D6 E6
            let ht = 0.2;
            highNotes.forEach(freq => {
                createTone(freq, 0.12, 'sine', 0.04, ht);
                ht += 0.25;
            });
        }

        function startBackgroundMusic() {
            initAudio();
            if (!audioContext) return;
            if (musicTimer) return;
            // ç«‹å³æ’­æ”¾ä¸€æ¬¡
            playBreakoutTheme();
            // æ¯5.5ç§’æ’­æ”¾ä¸€æ¬¡ï¼ˆæ¯”è¿·å®«æ¸¸æˆæ›´é¢‘ç¹ï¼Œæ›´æ´»æ³¼ï¼‰
            musicTimer = setInterval(() => {
                playBreakoutTheme();
            }, 5500);
        }

        function stopBackgroundMusic() {
            if (musicTimer) {
                clearInterval(musicTimer);
                musicTimer = null;
            }
        }

        // ä¿®æ”¹startGameå‡½æ•°ï¼Œæ·»åŠ éŸ³ä¹
        const originalStartGame = startGame;
        startGame = function () {
            originalStartGame();
            startBackgroundMusic();
        };

        // ä¿®æ”¹gameOverå‡½æ•°ï¼Œåœæ­¢éŸ³ä¹
        const originalGameOver = gameOver;
        gameOver = function () {
            stopBackgroundMusic();
            originalGameOver();
        };
    </script>
</body>

</html>