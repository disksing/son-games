<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥¶å¥¶å­¦è‹±è¯­ - Grandma Learns English</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 1s ease-in;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .parent-mode-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .parent-mode-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
            text-align: center;
        }

        .password-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .difficulty-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .difficulty-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .difficulty-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #667eea;
        }

        .difficulty-desc {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .difficulty-option.hard .difficulty-title {
            color: #d32f2f;
        }

        .difficulty-option.medium .difficulty-title {
            color: #f57c00;
        }

        .difficulty-option.easy .difficulty-title {
            color: #388e3c;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .level-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .level-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .level-card:hover::before {
            left: 100%;
        }

        .level-card.completed {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .level-card.locked {
            background: rgba(0, 0, 0, 0.2);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .level-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-content {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .level-card.locked .level-content::after {
            content: ' ğŸ”’';
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 20px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #81C784);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .game-screen {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            animation: slideUp 0.5s ease-out;
            min-height: 600px;
        }

        .game-screen.show {
            display: block;
        }

        .story-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .story-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }

        .story-text {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .phase-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .phase-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .phase-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .phase-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .phase-btn:not(.active) {
            background: rgba(255, 255, 255, 0.8);
            color: #666;
        }

        .play-area {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }

        /* Cat level styles */
        .cat-prison {
            background: linear-gradient(135deg, #8B4513, #654321);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 400px;
            text-align: center;
        }

        .prison-bars {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(90deg,
                    transparent,
                    transparent 30px,
                    rgba(255, 255, 255, 0.3) 30px,
                    rgba(255, 255, 255, 0.3) 35px);
            pointer-events: none;
        }

        .cat {
            font-size: 4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: catMove 2s infinite;
        }

        .cat:hover {
            transform: scale(1.2);
        }

        @keyframes catMove {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .toy {
            position: absolute;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: toyFloat 3s infinite;
        }

        .toy:hover {
            transform: scale(1.5);
        }

        @keyframes toyFloat {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }

        /* Dog level styles */
        .beach {
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
            position: relative;
        }

        .sand {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #F4A460;
            border-radius: 0 0 10px 10px;
        }

        .shell {
            position: absolute;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: shellShake 2s infinite;
        }

        .shell:hover {
            transform: scale(1.3);
        }

        @keyframes shellShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .speech-recognition {
            text-align: center;
            margin: 20px 0;
        }

        .mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .mic-btn.recording {
            background: linear-gradient(135deg, #4CAF50, #81C784);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .recognition-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .correct {
            background: #E8F5E8;
            color: #2E7D32;
            border: 2px solid #4CAF50;
        }

        .incorrect {
            background: #FFEBEE;
            color: #C62828;
            border: 2px solid #F44336;
        }

        .word-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .word {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }

        .pronunciation {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 15px;
        }

        .buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #dee2e6;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #81C784);
            color: white;
        }

        .celebration {
            text-align: center;
            color: #4CAF50;
            font-size: 1.5rem;
            font-weight: bold;
            animation: bounce 1s ease infinite alternate;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-10px);
            }
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .touch-item:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .letter-tile:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 600px) {
            .level-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 15px;
            }

            h1 {
                font-size: 2rem;
            }

            .word {
                font-size: 2.5rem;
            }

            .phase-buttons {
                flex-direction: column;
                align-items: center;
            }

            .touch-item {
                font-size: 3rem !important;
                padding: 15px !important;
            }

            .letter-tile {
                width: 40px !important;
                height: 40px !important;
                font-size: 1.2rem !important;
            }
        }
    </style>
</head>

<body>
    <div class="stars" id="stars"></div>

    <div class="container">
        <header>
            <button class="parent-mode-btn" id="parentModeBtn">ğŸ”’ å®¶é•¿è®¾ç½®</button>
            <h1>ğŸŒ¸ å¥¶å¥¶å­¦è‹±è¯­ ğŸŒ¸</h1>
            <p class="subtitle">Grandma Learns English</p>
        </header>

        <!-- é¦–æ¬¡è®¾ç½® - è¾“å…¥å„¿å­åå­— -->
        <div class="modal" id="initialSetupModal">
            <div class="modal-content">
                <div class="modal-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ é¦–æ¬¡è®¾ç½® - è¯·è¾“å…¥å„¿å­åå­—</div>
                <p style="color: #666; margin-bottom: 15px; text-align: center;">
                    è¿™æ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œéœ€è¦è®¾ç½®èº«ä»½éªŒè¯ä¿¡æ¯
                </p>
                <input type="text" id="sonNameInput" class="password-input" placeholder="è¯·è¾“å…¥å„¿å­çš„åå­—ï¼ˆç”¨äºèº«ä»½éªŒè¯ï¼‰" autofocus>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="confirmSonNameBtn" style="flex: 1;">ä¸‹ä¸€æ­¥</button>
                    <button class="btn btn-secondary" id="cancelInitialBtn" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®å¯†ç æ¨¡æ€æ¡† -->
        <div class="modal" id="setPasswordModal">
            <div class="modal-content">
                <div class="modal-title">ğŸ” è®¾ç½®å®¶é•¿å¯†ç </div>
                <p style="color: #666; margin-bottom: 15px; text-align: center;">
                    è¯·è®¾ç½®ä¸€ä¸ªå¯†ç ç”¨äºä¿æŠ¤å®¶é•¿è®¾ç½®
                </p>
                <input type="password" id="newPasswordInput" class="password-input" placeholder="è¯·è¾“å…¥æ–°å¯†ç " autofocus>
                <input type="password" id="confirmPasswordInput" class="password-input" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ç¡®è®¤"
                    style="margin-top: 10px;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="confirmSetPasswordBtn" style="flex: 1;">ç¡®è®¤è®¾ç½®</button>
                    <button class="btn btn-secondary" id="cancelSetPasswordBtn" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- å¯†ç è¾“å…¥æ¨¡æ€æ¡† -->
        <div class="modal" id="passwordModal">
            <div class="modal-content">
                <div class="modal-title">ğŸ”’ å®¶é•¿æ¨¡å¼ - è¯·è¾“å…¥å¯†ç </div>
                <input type="password" id="passwordInput" class="password-input" placeholder="è¯·è¾“å…¥å®¶é•¿å¯†ç " autofocus>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="confirmPasswordBtn" style="flex: 1;">ç¡®è®¤</button>
                    <button class="btn btn-secondary" id="cancelPasswordBtn" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
        <div class="modal" id="changePasswordModal">
            <div class="modal-content">
                <div class="modal-title">ğŸ”‘ ä¿®æ”¹å¯†ç </div>
                <p style="color: #666; margin-bottom: 20px; text-align: center;">
                    è¯·è¾“å…¥åŸå¯†ç å’Œæ–°å¯†ç 
                </p>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #333;">åŸå¯†ç ï¼š</label>
                    <input type="password" id="oldPasswordInput" class="password-input" placeholder="è¯·è¾“å…¥åŸå¯†ç " autofocus>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #333;">æ–°å¯†ç ï¼š</label>
                    <input type="password" id="newPasswordChangeInput" class="password-input" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #333;">ç¡®è®¤æ–°å¯†ç ï¼š</label>
                    <input type="password" id="confirmPasswordChangeInput" class="password-input"
                        placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="confirmChangePasswordBtn" style="flex: 1;">ç¡®è®¤ä¿®æ”¹</button>
                    <button class="btn btn-secondary" id="cancelChangePasswordBtn" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- éš¾åº¦è®¾ç½®æ¨¡æ€æ¡† -->
        <div class="modal" id="difficultyModal">
            <div class="modal-content">
                <div class="modal-title">ğŸ“š è®¾ç½®å‘éŸ³éš¾åº¦</div>
                <p style="color: #666; margin-bottom: 20px; text-align: center;">
                    è¯·é€‰æ‹©å‘éŸ³æ£€æµ‹çš„éš¾åº¦ç­‰çº§
                </p>

                <div class="difficulty-option hard" id="difficultyHard">
                    <div class="difficulty-title">ğŸ”´ æœ€éš¾ - æ ‡å‡†è‹±è¯­å‘éŸ³</div>
                    <div class="difficulty-desc">
                        å¿…é¡»ä½¿ç”¨æ ‡å‡†çš„è‹±è¯­å‘éŸ³ï¼Œä¸èƒ½æœ‰ä»»ä½•ä¸­æ–‡å£éŸ³ã€‚å‘éŸ³å¿…é¡»æ¸…æ™°ã€æ ‡å‡†ï¼Œå¤–å›½äººèƒ½å®Œå…¨å¬æ‡‚ã€‚
                    </div>
                </div>

                <div class="difficulty-option medium" id="difficultyMedium">
                    <div class="difficulty-title">ğŸŸ  ä¸­ç­‰ - å…è®¸æ··åˆå‘éŸ³</div>
                    <div class="difficulty-desc">
                        å¯ä»¥ä¸æ˜¯çº¯è‹±æ–‡å‘éŸ³ï¼Œä½†ä¸èƒ½å®Œå…¨æ˜¯ä¸­æ–‡ã€‚å…è®¸æœ‰ä¸€äº›ä¸­æ–‡å£éŸ³ï¼Œä½†å¿…é¡»èƒ½è¯†åˆ«å‡ºæ˜¯è‹±è¯­å•è¯ã€‚
                    </div>
                </div>

                <div class="difficulty-option easy" id="difficultyEasy">
                    <div class="difficulty-title">ğŸŸ¢ å®¹æ˜“ - å…è®¸å¿«é€Ÿä¸­æ–‡å‘éŸ³</div>
                    <div class="difficulty-desc">
                        å¯ä»¥è¯»å¾—éå¸¸å¿«ï¼Œå…è®¸ä¸­æ–‡å‘éŸ³æ–¹å¼ï¼Œä½†ä¸èƒ½å®Œå…¨éƒ½æ˜¯ä¸­æ–‡ã€‚åªè¦åŒ…å«è‹±è¯­å•è¯çš„åŸºæœ¬éŸ³ç´ å³å¯ã€‚
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" id="saveDifficultyBtn" style="flex: 1;">ä¿å­˜è®¾ç½®</button>
                    <button class="btn btn-secondary" id="cancelDifficultyBtn" style="flex: 1;">å–æ¶ˆ</button>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <button class="btn btn-secondary" id="changePasswordBtn" style="width: 100%;">
                        ğŸ”‘ ä¿®æ”¹å¯†ç 
                    </button>
                </div>

                <div id="currentDifficultyInfo"
                    style="margin-top: 15px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 5px; text-align: center; font-size: 0.9rem; color: #666;">
                </div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div
            style="text-align: center; margin-bottom: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;">
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; align-items: center;">
                <button class="btn btn-secondary" id="resetProgressBtn" style="font-size: 0.8rem; padding: 5px 10px;">
                    ğŸ”„ é‡ç½®è¿›åº¦
                </button>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label for="jumpToLevel" style="font-size: 0.8rem; color: white;">è·³è½¬åˆ°å…³å¡:</label>
                    <select id="jumpToLevel"
                        style="padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.8rem; background: white; cursor: pointer;">
                        <option value="">é€‰æ‹©å…³å¡...</option>
                    </select>
                    <button class="btn btn-secondary" id="jumpBtn" style="font-size: 0.8rem; padding: 5px 10px;">
                        ğŸš€ è·³è½¬
                    </button>
                </div>
            </div>
            <div id="debugInfo" style="font-size: 0.7rem; color: #666; margin-top: 10px; color: rgba(255,255,255,0.8);">
            </div>
        </div>

        <div class="level-grid" id="levelGrid">
            <!-- Levels will be dynamically generated -->
        </div>

        <div class="game-screen" id="gameScreen">
            <div class="story-section">
                <div class="story-title" id="storyTitle"></div>
                <div class="story-text" id="storyText"></div>
            </div>

            <div class="phase-section">
                <div class="phase-buttons">
                    <button class="phase-btn active" data-phase="recognize">ğŸ§ è®¤</button>
                    <button class="phase-btn" data-phase="learn">ğŸ“ å­¦</button>
                    <button class="phase-btn" data-phase="practice">ğŸ¤ è¯»</button>
                </div>
            </div>

            <div class="play-area" id="playArea">
                <!-- Dynamic content based on level and phase -->
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" id="backBtn">
                    â¬…ï¸ è¿”å›å…³å¡é€‰æ‹©
                </button>
            </div>

            <div class="celebration" id="celebration" style="display: none;">
                ğŸ‰ å¤ªæ£’äº†ï¼æ­å–œè¿‡å…³ï¼ ğŸ‰
            </div>
        </div>
    </div>

    <script>
        // Game data
        const levels = [
            {
                id: 1,
                word: 'cat',
                pronunciation: '/kÃ¦t/',
                storyTitle: 'ğŸ± å°çŒ«å’ªè¢«å›°ä½äº†ï¼',
                storyText: 'ä¸€åªå¯çˆ±çš„å°çŒ«å’ªè¢«å…³åœ¨ç‰¢æˆ¿é‡Œï¼Œéœ€è¦ä½ å¸®åŠ©å®ƒæ‰¾åˆ°é’¥åŒ™é€ƒå‡ºå»ã€‚ä½ éœ€è¦ç»™å°çŒ«å’ªæ‰¾åˆ°å®ƒçš„ç©å…·ï¼Œå®ƒä¼šå‘Šè¯‰ä½ "cat"çš„æ­£ç¡®å‘éŸ³ã€‚æ”¶é›†è¶³å¤Ÿçš„ç©å…·ï¼Œå°çŒ«å’ªå°±èƒ½æ‹¿åˆ°é’¥åŒ™é€ƒå‡ºå»äº†ï¼',
                gameType: 'find_toys',
                requiredInteractions: 5,
                toys: ['ğŸ¾', 'ğŸ§¶', 'ğŸ­', 'ğŸ¦´', 'ğŸ””']
            },
            {
                id: 2,
                word: 'dog',
                pronunciation: '/dÉ”Ëg/',
                storyTitle: 'ğŸ¶ å°ç‹—ç‹—è¢«æŠ“èµ°äº†ï¼',
                storyText: 'å°ç‹—ç‹—è¢«åäººæŠ“èµ°äº†ï¼Œè—åœ¨æµ·æ»©çš„è´å£³ä¸‹é¢ã€‚ä½ éœ€è¦æŒ–å¼€è´å£³æ•‘å‡ºå°ç‹—ç‹—ã€‚æ¯æŒ–å¼€ä¸€ä¸ªè´å£³ï¼Œå°ç‹—ç‹—éƒ½ä¼šå«ä¸€å£°"dog"ã€‚å¿«æ¥æ•‘æ•‘å°ç‹—ç‹—å§ï¼',
                gameType: 'dig_shells',
                requiredInteractions: 6
            },
            {
                id: 3,
                word: 'car',
                pronunciation: '/kÉ‘Ër/',
                storyTitle: 'ğŸš— å°æ±½è½¦è¿·è·¯äº†ï¼',
                storyText: 'ä¸€è¾†å°æ±½è½¦åœ¨åœè½¦åœºè¿·è·¯äº†ï¼Œéœ€è¦ä½ å¸®åŠ©å®ƒæ‰¾åˆ°å›å®¶çš„è·¯ã€‚æ‘¸æ‘¸å°æ±½è½¦ï¼Œå®ƒä¼šå‘å‡º"car"çš„å£°éŸ³ã€‚',
                gameType: 'touch_items',
                requiredInteractions: 4,
                items: ['ğŸš—', 'ğŸš™', 'ğŸšŒ']
            },
            {
                id: 4,
                word: 'but',
                pronunciation: '/bÊŒt/',
                storyTitle: 'ğŸ”„ è½¬æŠ˜è¯å¤§ä½œæˆ˜ï¼',
                storyText: '"But"æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„è½¬æŠ˜è¯ï¼Œæ„æ€æ˜¯"ä½†æ˜¯"ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥ç»ƒä¹ è¿™ä¸ªè¯çš„å‘éŸ³å§ï¼',
                gameType: 'choice_question',
                question: 'å“ªä¸ªè¯çš„æ„æ€æ˜¯"ä½†æ˜¯"ï¼Ÿ',
                options: ['but', 'and', 'or'],
                correctAnswer: 0
            },
            {
                id: 5,
                word: 'apple',
                pronunciation: '/ËˆÃ¦pÉ™l/',
                storyTitle: 'ğŸ çº¢è‹¹æœçœŸè¯±äººï¼',
                storyText: 'æ ‘ä¸ŠæŒ‚æ»¡äº†çº¢çº¢çš„è‹¹æœï¼Œé—»ç€å°±æƒ³åƒã€‚è®©æˆ‘ä»¬ä¸€èµ·å­¦è¯´"apple"å§ï¼',
                gameType: 'connect_letters',
                letters: ['a', 'p', 'p', 'l', 'e'],
                targetWord: 'apple'
            },
            {
                id: 6,
                word: 'banana',
                pronunciation: '/bÉ™ËˆnÃ¦nÉ™/',
                storyTitle: 'ğŸŒ é¦™è•‰çœŸå¥½åƒï¼',
                storyText: 'ä¸€æ ¹æ ¹é»„æ¾„æ¾„çš„é¦™è•‰æŒ‚åœ¨æ ‘ä¸Šï¼Œå¥¶å¥¶æœ€å–œæ¬¢åƒäº†ã€‚è®©æˆ‘ä»¬å­¦è¯´"banana"ï¼',
                gameType: 'choice_question',
                question: 'å“ªç§æ°´æœæ˜¯é»„è‰²çš„ï¼Ÿ',
                options: ['apple', 'banana', 'orange'],
                correctAnswer: 1
            },
            {
                id: 7,
                word: 'tap',
                pronunciation: '/tÃ¦p/',
                storyTitle: 'ğŸš° æ°´é¾™å¤´æ»´æ°´å•¦ï¼',
                storyText: 'æ°´é¾™å¤´åœ¨æ»´æ»´ç­”ç­”åœ°æ»´æ°´ï¼Œ"tap tap tap"ï¼Œè®©æˆ‘ä»¬å­¦è¯´"tap"å§ï¼',
                gameType: 'connect_letters',
                letters: ['t', 'a', 'p'],
                targetWord: 'tap'
            },
            {
                id: 8,
                word: 'pan',
                pronunciation: '/pÃ¦n/',
                storyTitle: 'ğŸ³ å¹³åº•é”…åšé¥­å•¦ï¼',
                storyText: 'å¥¶å¥¶æ­£åœ¨å¨æˆ¿ç”¨å¹³åº•é”…ç…è›‹ï¼Œ"pan pan pan"ï¼Œè®©æˆ‘ä»¬å­¦è¯´"pan"ï¼',
                gameType: 'choice_question',
                question: 'å¨å…·"pan"çš„ä¸­æ–‡æ„æ€æ˜¯ï¼Ÿ',
                options: ['é”…', 'é“²å­', 'ç¢—'],
                correctAnswer: 0
            },
            {
                id: 9,
                word: 'å•å¤æ•°S',
                pronunciation: 'cats, dogs, cars...',
                storyTitle: 'ğŸ”¢ å­¦ä¼šå•å¤æ•°å˜åŒ–ï¼',
                storyText: 'è‹±æ–‡åè¯æœ‰å•æ•°å’Œå¤æ•°ï¼Œå¤æ•°é€šå¸¸åœ¨è¯å°¾åŠ "s"ã€‚æ¯”å¦‚ï¼šcat â†’ catsï¼Œdog â†’ dogsã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥ç»ƒä¹ å§ï¼',
                gameType: 'plural_practice',
                examples: [
                    { singular: 'cat', plural: 'cats' },
                    { singular: 'dog', plural: 'dogs' },
                    { singular: 'car', plural: 'cars' },
                    { singular: 'apple', plural: 'apples' },
                    { singular: 'banana', plural: 'bananas' }
                ]
            },
            {
                id: 10,
                word: 'I like cat, but I don\'t like dog',
                pronunciation: '/aÉª laÉªk kÃ¦t, bÊŒt aÉª doÊŠnt laÉªk dÉ”Ëg/',
                storyTitle: 'ğŸ’¬ å­¦ä¼šç®€å•å¯¹è¯ï¼',
                storyText: 'å¥¶å¥¶è¯´ï¼š"æˆ‘å–œæ¬¢å°çŒ«å’ªï¼Œä½†æˆ‘ä¸å–œæ¬¢å°ç‹—ç‹—ã€‚"è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¥å­ï¼ŒåŒ…å«äº†"like"ã€"but"ã€"don\'t"ç­‰é‡è¦å•è¯ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥ç»ƒä¹ å§ï¼',
                gameType: 'sentence_practice',
                sentence: 'I like cat, but I don\'t like dog',
                words: ['I', 'like', 'cat', ',', 'but', 'I', 'don\'t', 'like', 'dog']
            },
            {
                id: 11,
                word: 'yes',
                pronunciation: '/jes/',
                storyTitle: 'âœ… æ˜¯çš„ï¼',
                storyText: '"Yes"æ˜¯"æ˜¯çš„"çš„æ„æ€ï¼Œè¡¨ç¤ºè‚¯å®šã€åŒæ„ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„å•è¯ï¼',
                gameType: 'choice_question',
                question: '"æ˜¯çš„"ç”¨è‹±è¯­æ€ä¹ˆè¯´ï¼Ÿ',
                options: ['yes', 'no', 'ok'],
                correctAnswer: 0
            },
            {
                id: 12,
                word: 'no',
                pronunciation: '/noÊŠ/',
                storyTitle: 'âŒ ä¸æ˜¯ï¼',
                storyText: '"No"æ˜¯"ä¸æ˜¯"çš„æ„æ€ï¼Œè¡¨ç¤ºå¦å®šã€æ‹’ç»ã€‚å’Œ"yes"ç›¸åï¼',
                gameType: 'choice_question',
                question: '"ä¸æ˜¯"ç”¨è‹±è¯­æ€ä¹ˆè¯´ï¼Ÿ',
                options: ['yes', 'no', 'not'],
                correctAnswer: 1
            },
            {
                id: 13,
                word: 'like',
                pronunciation: '/laÉªk/',
                storyTitle: 'â¤ï¸ å–œæ¬¢',
                storyText: '"Like"æ˜¯"å–œæ¬¢"çš„æ„æ€ï¼Œå¯ä»¥è¡¨è¾¾å¯¹æŸç‰©çš„å–œçˆ±ã€‚æ¯”å¦‚"I like cat"å°±æ˜¯"æˆ‘å–œæ¬¢çŒ«"ï¼',
                gameType: 'choice_question',
                question: '"å–œæ¬¢"ç”¨è‹±è¯­æ€ä¹ˆè¯´ï¼Ÿ',
                options: ['love', 'like', 'want'],
                correctAnswer: 1
            },
            {
                id: 14,
                word: 'red',
                pronunciation: '/red/',
                storyTitle: 'ğŸ”´ çº¢è‰²',
                storyText: '"Red"æ˜¯"çº¢è‰²"çš„æ„æ€ã€‚çº¢è‰²æ˜¯éå¸¸é²œè‰³çš„é¢œè‰²ï¼Œæ¯”å¦‚çº¢è‹¹æœå°±æ˜¯"red apple"ï¼',
                gameType: 'choice_question',
                question: '"çº¢è‰²"ç”¨è‹±è¯­æ€ä¹ˆè¯´ï¼Ÿ',
                options: ['blue', 'red', 'green'],
                correctAnswer: 1
            },
            {
                id: 15,
                word: 'cad',
                pronunciation: '/kÃ¦d/',
                storyTitle: 'ğŸš— å­¦ä¹ æ–°å•è¯',
                storyText: '"Cad"æ˜¯ä¸€ä¸ªè‹±è¯­å•è¯ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ å®ƒçš„å‘éŸ³å’Œç”¨æ³•å§ï¼',
                gameType: 'choice_question',
                question: 'è¯·é€‰æ‹©æ­£ç¡®çš„å•è¯"cad"',
                options: ['cat', 'cad', 'car'],
                correctAnswer: 1
            },
            {
                id: 16,
                word: 'å¤ä¹ æ€»ç»“',
                pronunciation: 'Review All Words',
                storyTitle: 'ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰å­¦ä¹ ï¼',
                storyText: 'ä½ å·²ç»å­¦ä¼šäº†å¾ˆå¤šå•è¯ï¼ç°åœ¨æ¥å¤ä¹ ä¸€ä¸‹ä½ å­¦è¿‡çš„å•è¯ï¼Œçœ‹çœ‹ä½ ä¼šå¤šå°‘ã€‚è¿™æ˜¯ä¸€å…³ç‰¹åˆ«çš„å¤ä¹ å…³ï¼šä¸€å…±300é“é¢˜ï¼Œå…ˆè¯»è‹±æ–‡ï¼Œå†é€‰ä¸­æ–‡ï¼Œå†æ‹¼å•è¯ï¼',
                gameType: 'summary_review',
                reviewQuestions: []
            }
        ];

        // Generate review questions for level 16ï¼ˆå¤ä¹ æ€»ç»“å…³ï¼Œä¸€å…±300é¢˜ï¼‰
        function generateReviewQuestions() {
            const allWords = [
                { word: 'cat', chinese: 'å°çŒ«å’ª', category: 'åŠ¨ç‰©' },
                { word: 'dog', chinese: 'å°ç‹—ç‹—', category: 'åŠ¨ç‰©' },
                { word: 'car', chinese: 'æ±½è½¦', category: 'äº¤é€šå·¥å…·' },
                { word: 'but', chinese: 'ä½†æ˜¯', category: 'è¿è¯' },
                { word: 'apple', chinese: 'è‹¹æœ', category: 'æ°´æœ' },
                { word: 'banana', chinese: 'é¦™è•‰', category: 'æ°´æœ' },
                { word: 'tap', chinese: 'æ°´é¾™å¤´', category: 'ç‰©å“' },
                { word: 'pan', chinese: 'å¹³åº•é”…', category: 'å¨å…·' },
                { word: 'milk', chinese: 'ç‰›å¥¶', category: 'é£Ÿç‰©' },
                { word: 'sun', chinese: 'å¤ªé˜³', category: 'è‡ªç„¶' },
                { word: 'moon', chinese: 'æœˆäº®', category: 'è‡ªç„¶' },
                { word: 'star', chinese: 'æ˜Ÿæ˜Ÿ', category: 'è‡ªç„¶' },
                { word: 'fish', chinese: 'é±¼', category: 'åŠ¨ç‰©' },
                { word: 'bird', chinese: 'å°é¸Ÿ', category: 'åŠ¨ç‰©' },
                { word: 'tree', chinese: 'æ ‘', category: 'è‡ªç„¶' },
                { word: 'flower', chinese: 'èŠ±', category: 'è‡ªç„¶' },
                { word: 'water', chinese: 'æ°´', category: 'è‡ªç„¶' },
                { word: 'fire', chinese: 'ç«', category: 'è‡ªç„¶' },
                { word: 'wind', chinese: 'é£', category: 'è‡ªç„¶' },
                { word: 'yes', chinese: 'æ˜¯çš„', category: 'å¸¸ç”¨è¯' },
                { word: 'no', chinese: 'ä¸æ˜¯', category: 'å¸¸ç”¨è¯' },
                { word: 'like', chinese: 'å–œæ¬¢', category: 'åŠ¨è¯' },
                { word: 'red', chinese: 'çº¢è‰²', category: 'é¢œè‰²' },
                { word: 'cad', chinese: 'cad', category: 'å•è¯' }
            ];

            // ä¸ºäº†æ›´ç¬¦åˆå¥¶å¥¶çš„å­¦ä¹ èŠ‚å¥ï¼Œæˆ‘ä»¬æŒ‰ã€Œè¯»è‹±æ–‡ â†’ é€‰ä¸­æ–‡ â†’ æ‹¼å•è¯ã€çš„é¡ºåºæ¥ç”Ÿæˆé¢˜ç›®ï¼Œ
            // æ¯ä¸€éƒ¨åˆ†å„100é¢˜ï¼Œæ€»å…±300é¢˜ã€‚

            const pronunciationQuestions = [];
            const choiceQuestions = [];
            const spellingQuestions = [];

            // â‘  å…ˆå¬ä¸­æ–‡ï¼Œè¯»è‹±æ–‡ï¼ˆ100 é¢˜ï¼‰
            for (let i = 0; i < 100; i++) {
                const wordIndex = Math.floor(Math.random() * allWords.length);
                const word = allWords[wordIndex];

                pronunciationQuestions.push({
                    type: 'pronunciation',
                    question: 'è¯·çœ‹ä¸‹é¢çš„ä¸­æ–‡ï¼ŒæŠŠå¯¹åº”çš„è‹±æ–‡å•è¯è¯»å‡ºæ¥ï¼š',
                    word: word.word,        // ç”¨æ¥åšè¯­éŸ³è¯†åˆ«çš„æ­£ç¡®è‹±æ–‡
                    chinese: word.chinese,  // æç¤ºç”¨ä¸­æ–‡
                    answer: word.word
                });
            }

            // â‘¡ è‹±æ–‡é€‰æ‹©ä¸­æ–‡æ„æ€ï¼ˆ100 é¢˜ï¼‰
            for (let i = 0; i < 100; i++) {
                const wordIndex = Math.floor(Math.random() * allWords.length);
                const word = allWords[wordIndex];

                // ä»å…¶ä»–è¯é‡ŒæŒ‘ä¸¤ä¸ªé”™è¯¯ä¸­æ–‡æ„æ€
                const otherWords = allWords.filter(w => w.word !== word.word);
                const wrongOptions = [];
                while (wrongOptions.length < 2 && otherWords.length > 0) {
                    const wrongIndex = Math.floor(Math.random() * otherWords.length);
                    const wrong = otherWords.splice(wrongIndex, 1)[0];
                    if (wrong && wrong.chinese !== word.chinese) {
                        wrongOptions.push(wrong.chinese);
                    }
                }

                const options = [word.chinese, ...wrongOptions];
                // è½»å¾®æ‰“ä¹±ä¸€ä¸‹é¡ºåº
                const shuffledOptions = options.sort(() => Math.random() - 0.5);
                const correctIndex = shuffledOptions.indexOf(word.chinese);

                choiceQuestions.push({
                    type: 'choice',
                    question: `å•è¯ "${word.word}" çš„ä¸­æ–‡æ„æ€æ˜¯ä»€ä¹ˆï¼Ÿ`,
                    options: shuffledOptions,
                    answer: correctIndex,
                    word: word.word,
                    chinese: word.chinese
                });
            }

            // â‘¢ æ ¹æ®ä¸­æ–‡æ‹¼å†™è‹±æ–‡å•è¯ï¼ˆ100 é¢˜ï¼‰
            for (let i = 0; i < 100; i++) {
                const wordIndex = Math.floor(Math.random() * allWords.length);
                const word = allWords[wordIndex];

                // å…ˆæŠŠç©ºæ ¼å»æ‰ï¼Œå†æ‰“ä¹±å­—æ¯é¡ºåºï¼ˆåé¢å¯ä»¥ç”¨æ¥åšè¿çº¿ç©æ³•ï¼‰
                const letters = word.word.replace(/\s+/g, '').split('');
                const shuffledLetters = letters.sort(() => Math.random() - 0.5);

                spellingQuestions.push({
                    type: 'spelling',
                    question: `è¯·æ‹¼å†™"${word.chinese}"å¯¹åº”çš„è‹±æ–‡å•è¯`,
                    chinese: word.chinese,
                    answer: word.word,
                    letters: shuffledLetters
                });
            }

            // æŒ‰é¡ºåºè¿”å›ï¼š100 é¢˜è¯»è‹±æ–‡ â†’ 100 é¢˜é€‰ä¸­æ–‡ â†’ 100 é¢˜æ‹¼å†™
            return [...pronunciationQuestions, ...choiceQuestions, ...spellingQuestions];
        }

        // Initialize review questions for level 11
        const reviewLevel = levels.find(l => l.id === 16);
        if (reviewLevel) {
            reviewLevel.reviewQuestions = generateReviewQuestions();
        }

        // Game state
        let currentLevel = 0;
        let currentPhase = 'recognize'; // recognize, learn, practice
        let completedLevels = JSON.parse(localStorage.getItem('grandmaEnglishProgress') || '[]');
        let interactionCount = 0;
        let recognition = null;

        // Parent mode state
        // å¯†ç å’Œå„¿å­åå­—å­˜å‚¨åœ¨ localStorage ä¸­
        let parentPasswordHash = localStorage.getItem('parentPasswordHash');
        let sonName = localStorage.getItem('sonName') || ''; // å„¿å­çš„åå­—ï¼Œç”¨äºèº«ä»½éªŒè¯
        let phoneNumber = localStorage.getItem('phoneNumber') || ''; // æ‰‹æœºå·ç 
        let isInitialSetupDone = localStorage.getItem('initialSetupDone') === 'true';
        let smsVerificationCode = ''; // å½“å‰éªŒè¯ç 
        let smsCodeExpiry = 0; // éªŒè¯ç è¿‡æœŸæ—¶é—´

        let currentDifficulty = localStorage.getItem('pronunciationDifficulty') || 'hard'; // hard, medium, easy

        // å¤šéŸ³å­—æ•°æ®åº“
        const polyphoneMap = {
            'é•¿': ['é•¿', 'å¸¸', 'åœº', 'å°'],
            'ä¸­': ['ä¸­', 'é‡', 'é’Ÿ', 'å¿ '],
            'è¡Œ': ['è¡Œ', 'å½¢', 'å‹', 'æ˜Ÿ'],
            'å‘': ['å‘', 'æ³•', 'ç½š'],
            'ä¼š': ['ä¼š', 'å›', 'ç°', 'æŒ¥'],
            'äº†': ['äº†', 'ä¹', 'å‹’'],
            'ç€': ['ç€', 'æ‹›', 'æ‰¾'],
            'åœ°': ['åœ°', 'çš„', 'ç¬¬'],
            'å¾—': ['å¾—', 'çš„', 'å¾·'],
            'ä¸º': ['ä¸º', 'å›´', 'ä¼Ÿ'],
            'é‡': ['é‡', 'ä¸­', 'ç§'],
            'ç›¸': ['ç›¸', 'æƒ³', 'å‘'],
            'åº”': ['åº”', 'è‹±', 'å½±'],
            'æ­£': ['æ­£', 'äº‰', 'å¾'],
            'è¿˜': ['è¿˜', 'æ¢', 'ç¯'],
            'æ²¡': ['æ²¡', 'æ¯', 'æ¢…'],
            'å’Œ': ['å’Œ', 'ä½•', 'åˆ'],
            'äº†': ['äº†', 'ä¹'],
            'éƒ½': ['éƒ½', 'æ–—', 'è±†'],
            'çœ‹': ['çœ‹', 'ç ', 'çœ‹']
        };

        // Simple hash function (for basic obfuscation, not real security)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }

        // ç”Ÿæˆ6ä½æ•°å­—éªŒè¯ç 
        function generateSmsCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Clean up invalid completed levels (in case of old data)
        const validLevelIds = levels.map(level => level.id);
        completedLevels = completedLevels.filter(id => validLevelIds.includes(id));

        // DOM elements
        const levelGrid = document.getElementById('levelGrid');
        const gameScreen = document.getElementById('gameScreen');
        const progressFill = document.getElementById('progressFill');
        const storyTitle = document.getElementById('storyTitle');
        const storyText = document.getElementById('storyText');
        const playArea = document.getElementById('playArea');
        const backBtn = document.getElementById('backBtn');
        const celebration = document.getElementById('celebration');

        // Initialize stars background
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 2 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 2 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Create level cards
        function createLevelCards() {
            levelGrid.innerHTML = '';
            levels.forEach((level, index) => {
                const card = document.createElement('div');
                card.className = 'level-card';

                // Debug logging
                console.log(`Level ${level.id} (${level.word}): completed=${completedLevels.includes(level.id)}, index=${index}, prevCompleted=${index > 0 ? completedLevels.includes(levels[index - 1].id) : 'N/A'}`);

                if (completedLevels.includes(level.id)) {
                    card.classList.add('completed');
                    card.onclick = () => startLevel(index);
                } else if (index > 0 && !completedLevels.includes(levels[index - 1].id)) {
                    card.classList.add('locked');
                    card.onclick = null;
                    console.log(`Level ${level.id} is LOCKED`);
                } else {
                    card.onclick = () => {
                        console.log(`Starting level ${level.id}`);
                        startLevel(index);
                    };
                }

                card.innerHTML = `
                    <div class="level-number">${level.id}</div>
                    <div class="level-content">${level.word}</div>
                `;
                levelGrid.appendChild(card);
            });
        }

        // Update progress bar
        function updateProgress() {
            const progress = (completedLevels.length / levels.length) * 100;
            progressFill.style.width = progress + '%';
        }

        // Update debug info
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent = `å·²å®Œæˆ: ${completedLevels.length}/${levels.length} å…³å¡ | è¿›åº¦: ${completedLevels.join(', ') || 'æ— '}`;
        }

        // Start a level
        function startLevel(levelIndex) {
            currentLevel = levelIndex;
            currentPhase = 'recognize';
            interactionCount = 0;

            const level = levels[levelIndex];
            storyTitle.textContent = level.storyTitle;
            storyText.textContent = level.storyText;

            // Hide level grid, show game screen
            document.querySelector('.level-grid').style.display = 'none';
            gameScreen.classList.add('show');
            celebration.style.display = 'none';

            updatePhaseButtons();
            renderPlayArea();
        }

        // Update phase buttons
        function updatePhaseButtons() {
            document.querySelectorAll('.phase-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.phase === currentPhase) {
                    btn.classList.add('active');
                }
            });
        }

        // Render play area based on level and phase
        function renderPlayArea() {
            const level = levels[currentLevel];
            playArea.innerHTML = '';

            if (currentPhase === 'recognize') {
                renderRecognizePhase(level);
            } else if (currentPhase === 'learn') {
                renderLearnPhase(level);
            } else if (currentPhase === 'practice') {
                renderPracticePhase(level);
            }
        }

        // Recognize phase - listen to correct pronunciation
        function renderRecognizePhase(level) {
            playArea.innerHTML = `
                <div class="word-display">
                    <div class="word">${level.word}</div>
                    <div class="pronunciation">${level.pronunciation}</div>
                    <p style="color: #666; margin-top: 15px;">ç‚¹å‡»å–‡å­æ”¶å¬æ­£ç¡®å‘éŸ³</p>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-primary" id="listenBtn" style="font-size: 2rem; padding: 20px 40px;">
                        ğŸ”Š
                    </button>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" id="nextPhaseBtn">æˆ‘å¬æ‡‚äº†ï¼Œä¸‹ä¸€æ­¥</button>
                </div>
            `;

            document.getElementById('listenBtn').addEventListener('click', () => playAudio(level.word));
            document.getElementById('nextPhaseBtn').addEventListener('click', () => changePhase('learn'));
        }

        // Learn phase - interactive learning
        function renderLearnPhase(level) {
            switch (level.gameType) {
                case 'find_toys':
                    renderFindToysLevel(level);
                    break;
                case 'dig_shells':
                    renderDigShellsLevel(level);
                    break;
                case 'touch_items':
                    renderTouchItemsLevel(level);
                    break;
                case 'choice_question':
                    renderChoiceQuestionLevel(level);
                    break;
                case 'connect_letters':
                    renderConnectLettersLevel(level);
                    break;
                case 'plural_practice':
                    renderPluralPracticeLevel(level);
                    break;
                case 'sentence_practice':
                    renderSentencePracticeLevel(level);
                    break;
                case 'summary_review':
                    renderSummaryReviewLevel(level);
                    break;
                default:
                    renderGenericLearnLevel(level);
            }
        }

        // Find toys level (çŒ«å’ªæ‰¾ç©å…·)
        function renderFindToysLevel(level) {
            playArea.innerHTML = `
                <div class="cat-prison">
                    <div class="prison-bars"></div>
                    <div class="cat" id="cat">ğŸ±</div>
                    <p style="color: white; margin-top: 10px;">ç»™å°çŒ«å’ªæ‰¾åˆ°å®ƒçš„ç©å…·å§ï¼</p>
                    <p style="color: yellow; font-size: 0.9rem;">æ”¶é›†${level.requiredInteractions}ä¸ªç©å…·å°±èƒ½æ‹¿åˆ°é’¥åŒ™ï¼</p>
                    <div style="position: relative; height: 200px;">
                        ${level.toys.map((toy, index) =>
                `<div class="toy" id="toy${index}" style="top: ${50 + index * 20}px; left: ${50 + index * 30}px;">${toy}</div>`
            ).join('')}
                    </div>
                    <div style="background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: white;">æ”¶é›†è¿›åº¦: <span id="toyProgress">0</span>/${level.requiredInteractions}</p>
                    </div>
                </div>
            `;

            // Add event listeners for toys
            level.toys.forEach((toy, index) => {
                const toyId = `toy${index}`;
                document.getElementById(toyId).addEventListener('click', () => {
                    playAudio(level.word);
                    interactionCount++;
                    document.getElementById('toyProgress').textContent = interactionCount;

                    // Hide the toy after interaction
                    document.getElementById(toyId).style.display = 'none';

                    if (interactionCount >= level.requiredInteractions) {
                        setTimeout(() => {
                            playArea.innerHTML = `
                                <div style="text-align: center; padding: 50px;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ±ğŸ”‘</div>
                                    <h3 style="color: #4CAF50; margin-bottom: 20px;">å¤ªæ£’äº†ï¼å°çŒ«å’ªæ‹¿åˆ°é’¥åŒ™äº†ï¼</h3>
                                    <button class="btn btn-success" onclick="changePhase('practice')">å‡†å¤‡å‘éŸ³æµ‹è¯•</button>
                                </div>
                            `;
                        }, 1000);
                    }
                });
            });

            // Cat interaction
            document.getElementById('cat').addEventListener('click', () => {
                playAudio(level.word);
            });
        }

        // Dig shells level (æŒ–è´å£³æ•‘ç‹—ç‹—)
        function renderDigShellsLevel(level) {
            playArea.innerHTML = `
                <div class="beach">
                    <h3 style="text-align: center; color: #333;">æµ·æ»©å¯»å® - æ•‘å‡ºå°ç‹—ç‹—ï¼</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 20px;">ç‚¹å‡»è´å£³æŒ–å¼€å®ƒä»¬ï¼Œæ•‘å‡ºè—åœ¨é‡Œé¢çš„å°ç‹—ç‹—ï¼</p>
                    <div style="position: relative; height: 300px;">
                        ${Array.from({ length: level.requiredInteractions }, (_, i) =>
                `<div class="shell" id="shell${i}" style="top: ${50 + i * 30}px; left: ${50 + (i % 3) * 100}px;">ğŸš</div>`
            ).join('')}
                    </div>
                    <div class="sand"></div>
                    <div style="background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="text-align: center; color: #333;">æ•‘å‡ºå°ç‹—ç‹—: <span id="shellProgress">0</span>/${level.requiredInteractions}</p>
                    </div>
                </div>
            `;

            // Add event listeners for shells
            for (let i = 0; i < level.requiredInteractions; i++) {
                const shellId = `shell${i}`;
                document.getElementById(shellId).addEventListener('click', () => {
                    playAudio(level.word);
                    interactionCount++;
                    document.getElementById('shellProgress').textContent = interactionCount;

                    // Hide the shell after interaction
                    document.getElementById(shellId).style.display = 'none';

                    if (interactionCount >= level.requiredInteractions) {
                        setTimeout(() => {
                            playArea.innerHTML = `
                                <div style="text-align: center; padding: 50px;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ¶âœ¨</div>
                                    <h3 style="color: #4CAF50; margin-bottom: 20px;">å¤ªæ£’äº†ï¼å°ç‹—ç‹—è¢«æ•‘å‡ºæ¥äº†ï¼</h3>
                                    <button class="btn btn-success" onclick="changePhase('practice')">å‡†å¤‡å‘éŸ³æµ‹è¯•</button>
                                </div>
                            `;
                        }, 1000);
                    }
                });
            }
        }

        // Touch items level (è§¦æ‘¸ç‰©å“)
        function renderTouchItemsLevel(level) {
            playArea.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">è§¦æ‘¸è¿™äº›ç‰©å“å§ï¼</h3>
                    <p style="color: #666; margin-bottom: 30px;">æ¯è§¦æ‘¸ä¸€ä¸ªç‰©å“ï¼Œå°±ä¼šå¬åˆ°"${level.word}"çš„å‘éŸ³</p>
                    <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 30px;">
                        ${level.items.map((item, index) =>
                `<div class="touch-item" id="item${index}" style="font-size: 4rem; cursor: pointer; transition: all 0.3s ease; padding: 20px;">${item}</div>`
            ).join('')}
                    </div>
                    <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; display: inline-block;">
                        <p style="color: #333; margin: 0;">è§¦æ‘¸è¿›åº¦: <span id="touchProgress">0</span>/${level.requiredInteractions}</p>
                    </div>
                </div>
            `;

            // Add event listeners for items
            level.items.forEach((item, index) => {
                const itemId = `item${index}`;
                document.getElementById(itemId).addEventListener('click', () => {
                    playAudio(level.word);
                    interactionCount++;
                    document.getElementById('touchProgress').textContent = interactionCount;

                    // Add animation effect
                    document.getElementById(itemId).style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        document.getElementById(itemId).style.transform = 'scale(1)';
                    }, 300);

                    if (interactionCount >= level.requiredInteractions) {
                        setTimeout(() => {
                            playArea.innerHTML = `
                                <div style="text-align: center; padding: 50px;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">${level.items[0]}âœ¨</div>
                                    <h3 style="color: #4CAF50; margin-bottom: 20px;">å¤ªæ£’äº†ï¼ä½ å­¦ä¼šäº†"${level.word}"ï¼</h3>
                                    <button class="btn btn-success" onclick="changePhase('practice')">å‡†å¤‡å‘éŸ³æµ‹è¯•</button>
                                </div>
                            `;
                        }, 1000);
                    }
                });
            });
        }

        // Choice question level (é€‰æ‹©é¢˜)
        function renderChoiceQuestionLevel(level) {
            playArea.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div style="margin-bottom: 30px;">
                        <button class="btn btn-primary" id="playQuestionAudio" style="margin-bottom: 20px;">
                            ğŸ”Š æ’­æ”¾é—®é¢˜éŸ³é¢‘
                        </button>
                        <p style="font-size: 1.2rem; color: #333; margin: 20px 0;">${level.question}</p>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                        ${level.options.map((option, index) =>
                `<button class="choice-btn" data-index="${index}" style="padding: 15px 30px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s ease; min-width: 200px;">${option}</button>`
            ).join('')}
                    </div>
                </div>
            `;

            document.getElementById('playQuestionAudio').addEventListener('click', () => {
                playAudio(level.word);
            });

            // Add event listeners for choice buttons
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const selectedIndex = parseInt(btn.dataset.index);
                    const isCorrect = selectedIndex === level.correctAnswer;

                    if (isCorrect) {
                        btn.style.background = '#4CAF50';
                        btn.style.color = 'white';
                        btn.style.borderColor = '#4CAF50';
                        setTimeout(() => {
                            playArea.innerHTML = `
                                <div style="text-align: center; padding: 50px;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">âœ…âœ¨</div>
                                    <h3 style="color: #4CAF50; margin-bottom: 20px;">å›ç­”æ­£ç¡®ï¼å¤ªæ£’äº†ï¼</h3>
                                    <button class="btn btn-success" onclick="changePhase('practice')">å‡†å¤‡å‘éŸ³æµ‹è¯•</button>
                                </div>
                            `;
                        }, 1500);
                    } else {
                        btn.style.background = '#F44336';
                        btn.style.color = 'white';
                        btn.style.borderColor = '#F44336';
                        setTimeout(() => {
                            alert('ä¸å¯¹å“¦ï¼Œå†è¯•è¯•çœ‹ï¼');
                            btn.style.background = 'white';
                            btn.style.color = 'black';
                            btn.style.borderColor = '#ddd';
                        }, 1000);
                    }
                });
            });
        }

        // Connect letters level (è¿çº¿å­—æ¯)
        function renderConnectLettersLevel(level) {
            let connectedLetters = [];
            let availableLetters = [...level.letters];

            playArea.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">æŠŠå­—æ¯è¿èµ·æ¥ç»„æˆå•è¯ï¼</h3>
                    <p style="color: #666; margin-bottom: 20px;">ç›®æ ‡å•è¯: <strong style="font-size: 1.5rem; color: #667eea;">${level.targetWord}</strong></p>

                    <div style="background: #E8F5E8; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="color: #2E7D32; margin-bottom: 10px;">ğŸ“ æ‹¼è¯»ç¤ºèŒƒ</h4>
                        <p style="color: #2E7D32; margin: 0; font-size: 1.1rem;">
                            è¯·è¯»æˆ: <strong>"${level.letters.join('-')}"</strong><br>
                            ä¾‹å¦‚æ…¢æ…¢åœ°è¯´: "${level.letters.join('...')}..."
                        </p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <button class="btn btn-secondary" id="playWordAudio">ğŸ”Š æ’­æ”¾å•è¯å‘éŸ³</button>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
                        ${availableLetters.map((letter, index) =>
                `<div class="letter-tile" data-letter="${letter}" data-index="${index}" style="width: 50px; height: 50px; border: 2px solid #667eea; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; background: white; cursor: pointer; transition: all 0.3s ease;">${letter}</div>`
            ).join('')}
                    </div>

                    <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; min-height: 50px;">
                        <p style="color: #333; margin: 0;">å·²è¿æ¥: <span id="connectedWord" style="font-size: 1.2rem; font-weight: bold;"></span></p>
                    </div>
                </div>
            `;

            document.getElementById('playWordAudio').addEventListener('click', () => {
                playAudio(level.targetWord);
            });

            // Add event listeners for letter tiles
            document.querySelectorAll('.letter-tile').forEach(tile => {
                tile.addEventListener('click', () => {
                    const letter = tile.dataset.letter;
                    const index = parseInt(tile.dataset.index);

                    // Add letter to connected word
                    connectedLetters.push(letter);
                    updateConnectedWord();

                    // Remove tile
                    tile.style.display = 'none';

                    // Check if word is complete
                    if (connectedLetters.join('') === level.targetWord) {
                        setTimeout(() => {
                            playArea.innerHTML = `
                                <div style="text-align: center; padding: 50px;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ”¤âœ¨</div>
                                    <h3 style="color: #4CAF50; margin-bottom: 20px;">å¤ªæ£’äº†ï¼ä½ æˆåŠŸç»„æˆäº†"${level.targetWord}"ï¼</h3>
                                    <button class="btn btn-success" onclick="changePhase('practice')">å‡†å¤‡å‘éŸ³æµ‹è¯•</button>
                                </div>
                            `;
                        }, 1000);
                    }
                });
            });

            function updateConnectedWord() {
                document.getElementById('connectedWord').textContent = connectedLetters.join('');
            }
        }

        // Plural practice level (å•å¤æ•°ç»ƒä¹ )
        function renderPluralPracticeLevel(level) {
            let currentExampleIndex = 0;
            let correctCount = 0;

            function showNextExample() {
                if (currentExampleIndex >= level.examples.length) {
                    // All examples completed
                    playArea.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ”¢âœ¨</div>
                            <h3 style="color: #4CAF50; margin-bottom: 20px;">å¤ªæ£’äº†ï¼ä½ å­¦ä¼šäº†å•å¤æ•°å˜åŒ–ï¼</h3>
                            <p style="font-size: 1.1rem; margin-bottom: 30px;">æ­£ç¡®ç‡: ${correctCount}/${level.examples.length} (${Math.round(correctCount / level.examples.length * 100)}%)</p>
                            <button class="btn btn-success" onclick="changePhase('practice')">å‡†å¤‡å‘éŸ³æµ‹è¯•</button>
                        </div>
                    `;
                    return;
                }

                const example = level.examples[currentExampleIndex];
                playArea.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h3 style="margin-bottom: 20px; color: #667eea;">å•å¤æ•°ç»ƒä¹  ${currentExampleIndex + 1}/${level.examples.length}</h3>

                        <div style="margin-bottom: 30px;">
                            <button class="btn btn-primary" id="playPluralAudio">ğŸ”Š æ’­æ”¾å‘éŸ³</button>
                        </div>

                        <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                            <p style="font-size: 1.2rem; color: #333; margin-bottom: 15px;">
                                å•æ•°: <strong style="font-size: 1.5rem; color: #667eea;">${example.singular}</strong>
                            </p>
                            <p style="font-size: 1.2rem; color: #666;">è¯·å†™å‡ºå¤æ•°å½¢å¼:</p>
                            <input type="text" id="pluralInput" style="padding: 10px; font-size: 1.2rem; border: 2px solid #667eea; border-radius: 10px; width: 200px; text-align: center;" placeholder="è¾“å…¥å¤æ•°å½¢å¼">
                        </div>

                        <button class="btn btn-success" id="checkPluralBtn">æ£€æŸ¥ç­”æ¡ˆ</button>

                        <div style="margin-top: 30px; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px;">
                            <p style="color: #333; margin: 0;">æ­£ç¡®æ•°é‡: <span id="pluralScore">${correctCount}</span>/${level.examples.length}</p>
                        </div>
                    </div>
                `;

                document.getElementById('playPluralAudio').addEventListener('click', () => {
                    playAudio(example.plural);
                });

                document.getElementById('checkPluralBtn').addEventListener('click', () => {
                    const input = document.getElementById('pluralInput').value.trim().toLowerCase();
                    const correct = input === example.plural.toLowerCase();

                    if (correct) {
                        correctCount++;
                        document.getElementById('pluralScore').textContent = correctCount;
                        alert(`âœ… æ­£ç¡®ï¼${example.singular} â†’ ${example.plural}`);
                        currentExampleIndex++;
                        setTimeout(showNextExample, 1000);
                    } else {
                        alert(`âŒ ä¸å¯¹å“¦ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯: ${example.plural}\nå†è¯•è¯•çœ‹ï¼`);
                        document.getElementById('pluralInput').value = '';
                        document.getElementById('pluralInput').focus();
                    }
                });

                // Auto-focus input
                setTimeout(() => {
                    document.getElementById('pluralInput').focus();
                }, 100);
            }

            showNextExample();
        }

        // Sentence practice level (å¥å­ç»ƒä¹ )
        function renderSentencePracticeLevel(level) {
            playArea.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">å¥å­ç»ƒä¹ </h3>

                    <div style="margin-bottom: 30px;">
                        <button class="btn btn-primary" id="playSentenceAudio">ğŸ”Š æ’­æ”¾å®Œæ•´å¥å­</button>
                    </div>

                    <div style="background: rgba(255,255,255,0.9); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                        <p style="font-size: 1.3rem; color: #333; margin-bottom: 20px; line-height: 1.6;">
                            <strong>å®Œæ•´å¥å­ï¼š</strong><br>
                            <span style="font-size: 1.5rem; color: #667eea;">"${level.sentence}"</span>
                        </p>

                        <p style="color: #666; margin-bottom: 15px;">å¥å­åŒ…å«ä»¥ä¸‹å•è¯ï¼š</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px;">
                            ${level.words.map(word => `<span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold;">${word}</span>`).join('')}
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="changePhase('practice')">å‡†å¤‡å‘éŸ³æµ‹è¯•</button>
                </div>
            `;

            document.getElementById('playSentenceAudio').addEventListener('click', () => {
                playAudio(level.sentence);
            });
        }

        // Summary review level (æ€»ç»“å¤ä¹  - 20ä¸ªé¢˜ç›®)
        function renderSummaryReviewLevel(level) {
            let currentQuestionIndex = 0;
            let correctCount = 0;

            function showNextQuestion() {
                if (currentQuestionIndex >= level.reviewQuestions.length) {
                    // All questions completed
                    const percentage = Math.round(correctCount / level.reviewQuestions.length * 100);
                    let gradeMessage = '';

                    if (percentage >= 90) {
                        gradeMessage = 'ğŸ‰ ä¼˜ç§€ï¼ä½ æ˜¯è‹±è¯­å­¦ä¹ å°è¾¾äººï¼';
                    } else if (percentage >= 80) {
                        gradeMessage = 'ğŸ‘ å¾ˆå¥½ï¼ç»§ç»­åŠ æ²¹ï¼';
                    } else if (percentage >= 70) {
                        gradeMessage = 'ğŸ™‚ ä¸é”™ï¼è¿˜éœ€è¦å¤šç»ƒä¹ ï¼';
                    } else {
                        gradeMessage = 'ğŸ’ª åŠ æ²¹ï¼å¤šå¤ä¹ å°±ä¼šè¿›æ­¥ï¼';
                    }

                    playArea.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ‰ğŸ†</div>
                            <h2 style="color: #4CAF50; margin-bottom: 10px;">å¤ä¹ å®Œæˆï¼</h2>
                            <p style="font-size: 1.8rem; font-weight: bold; color: #667eea; margin-bottom: 20px;">
                                å¾—åˆ†: ${correctCount}/${level.reviewQuestions.length} (${percentage}%)
                            </p>
                            <p style="font-size: 1.2rem; margin-bottom: 30px;">${gradeMessage}</p>

                            <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                                <h3 style="margin-bottom: 15px;">ä½ å·²ç»å­¦ä¼šçš„å•è¯ï¼š</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">cat</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">dog</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">car</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">but</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">apple</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">banana</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">tap</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">pan</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">milk</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">sun</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">moon</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">star</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">fish</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">bird</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">tree</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">flower</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">water</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">fire</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">wind</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">yes</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">no</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">like</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">red</span>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">cad</span>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="backToMenu()">è¿”å›ä¸»èœå•</button>
                        </div>
                    `;
                    return;
                }

                const question = level.reviewQuestions[currentQuestionIndex];
                let questionHTML = '';

                if (question.type === 'choice') {
                    questionHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h3 style="margin-bottom: 20px; color: #667eea;">é€‰æ‹©é¢˜ ${currentQuestionIndex + 1}/${level.reviewQuestions.length}</h3>
                            <p style="font-size: 1.2rem; color: #333; margin-bottom: 30px;">${question.question}</p>

                            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center; margin-bottom: 30px;">
                                ${question.options.map((option, index) =>
                        `<button class="choice-btn" data-index="${index}" style="padding: 12px 25px; font-size: 1rem; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s ease; min-width: 200px;">${option}</button>`
                    ).join('')}
                            </div>
                        </div>
                    `;
                } else if (question.type === 'pronunciation') {
                    questionHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h3 style="margin-bottom: 20px; color: #667eea;">è¯»å•è¯ ${currentQuestionIndex + 1}/${level.reviewQuestions.length}</h3>
                            <p style="font-size: 1.2rem; color: #333; margin-bottom: 20px;">${question.question}</p>
                            <p style="font-size: 1.1rem; color: #555; margin-bottom: 10px;">è¯·è¯»å‡ºä¸‹é¢è¿™ä¸ªä¸­æ–‡å¯¹åº”çš„è‹±æ–‡å•è¯ï¼š</p>
                            <div style="font-size: 2rem; font-weight: bold; color: #333; margin: 30px 0;">
                                ${question.chinese}
                            </div>

                            <button class="mic-btn" id="reviewPronunciationMicBtn" style="width: 80px; height: 80px; font-size: 2rem; margin-bottom: 20px;">ğŸ¤</button>
                            <p style="font-size: 0.9rem; color: #999; margin-bottom: 20px;">
                                ç‚¹å‡»éº¦å…‹é£ï¼Œè¯»å‡ºè¿™ä¸ªå•è¯
                            </p>

                            <div style="margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="playAudio('${question.word}')">ğŸ”Š å¬æ ‡å‡†å‘éŸ³</button>
                            </div>

                            <div id="reviewPronunciationResult" style="margin-top: 20px;"></div>
                        </div>
                    `;
                } else if (question.type === 'spelling') {
                    questionHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h3 style="margin-bottom: 20px; color: #667eea;">æ‹¼å†™é¢˜ ${currentQuestionIndex + 1}/${level.reviewQuestions.length}</h3>
                            <p style="font-size: 1.2rem; color: #333; margin-bottom: 20px;">${question.question}</p>
                            <p style="color: #666; margin-bottom: 30px; font-size: 1.1rem;">è¯·åœ¨é”®ç›˜ä¸Šæ‰“å‡ºè¿™ä¸ªå•è¯</p>

                            <input type="text" id="spellingInput" style="padding: 15px; font-size: 1.3rem; border: 2px solid #667eea; border-radius: 10px; width: 300px; text-align: center; letter-spacing: 2px;" placeholder="ç”¨é”®ç›˜è¾“å…¥å•è¯" autofocus>
                            <br><br>
                            <button class="btn btn-success" id="checkSpellingBtn" style="padding: 12px 30px; font-size: 1.1rem;">æ£€æŸ¥ç­”æ¡ˆ</button>
                        </div>
                    `;
                } else if (question.type === 'plural') {
                    questionHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h3 style="margin-bottom: 20px; color: #667eea;">å¤ä¹ é¢˜ ${currentQuestionIndex + 1}/20</h3>
                            <p style="font-size: 1.2rem; color: #333; margin-bottom: 20px;">${question.question}</p>
                            <input type="text" id="pluralReviewInput" style="padding: 10px; font-size: 1.2rem; border: 2px solid #667eea; border-radius: 10px; width: 200px; text-align: center;" placeholder="è¾“å…¥å¤æ•°å½¢å¼">
                            <br><br>
                            <button class="btn btn-success" id="checkPluralReviewBtn">æ£€æŸ¥ç­”æ¡ˆ</button>
                        </div>
                    `;
                } else if (question.type === 'sentence') {
                    questionHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h3 style="margin-bottom: 20px; color: #667eea;">å¤ä¹ é¢˜ ${currentQuestionIndex + 1}/20</h3>
                            <p style="font-size: 1.2rem; color: #333; margin-bottom: 20px;">è¯·ç»„åˆæˆå®Œæ•´çš„å¥å­ï¼š</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px;">
                                ${question.parts.map(part => `<span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">${part}</span>`).join('')}
                            </div>
                            <input type="text" id="sentenceInput" style="padding: 10px; font-size: 1.2rem; border: 2px solid #667eea; border-radius: 10px; width: 300px; text-align: center;" placeholder="è¾“å…¥å®Œæ•´å¥å­">
                            <br><br>
                            <button class="btn btn-success" id="checkSentenceBtn">æ£€æŸ¥ç­”æ¡ˆ</button>
                        </div>
                    `;
                } else if (question.type === 'touch') {
                    questionHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h3 style="margin-bottom: 20px; color: #667eea;">å¤ä¹ é¢˜ ${currentQuestionIndex + 1}/20</h3>
                            <p style="font-size: 1.2rem; color: #333; margin-bottom: 30px;">${question.question}</p>
                            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
                                ${question.items.map((item, index) =>
                        `<div class="touch-item" id="reviewItem${index}" style="font-size: 3rem; cursor: pointer; transition: all 0.3s ease; padding: 15px;">${item}</div>`
                    ).join('')}
                            </div>
                            <div style="background: rgba(255,255,255,0.8); padding: 10px; border-radius: 10px;">
                                <p style="color: #333; margin: 0;">å·²è§¦æ‘¸: <span id="touchCount">0</span>/${question.required}</p>
                            </div>
                        </div>
                    `;
                }

                playArea.innerHTML = questionHTML;

                // Add event listeners based on question type
                if (question.type === 'choice') {
                    document.querySelectorAll('.choice-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const selectedIndex = parseInt(btn.dataset.index);
                            const isCorrect = selectedIndex === question.answer;

                            if (isCorrect) {
                                correctCount++;
                                btn.style.background = '#4CAF50';
                                btn.style.color = 'white';
                                btn.style.borderColor = '#4CAF50';
                                setTimeout(() => {
                                    currentQuestionIndex++;
                                    showNextQuestion();
                                }, 1000);
                            } else {
                                btn.style.background = '#F44336';
                                btn.style.color = 'white';
                                btn.style.borderColor = '#F44336';
                                setTimeout(() => {
                                    btn.style.background = 'white';
                                    btn.style.color = 'black';
                                    btn.style.borderColor = '#ddd';
                                }, 1000);
                            }
                        });
                    });
                } else if (question.type === 'pronunciation') {
                    // Initialize speech recognition for pronunciation question
                    initReviewPronunciationRecognition(question, () => {
                        correctCount++;
                        currentQuestionIndex++;
                        showNextQuestion();
                    });
                } else if (question.type === 'spelling') {
                    document.getElementById('checkSpellingBtn').addEventListener('click', () => {
                        const input = document.getElementById('spellingInput').value.trim().toLowerCase();
                        const isCorrect = input === question.answer.toLowerCase();

                        if (isCorrect) {
                            correctCount++;
                            alert('âœ… æ­£ç¡®ï¼');
                            currentQuestionIndex++;
                            showNextQuestion();
                        } else {
                            alert(`âŒ ä¸å¯¹å“¦ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯: ${question.answer}`);
                            document.getElementById('spellingInput').value = '';
                            document.getElementById('spellingInput').focus();
                        }
                    });

                    // Allow Enter key to submit
                    document.getElementById('spellingInput').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('checkSpellingBtn').click();
                        }
                    });
                } else if (question.type === 'plural') {
                    document.getElementById('checkPluralReviewBtn').addEventListener('click', () => {
                        const input = document.getElementById('pluralReviewInput').value.trim().toLowerCase();
                        const isCorrect = input === question.answer.toLowerCase();

                        if (isCorrect) {
                            correctCount++;
                            alert('âœ… æ­£ç¡®ï¼');
                            currentQuestionIndex++;
                            showNextQuestion();
                        } else {
                            alert(`âŒ ä¸å¯¹å“¦ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯: ${question.answer}`);
                            document.getElementById('pluralReviewInput').value = '';
                            document.getElementById('pluralReviewInput').focus();
                        }
                    });
                } else if (question.type === 'sentence') {
                    document.getElementById('checkSentenceBtn').addEventListener('click', () => {
                        const input = document.getElementById('sentenceInput').value.trim().toLowerCase();
                        const isCorrect = input === question.answer.toLowerCase();

                        if (isCorrect) {
                            correctCount++;
                            alert('âœ… æ­£ç¡®ï¼');
                            currentQuestionIndex++;
                            showNextQuestion();
                        } else {
                            alert(`âŒ ä¸å¯¹å“¦ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯: "${question.answer}"`);
                            document.getElementById('sentenceInput').value = '';
                            document.getElementById('sentenceInput').focus();
                        }
                    });
                } else if (question.type === 'touch') {
                    let touchCount = 0;
                    question.items.forEach((item, index) => {
                        document.getElementById(`reviewItem${index}`).addEventListener('click', () => {
                            touchCount++;
                            document.getElementById('touchCount').textContent = touchCount;

                            if (touchCount >= question.required) {
                                correctCount++;
                                setTimeout(() => {
                                    currentQuestionIndex++;
                                    showNextQuestion();
                                }, 1000);
                            }
                        });
                    });
                }
            }

            showNextQuestion();
        }

        // Initialize pronunciation recognition for review questions
        function initReviewPronunciationRecognition(question, onCorrect) {
            const micBtn = document.getElementById('reviewPronunciationMicBtn');
            const resultDiv = document.getElementById('reviewPronunciationResult');
            let isReviewRecording = false;
            let reviewTranscripts = [];
            let reviewRecognition = null;

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                resultDiv.innerHTML = '<div class="incorrect">æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ã€‚</div>';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            reviewRecognition = new SpeechRecognition();
            reviewRecognition.continuous = true;
            reviewRecognition.interimResults = true;
            reviewRecognition.lang = 'en-US';
            reviewRecognition.maxAlternatives = 1;

            reviewRecognition.onstart = () => {
                isReviewRecording = true;
                micBtn.classList.add('recording');
                micBtn.textContent = 'ğŸ›‘';
                resultDiv.innerHTML = '<p style="color: #666;">æ­£åœ¨å½•éŸ³... è¯·è¯»å‡ºè¿™ä¸ªå•è¯</p>';
                reviewTranscripts = [];
            };

            reviewRecognition.onresult = (event) => {
                reviewTranscripts = [];
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript.trim();
                    const isFinal = event.results[i].isFinal;
                    if (transcript) {
                        reviewTranscripts.push({ transcript: transcript, isFinal: isFinal });
                        if (isFinal) {
                            resultDiv.innerHTML = `<p style="color: #666;">å¬åˆ°: "${transcript}"</p>`;
                        }
                    }
                }
            };

            reviewRecognition.onend = () => {
                isReviewRecording = false;
                micBtn.classList.remove('recording');
                micBtn.textContent = 'ğŸ¤';

                const finalResults = reviewTranscripts.filter(r => r.isFinal);
                if (finalResults.length > 0) {
                    const recognizedWord = finalResults[finalResults.length - 1].transcript.toLowerCase().trim();
                    checkReviewPronunciation(recognizedWord, question, onCorrect);
                } else if (reviewTranscripts.length > 0) {
                    const recognizedWord = reviewTranscripts[reviewTranscripts.length - 1].transcript.toLowerCase().trim();
                    checkReviewPronunciation(recognizedWord, question, onCorrect);
                } else {
                    resultDiv.innerHTML = '<div class="incorrect">æ²¡æœ‰è¯†åˆ«åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•ã€‚</div>';
                }
            };

            reviewRecognition.onerror = (event) => {
                if (event.error !== 'no-speech') {
                    isReviewRecording = false;
                    micBtn.classList.remove('recording');
                    micBtn.textContent = 'ğŸ¤';
                    resultDiv.innerHTML = '<div class="incorrect">å½•éŸ³å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚</div>';
                }
            };

            micBtn.onclick = () => {
                if (!isReviewRecording) {
                    try {
                        reviewRecognition.start();
                    } catch (error) {
                        if (error.message.includes('already started')) {
                            reviewRecognition.stop();
                            setTimeout(() => {
                                reviewRecognition.start();
                            }, 100);
                        }
                    }
                } else {
                    reviewRecognition.stop();
                }
            };
        }

        // Check pronunciation for review question
        function checkReviewPronunciation(transcript, question, onCorrect) {
            const resultDiv = document.getElementById('reviewPronunciationResult');
            const isCorrect = checkPronunciation(transcript, question.answer);

            if (isCorrect) {
                resultDiv.innerHTML = `
                    <div class="recognition-result correct">
                        âœ… æ­£ç¡®ï¼å‘éŸ³æ ‡å‡†ï¼<br>
                        <small>ä½ è¯´çš„æ˜¯: "${transcript}"</small>
                    </div>
                `;
                setTimeout(() => {
                    if (onCorrect) {
                        onCorrect();
                    }
                }, 2000);
            } else {
                resultDiv.innerHTML = `
                    <div class="recognition-result incorrect">
                        âŒ å‘éŸ³ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•ï¼<br>
                        <small>ä½ è¯´çš„æ˜¯: "${transcript}"</small>
                    </div>
                `;
            }
        }

        // Generic learn level for other words
        function renderGenericLearnLevel(level) {
            playArea.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div class="word-display">
                        <div class="word">${level.word}</div>
                        <div class="pronunciation">${level.pronunciation}</div>
                    </div>
                    <p style="color: #666; margin: 20px 0;">è®©æˆ‘ä»¬å¤šå¬å‡ éè¿™ä¸ªå•è¯çš„å‘éŸ³å§ï¼</p>
                    <button class="btn btn-primary" id="repeatListenBtn" style="margin: 10px;">
                        ğŸ”Š å†å¬ä¸€é
                    </button>
                    <div style="margin-top: 30px;">
                        <button class="btn btn-success" onclick="changePhase('practice')">æˆ‘å­¦ä¼šäº†ï¼Œå‡†å¤‡æµ‹è¯•</button>
                    </div>
                </div>
            `;

            document.getElementById('repeatListenBtn').addEventListener('click', () => playAudio(level.word));
        }

        // Practice phase - speech recognition
        function renderPracticePhase(level) {
            let instructions = '';

            if (level.gameType === 'connect_letters') {
                instructions = `
                    <div style="background: #FFF3CD; border: 2px solid #FFC107; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">ğŸ“ æ‹¼è¯»è¦æ±‚ï¼ˆä¸¥æ ¼æ ‡å‡†ï¼‰</h4>
                        <p style="color: #856404; margin: 0; line-height: 1.6;">
                            è¯·<strong>ä¸€ä¸ªå­—æ¯ä¸€ä¸ªå­—æ¯åœ°æ…¢æ…¢æ‹¼è¯»</strong>ï¼Œä¸èƒ½ç›´æ¥è¯´æ•´ä¸ªå•è¯ï¼<br>
                            ä¾‹å¦‚ï¼š"apple" è¦è¯»æˆ "a-p-p-l-e" æˆ– "a p p l e"<br>
                            <strong>å‘éŸ³å¿…é¡»éå¸¸æ ‡å‡†ï¼Œé€Ÿåº¦è¦æ…¢ï¼Œä¸èƒ½å¤ªå¿«ï¼</strong>
                        </p>
                    </div>
                `;
            } else {
                let difficultyInstructions = '';
                const difficultyStyles = {
                    'hard': {
                        bg: '#D1ECF1',
                        border: '#17A2B8',
                        color: '#0C5460',
                        title: 'ğŸ¯ å‘éŸ³è¦æ±‚ï¼ˆæœ€éš¾ - æ ‡å‡†è‹±è¯­å‘éŸ³ï¼‰',
                        text: 'è¯·æ…¢æ…¢åœ°ã€æ¸…æ¥šåœ°è¯»å‡ºè¿™ä¸ªå•è¯ï¼Œ<strong>å‘éŸ³å¿…é¡»éå¸¸æ ‡å‡†</strong>ï¼ä¸èƒ½è¯»å¾—å¤ªå¿«ï¼Œè¦è®©æ¯ä¸ªéŸ³èŠ‚éƒ½æ¸…æ™°å¯è¾¨ã€‚<strong>æ³¨æ„ï¼šä¸­æ–‡å£éŸ³çš„å‘éŸ³ä¸åˆæ ¼ï¼Œå¿…é¡»ç”¨æ ‡å‡†çš„è‹±è¯­å‘éŸ³ï¼</strong>'
                    },
                    'medium': {
                        bg: '#FFF3CD',
                        border: '#FFC107',
                        color: '#856404',
                        title: 'ğŸ¯ å‘éŸ³è¦æ±‚ï¼ˆä¸­ç­‰ - å…è®¸æ··åˆå‘éŸ³ï¼‰',
                        text: 'å¯ä»¥ä¸æ˜¯çº¯è‹±æ–‡å‘éŸ³ï¼Œä½†ä¸èƒ½å®Œå…¨æ˜¯ä¸­æ–‡ã€‚å…è®¸æœ‰ä¸€äº›ä¸­æ–‡å£éŸ³ï¼Œä½†å¿…é¡»èƒ½è¯†åˆ«å‡ºæ˜¯è‹±è¯­å•è¯ã€‚'
                    },
                    'easy': {
                        bg: '#D4EDDA',
                        border: '#28A745',
                        color: '#155724',
                        title: 'ğŸ¯ å‘éŸ³è¦æ±‚ï¼ˆå®¹æ˜“ - å…è®¸å¿«é€Ÿä¸­æ–‡å‘éŸ³ï¼‰',
                        text: 'å¯ä»¥è¯»å¾—éå¸¸å¿«ï¼Œå…è®¸ä¸­æ–‡å‘éŸ³æ–¹å¼ï¼Œä½†ä¸èƒ½å®Œå…¨éƒ½æ˜¯ä¸­æ–‡ã€‚åªè¦åŒ…å«è‹±è¯­å•è¯çš„åŸºæœ¬éŸ³ç´ å³å¯ã€‚'
                    }
                };

                const style = difficultyStyles[currentDifficulty] || difficultyStyles['hard'];
                instructions = `
                    <div style="background: ${style.bg}; border: 2px solid ${style.border}; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="color: ${style.color}; margin-bottom: 10px;">${style.title}</h4>
                        <p style="color: ${style.color}; margin: 0; line-height: 1.6;">
                            ${style.text}
                        </p>
                    </div>
                `;
            }

            playArea.innerHTML = `
                <div class="speech-recognition">
                    <h3 style="margin-bottom: 20px; color: #667eea;">å‘éŸ³æµ‹è¯•æ—¶é—´ï¼</h3>

                    ${instructions}

                    <p style="margin-bottom: 20px; color: #666;">
                        è¯·çœ‹ç€è¿™ä¸ªå†…å®¹ï¼Œç‚¹å‡»éº¦å…‹é£æŒ‰é’®ï¼Œç„¶åæŒ‰è¦æ±‚è¯»å‡ºæ¥ï¼š<br>
                        <strong style="font-size: 2rem; color: #667eea;">${level.word}</strong>
                    </p>
                    <div class="pronunciation" style="margin-bottom: 30px;">${level.pronunciation}</div>

                    <button class="mic-btn" id="micBtn">ğŸ¤ ç‚¹å‡»å¼€å§‹å½•éŸ³</button>
                    <p style="font-size: 0.9rem; color: #999; margin-top: 10px;">
                        æç¤ºï¼šç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³ï¼Œè¯´å®Œåå†æ¬¡ç‚¹å‡»åœæ­¢å½•éŸ³
                    </p>

                    <div id="recognitionResult" style="margin-top: 20px;"></div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="playAudio('${level.word}')">ğŸ”Š å¬æ ‡å‡†å‘éŸ³</button>
                    </div>
                </div>
            `;

            // Initialize speech recognition
            initSpeechRecognition(level);
        }

        // Initialize speech recognition
        let isRecording = false;
        let recognitionTranscripts = [];

        function initSpeechRecognition(level) {
            const micBtn = document.getElementById('micBtn');
            const resultDiv = document.getElementById('recognitionResult');
            isRecording = false;
            recognitionTranscripts = [];

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                resultDiv.innerHTML = '<div class="incorrect">æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ã€‚è¯·ä½¿ç”¨Chromeæµè§ˆå™¨ã€‚</div>';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true; // æ”¹ä¸ºè¿ç»­æ¨¡å¼ï¼Œæ‰‹åŠ¨åœæ­¢
            recognition.interimResults = true; // å…è®¸æ˜¾ç¤ºä¸­é—´ç»“æœ
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('recording');
                micBtn.textContent = 'ğŸ›‘ ç‚¹å‡»åœæ­¢å½•éŸ³';
                resultDiv.innerHTML = '<p style="color: #666;">ğŸ™ï¸ æ­£åœ¨å½•éŸ³ä¸­... è¯·å¤§å£°è¯´å‡º "' + level.word + '"<br><small>è¯´å®Œåç‚¹å‡»éº¦å…‹é£æŒ‰é’®åœæ­¢</small></p>';
                recognitionTranscripts = []; // æ¸…ç©ºä¹‹å‰çš„å½•éŸ³ç»“æœ
            };

            recognition.onresult = (event) => {
                // æ”¶é›†æ‰€æœ‰è¯†åˆ«ç»“æœ
                recognitionTranscripts = [];
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript.toLowerCase().trim();
                    const isFinal = event.results[i].isFinal;

                    if (transcript) {
                        recognitionTranscripts.push({
                            transcript: transcript,
                            isFinal: isFinal
                        });
                    }
                }

                // æ˜¾ç¤ºå®æ—¶è¯†åˆ«ç»“æœï¼ˆæœ€åä¸€ä¸ªï¼‰
                if (recognitionTranscripts.length > 0) {
                    const lastResult = recognitionTranscripts[recognitionTranscripts.length - 1];
                    if (!lastResult.isFinal) {
                        resultDiv.innerHTML = '<p style="color: #666;">ğŸ™ï¸ æ­£åœ¨å½•éŸ³ä¸­...<br><small style="color: #999;">å¬åˆ°: "' + lastResult.transcript + '"</small></p>';
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    // æ²¡æœ‰è¯­éŸ³è¾“å…¥ï¼Œç»§ç»­ç­‰å¾…
                    return;
                }
                isRecording = false;
                micBtn.classList.remove('recording');
                micBtn.textContent = 'ğŸ¤ ç‚¹å‡»å¼€å§‹å½•éŸ³';
                resultDiv.innerHTML = '<div class="incorrect">å½•éŸ³å‡ºé”™: ' + event.error + 'ï¼Œè¯·é‡è¯•ã€‚</div>';
            };

            recognition.onend = () => {
                isRecording = false;
                micBtn.classList.remove('recording');
                micBtn.textContent = 'ğŸ¤ ç‚¹å‡»å¼€å§‹å½•éŸ³';

                // å¤„ç†æœ€ç»ˆè¯†åˆ«ç»“æœ
                if (recognitionTranscripts.length > 0) {
                    // ä½¿ç”¨æœ€åä¸€ä¸ªæœ€ç»ˆç»“æœ
                    const finalResults = recognitionTranscripts.filter(r => r.isFinal);
                    const bestTranscript = finalResults.length > 0
                        ? finalResults[finalResults.length - 1].transcript
                        : recognitionTranscripts[recognitionTranscripts.length - 1].transcript;

                    console.log('Final transcript:', bestTranscript);

                    // Check if pronunciation is correct
                    const isCorrect = checkPronunciation(bestTranscript, level.word);

                    if (isCorrect) {
                        const level = levels[currentLevel];
                        resultDiv.innerHTML = `
                            <div class="recognition-result correct">
                                ğŸ‰ å¤ªæ£’äº†ï¼${level.word}å‘éŸ³å®Œå…¨æ­£ç¡®ï¼<br>
                                <small>ä½ è¯´çš„æ˜¯: "${bestTranscript}"</small>
                            </div>
                        `;
                        setTimeout(() => {
                            completeLevel();
                        }, 2000);
                    } else {
                        const level = levels[currentLevel];
                        let simpleErrorMessage = '';

                        if (level.gameType === 'connect_letters') {
                            simpleErrorMessage = 'å¿…é¡»ä¸€ä¸ªå­—æ¯ä¸€ä¸ªå­—æ¯åœ°æ‹¼è¯»ï¼ä¸èƒ½ç›´æ¥è¯´æ•´ä¸ªå•è¯ã€‚';
                        } else {
                            simpleErrorMessage = 'å‘éŸ³æ ‡å‡†åº¦ä¸å¤Ÿï¼Œè¯·ç”¨æ ‡å‡†çš„è‹±è¯­å‘éŸ³é‡è¯•ï¼';
                        }

                        resultDiv.innerHTML = `
                            <div class="recognition-result incorrect">
                                âŒ ä¸åˆæ ¼ï¼Œè¯·é‡è¯•ï¼<br>
                                <small>ä½ è¯´çš„æ˜¯: "${bestTranscript}"</small><br>
                                <small style="color: #d32f2f; font-weight: bold;">${simpleErrorMessage}</small>
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = '<div class="incorrect">æ²¡æœ‰è¯†åˆ«åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•ã€‚</div>';
                }
            };

            // ç‚¹å‡»éº¦å…‹é£æŒ‰é’®å¼€å§‹/åœæ­¢å½•éŸ³
            micBtn.addEventListener('click', () => {
                if (!isRecording) {
                    // å¼€å§‹å½•éŸ³
                    try {
                        recognition.start();
                    } catch (error) {
                        if (error.message.includes('already started')) {
                            // å¦‚æœå·²ç»åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å†å¼€å§‹
                            recognition.stop();
                            setTimeout(() => {
                                recognition.start();
                            }, 100);
                        }
                    }
                } else {
                    // åœæ­¢å½•éŸ³
                    recognition.stop();
                }
            });
        }

        // Check pronunciationï¼ˆå·²æ”¾å®½æ ‡å‡†ï¼Œå°½é‡ä¸æ°”å¥¶å¥¶ï¼‰
        function checkPronunciation(transcript, targetWord) {
            const transcriptClean = transcript.toLowerCase().trim();

            // Remove punctuation and extra spaces
            const cleanTranscript = transcriptClean.replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();

            // Special handling for different game types
            const level = levels[currentLevel];

            // For connect letters levels, check if they spelled it out letter by letter
            if (level.gameType === 'connect_letters') {
                // Check if they spelled the word by saying individual letters
                const letters = level.letters;
                const spelledCorrectly = checkSpellingPronunciation(cleanTranscript, targetWord, letters);

                if (!spelledCorrectly) {
                    return false;
                }
            }

            // For choice question levels, they should pronounce the wordï¼Œä½†å…è®¸æ¯”è¾ƒå®½æ¾
            if (level.gameType === 'choice_question') {
                return checkWordPronunciation(cleanTranscript, targetWord);
            }

            // For plural practice levels, check plural forms
            if (level.gameType === 'plural_practice') {
                return checkPluralPronunciation(cleanTranscript, targetWord);
            }

            // For sentence practice levels, check sentence pronunciation
            if (level.gameType === 'sentence_practice') {
                return checkSentencePronunciation(cleanTranscript, targetWord);
            }

            // Forå…¶å®ƒå…³å¡ï¼ˆåŒ…æ‹¬å¤ä¹ å…³é‡Œçš„è¯»å•è¯ï¼‰ï¼Œç»Ÿä¸€ä½¿ç”¨ã€Œéå¸¸å®½æ¾ã€çš„æ£€æŸ¥é€»è¾‘
            return checkLenientPronunciation(cleanTranscript, targetWord);
        }

        // Check if they spelled the word letter by letter
        function checkSpellingPronunciation(transcript, targetWord, letters) {
            // Remove spaces and check if they said the letters individually
            const noSpaces = transcript.replace(/\s/g, '');

            // Check if they spelled it correctly
            if (noSpaces === letters.join('')) {
                return true;
            }

            // Check if they said it with spaces between letters
            const spacedLetters = letters.join(' ');
            if (transcript === spacedLetters) {
                return true;
            }

            // Check if they said "a-p-p-l-e" style spelling
            const hyphenated = letters.join('-');
            if (transcript.replace(/\s/g, '-') === hyphenated) {
                return true;
            }

            return false;
        }

        // å•è¯å‘éŸ³æ£€æŸ¥ï¼šæ ¹æ®éš¾åº¦è°ƒæ•´ï¼Œä½†æ•´ä½“æ”¾å®½
        function checkWordPronunciation(transcript, targetWord) {
            const cleanInput = transcript.replace(/[^\w]/g, '').toLowerCase();
            const cleanTarget = targetWord.toLowerCase();

            // Allow both singular and plural forms
            const pluralVariants = {
                'cat': ['cat', 'cats'],
                'dog': ['dog', 'dogs'],
                'car': ['car', 'cars'],
                'apple': ['apple', 'apples'],
                'banana': ['banana', 'bananas']
            };

            let acceptableWords = [cleanTarget];
            if (pluralVariants[cleanTarget]) {
                acceptableWords = pluralVariants[cleanTarget];
            }

            // Check if input matches any acceptable variant
            const isAcceptableWord = acceptableWords.some(word => cleanInput === word);

            if (!isAcceptableWord) {
                return false;
            }

            // ç›´æ¥ä½¿ç”¨ã€Œç®€å•å®½æ¾ã€è§„åˆ™ï¼Œä¸å†åŒºåˆ† hard/medium/easy
            return checkLenientPronunciation(transcript, targetWord);
        }

        // éå¸¸å®½æ¾çš„å‘éŸ³æ£€æŸ¥ï¼šåªè¦å¤§è‡´åƒå°±é€šè¿‡ï¼Œé¿å… C/H ä¹‹ç±»çš„å°é”™è¯¯å¯¼è‡´å¤±è´¥
        function checkLenientPronunciation(transcript, targetWord) {
            const input = transcript.toLowerCase();
            const word = targetWord.toLowerCase();

            // 1. å®Œå…¨ä¸­æ–‡ç›´æ¥åˆ¤é”™ï¼ˆæ¯”å¦‚åªè¯´â€œçŒ«â€ï¼‰
            const allChinese = /^[\u4e00-\u9fa5]+$/.test(transcript);
            if (allChinese) return false;

            // 2. åªè¦æœ‰è‹±æ–‡å­—ç¬¦ï¼Œå°±è®¤ä¸ºæ˜¯å°è¯•è¯»è‹±æ–‡
            if (/[a-z]/.test(input)) {
                // å¯¹å¾ˆçŸ­çš„è¯ï¼ˆcat, dog, car, but ç­‰ï¼‰å†å®½æ¾ä¸€ç‚¹ï¼š
                // - åªè¦åŒ…å«é¦–å­—æ¯æˆ–å°¾å­—æ¯å°±å¯ä»¥
                if (word.length <= 4) {
                    const first = word[0];
                    const last = word[word.length - 1];
                    if (input.includes(first) || input.includes(last)) {
                        return true;
                    }
                }

                // å¯¹å…¶å®ƒå•è¯ï¼šåªè¦æœ‰ä¸€éƒ¨åˆ†è¿ç»­çš„å­—æ¯å’Œç›®æ ‡å•è¯é‡åˆå³å¯
                // ä¾‹å¦‚ "ca" ä¹Ÿå¯ä»¥ç®— cat
                for (let len = Math.min(2, word.length); len <= word.length; len++) {
                    const part = word.slice(0, len);
                    if (input.includes(part)) {
                        return true;
                    }
                }

            }

            return false;
        }

        function checkHardModePronunciation(transcript, targetWord) {
            // Hard mode: Must be standard English pronunciation
            const word = targetWord.toLowerCase();

            // Check for Chinese-influenced pronunciations (reject them)
            const chinesePatterns = {
                'cat': ['ka', 'te', 'å‡¯ç‰¹'],
                'dog': ['dou', 'ge', 'è±†å“¥'],
                'car': ['ka', 'er', 'å¡å°”'],
                'but': ['ba', 'te', 'å·´ç‰¹'],
                'apple': ['po', 'pu', 'è‹¹æœ'],
                'banana': ['na', 'é‚£', 'é¦™è•‰']
            };

            if (chinesePatterns[word]) {
                const patterns = chinesePatterns[word];
                const transcriptLower = transcript.toLowerCase();
                // If contains too many Chinese patterns, reject
                const chineseMatchCount = patterns.filter(pattern => transcriptLower.includes(pattern)).length;
                if (chineseMatchCount >= 2) {
                    return false;
                }
            }

            // Must contain English-like patterns
            return transcript.toLowerCase().match(/[a-z]{2,}/) !== null;
        }

        function checkMediumModePronunciation(transcript, targetWord, cleanInput) {
            // Medium mode: Can be mixed, but not completely Chinese
            const word = targetWord.toLowerCase();
            const transcriptLower = transcript.toLowerCase();

            // Check if it's completely Chinese (reject)
            const allChineseChars = /^[\u4e00-\u9fa5]+$/.test(transcript);
            if (allChineseChars) {
                return false;
            }

            // Must contain some English letters or recognizable English word pattern
            const hasEnglishChars = /[a-z]/i.test(transcript);
            if (!hasEnglishChars) {
                return false;
            }

            // Must contain at least part of the target word
            return transcriptLower.includes(word.substring(0, 2)) || cleanInput.includes(word.substring(0, 2));
        }

        function checkEasyModePronunciation(transcript, targetWord, cleanInput) {
            // Easy mode: Allow fast Chinese-style, but can't be completely Chinese
            const word = targetWord.toLowerCase();
            const transcriptLower = transcript.toLowerCase();

            // Check if it's completely Chinese (reject)
            const allChineseChars = /^[\u4e00-\u9fa5]+$/.test(transcript);
            if (allChineseChars) {
                return false;
            }

            // Very lenient: just needs to contain some reference to the word
            // Check if transcript contains any letters from the target word
            const wordLetters = word.split('').filter(l => /[a-z]/.test(l));
            const matchingLetters = wordLetters.filter(letter => transcriptLower.includes(letter)).length;

            // Must have at least 1 matching letter (very lenient)
            return matchingLetters > 0 || cleanInput.length > 0;
        }

        // Check plural pronunciation
        function checkPluralPronunciation(transcript, targetWord) {
            // For plural practice level (ç¬¬9å…³)ï¼Œç”¨æˆ·éœ€è¦å‘éŸ³å¤æ•°å½¢å¼
            if (targetWord === 'å•å¤æ•°S') {
                const level = levels[currentLevel];
                const examples = level.examples;

                // Check if transcript contains any of the plural forms correctly
                for (const example of examples) {
                    if (transcript.toLowerCase().includes(example.plural.toLowerCase())) {
                        return true;
                    }
                }

                // Check if they said multiple plural forms
                const pluralWords = ['cats', 'dogs', 'cars', 'apples', 'bananas'];
                const foundPlurals = pluralWords.filter(word => transcript.toLowerCase().includes(word));

                return foundPlurals.length >= 2; // Must say at least 2 plural forms
            }

            return false;
        }

        // Check sentence pronunciation
        function checkSentencePronunciation(transcript, targetWord) {
            // For sentence practice, check if they pronounced the key parts correctly
            const level = levels[currentLevel];
            const sentence = level.sentence.toLowerCase();

            // Check for key elements in the sentence
            const hasLike = transcript.includes('like');
            const hasBut = transcript.includes('but');
            const hasDont = transcript.includes('don\'t') || transcript.includes('dont');
            const hasCat = transcript.includes('cat');
            const hasDog = transcript.includes('dog');

            // Must have most of the key elements
            const keyElements = [hasLike, hasBut, hasDont, hasCat, hasDog];
            const presentCount = keyElements.filter(Boolean).length;

            return presentCount >= 4; // Must have at least 4 out of 5 key elements
        }

        // Strict pronunciation checking for all words
        function checkStrictPronunciation(transcript, targetWord) {
            // For simple words, require exact pronunciation
            const simpleWords = ['tap', 'pan', 'milk', 'sun', 'moon', 'star', 'fish', 'bird', 'tree', 'flower', 'water', 'fire', 'wind'];

            if (simpleWords.includes(targetWord)) {
                return checkWordPronunciation(transcript, targetWord);
            }

            // For complex phrases like "I like cat, but I don't like dog"
            if (targetWord.includes('I like cat, but I don\'t like dog')) {
                const cleanInput = transcript.toLowerCase().replace(/[^\w\s]/g, '');

                // Must contain all key elements
                const hasILike = cleanInput.includes('i like') || cleanInput.includes('i love');
                const hasCat = cleanInput.includes('cat');
                const hasBut = cleanInput.includes('but') || cleanInput.includes('butt');
                const hasDont = cleanInput.includes('dont') || cleanInput.includes('don\'t');
                const hasLikeDog = cleanInput.includes('like dog');

                return hasILike && hasCat && hasBut && hasDont && hasLikeDog;
            }

            // Default strict checking
            return checkWordPronunciation(transcript, targetWord);
        }

        // Change phase
        function changePhase(phase) {
            currentPhase = phase;
            updatePhaseButtons();
            renderPlayArea();
        }

        // Play audio using Web Speech API
        function playAudio(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.7; // Slightly slower for learning

                // Find a good English voice
                const voices = speechSynthesis.getVoices();
                const englishVoice = voices.find(voice =>
                    voice.lang.startsWith('en') && voice.name.toLowerCase().includes('female')
                ) || voices.find(voice => voice.lang.startsWith('en'));

                if (englishVoice) {
                    utterance.voice = englishVoice;
                }

                speechSynthesis.speak(utterance);
            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½ã€‚è¯·å°è¯•ä½¿ç”¨Chromeæˆ–Safariæµè§ˆå™¨ã€‚');
            }
        }

        // Complete level
        function completeLevel() {
            const level = levels[currentLevel];

            // Mark current level as completed
            if (!completedLevels.includes(level.id)) {
                completedLevels.push(level.id);
                localStorage.setItem('grandmaEnglishProgress', JSON.stringify(completedLevels));
                updateProgress();
                createLevelCards();
            }

            // Show celebration
            celebration.style.display = 'block';
            setTimeout(() => {
                celebration.style.display = 'none';

                // Go to next level or back to menu
                if (currentLevel < levels.length - 1) {
                    startLevel(currentLevel + 1);
                } else {
                    // All levels completed!
                    backToMenu();
                    alert('ğŸ‰ æ­å–œå¥¶å¥¶ï¼æ‚¨å·²ç»å®Œæˆäº†æ‰€æœ‰çš„è‹±è¯­å­¦ä¹ å…³å¡ï¼ğŸ‰');
                }
            }, 3000);
        }

        // Back to level selection
        function backToMenu() {
            gameScreen.classList.remove('show');
            document.querySelector('.level-grid').style.display = 'grid';

            // Stop speech recognition if active
            if (recognition) {
                recognition.stop();
            }
        }

        // Phase button event listeners
        document.querySelectorAll('.phase-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const phase = btn.dataset.phase;
                changePhase(phase);
            });
        });

        // Back button
        backBtn.addEventListener('click', backToMenu);

        // Initialize jump to level dropdown
        function initJumpToLevelDropdown() {
            const jumpSelect = document.getElementById('jumpToLevel');
            jumpSelect.innerHTML = '<option value="">é€‰æ‹©å…³å¡...</option>';

            levels.forEach((level, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `ç¬¬${level.id}å…³: ${level.word}`;
                jumpSelect.appendChild(option);
            });
        }

        // Initialize game
        createStars();
        createLevelCards();
        updateProgress();
        updateDebugInfo();
        initJumpToLevelDropdown();

        // Reset progress button
        document.getElementById('resetProgressBtn').addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¸¸æˆè¿›åº¦å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å·²å®Œæˆçš„å…³å¡ï¼')) {
                completedLevels = [];
                localStorage.setItem('grandmaEnglishProgress', JSON.stringify(completedLevels));
                updateProgress();
                createLevelCards();
                updateDebugInfo();
                initJumpToLevelDropdown();
                alert('è¿›åº¦å·²é‡ç½®ï¼ç°åœ¨å¯ä»¥é‡æ–°å¼€å§‹æ¸¸æˆäº†ã€‚');
            }
        });

        // Jump to level button
        document.getElementById('jumpBtn').addEventListener('click', () => {
            const jumpSelect = document.getElementById('jumpToLevel');
            const selectedLevelIndex = parseInt(jumpSelect.value);

            if (isNaN(selectedLevelIndex) || selectedLevelIndex < 0 || selectedLevelIndex >= levels.length) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…³å¡ï¼');
                return;
            }

            // Temporarily unlock all previous levels for debugging
            const targetLevel = levels[selectedLevelIndex];

            if (confirm(`ç¡®å®šè¦è·³è½¬åˆ°ç¬¬${targetLevel.id}å…³ "${targetLevel.word}" å—ï¼Ÿ\nï¼ˆè°ƒè¯•æ¨¡å¼ï¼šå°†ä¸´æ—¶è§£é”è¯¥å…³å¡ï¼‰`)) {
                // Stop any ongoing recognition
                if (recognition) {
                    recognition.stop();
                }

                // Close game screen if open
                gameScreen.classList.remove('show');
                document.querySelector('.level-grid').style.display = 'grid';

                // Start the selected level directly
                startLevel(selectedLevelIndex);
            }
        });

        // Parent mode setup
        function initParentMode() {
            // Check if initial setup is needed
            if (!isInitialSetupDone) {
                // First time use - show initial setup
                document.getElementById('initialSetupModal').classList.add('show');
            }

            updateDifficultyDisplay();

            // Initial setup - son name input
            document.getElementById('confirmSonNameBtn').addEventListener('click', () => {
                const sonNameInput = document.getElementById('sonNameInput').value.trim();

                if (!sonNameInput) {
                    alert('è¯·è¾“å…¥å„¿å­çš„åå­—ï¼');
                    return;
                }

                sonName = sonNameInput;
                localStorage.setItem('sonName', sonName);

                document.getElementById('initialSetupModal').classList.remove('show');
                document.getElementById('setPasswordModal').classList.add('show');
            });

            document.getElementById('cancelInitialBtn').addEventListener('click', () => {
                document.getElementById('initialSetupModal').classList.remove('show');
            });

            // Set password modal events
            const confirmSetPasswordBtn = document.getElementById('confirmSetPasswordBtn');

            // Remove existing event listeners by cloning the button
            const newConfirmSetPasswordBtn = confirmSetPasswordBtn.cloneNode(true);
            confirmSetPasswordBtn.parentNode.replaceChild(newConfirmSetPasswordBtn, confirmSetPasswordBtn);

            newConfirmSetPasswordBtn.addEventListener('click', () => {
                const newPassword = document.getElementById('newPasswordInput').value;
                const confirmPassword = document.getElementById('confirmPasswordInput').value;

                if (!newPassword) {
                    alert('è¯·è¾“å…¥å¯†ç ï¼');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡è¯•ï¼');
                    document.getElementById('confirmPasswordInput').value = '';
                    document.getElementById('confirmPasswordInput').focus();
                    return;
                }

                parentPasswordHash = simpleHash(newPassword);
                localStorage.setItem('parentPasswordHash', parentPasswordHash);

                // If this is initial setup
                if (!isInitialSetupDone) {
                    localStorage.setItem('initialSetupDone', 'true');
                    isInitialSetupDone = true;
                }

                document.getElementById('setPasswordModal').classList.remove('show');
                document.getElementById('difficultyModal').classList.add('show');
                updateDifficultySelection();
                alert('å¯†ç è®¾ç½®æˆåŠŸï¼');
            });

            document.getElementById('cancelSetPasswordBtn').addEventListener('click', () => {
                document.getElementById('setPasswordModal').classList.remove('show');
                document.getElementById('initialSetupModal').classList.add('show');
            });

            // Parent mode button click
            document.getElementById('parentModeBtn').addEventListener('click', () => {
                if (!isInitialSetupDone) {
                    document.getElementById('initialSetupModal').classList.add('show');
                    return;
                }
                document.getElementById('passwordModal').classList.add('show');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            });

            // Password modal events
            document.getElementById('confirmPasswordBtn').addEventListener('click', checkPassword);
            document.getElementById('cancelPasswordBtn').addEventListener('click', () => {
                document.getElementById('passwordModal').classList.remove('show');
            });
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // Change password button (in difficulty modal)
            document.getElementById('changePasswordBtn').addEventListener('click', () => {
                document.getElementById('difficultyModal').classList.remove('show');
                document.getElementById('changePasswordModal').classList.add('show');
                document.getElementById('oldPasswordInput').value = '';
                document.getElementById('newPasswordChangeInput').value = '';
                document.getElementById('confirmPasswordChangeInput').value = '';
                document.getElementById('oldPasswordInput').focus();
            });

            // Difficulty selection events
            ['Hard', 'Medium', 'Easy'].forEach(diff => {
                document.getElementById(`difficulty${diff}`).addEventListener('click', () => {
                    document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('selected'));
                    document.getElementById(`difficulty${diff}`).classList.add('selected');
                });
            });

            // Save difficulty button
            document.getElementById('saveDifficultyBtn').addEventListener('click', () => {
                const selected = document.querySelector('.difficulty-option.selected');
                if (selected) {
                    const difficulty = selected.id.replace('difficulty', '').toLowerCase();
                    currentDifficulty = difficulty;
                    localStorage.setItem('pronunciationDifficulty', difficulty);
                    updateDifficultyDisplay();
                    document.getElementById('difficultyModal').classList.remove('show');
                    alert('éš¾åº¦è®¾ç½®å·²ä¿å­˜ï¼');
                } else {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéš¾åº¦ç­‰çº§ï¼');
                }
            });

            // Cancel difficulty button
            document.getElementById('cancelDifficultyBtn').addEventListener('click', () => {
                document.getElementById('difficultyModal').classList.remove('show');
                updateDifficultySelection();
            });

            // Change password modal events
            document.getElementById('confirmChangePasswordBtn').addEventListener('click', () => {
                const oldPassword = document.getElementById('oldPasswordInput').value;
                const newPassword = document.getElementById('newPasswordChangeInput').value;
                const confirmPassword = document.getElementById('confirmPasswordChangeInput').value;

                if (!oldPassword) {
                    alert('è¯·è¾“å…¥åŸå¯†ç ï¼');
                    return;
                }

                // Verify old password
                const oldPasswordHash = simpleHash(oldPassword);
                if (oldPasswordHash !== parentPasswordHash) {
                    alert('åŸå¯†ç é”™è¯¯ï¼è¯·é‡è¯•ã€‚');
                    document.getElementById('oldPasswordInput').value = '';
                    document.getElementById('oldPasswordInput').focus();
                    return;
                }

                if (!newPassword) {
                    alert('è¯·è¾“å…¥æ–°å¯†ç ï¼');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡è¯•ï¼');
                    document.getElementById('confirmPasswordChangeInput').value = '';
                    document.getElementById('confirmPasswordChangeInput').focus();
                    return;
                }

                // Update password
                parentPasswordHash = simpleHash(newPassword);
                localStorage.setItem('parentPasswordHash', parentPasswordHash);

                document.getElementById('changePasswordModal').classList.remove('show');
                document.getElementById('difficultyModal').classList.add('show');
                alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            });

            document.getElementById('cancelChangePasswordBtn').addEventListener('click', () => {
                document.getElementById('changePasswordModal').classList.remove('show');
                document.getElementById('difficultyModal').classList.add('show');
            });

            // Load saved difficulty on startup
            updateDifficultySelection();
        }

        // Send SMS verification code
        function sendSmsCode() {
            const phoneInput = document.getElementById('phoneInput').value.trim();

            if (!phoneInput) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·ç ï¼');
                return;
            }

            // Validate phone number format (11 digits starting with 1)
            if (!/^1[3-9]\d{9}$/.test(phoneInput)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç æ ¼å¼ï¼ˆ11ä½æ•°å­—ï¼‰ï¼');
                return;
            }

            // Generate and store verification code
            smsVerificationCode = generateSmsCode();
            smsCodeExpiry = Date.now() + 5 * 60 * 1000; // 5 minutes

            // Save phone number
            phoneNumber = phoneInput;
            localStorage.setItem('phoneNumber', phoneNumber);

            // Simulate sending SMS (in real app, this would call SMS service)
            alert(`éªŒè¯ç å·²å‘é€åˆ° ${phoneInput}\nï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼šéªŒè¯ç æ˜¯ ${smsVerificationCode}ï¼‰`);

            // Start countdown
            let countdown = 60;
            const sendBtn = document.getElementById('sendSmsBtn');
            const timerDiv = document.getElementById('smsTimer');
            sendBtn.disabled = true;

            const timer = setInterval(() => {
                countdown--;
                timerDiv.textContent = `${countdown}ç§’åå¯é‡æ–°å‘é€`;

                if (countdown <= 0) {
                    clearInterval(timer);
                    sendBtn.disabled = false;
                    timerDiv.textContent = '';
                }
            }, 1000);
        }

        // Verify SMS code
        function verifySmsCode() {
            const codeInput = document.getElementById('smsCodeInput').value.trim();
            const phoneInput = document.getElementById('phoneInput').value.trim();

            if (!codeInput) {
                alert('è¯·è¾“å…¥éªŒè¯ç ï¼');
                return;
            }

            if (!phoneInput) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·ç ï¼');
                return;
            }

            // Check if code is expired
            if (Date.now() > smsCodeExpiry) {
                alert('éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–ï¼');
                return;
            }

            // Verify code
            if (codeInput === smsVerificationCode) {
                // Verification successful - proceed to password change
                document.getElementById('smsVerifyModal').classList.remove('show');
                document.getElementById('setPasswordModal').classList.add('show');
                document.getElementById('newPasswordInput').value = '';
                document.getElementById('confirmPasswordInput').value = '';
                smsVerificationCode = ''; // Clear code after use
            } else {
                alert('éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
                document.getElementById('smsCodeInput').value = '';
                document.getElementById('smsCodeInput').focus();
            }
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const inputHash = simpleHash(input);

            if (inputHash === parentPasswordHash) {
                document.getElementById('passwordModal').classList.remove('show');
                document.getElementById('difficultyModal').classList.add('show');
                updateDifficultySelection();
            } else {
                alert('å¯†ç é”™è¯¯ï¼è¯·é‡è¯•ã€‚');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        // Voice verification for password change
        function initVoiceVerification() {
            const micBtn = document.getElementById('voiceVerifyMicBtn');
            const resultDiv = document.getElementById('voiceVerifyResult');
            let voiceVerifyRecognition = null;
            let isVoiceRecording = false;
            let voiceTranscripts = [];

            resultDiv.innerHTML = '';

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                resultDiv.innerHTML = '<div class="incorrect">æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ã€‚</div>';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceVerifyRecognition = new SpeechRecognition();
            voiceVerifyRecognition.continuous = true;
            voiceVerifyRecognition.interimResults = true;
            voiceVerifyRecognition.lang = 'zh-CN'; // ä½¿ç”¨ä¸­æ–‡è¯†åˆ«å„¿å­çš„åå­—
            voiceVerifyRecognition.maxAlternatives = 1;

            voiceVerifyRecognition.onstart = () => {
                isVoiceRecording = true;
                micBtn.classList.add('recording');
                micBtn.textContent = 'ğŸ›‘';
                resultDiv.innerHTML = '<p style="color: #666;">æ­£åœ¨å½•éŸ³... è¯·è¯´å‡ºå„¿å­çš„åå­—</p>';
                voiceTranscripts = [];
            };

            voiceVerifyRecognition.onresult = (event) => {
                voiceTranscripts = [];
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript.trim();
                    const isFinal = event.results[i].isFinal;
                    if (transcript) {
                        voiceTranscripts.push({ transcript: transcript, isFinal: isFinal });
                        if (isFinal) {
                            resultDiv.innerHTML = `<p style="color: #666;">å¬åˆ°: "${transcript}"</p>`;
                        }
                    }
                }
            };

            voiceVerifyRecognition.onend = () => {
                isVoiceRecording = false;
                micBtn.classList.remove('recording');
                micBtn.textContent = 'ğŸ¤';

                // Get the last final result
                const finalResults = voiceTranscripts.filter(r => r.isFinal);
                if (finalResults.length > 0) {
                    const recognizedName = finalResults[finalResults.length - 1].transcript.trim();
                    verifySonName(recognizedName);
                } else if (voiceTranscripts.length > 0) {
                    const recognizedName = voiceTranscripts[voiceTranscripts.length - 1].transcript.trim();
                    verifySonName(recognizedName);
                } else {
                    resultDiv.innerHTML = '<div class="incorrect">æ²¡æœ‰è¯†åˆ«åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•ã€‚</div>';
                }
            };

            voiceVerifyRecognition.onerror = (event) => {
                if (event.error !== 'no-speech') {
                    isVoiceRecording = false;
                    micBtn.classList.remove('recording');
                    micBtn.textContent = 'ğŸ¤';
                    resultDiv.innerHTML = '<div class="incorrect">å½•éŸ³å‡ºé”™: ' + event.error + 'ï¼Œè¯·é‡è¯•ã€‚</div>';
                }
            };

            micBtn.onclick = () => {
                if (!isVoiceRecording) {
                    try {
                        voiceVerifyRecognition.start();
                    } catch (error) {
                        if (error.message.includes('already started')) {
                            voiceVerifyRecognition.stop();
                            setTimeout(() => {
                                voiceVerifyRecognition.start();
                            }, 100);
                        }
                    }
                } else {
                    voiceVerifyRecognition.stop();
                }
            };
        }

        function verifySonName(recognizedName) {
            // Check for polyphones (å¤šéŸ³å­—)
            const polyphonesFound = [];
            const recognizedChars = recognizedName.split('');

            for (let i = 0; i < recognizedChars.length; i++) {
                const char = recognizedChars[i];
                if (polyphoneMap[char]) {
                    polyphonesFound.push({
                        index: i,
                        char: char,
                        options: polyphoneMap[char]
                    });
                }
            }

            // If polyphones found, show selection interface
            if (polyphonesFound.length > 0) {
                showPolyphoneSelection(recognizedName, polyphonesFound);
                return;
            }

            // Check if recognized name matches stored son name (fuzzy match)
            const normalizedRecognized = recognizedName.toLowerCase().replace(/\s/g, '');
            const normalizedStored = sonName.toLowerCase().replace(/\s/g, '');

            if (normalizedRecognized.includes(normalizedStored) || normalizedStored.includes(normalizedRecognized)) {
                // Verification successful - proceed to SMS verification
                document.getElementById('voiceVerifyModal').classList.remove('show');
                document.getElementById('smsVerifyModal').classList.add('show');
                // Pre-fill phone number if exists
                if (phoneNumber) {
                    document.getElementById('phoneInput').value = phoneNumber;
                }
            } else {
                // Show error with correct name
                document.getElementById('voiceVerifyResult').innerHTML = `
                    <div class="incorrect">
                        âŒ èº«ä»½éªŒè¯å¤±è´¥ï¼<br>
                        <small>å¬åˆ°: "${recognizedName}"</small><br>
                        <strong style="color: #4CAF50;">æ­£ç¡®åå­—: "${sonName}"</strong><br>
                        <small style="color: #999;">ä¸‹æ¬¡è¯·è¯´å‡ºæ­£ç¡®çš„åå­—</small>
                    </div>
                `;
            }
        }

        function showPolyphoneSelection(recognizedName, polyphones) {
            const polyphoneOptions = document.getElementById('polyphoneOptions');
            polyphoneOptions.innerHTML = '';

            // Show the recognized name for context
            const contextDiv = document.createElement('div');
            contextDiv.style.gridColumn = '1 / -1';
            contextDiv.style.marginBottom = '15px';
            contextDiv.style.padding = '10px';
            contextDiv.style.background = 'rgba(102, 126, 234, 0.1)';
            contextDiv.style.borderRadius = '5px';
            contextDiv.innerHTML = `<strong>è¯†åˆ«åˆ°çš„åå­—ï¼š</strong>${recognizedName}`;
            polyphoneOptions.appendChild(contextDiv);

            polyphones.forEach((poly, idx) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.gridColumn = '1 / -1';
                itemDiv.style.marginBottom = '15px';

                const label = document.createElement('div');
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '8px';
                label.style.color = '#333';
                label.textContent = `ç¬¬${poly.index + 1}ä¸ªå­— "${poly.char}" çš„è¯»éŸ³ï¼šè¯·é€‰æ‹©æ­£ç¡®çš„å­—`;
                itemDiv.appendChild(label);

                const optionsContainer = document.createElement('div');
                optionsContainer.style.display = 'flex';
                optionsContainer.style.gap = '10px';
                optionsContainer.style.flexWrap = 'wrap';

                poly.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-secondary';
                    btn.textContent = option;
                    btn.style.padding = '10px 20px';
                    btn.style.fontSize = '1.1rem';
                    btn.onclick = () => {
                        // Replace character at this position
                        const chars = recognizedName.split('');
                        chars[poly.index] = option;
                        const correctedName = chars.join('');

                        // Close polyphone modal and verify again with corrected name
                        document.getElementById('polyphoneModal').classList.remove('show');
                        verifySonName(correctedName);
                    };
                    optionsContainer.appendChild(btn);
                });

                itemDiv.appendChild(optionsContainer);
                polyphoneOptions.appendChild(itemDiv);
            });

            document.getElementById('polyphoneModal').classList.add('show');
        }

        function updateDifficultySelection() {
            document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('selected'));
            const difficultyMap = { 'hard': 'Hard', 'medium': 'Medium', 'easy': 'Easy' };
            document.getElementById(`difficulty${difficultyMap[currentDifficulty]}`).classList.add('selected');
        }

        function updateDifficultyDisplay() {
            const difficultyNames = {
                'hard': 'ğŸ”´ æœ€éš¾ - æ ‡å‡†è‹±è¯­å‘éŸ³',
                'medium': 'ğŸŸ  ä¸­ç­‰ - å…è®¸æ··åˆå‘éŸ³',
                'easy': 'ğŸŸ¢ å®¹æ˜“ - å…è®¸å¿«é€Ÿä¸­æ–‡å‘éŸ³'
            };
            document.getElementById('currentDifficultyInfo').textContent =
                `å½“å‰éš¾åº¦: ${difficultyNames[currentDifficulty]}`;
        }

        // Initialize parent mode
        initParentMode();

        // Debug feature: Middle mouse button to restart game
        document.addEventListener('auxclick', (event) => {
            if (event.button === 1) { // Middle mouse button
                event.preventDefault();
                restartGame();
            }
        });

        // Load voices for speech synthesis
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                // Voices are loaded
            };
        }

        // Restart game function (debug feature)
        function restartGame() {
            // Clear all progress
            completedLevels = [];
            localStorage.setItem('grandmaEnglishProgress', JSON.stringify(completedLevels));

            // Reset current state
            currentLevel = 0;
            currentPhase = 'recognize';
            interactionCount = 0;

            // Stop any ongoing speech recognition
            if (recognition) {
                recognition.stop();
            }

            // Reset UI
            updateProgress();
            createLevelCards();
            updateDebugInfo();
            initJumpToLevelDropdown();
            backToMenu();

            // Show restart message
            alert('ğŸ”„ è°ƒè¯•æ¨¡å¼ï¼šæ¸¸æˆå·²é‡æ–°å¼€å§‹ï¼æ‰€æœ‰è¿›åº¦å·²é‡ç½®ã€‚');
        }
    </script>
</body>

</html>